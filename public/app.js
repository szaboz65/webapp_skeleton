(()=>{var he=class{constructor(e,t){Object.assign(this,{type:t.type??null,detail:t,owner:e,target:t.target??null,phase:t.phase??"before",object:t.object??null,execute:null,isStopped:!1,isCancelled:!1,onComplete:null,listeners:[]}),delete t.type,delete t.target,delete t.object,this.complete=new Promise((i,s)=>{this._resolve=i,this._reject=s}),this.complete.catch(()=>{})}finish(e){e&&u.extend(this.detail,e),this.phase="after",this.owner.trigger.call(this.owner,this)}done(e){this.listeners.push(e)}preventDefault(){this._reject(),this.isCancelled=!0}stopPropagation(){this.isStopped=!0}},Y=class{constructor(e){if(this.activeEvents=[],this.listeners=[],typeof e<"u"){if(!u.checkName(e))return;N[e]=this}this.debug=!1}on(e,t){return typeof e=="string"?e=e.split(/[,\s]+/):e=[e],e.forEach(i=>{let s=typeof i=="string"?i:i.type+":"+i.execute+"."+i.scope;if(typeof i=="string"){let[l,r]=i.split("."),[n,a]=l.replace(":complete",":after").replace(":done",":after").split(":");i={type:n,execute:a??"before",scope:r}}if(i=u.extend({type:null,execute:"before",onComplete:null},i),!i.type){console.log("ERROR: You must specify event type when calling .on() method of "+this.name);return}if(!t){console.log("ERROR: You must specify event handler function when calling .on() method of "+this.name);return}Array.isArray(this.listeners)||(this.listeners=[]),this.listeners.push({name:s,edata:i,handler:t}),this.debug&&console.log("w2base: add event",{name:s,edata:i,handler:t})}),this}off(e,t){return typeof e=="string"?e=e.split(/[,\s]+/):e=[e],e.forEach(i=>{let s=typeof i=="string"?i:i.type+":"+i.execute+"."+i.scope;if(typeof i=="string"){let[r,n]=i.split("."),[a,h]=r.replace(":complete",":after").replace(":done",":after").split(":");i={type:a||"*",execute:h||"",scope:n||""}}if(i=u.extend({type:null,execute:null,onComplete:null},i),!i.type&&!i.scope){console.log("ERROR: You must specify event type when calling .off() method of "+this.name);return}t||(t=null);let l=0;this.listeners=this.listeners.filter(r=>(i.type==="*"||i.type===r.edata.type)&&(i.execute===""||i.execute===r.edata.execute)&&(i.scope===""||i.scope===r.edata.scope)&&(i.handler==null||i.handler===r.edata.handler)?(l++,!1):!0),this.debug&&console.log(`w2base: remove event (${l})`,{name:s,edata:i,handler:t})}),this}trigger(e,t){if(arguments.length==1?typeof e=="string"?t={type:e,target:this}:t=e:(t.type=e,t.target=t.target??this),u.isPlainObject(t)&&t.phase=="after"){if(t=this.activeEvents.find(n=>n.type==t.type&&n.target==t.target),!t){console.log(`ERROR: Cannot find even handler for "${t.type}" on "${t.target}".`);return}console.log(`NOTICE: This syntax "edata.trigger({ phase: 'after' })" is outdated. Use edata.finish() instead.`)}else t instanceof he||(t=new he(this,t),this.activeEvents.push(t));let i,s,l;Array.isArray(this.listeners)||(this.listeners=[]),this.debug&&console.log(`w2base: trigger "${t.type}:${t.phase}"`,t);for(let n=this.listeners.length-1;n>=0;n--){let a=this.listeners[n];if(a!=null&&(a.edata.type===t.type||a.edata.type==="*")&&(a.edata.target===t.target||a.edata.target==null)&&(a.edata.execute===t.phase||a.edata.execute==="*"||a.edata.phase==="*")&&(Object.keys(a.edata).forEach(h=>{t[h]==null&&a.edata[h]!=null&&(t[h]=a.edata[h])}),i=[],l=new RegExp(/\((.*?)\)/).exec(String(a.handler).split("=>")[0]),l&&(i=l[1].split(/\s*,\s*/)),i.length===2?(a.handler.call(this,t.target,t),this.debug&&console.log(" - call (old)",a.handler)):(a.handler.call(this,t),this.debug&&console.log(" - call",a.handler)),t.isStopped===!0||t.stop===!0))return t}let r="on"+t.type.substr(0,1).toUpperCase()+t.type.substr(1);if(t.phase==="before"&&typeof this[r]=="function"&&(s=this[r],i=[],l=new RegExp(/\((.*?)\)/).exec(String(s).split("=>")[0]),l&&(i=l[1].split(/\s*,\s*/)),i.length===2?(s.call(this,t.target,t),this.debug&&console.log(" - call: on[Event] (old)",s)):(s.call(this,t),this.debug&&console.log(" - call: on[Event]",s)),t.isStopped===!0||t.stop===!0)||t.object!=null&&t.phase==="before"&&typeof t.object[r]=="function"&&(s=t.object[r],i=[],l=new RegExp(/\((.*?)\)/).exec(String(s).split("=>")[0]),l&&(i=l[1].split(/\s*,\s*/)),i.length===2?(s.call(this,t.target,t),this.debug&&console.log(" - call: edata.object (old)",s)):(s.call(this,t),this.debug&&console.log(" - call: edata.object",s)),t.isStopped===!0||t.stop===!0))return t;if(t.phase==="after"){typeof t.onComplete=="function"&&t.onComplete.call(this,t);for(let a=0;a<t.listeners.length;a++)typeof t.listeners[a]=="function"&&(t.listeners[a].call(this,t),this.debug&&console.log(" - call: done",s));t._resolve(t),this.debug&&console.log(`w2base: trigger "${t.type}:${t.phase}"`,t);let n=this.activeEvents.indexOf(t);n!==-1&&this.activeEvents.splice(n,1)}return t}render(e){}unmount(){let e=this.trigger("unmount",{target:this.name});if(e.isCancelled)return;let t=[];this.box instanceof HTMLElement&&this.box.classList.forEach(i=>{i.startsWith("w2ui-")&&t.push(i)}),o(this.box).off().removeClass(t).removeAttr("name").html(""),this.box=null,e.finish()}},be={locale:"en-US",dateFormat:"m/d/yyyy",timeFormat:"hh:mi pm",datetimeFormat:"m/d/yyyy|hh:mi pm",currencyPrefix:"$",currencySuffix:"",currencyPrecision:2,groupSymbol:",",decimalSymbol:".",shortmonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],fullmonths:["January","February","March","April","May","June","July","August","September","October","November","December"],shortdays:["M","T","W","T","F","S","S"],fulldays:["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],weekStarts:"S",phrases:{"${count} letters or more...":"---","Add new record":"---","Add New":"---","Advanced Search":"---",after:"---","AJAX error. See console for more details.":"---","All Fields":"---",All:"---",Any:"---","Are you sure you want to delete ${count} ${records}?":"---","Attach files by dragging and dropping or Click to Select":"---",before:"---","begins with":"---",begins:"---",between:"---",buffered:"---",Cancel:"---",Close:"---",Column:"---",Confirmation:"---",contains:"---",Copied:"---","Copy to clipboard":"---","Current Date & Time":"---","Delete selected records":"---",Delete:"---",'Do you want to delete search item "${item}"?':"---","Edit selected record":"---",Edit:"---","Empty list":"---","ends with":"---",ends:"---","Field should be at least ${count} characters.":"---",Hide:"---",in:"---","is not":"---",is:"---","less than":"---","Line #":"---","Load ${count} more...":"---","Loading...":"---","Maximum number of files is ${count}":"---","Maximum total size is ${count}":"---",Modified:"---","more than":"---","Multiple Fields":"---",Name:"---","No items found":"---","No matches":"---",No:"---",none:"---","Not a float":"---","Not a hex number":"---","Not a valid date":"---","Not a valid email":"---","Not alpha-numeric":"---","Not an integer":"---","Not in money format":"---","not in":"---",Notification:"---",of:"---",Ok:"---",Opacity:"---","Record ID":"---",record:"---",records:"---","Refreshing...":"---","Reload data in the list":"---",Remove:"---","Remove This Field":"---","Request aborted.":"---","Required field":"---",Reset:"---","Restore Default State":"---","Returned data is not in valid JSON format.":"---","Save changed records":"---","Save Grid State":"---",Save:"---","Saved Searches":"---","Saving...":"---","Search took ${count} seconds":"---",Search:"---","Select Hour":"---","Select Minute":"---",selected:"---","Server Response ${count} seconds":"---","Show/hide columns":"---",Show:"---",Size:"---",Skip:"---","Sorting took ${count} seconds":"---","Type to search...":"---",Type:"---",Yes:"---",Yesterday:"---","Your remote data source record count has changed, reloading from the first record.":"---"}},ne=class I{static version=.8;constructor(e,t){this.context=t??document;let i=[];if(Array.isArray(e))i=e;else if(e instanceof Node||e instanceof Window)i=[e];else if(e instanceof I)i=e.nodes;else if(typeof e=="string"){if(typeof this.context.querySelector!="function")throw new Error("Invalid context");i=Array.from(this.context.querySelectorAll(e))}else if(e==null)i=[];else{let s=Array.from(e??[]);if(typeof e=="object"&&Array.isArray(s))i=s;else throw new Error(`Invalid selector "${e}"`)}this.nodes=i,this.length=i.length,this.each((s,l)=>{this[l]=s})}static _fragment(e){let t=document.createElement("template");return t.innerHTML=e,t.content.childNodes.forEach(i=>{let s=I._scriptConvert(i);s!=i&&t.content.replaceChild(s,i)}),t.content}static _scriptConvert(e){let t=i=>{let l=i.ownerDocument.createElement("script");l.text=i.text;let r=i.attributes;for(let n=0;n<r.length;n++)l.setAttribute(r[n].name,r[n].value);return l};return e.tagName=="SCRIPT"&&(e=t(e)),e.querySelectorAll&&e.querySelectorAll("script").forEach(i=>{i.parentNode.replaceChild(t(i),i)}),e}static _fixProp(e){let t={cellpadding:"cellPadding",cellspacing:"cellSpacing",class:"className",colspan:"colSpan",contenteditable:"contentEditable",for:"htmlFor",frameborder:"frameBorder",maxlength:"maxLength",readonly:"readOnly",rowspan:"rowSpan",tabindex:"tabIndex",usemap:"useMap"};return t[e]?t[e]:e}_insert(e,t){let i=[],s=this.length;if(s<1)return;let l=this;if(typeof t=="string")this.each(r=>{let n=I._fragment(t);i.push(...n.childNodes),r[e](n)});else if(t instanceof I){let r=s==1;t.each(n=>{this.each(a=>{let h=r?n:n.cloneNode(!0);i.push(h),a[e](h),I._scriptConvert(h)})}),r||t.remove()}else if(t instanceof Node)this.each(r=>{let n=s===1?t:I._fragment(t.outerHTML);i.push(...s===1?[t]:n.childNodes),r[e](n)}),s>1&&t.remove();else throw new Error(`Incorrect argument for "${e}(html)". It expects one string argument.`);return e=="replaceWith"&&(l=new I(i,this.context)),l}_save(e,t,i){e._mQuery=e._mQuery??{},Array.isArray(i)?(e._mQuery[t]=e._mQuery[t]??[],e._mQuery[t].push(...i)):i!=null?e._mQuery[t]=i:delete e._mQuery[t]}get(e){e<0&&(e=this.length+e);let t=this[e];return t||(e!=null?null:this.nodes)}eq(e){e<0&&(e=this.length+e);let t=[this[e]];return t[0]==null&&(t=[]),new I(t,this.context)}then(e){let t=e(this);return t??this}find(e){let t=[];return this.each(i=>{let s=Array.from(i.querySelectorAll(e));s.length>0&&t.push(...s)}),new I(t,this.context)}filter(e){let t=[];return this.each(i=>{(i===e||typeof e=="string"&&i.matches&&i.matches(e)||typeof e=="function"&&e(i))&&t.push(i)}),new I(t,this.context)}next(){let e=[];return this.each(t=>{let i=t.nextElementSibling;i&&e.push(i)}),new I(e,this.context)}prev(){let e=[];return this.each(t=>{let i=t.previousElementSibling;i&&e.push(i)}),new I(e,this.context)}shadow(e){let t=[];this.each(s=>{s.shadowRoot&&t.push(s.shadowRoot)});let i=new I(t,this.context);return e?i.find(e):i}closest(e){let t=[];return this.each(i=>{let s=i.closest(e);s&&t.push(s)}),new I(t,this.context)}host(e){let t=[],i=l=>l.parentNode?i(l.parentNode):l,s=l=>{let r=i(l);t.push(r.host?r.host:r),r.host&&e&&s(r.host)};return this.each(l=>{s(l)}),new I(t,this.context)}parent(e){return this.parents(e,!0)}parents(e,t){let i=[],s=r=>{if(i.indexOf(r)==-1&&i.push(r),!t&&r.parentNode)return s(r.parentNode)};this.each(r=>{r.parentNode&&s(r.parentNode)});let l=new I(i,this.context);return e?l.filter(e):l}add(e){let t=e instanceof I?e.nodes:Array.isArray(e)?e:[e];return new I(this.nodes.concat(t),this.context)}each(e){return this.nodes.forEach((t,i)=>{e(t,i,this)}),this}append(e){return this._insert("append",e)}prepend(e){return this._insert("prepend",e)}after(e){return this._insert("after",e)}before(e){return this._insert("before",e)}replace(e){return this._insert("replaceWith",e)}remove(){return this.each(e=>{e.remove()}),this}css(e,t){let i=e,s=arguments.length;if(s===0||s===1&&typeof e=="string")if(this[0]){let l=this[0].style;if(typeof e=="string"){let r=l.getPropertyPriority(e);return l.getPropertyValue(e)+(r?"!"+r:"")}else return Object.fromEntries(this[0].style.cssText.split(";").filter(r=>!!r).map(r=>r.split(":").map(n=>n.trim())))}else return;else return typeof e!="object"&&(i={},i[e]=t),this.each((l,r)=>{Object.keys(i).forEach(n=>{let a=String(i[n]).toLowerCase().includes("!important")?"important":"";l.style.setProperty(n,String(i[n]).replace(/\!important/i,""),a)})}),this}addClass(e){return this.toggleClass(e,!0),this}removeClass(e){return this.toggleClass(e,!1),this}toggleClass(e,t){return typeof e=="string"&&(e=e.split(/[,\s]+/)),this.each(i=>{let s=e;s==null&&t===!1&&(s=Array.from(i.classList)),s.forEach(l=>{if(l!==""){let r="toggle";t!=null&&(r=t?"add":"remove"),i.classList[r](l)}})}),this}hasClass(e){if(typeof e=="string"&&(e=e.split(/[,\s]+/)),e==null&&this.length>0)return Array.from(this[0].classList);let t=!1;return this.each(i=>{t=t||e.every(s=>Array.from(i.classList??[]).includes(s))}),t}on(e,t,i){typeof t=="function"&&(i=t,t=void 0);let s;return t?.delegate&&(s=t.delegate,delete t.delegate),e=e.split(/[,\s]+/),e.forEach(l=>{let[r,n]=String(l).toLowerCase().split(".");if(s){let a=i;i=h=>{let d=o(h.target).parents(s);d.length>0?h.delegate=d[0]:h.delegate=h.target,(h.target.matches(s)||d.length>0)&&a(h)}}this.each(a=>{this._save(a,"events",[{event:r,scope:n,callback:i,options:t}]),a.addEventListener(r,i,t)})}),this}off(e,t,i){return typeof t=="function"&&(i=t,t=void 0),e=(e??"").split(/[,\s]+/),e.forEach(s=>{let[l,r]=String(s).toLowerCase().split(".");this.each(n=>{if(Array.isArray(n._mQuery?.events))for(let a=n._mQuery.events.length-1;a>=0;a--){let h=n._mQuery.events[a];r==null||r===""?(h.event==l||l==="")&&(h.callback==i||i==null)&&(n.removeEventListener(h.event,h.callback,h.options),n._mQuery.events.splice(a,1)):(h.event==l||l==="")&&h.scope==r&&(n.removeEventListener(h.event,h.callback,h.options),n._mQuery.events.splice(a,1))}})}),this}trigger(e,t){let i,s=["click","dblclick","mousedown","mouseup","mousemove"],l=["keydown","keyup","keypress"];return e instanceof Event||e instanceof CustomEvent?i=e:s.includes(e)?i=new MouseEvent(e,t):l.includes(e)?i=new KeyboardEvent(e,t):i=new Event(e,t),this.each(r=>{r.dispatchEvent(i)}),this}attr(e,t){if(t===void 0&&typeof e=="string")return this[0]?this[0].getAttribute(e):void 0;{let i={};return typeof e=="object"?i=e:i[e]=t,this.each(s=>{Object.entries(i).forEach(([l,r])=>{s.setAttribute(l,r)})}),this}}removeAttr(){return this.each(e=>{Array.from(arguments).forEach(t=>{e.removeAttribute(t)})}),this}prop(e,t){if(t===void 0&&typeof e=="string")return this[0]?this[0][e]:void 0;{let i={};return typeof e=="object"?i=e:i[e]=t,this.each(s=>{Object.entries(i).forEach(([l,r])=>{let n=I._fixProp(l);s[n]=r,n=="innerHTML"&&I._scriptConvert(s)})}),this}}removeProp(){return this.each(e=>{Array.from(arguments).forEach(t=>{delete e[I._fixProp(t)]})}),this}data(e,t){if(e instanceof Object){Object.entries(e).forEach(i=>{this.data(i[0],i[1])});return}if(e&&e.indexOf("-")!=-1&&console.error(`Key "${e}" contains "-" (dash). Dashes are not allowed in property names. Use camelCase instead.`),arguments.length<2)if(this[0]){let i=Object.assign({},this[0].dataset);return Object.keys(i).forEach(s=>{if(i[s].startsWith("[")||i[s].startsWith("{"))try{i[s]=JSON.parse(i[s])}catch{}}),e?i[e]:i}else return;else return this.each(i=>{t!=null?i.dataset[e]=t instanceof Object?JSON.stringify(t):t:delete i.dataset[e]}),this}removeData(e){return typeof e=="string"&&(e=e.split(/[,\s]+/)),this.each(t=>{e.forEach(i=>{delete t.dataset[i]})}),this}show(){return this.toggle(!0)}hide(){return this.toggle(!1)}toggle(e){return this.each(t=>{let i=t.style.display,s=getComputedStyle(t).display,l=i=="none"||s=="none";if(l&&(e==null||e===!0)){let r=t instanceof HTMLTableRowElement?"table-row":t instanceof HTMLTableCellElement?"table-cell":"block";t.style.display=t._mQuery?.prevDisplay??(i==s&&s!="none"?"":r),this._save(t,"prevDisplay",null)}!l&&(e==null||e===!1)&&(s!="none"&&this._save(t,"prevDisplay",s),t.style.setProperty("display","none"))})}empty(){return this.html("")}html(e){return e instanceof HTMLElement?this.empty().append(e):this.prop("innerHTML",e)}text(e){return this.prop("textContent",e)}val(e){return this.prop("value",e)}change(){return this.trigger("change")}click(){return this.trigger("click")}},o=function(I,e){if(typeof I=="function")document.readyState=="complete"?I():window.addEventListener("load",I);else return new ne(I,e)};o.html=I=>{let e=ne._fragment(I);return o(e.children,e)};o.version=ne.version;var N={},ye=class{constructor(){this.version="2.0.x",this.tmp={},this.settings=this.extend({},{dataType:"HTTPJSON",dateStartYear:1950,dateEndYear:2030,macButtonOrder:!1,warnNoPhrase:!1},be,{phrases:null}),this.i18nCompare=Intl.Collator().compare,this.hasLocalStorage=e(),this.isMac=/Mac/i.test(navigator.platform),this.isMobile=/(iphone|ipod|ipad|mobile|android)/i.test(navigator.userAgent),this.isIOS=/(iphone|ipod|ipad)/i.test(navigator.platform),this.isAndroid=/(android)/i.test(navigator.userAgent),this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.isFirefox=/(Firefox)/i.test(navigator.userAgent),this.formatters={number(t,i){return parseInt(i)>20&&(i=20),parseInt(i)<0&&(i=0),t==null||t===""?"":u.formatNumber(parseFloat(t),i,!0)},float(t,i){return u.formatters.number(t,i)},int(t,i){return u.formatters.number(t,0)},money(t,i){if(t==null||t==="")return"";let s=u.formatNumber(Number(t),u.settings.currencyPrecision);return(u.settings.currencyPrefix||"")+s+(u.settings.currencySuffix||"")},currency(t,i){return u.formatters.money(t,i)},percent(t,i){return t==null||t===""?"":u.formatNumber(t,i||1)+"%"},size(t,i){return t==null||t===""?"":u.formatSize(parseInt(t))},date(t,i){if(i===""&&(i=u.settings.dateFormat),t==null||t===0||t==="")return"";let s=u.isDateTime(t,i,!0);return s===!1&&(s=u.isDate(t,i,!0)),'<span title="'+s+'">'+u.formatDate(s,i)+"</span>"},datetime(t,i){if(i===""&&(i=u.settings.datetimeFormat),t==null||t===0||t==="")return"";let s=u.isDateTime(t,i,!0);return s===!1&&(s=u.isDate(t,i,!0)),'<span title="'+s+'">'+u.formatDateTime(s,i)+"</span>"},time(t,i){if(i===""&&(i=u.settings.timeFormat),i==="h12"&&(i="hh:mi pm"),i==="h24"&&(i="h24:mi"),t==null||t===0||t==="")return"";let s=u.isDateTime(t,i,!0);return s===!1&&(s=u.isDate(t,i,!0)),'<span title="'+s+'">'+u.formatTime(t,i)+"</span>"},timestamp(t,i){if(i===""&&(i=u.settings.datetimeFormat),t==null||t===0||t==="")return"";let s=u.isDateTime(t,i,!0);return s===!1&&(s=u.isDate(t,i,!0)),s.toString?s.toString():""},gmt(t,i){if(i===""&&(i=u.settings.datetimeFormat),t==null||t===0||t==="")return"";let s=u.isDateTime(t,i,!0);return s===!1&&(s=u.isDate(t,i,!0)),s.toUTCString?s.toUTCString():""},age(t,i){if(t==null||t===0||t==="")return"";let s=u.isDateTime(t,null,!0);return s===!1&&(s=u.isDate(t,null,!0)),'<span title="'+s+'">'+u.age(t)+(i?" "+i:"")+"</span>"},interval(t,i){return t==null||t===0||t===""?"":u.interval(t)+(i?" "+i:"")},toggle(t,i){return t?u.lang("Yes"):""},password(t,i){let s="";for(let l=0;l<t.length;l++)s+="*";return s}};return;function e(){let t="w2ui_test";try{return localStorage.setItem(t,t),localStorage.removeItem(t),!0}catch{return!1}}}isBin(e){return/^[0-1]+$/.test(e)}isInt(e){return/^[-+]?[0-9]+$/.test(e)}isFloat(e){return typeof e=="string"&&(e=e.replace(this.settings.groupSymbol,"").replace(this.settings.decimalSymbol,".")),(typeof e=="number"||typeof e=="string"&&e!=="")&&!isNaN(Number(e))}isMoney(e){if(typeof e=="object"||e==="")return!1;if(this.isFloat(e))return!0;let t=this.settings,i=new RegExp("^"+(t.currencyPrefix?"\\"+t.currencyPrefix+"?":"")+"[-+]?"+(t.currencyPrefix?"\\"+t.currencyPrefix+"?":"")+"[0-9]*[\\"+t.decimalSymbol+"]?[0-9]+"+(t.currencySuffix?"\\"+t.currencySuffix+"?":"")+"$","i");return typeof e=="string"&&(e=e.replace(new RegExp(t.groupSymbol,"g"),"")),i.test(e)}isHex(e){return/^(0x)?[0-9a-fA-F]+$/.test(e)}isAlphaNumeric(e){return/^[a-zA-Z0-9_-]+$/.test(e)}isEmail(e){return/^[a-zA-Z0-9._%\-+]+@[а-яА-Яa-zA-Z0-9.-]+\.[а-яА-Яa-zA-Z]+$/.test(e)}isIpAddress(e){return new RegExp("^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$").test(e)}isDate(e,t,i){if(!e)return!1;let s="Invalid Date",l,r,n;if(t==null&&(t=this.settings.dateFormat),typeof e.getFullYear=="function")n=e.getFullYear(),l=e.getMonth()+1,r=e.getDate();else if(parseInt(e)==e&&parseInt(e)>0)e=new Date(parseInt(e)),n=e.getFullYear(),l=e.getMonth()+1,r=e.getDate();else{if(e=String(e),new RegExp("mon","ig").test(t)){t=t.replace(/month/ig,"m").replace(/mon/ig,"m").replace(/dd/ig,"d").replace(/[, ]/ig,"/").replace(/\/\//g,"/").toLowerCase(),e=e.replace(/[, ]/ig,"/").replace(/\/\//g,"/").toLowerCase();for(let d=0,g=this.settings.fullmonths.length;d<g;d++){let c=this.settings.fullmonths[d];e=e.replace(new RegExp(c,"ig"),parseInt(d)+1).replace(new RegExp(c.substr(0,3),"ig"),parseInt(d)+1)}}let a=e.replace(/-/g,"/").replace(/\./g,"/").toLowerCase().split("/"),h=t.replace(/-/g,"/").replace(/\./g,"/").toLowerCase();h==="mm/dd/yyyy"&&(l=a[0],r=a[1],n=a[2]),h==="m/d/yyyy"&&(l=a[0],r=a[1],n=a[2]),h==="dd/mm/yyyy"&&(l=a[1],r=a[0],n=a[2]),h==="d/m/yyyy"&&(l=a[1],r=a[0],n=a[2]),h==="yyyy/dd/mm"&&(l=a[2],r=a[1],n=a[0]),h==="yyyy/d/m"&&(l=a[2],r=a[1],n=a[0]),h==="yyyy/mm/dd"&&(l=a[1],r=a[2],n=a[0]),h==="yyyy/m/d"&&(l=a[1],r=a[2],n=a[0]),h==="mm/dd/yy"&&(l=a[0],r=a[1],n=a[2]),h==="m/d/yy"&&(l=a[0],r=a[1],n=parseInt(a[2])+1900),h==="dd/mm/yy"&&(l=a[1],r=a[0],n=parseInt(a[2])+1900),h==="d/m/yy"&&(l=a[1],r=a[0],n=parseInt(a[2])+1900),h==="yy/dd/mm"&&(l=a[2],r=a[1],n=parseInt(a[0])+1900),h==="yy/d/m"&&(l=a[2],r=a[1],n=parseInt(a[0])+1900),h==="yy/mm/dd"&&(l=a[1],r=a[2],n=parseInt(a[0])+1900),h==="yy/m/d"&&(l=a[1],r=a[2],n=parseInt(a[0])+1900)}return!this.isInt(n)||!this.isInt(l)||!this.isInt(r)||(n=+n,l=+l,r=+r,s=new Date(n,l-1,r),s.setFullYear(n),l==null)||String(s)==="Invalid Date"||s.getMonth()+1!==l||s.getDate()!==r||s.getFullYear()!==n?!1:i===!0?s:!0}isTime(e,t){if(e==null)return!1;let i,s,l;e=String(e),e=e.toUpperCase(),s=e.indexOf("AM")>=0,l=e.indexOf("PM")>=0;let r=l||s;r?i=12:i=24,e=e.replace("AM","").replace("PM","").trim();let n=e.split(":"),a=parseInt(n[0]||0),h=parseInt(n[1]||0),d=parseInt(n[2]||0);return(!r||n.length!==1)&&n.length!==2&&n.length!==3||n[0]===""||a<0||a>i||!this.isInt(n[0])||n[0].length>2||n.length>1&&(n[1]===""||h<0||h>59||!this.isInt(n[1])||n[1].length!==2)||n.length>2&&(n[2]===""||d<0||d>59||!this.isInt(n[2])||n[2].length!==2)||!r&&i===a&&(h!==0||d!==0)||r&&n.length===1&&a===0?!1:t===!0?(l&&a!==12&&(a+=12),s&&a===12&&(a+=12),{hours:a,minutes:h,seconds:d}):!0}isDateTime(e,t,i){if(typeof e.getFullYear=="function")return i!==!0?!0:e;let s=parseInt(e);if(s===e)return s<0?!1:i!==!0?!0:new Date(s);let l=String(e).indexOf(" ");if(l<0)return String(e).indexOf("T")<0||String(new Date(e))=="Invalid Date"?!1:i!==!0?!0:new Date(e);{t==null&&(t=this.settings.datetimeFormat);let r=t.split("|"),n=[e.substr(0,l),e.substr(l).trim()];r[0]=r[0].trim(),r[1]&&(r[1]=r[1].trim());let a=this.isDate(n[0],r[0],!0),h=this.isTime(n[1],!0);return a!==!1&&h!==!1?i!==!0?!0:(a.setHours(h.hours),a.setMinutes(h.minutes),a.setSeconds(h.seconds),a):!1}}age(e){let t;if(e===""||e==null||(typeof e.getFullYear=="function"?t=e:parseInt(e)==e&&parseInt(e)>0?t=new Date(parseInt(e)):t=new Date(e),String(t)==="Invalid Date"))return"";let s=(new Date().getTime()-t.getTime())/1e3,l="",r="";return s<0?(l=0,r="sec"):s<60?(l=Math.floor(s),r="sec",s<0&&(l=0,r="sec")):s<60*60?(l=Math.floor(s/60),r="min"):s<24*60*60?(l=Math.floor(s/60/60),r="hour"):s<30*24*60*60?(l=Math.floor(s/24/60/60),r="day"):s<365*24*60*60?(l=Math.floor(s/30/24/60/60*10)/10,r="month"):s<365*4*24*60*60?(l=Math.floor(s/365/24/60/60*10)/10,r="year"):s>=365*4*24*60*60&&(l=Math.floor(s/365.25/24/60/60*10)/10,r="year"),l+" "+r+(l>1?"s":"")}interval(e){let t="";return e<100?t="< 0.01 sec":e<1e3?t=Math.floor(e/10)/100+" sec":e<1e4?t=Math.floor(e/100)/10+" sec":e<6e4?t=Math.floor(e/1e3)+" secs":e<36e5?t=Math.floor(e/6e4)+" mins":e<864e5?t=Math.floor(e/36e5*10)/10+" hours":e<2628e6?t=Math.floor(e/864e5*10)/10+" days":e<31536e6?t=Math.floor(e/2628e6*10)/10+" months":t=Math.floor(e/31536e5)/10+" years",t}date(e){if(e===""||e==null||typeof e=="object"&&!e.getMonth)return"";let t=new Date(e);if(this.isInt(e)&&(t=new Date(Number(e))),String(t)==="Invalid Date")return"";let i=this.settings.shortmonths,s=new Date,l=new Date;l.setTime(l.getTime()-864e5);let r=i[t.getMonth()]+" "+t.getDate()+", "+t.getFullYear(),n=i[s.getMonth()]+" "+s.getDate()+", "+s.getFullYear(),a=i[l.getMonth()]+" "+l.getDate()+", "+l.getFullYear(),h=t.getHours()-(t.getHours()>12?12:0)+":"+(t.getMinutes()<10?"0":"")+t.getMinutes()+" "+(t.getHours()>=12?"pm":"am"),d=t.getHours()-(t.getHours()>12?12:0)+":"+(t.getMinutes()<10?"0":"")+t.getMinutes()+":"+(t.getSeconds()<10?"0":"")+t.getSeconds()+" "+(t.getHours()>=12?"pm":"am"),g=r;return r===n&&(g=h),r===a&&(g=this.lang("Yesterday")),'<span title="'+r+" "+d+'">'+g+"</span>"}formatSize(e){if(!this.isFloat(e)||e==="")return"";if(e=parseFloat(e),e===0)return 0;let t=["Bt","KB","MB","GB","TB","PB","EB","ZB"],i=parseInt(Math.floor(Math.log(e)/Math.log(1024)));return(Math.floor(e/Math.pow(1024,i)*10)/10).toFixed(i===0?0:1)+" "+(t[i]||"??")}formatNumber(e,t,i){if(e==null||e===""||typeof e=="object")return"";let s={minimumFractionDigits:parseInt(t),maximumFractionDigits:parseInt(t),useGrouping:!!i};return(t==null||t<0)&&(s.minimumFractionDigits=0,s.maximumFractionDigits=20),parseFloat(e).toLocaleString(this.settings.locale,s)}formatDate(e,t){if(t||(t=this.settings.dateFormat),e===""||e==null||typeof e=="object"&&!e.getMonth)return"";let i=new Date(e);if(this.isInt(e)&&(i=new Date(Number(e))),String(i)==="Invalid Date")return"";let s=i.getFullYear(),l=i.getMonth(),r=i.getDate();return t.toLowerCase().replace("month",this.settings.fullmonths[l]).replace("mon",this.settings.shortmonths[l]).replace(/yyyy/g,("000"+s).slice(-4)).replace(/yyy/g,("000"+s).slice(-4)).replace(/yy/g,("0"+s).slice(-2)).replace(/(^|[^a-z$])y/g,"$1"+s).replace(/mm/g,("0"+(l+1)).slice(-2)).replace(/dd/g,("0"+r).slice(-2)).replace(/th/g,r==1?"st":"th").replace(/th/g,r==2?"nd":"th").replace(/th/g,r==3?"rd":"th").replace(/(^|[^a-z$])m/g,"$1"+(l+1)).replace(/(^|[^a-z$])d/g,"$1"+r)}formatTime(e,t){if(t||(t=this.settings.timeFormat),e===""||e==null||typeof e=="object"&&!e.getMonth)return"";let i=new Date(e);if(this.isInt(e)&&(i=new Date(Number(e))),this.isTime(e)){let h=this.isTime(e,!0);i=new Date,i.setHours(h.hours),i.setMinutes(h.minutes)}if(String(i)==="Invalid Date")return"";t=="h12"&&(t="hh:mi pm");let s="am",l=i.getHours(),r=i.getHours(),n=i.getMinutes(),a=i.getSeconds();return n<10&&(n="0"+n),a<10&&(a="0"+a),(t.indexOf("am")!==-1||t.indexOf("pm")!==-1)&&(l>=12&&(s="pm"),l>12&&(l=l-12),l===0&&(l=12)),t.toLowerCase().replace("am",s).replace("pm",s).replace("hhh",l<10?"0"+l:l).replace("hh24",r<10?"0"+r:r).replace("h24",r).replace("hh",l).replace("mm",n).replace("mi",n).replace("ss",a).replace(/(^|[^a-z$])h/g,"$1"+l).replace(/(^|[^a-z$])m/g,"$1"+n).replace(/(^|[^a-z$])s/g,"$1"+a)}formatDateTime(e,t){let i;return e===""||e==null||typeof e=="object"&&!e.getMonth?"":(typeof t!="string"?i=[this.settings.dateFormat,this.settings.timeFormat]:(i=t.split("|"),i[0]=i[0].trim(),i[1]=i.length>1?i[1].trim():this.settings.timeFormat),i[1]==="h12"&&(i[1]="h:m pm"),i[1]==="h24"&&(i[1]="h24:m"),this.formatDate(e,i[0])+" "+this.formatTime(e,i[1]))}stripSpaces(e){if(e==null)return e;switch(typeof e){case"number":break;case"string":e=String(e).replace(/(?:\r\n|\r|\n)/g," ").replace(/\s\s+/g," ").trim();break;case"object":Array.isArray(e)?(e=this.extend([],e),e.forEach((t,i)=>{e[i]=this.stripSpaces(t)})):(e=this.extend({},e),Object.keys(e).forEach(t=>{e[t]=this.stripSpaces(e[t])}));break}return e}stripTags(e){if(e==null)return e;switch(typeof e){case"number":break;case"string":e=String(e).replace(/<(?:[^>=]|='[^']*'|="[^"]*"|=[^'"][^\s>]*)*>/ig,"");break;case"object":Array.isArray(e)?(e=this.extend([],e),e.forEach((t,i)=>{e[i]=this.stripTags(t)})):(e=this.extend({},e),Object.keys(e).forEach(t=>{e[t]=this.stripTags(e[t])}));break}return e}encodeTags(e){if(e==null)return e;switch(typeof e){case"number":break;case"string":e=String(e).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;");break;case"object":Array.isArray(e)?(e=this.extend([],e),e.forEach((t,i)=>{e[i]=this.encodeTags(t)})):(e=this.extend({},e),Object.keys(e).forEach(t=>{e[t]=this.encodeTags(e[t])}));break}return e}decodeTags(e){if(e==null)return e;switch(typeof e){case"number":break;case"string":e=String(e).replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&quot;/g,'"').replace(/&amp;/g,"&");break;case"object":Array.isArray(e)?(e=this.extend([],e),e.forEach((t,i)=>{e[i]=this.decodeTags(t)})):(e=this.extend({},e),Object.keys(e).forEach(t=>{e[t]=this.decodeTags(e[t])}));break}return e}escapeId(e){if(e===""||e==null)return"";let t=/([\0-\x1f\x7f]|^-?\d)|^-$|[^\0-\x1f\x7f-\uFFFF\w-]/g;return(e+"").replace(t,(i,s)=>s?i==="\0"?"\uFFFD":i.slice(0,-1)+"\\"+i.charCodeAt(i.length-1).toString(16)+" ":"\\"+i)}unescapeId(e){if(e===""||e==null)return"";let t=/\\[\da-fA-F]{1,6}[\x20\t\r\n\f]?|\\([^\r\n\f])/g;return e.replace(t,(i,s)=>{let l="0x"+i.slice(1)-65536;return s||(l<0?String.fromCharCode(l+65536):String.fromCharCode(l>>10|55296,l&1023|56320))})}base64encode(e){return btoa(e)}base64decode(e){return atob(e)}async sha256(e){let t=new TextEncoder().encode(e);return crypto.subtle.digest("SHA-256",t).then(i=>Array.from(new Uint8Array(i)).map(l=>l.toString(16).padStart(2,"0")).join(""))}transition(e,t,i,s){return new Promise((l,r)=>{let n=getComputedStyle(e),a=parseInt(n.width),h=parseInt(n.height),d=.5;if(!e||!t){console.log("ERROR: Cannot do transition when one of the divs is null");return}switch(e.parentNode.style.cssText+="perspective: 900px; overflow: hidden;",e.style.cssText+="; position: absolute; z-index: 1019; backface-visibility: hidden",t.style.cssText+="; position: absolute; z-index: 1020; backface-visibility: hidden",i){case"slide-left":e.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",t.style.cssText+="overflow: hidden; transform: translate3d("+a+"px, 0, 0)",o(t).show(),setTimeout(()=>{t.style.cssText+="transition: "+d+"s; transform: translate3d(0, 0, 0)",e.style.cssText+="transition: "+d+"s; transform: translate3d(-"+a+"px, 0, 0)"},1);break;case"slide-right":e.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",t.style.cssText+="overflow: hidden; transform: translate3d(-"+a+"px, 0, 0)",o(t).show(),setTimeout(()=>{t.style.cssText+="transition: "+d+"s; transform: translate3d(0px, 0, 0)",e.style.cssText+="transition: "+d+"s; transform: translate3d("+a+"px, 0, 0)"},1);break;case"slide-down":e.style.cssText+="overflow: hidden; z-index: 1; transform: translate3d(0, 0, 0)",t.style.cssText+="overflow: hidden; z-index: 0; transform: translate3d(0, 0, 0)",o(t).show(),setTimeout(()=>{t.style.cssText+="transition: "+d+"s; transform: translate3d(0, 0, 0)",e.style.cssText+="transition: "+d+"s; transform: translate3d(0, "+h+"px, 0)"},1);break;case"slide-up":e.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",t.style.cssText+="overflow: hidden; transform: translate3d(0, "+h+"px, 0)",o(t).show(),setTimeout(()=>{t.style.cssText+="transition: "+d+"s; transform: translate3d(0, 0, 0)",e.style.cssText+="transition: "+d+"s; transform: translate3d(0, 0, 0)"},1);break;case"flip-left":e.style.cssText+="overflow: hidden; transform: rotateY(0deg)",t.style.cssText+="overflow: hidden; transform: rotateY(-180deg)",o(t).show(),setTimeout(()=>{t.style.cssText+="transition: "+d+"s; transform: rotateY(0deg)",e.style.cssText+="transition: "+d+"s; transform: rotateY(180deg)"},1);break;case"flip-right":e.style.cssText+="overflow: hidden; transform: rotateY(0deg)",t.style.cssText+="overflow: hidden; transform: rotateY(180deg)",o(t).show(),setTimeout(()=>{t.style.cssText+="transition: "+d+"s; transform: rotateY(0deg)",e.style.cssText+="transition: "+d+"s; transform: rotateY(-180deg)"},1);break;case"flip-down":e.style.cssText+="overflow: hidden; transform: rotateX(0deg)",t.style.cssText+="overflow: hidden; transform: rotateX(180deg)",o(t).show(),setTimeout(()=>{t.style.cssText+="transition: "+d+"s; transform: rotateX(0deg)",e.style.cssText+="transition: "+d+"s; transform: rotateX(-180deg)"},1);break;case"flip-up":e.style.cssText+="overflow: hidden; transform: rotateX(0deg)",t.style.cssText+="overflow: hidden; transform: rotateX(-180deg)",o(t).show(),setTimeout(()=>{t.style.cssText+="transition: "+d+"s; transform: rotateX(0deg)",e.style.cssText+="transition: "+d+"s; transform: rotateX(180deg)"},1);break;case"pop-in":e.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",t.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0); transform: scale(.8); opacity: 0;",o(t).show(),setTimeout(()=>{t.style.cssText+="transition: "+d+"s; transform: scale(1); opacity: 1;",e.style.cssText+="transition: "+d+"s;"},1);break;case"pop-out":e.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0); transform: scale(1); opacity: 1;",t.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0); opacity: 0;",o(t).show(),setTimeout(()=>{t.style.cssText+="transition: "+d+"s; opacity: 1;",e.style.cssText+="transition: "+d+"s; transform: scale(1.7); opacity: 0;"},1);break;default:e.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",t.style.cssText+="overflow: hidden; translate3d(0, 0, 0); opacity: 0;",o(t).show(),setTimeout(()=>{t.style.cssText+="transition: "+d+"s; opacity: 1;",e.style.cssText+="transition: "+d+"s"},1);break}setTimeout(()=>{i==="slide-down"&&(o(e).css("z-index","1019"),o(t).css("z-index","1020")),t&&o(t).css({opacity:"1"}).css({transition:"",transform:""}),e&&o(e).css({opacity:"1"}).css({transition:"",transform:""}),typeof s=="function"&&s(),l()},d*1e3)})}lock(e,t={}){if(e==null)return;typeof t=="string"&&(t={msg:t}),arguments[2]&&(t.spinner=arguments[2]),t=this.extend({spinner:!1},t),e?.[0]instanceof Node&&(e=Array.isArray(e)?e:e.get()),!t.msg&&t.msg!==0&&(t.msg=""),this.unlock(e);let i=o(e).get(0),s=i.scrollWidth,l=i.scrollHeight;i.tagName=="BODY"&&(s<innerWidth&&(s=innerWidth),l<innerHeight&&(l=innerHeight)),o(e).prepend(`<div class="w2ui-lock" style="height: ${l}px; width: ${s}px"></div><div class="w2ui-lock-msg"></div>`);let r=o(e).find(".w2ui-lock"),n=o(e).find(".w2ui-lock-msg");t.msg||n.css({"background-color":"transparent","background-image":"none",border:"0px","box-shadow":"none"}),t.spinner===!0&&(t.msg=`<div class="w2ui-spinner" ${t.msg?"":'style="width: 35px; height: 35px"'}></div>`+t.msg),t.msg?n.html(t.msg).css("display","block"):n.remove(),t.opacity!=null&&r.css("opacity",t.opacity),r.css({display:"block"}),t.bgColor&&r.css({"background-color":t.bgColor});let h=getComputedStyle(r.get(0)).opacity??.15;r.on("mousedown",function(){typeof t.onClick=="function"?t.onClick():r.css({transition:".2s",opacity:h*1.5})}).on("mouseup",function(){typeof t.onClick!="function"&&r.css({transition:".2s",opacity:h})}).on("mousewheel",function(d){d&&(d.stopPropagation(),d.preventDefault())})}unlock(e,t){if(e!=null)if(clearTimeout(e._prevUnlock),e?.[0]instanceof Node&&(e=Array.isArray(e)?e:e.get()),this.isInt(t)&&t>0){o(e).find(".w2ui-lock").css({transition:t/1e3+"s",opacity:0});let i=o(e).get(0);clearTimeout(i._prevUnlock),i._prevUnlock=setTimeout(()=>{o(e).find(".w2ui-lock").remove()},t),o(e).find(".w2ui-lock-msg").remove()}else o(e).find(".w2ui-lock").remove(),o(e).find(".w2ui-lock-msg").remove()}message(e,t){let i,s,l,r=()=>{let f=o(e?.box).find(".w2ui-message");f.length!=0&&(t=f.get(0)._msg_options||{},typeof t?.close=="function"&&t.close())},n=f=>{let m=f.box._msg_prevFocus;if(o(e.box).find(".w2ui-message").length<=1?e.owner?e.owner.unlock(e.param,150):this.unlock(e.box,150):o(e.box).find(`#w2ui-message-${e.owner?.name}-${f.msgIndex-1}`).css("z-index",1500),m){let w=o(m).closest(".w2ui-message");w.length>0?w.get(0)._msg_options.setFocus(m):m.focus()}else typeof e.owner?.focus=="function"&&e.owner.focus();o(f.box).remove(),f.msgIndex===0&&(p.css("z-index",f.tmp.zIndex),o(e.box).css("overflow",f.tmp.overflow)),f.trigger&&l.finish()};if((typeof t=="string"||typeof t=="number")&&(t={width:String(t).length<300?350:550,height:String(t).length<300?170:250,text:String(t)}),typeof t!="object"){r();return}if(t.text!=null&&(t.body=`<div class="w2ui-centered w2ui-msg-text">${t.text}</div>`),t.width==null&&(t.width=350),t.height==null&&(t.height=170),t.hideOn==null&&(t.hideOn=["esc"]),t.on==null){let f=t;t=new Y,u.extend(t,f)}t.on("open",f=>{u.bindEvents(o(t.box).find(".w2ui-eaction"),t),o(f.detail.box).find("button, input, textarea, [name=hidden-first]").off(".message").on("keydown.message",function(m){m.keyCode==27&&t.hideOn.includes("esc")&&(t.cancelAction?t.action(t.cancelAction):t.close())}),setTimeout(()=>t.setFocus(t.focus),300)}),t.off(".prom");let a={self:t,action(f){return t.on("action.prom",f),a},close(f){return t.on("close.prom",f),a},open(f){return t.on("open.prom",f),a},then(f){return t.on("open:after.prom",f),a}};t.actions==null&&t.buttons==null&&t.html==null&&(t.actions={Ok(f){f.detail.self.close()}}),t.off(".buttons"),t.actions!=null&&(t.buttons="",Object.keys(t.actions).forEach(f=>{let m=t.actions[f],w=f;typeof m=="function"&&(t.buttons+=`<button class="w2ui-btn w2ui-eaction" data-click='["action","${f}","event"]' name="${f}">${f}</button>`),typeof m=="object"&&(t.buttons+=`<button class="w2ui-btn w2ui-eaction ${m.class||""}" name="${f}" data-click='["action","${f}","event"]'
                        style="${m.style??""}" ${m.attrs??""}>${m.text||f}</button>`,w=Array.isArray(t.actions)?m.text:f),typeof m=="string"&&(t.buttons+=`<button class="w2ui-btn w2ui-eaction" name="${m}" data-click='["action","${m}","event"]'>${m}</button>`,w=m),typeof w=="string"&&(w=w[0].toLowerCase()+w.substr(1).replace(/\s+/g,"")),a[w]=function(b){return t.on("action.buttons",y=>{y.detail.action[0].toLowerCase()+y.detail.action.substr(1).replace(/\s+/g,"")==w&&b(y)}),a}})),Array("html","body","buttons").forEach(f=>{t[f]=String(t[f]??"").trim()}),(t.body!==""||t.buttons!=="")&&(t.html=`
                <div class="w2ui-message-body">${t.body||""}</div>
                <div class="w2ui-message-buttons">${t.buttons||""}</div>
            `);let h=getComputedStyle(o(e.box).get(0)),d=parseFloat(h.width),g=parseFloat(h.height),c=0;o(e.after).length>0&&(h=getComputedStyle(o(e.after).get(0)),c=parseInt(h.display!="none"?parseInt(h.height):0)),t.width>d&&(t.width=d-10),t.height>g-c&&(t.height=g-10-c),t.originalWidth=t.width,t.originalHeight=t.height,parseInt(t.width)<0&&(t.width=d+t.width),parseInt(t.width)<10&&(t.width=10),parseInt(t.height)<0&&(t.height=g+t.height-c),parseInt(t.height)<10&&(t.height=10),t.originalHeight<0&&(t.height=g+t.originalHeight-c),t.originalWidth<0&&(t.width=d+t.originalWidth*2);let p=o(e.box).find(e.after);if(t.tmp||(t.tmp={zIndex:p.css("z-index"),overflow:h.overflow}),t.html===""&&t.body===""&&t.buttons==="")r();else{t.msgIndex=o(e.box).find(".w2ui-message").length,t.msgIndex===0&&typeof this.lock=="function"&&(o(e.box).css("overflow","hidden"),e.owner?e.owner.lock(e.param):this.lock(e.box)),o(e.box).find(".w2ui-message").css("z-index",1390),p.css("z-index",1501);let f=`
                <div id="w2ui-message-${e.owner?.name}-${t.msgIndex}" class="w2ui-message" data-mousedown="stop"
                    style="z-index: 1500; left: ${(d-t.width)/2}px; top: ${c}px;
                        width: ${t.width}px; height: ${t.height}px; transform: translateY(-${t.height}px)"
                    ${t.hideOn.includes("click")?e.param?`data-click='["message", "${e.param}"]`:'data-click="message"':""}>
                    <span name="hidden-first" tabindex="0" style="position: absolute; top: 0; outline: none"></span>
                    ${t.html}
                    <span name="hidden-last" tabindex="0" style="position: absolute; top: 0; outline: none"></span>
                </div>`;o(e.after).length>0?o(e.box).find(e.after).after(f):o(e.box).prepend(f),t.box=o(e.box).find(`#w2ui-message-${e.owner?.name}-${t.msgIndex}`)[0],u.bindEvents(t.box,this),o(t.box).addClass("animating"),t.box._msg_options=t,t.box._msg_prevFocus=document.activeElement,setTimeout(()=>{if(l=t.trigger("open",{target:this.name,box:t.box,self:t}),l.isCancelled===!0){o(e.box).find(`#w2ui-message-${e.owner?.name}-${t.msgIndex}`).remove(),t.msgIndex===0&&(p.css("z-index",t.tmp.zIndex),o(e.box).css("overflow",t.tmp.overflow));return}o(t.box).css({transition:"0.3s",transform:"translateY(0px)"})},0),s=setTimeout(()=>{o(e.box).find(`#w2ui-message-${e.owner?.name}-${t.msgIndex}`).removeClass("animating").css({transition:"0s"}),l.finish()},300)}return t.action=(f,m)=>{let w=t.actions[f];w instanceof Object&&w.onClick&&(w=w.onClick);let b=t.trigger("action",{target:this.name,action:f,self:t,originalEvent:m,value:t.input?t.input.value:null});b.isCancelled!==!0&&(typeof w=="function"&&w(b),b.finish())},t.close=()=>{if(l=t.trigger("close",{target:"self",box:t.box,self:t}),l.isCancelled!==!0){if(clearTimeout(s),o(t.box).hasClass("animating")){clearTimeout(i),n(t);return}o(t.box).addClass("w2ui-closing animating").css({transition:"0.15s",transform:"translateY(-"+t.height+"px)"}),t.msgIndex!==0&&o(e.box).find(`#w2ui-message-${e.owner?.name}-${t.msgIndex-1}`).css("z-index",1499),i=setTimeout(()=>{n(t)},150)}},t.setFocus=f=>{let m=o(e.box).find(".w2ui-message").length-1,w=o(e.box).find(`#w2ui-message-${e.owner?.name}-${m}`),b="input, button, select, textarea, [contentEditable], .w2ui-input";f!=null?(isNaN(f)?w.find(b).filter(f).get(0):w.find(b).get(f))?.focus():w.find("[name=hidden-first]").get(0)?.focus(),o(e.box).find(".w2ui-message").find(b+",[name=hidden-first],[name=hidden-last]").off(".keep-focus"),o(w).find(b+",[name=hidden-first],[name=hidden-last]").on("blur.keep-focus",function(y){setTimeout(()=>{let x=document.activeElement,C=o(w).find(b).filter(x).length>0,_=o(x).attr("name");!C&&x&&x!==document.body&&o(w).find(b).get(0)?.focus(),_=="hidden-last"&&o(w).find(b).get(0)?.focus(),_=="hidden-first"&&o(w).find(b).get(-1)?.focus()},1)})},a}notify(e,t){return new Promise(i=>{if(typeof e=="object"&&(t=e,e=t.text),t=t||{},t.where=t.where??document.body,t.timeout=t.timeout??15e3,typeof this.tmp.notify_resolve=="function"&&(this.tmp.notify_resolve(),o(this.tmp.notify_where).find("#w2ui-notify").remove()),this.tmp.notify_resolve=i,this.tmp.notify_where=t.where,clearTimeout(this.tmp.notify_timer),e){if(typeof t.actions=="object"){let l={};Object.keys(t.actions).forEach(r=>{l[r]=`<a class="w2ui-notify-link" value="${r}">${r}</a>`}),e=this.execTemplate(e,l)}let s=`
                    <div id="w2ui-notify">
                        <div class="${t.class} ${t.error?"w2ui-notify-error":""}">
                            ${e}
                            <span class="w2ui-notify-close w2ui-icon-cross"></span>
                        </div>
                    </div>`;o(t.where).append(s),o(t.where).find("#w2ui-notify").find(".w2ui-notify-close").on("click",l=>{o(t.where).find("#w2ui-notify").remove(),i()}),t.actions&&o(t.where).find("#w2ui-notify .w2ui-notify-link").on("click",l=>{let r=o(l.target).attr("value");t.actions[r](),o(t.where).find("#w2ui-notify").remove(),i()}),t.timeout>0&&(this.tmp.notify_timer=setTimeout(()=>{o(t.where).find("#w2ui-notify").remove(),i()},t.timeout))}})}confirm(e,t){typeof t=="string"&&(t={text:t}),u.normButtons(t,{yes:"Yes",no:"No"});let i=u.message(e,t);return i&&i.action(s=>{s.detail.self.close()}),i}normButtons(e,t){e.actions=e.actions??{};let i=Object.keys(t);return i.forEach(s=>{let l=e["btn_"+s];l&&(t[s]={text:u.lang(l.text??t[s]??""),class:l.class??"",style:l.style??"",attrs:l.attrs??""},delete e["btn_"+s]),Array("text","class","style","attrs").forEach(r=>{e[s+"_"+r]&&(typeof t[s]=="string"&&(t[s]={text:t[s]}),t[s][r]=e[s+"_"+r],delete e[s+"_"+r])})}),i.includes("yes")&&i.includes("no")&&(u.settings.macButtonOrder?u.extend(e.actions,{no:t.no,yes:t.yes}):u.extend(e.actions,{yes:t.yes,no:t.no})),i.includes("ok")&&i.includes("cancel")&&(u.settings.macButtonOrder?u.extend(e.actions,{cancel:t.cancel,ok:t.ok}):u.extend(e.actions,{ok:t.ok,cancel:t.cancel})),e}getSize(e,t){e=o(e);let i=0;if(e.length>0){e=e[0];let s=getComputedStyle(e);switch(t){case"width":i=parseFloat(s.width),s.width==="auto"&&(i=0);break;case"height":i=parseFloat(s.height),s.height==="auto"&&(i=0);break;default:i=parseFloat(s[t]??0)||0;break}}return i}getStrWidth(e,t,i){let s=o("body > #_tmp_width");return s.length===0&&(o("body").append('<div id="_tmp_width" style="position: absolute; top: -9000px;"></div>'),s=o("body > #_tmp_width")),s.html(i?e:this.encodeTags(e)).attr("style",`position: absolute; top: -9000px; ${t||""}`),s[0].clientWidth}execTemplate(e,t){return typeof e!="string"||!t||typeof t!="object"?e:e.replace(/\${([^}]+)?}/g,function(i,s){return t[s]||s})}marker(e,t,i={onlyFirst:!1,wholeWord:!1}){Array.isArray(t)||(t!=null&&t!==""?t=[t]:t=[]);let s=i.wholeWord;o(e).each(r=>{l(r),t.forEach(n=>{typeof n!="string"&&(n=String(n));let a=d=>'<span class="w2ui-marker">'+d+"</span>";n=n.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&").replace(/&/g,"&amp;").replace(/</g,"&gt;").replace(/>/g,"&lt;");let h=new RegExp((s?"\\b":"")+n+(s?"\\b":"")+"(?!([^<]+)?>)","i"+(i.onlyFirst?"":"g"));r.innerHTML=r.innerHTML.replace(h,a)})});function l(r){let n=/\<span class=\"w2ui\-marker\"\>((.|\n|\r)*)\<\/span\>/ig;for(;r.innerHTML.indexOf('<span class="w2ui-marker"')!==-1;)r.innerHTML=r.innerHTML.replace(n,"$1")}}lang(e,t){if(!e||this.settings.phrases==null||typeof e!="string"||"<=>=".includes(e))return this.execTemplate(e,t);let i=this.settings.phrases[e];return i==null?(i=e,this.settings.warnNoPhrase&&(this.settings.missing||(this.settings.missing={}),this.settings.missing[e]="---",this.settings.phrases[e]="---",console.log(`Missing translation for "%c${e}%c", see %c w2utils.settings.phrases %c with value "---"`,"color: orange","","color: #999",""))):i==="---"&&!this.settings.warnNoPhrase&&(i=e),i==="---"&&(i=`<span ${this.tooltip(e)}>---</span>`),this.execTemplate(i,t)}locale(e,t,i){return new Promise((s,l)=>{if(Array.isArray(e)){this.settings.phrases={};let r=[],n={};e.forEach((a,h)=>{a.length===5&&(a="locale/"+a.toLowerCase()+".json",e[h]=a),r.push(this.locale(a,!0,!1))}),Promise.allSettled(r).then(a=>{a.forEach(h=>{h.value&&(n[h.value.file]=h.value.data)}),e.forEach(h=>{this.settings=this.extend({},this.settings,n[h])}),s()});return}if(e||(e="en-us"),e instanceof Object){this.settings=this.extend({},this.settings,be,e);return}e.length===5&&(e="locale/"+e.toLowerCase()+".json"),fetch(e,{method:"GET"}).then(r=>r.json()).then(r=>{i!==!0&&(t?this.settings=this.extend({},this.settings,r):this.settings=this.extend({},this.settings,be,{phrases:{}},r)),s({file:e,data:r})}).catch(r=>{console.log("ERROR: Cannot load locale "+e),l(r)})})}scrollBarSize(){return this.tmp.scrollBarSize?this.tmp.scrollBarSize:(o("body").append(`
            <div id="_scrollbar_width" style="position: absolute; top: -300px; width: 100px; height: 100px; overflow-y: scroll;">
                <div style="height: 120px">1</div>
            </div>
        `),this.tmp.scrollBarSize=100-o("#_scrollbar_width > div")[0].clientWidth,o("#_scrollbar_width").remove(),this.tmp.scrollBarSize)}checkName(e){return e==null?(console.log('ERROR: Property "name" is required but not supplied.'),!1):N[e]!=null?(console.log(`ERROR: Object named "${e}" is already registered as w2ui.${e}.`),!1):this.isAlphaNumeric(e)?!0:(console.log('ERROR: Property "name" has to be alpha-numeric (a-z, 0-9, dash and underscore).'),!1)}checkUniqueId(e,t,i,s){Array.isArray(t)||(t=[t]);let l=!0;return t.forEach(r=>{r.id===e&&(console.log(`ERROR: The item id="${e}" is not unique within the ${i} "${s}".`,t),l=!1)}),l}encodeParams(e,t=""){let i="";return Object.keys(e).forEach(s=>{i!=""&&(i+="&"),typeof e[s]=="object"?i+=this.encodeParams(e[s],t+s+(t?"]":"")+"["):i+=`${t}${s}${t?"]":""}=${e[s]}`}),i}parseRoute(e){let t=[],i=e.replace(/\/\(/g,"(?:/").replace(/\+/g,"__plus__").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,(s,l,r,n,a,h)=>(t.push({name:n,optional:!!h}),l=l||"",""+(h?"":l)+"(?:"+(h?l:"")+(r||"")+(a||r&&"([^/.]+?)"||"([^/]+?)")+")"+(h||""))).replace(/([\/.])/g,"\\$1").replace(/__plus__/g,"(.+)").replace(/\*/g,"(.*)");return{path:new RegExp("^"+i+"$","i"),keys:t}}getCursorPosition(e){if(e==null)return null;let t=0,i=e.ownerDocument||e.document,s=i.defaultView||i.parentWindow,l;if(["INPUT","TEXTAREA"].includes(e.tagName))t=e.selectionStart;else if(s.getSelection){if(l=s.getSelection(),l.rangeCount>0){let r=l.getRangeAt(0),n=r.cloneRange();n.selectNodeContents(e),n.setEnd(r.endContainer,r.endOffset),t=n.toString().length}}else if((l=i.selection)&&l.type!=="Control"){let r=l.createRange(),n=i.body.createTextRange();n.moveToElementText(e),n.setEndPoint("EndToEnd",r),t=n.text.length}return t}setCursorPosition(e,t,i){if(e==null)return;let s=document.createRange(),l,r=window.getSelection();if(["INPUT","TEXTAREA"].includes(e.tagName))e.setSelectionRange(t,i??t);else{for(let n=0;n<e.childNodes.length;n++){let a=o(e.childNodes[n]).text();if(e.childNodes[n].tagName&&(a=o(e.childNodes[n]).html(),a=a.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&nbsp;/g," ")),t<=a.length){l=e.childNodes[n],l.childNodes&&l.childNodes.length>0&&(l=l.childNodes[0]),l.childNodes&&l.childNodes.length>0&&(l=l.childNodes[0]);break}else t-=a.length}if(l==null)return;t>l.length&&(t=l.length),s.setStart(l,t),i?s.setEnd(l,i):s.collapse(!0),r.removeAllRanges(),r.addRange(s)}}parseColor(e){if(typeof e!="string")return null;e=e.trim().toUpperCase(),e[0]==="#"&&(e=e.substr(1));let t={};if(e.length===3)t={r:parseInt(e[0]+e[0],16),g:parseInt(e[1]+e[1],16),b:parseInt(e[2]+e[2],16),a:1};else if(e.length===6)t={r:parseInt(e.substr(0,2),16),g:parseInt(e.substr(2,2),16),b:parseInt(e.substr(4,2),16),a:1};else if(e.length===8)t={r:parseInt(e.substr(0,2),16),g:parseInt(e.substr(2,2),16),b:parseInt(e.substr(4,2),16),a:Math.round(parseInt(e.substr(6,2),16)/255*100)/100};else if(e.length>4&&e.substr(0,4)==="RGB("){let i=e.replace("RGB","").replace(/\(/g,"").replace(/\)/g,"").split(",");t={r:parseInt(i[0],10),g:parseInt(i[1],10),b:parseInt(i[2],10),a:1}}else if(e.length>5&&e.substr(0,5)==="RGBA("){let i=e.replace("RGBA","").replace(/\(/g,"").replace(/\)/g,"").split(",");t={r:parseInt(i[0],10),g:parseInt(i[1],10),b:parseInt(i[2],10),a:parseFloat(i[3])}}else return null;return t}colorContrast(e,t){let i=r(e),s=r(t);return((Math.max(i,s)+.05)/(Math.min(i,s)+.05)).toFixed(2);function r(n){let{r:a,g:h,b:d}=u.parseColor(n)??{r:0,g:0,b:0},g=2.2,c=a/255,p=h/255,f=d/255,m=c<=.03928?c/12.92:Math.pow((c+.055)/1.055,g),w=p<=.03928?p/12.92:Math.pow((p+.055)/1.055,g),b=f<=.03928?f/12.92:Math.pow((f+.055)/1.055,g);return .2126*m+.7152*w+.0722*b}}hsv2rgb(e,t,i,s){let l,r,n,a,h,d,g,c;switch(arguments.length===1&&(t=e.s,i=e.v,s=e.a,e=e.h),e=e/360,t=t/100,i=i/100,a=Math.floor(e*6),h=e*6-a,d=i*(1-t),g=i*(1-h*t),c=i*(1-(1-h)*t),a%6){case 0:l=i,r=c,n=d;break;case 1:l=g,r=i,n=d;break;case 2:l=d,r=i,n=c;break;case 3:l=d,r=g,n=i;break;case 4:l=c,r=d,n=i;break;case 5:l=i,r=d,n=g;break}return{r:Math.round(l*255),g:Math.round(r*255),b:Math.round(n*255),a:s??1}}rgb2hsv(e,t,i,s){arguments.length===1&&(t=e.g,i=e.b,s=e.a,e=e.r);let l=Math.max(e,t,i),r=Math.min(e,t,i),n=l-r,a,h=l===0?0:n/l,d=l/255;switch(l){case r:a=0;break;case e:a=t-i+n*(t<i?6:0),a/=6*n;break;case t:a=i-e+n*2,a/=6*n;break;case i:a=e-t+n*4,a/=6*n;break}return{h:Math.round(a*360),s:Math.round(h*100),v:Math.round(d*100),a:s??1}}tooltip(e,t){let i,s="mouseenter",l="mouseleave";return typeof e=="object"&&(t=e),t=t||{},typeof e=="string"&&(t.html=e),t.showOn&&(s=t.showOn,delete t.showOn),t.hideOn&&(l=t.hideOn,delete t.hideOn),t.name||(t.name="no-name"),i=` on${s}="w2tooltip.show(this, JSON.parse(w2utils.base64decode('${this.base64encode(JSON.stringify(t))}')))" on${l}="w2tooltip.hide('${t.name}')"`,i}isPlainObject(e){if(e==null||Object.prototype.toString.call(e)!=="[object Object]")return!1;if(e.constructor===void 0)return!0;let t=Object.getPrototypeOf(e);return t===null||t===Object.prototype}clone(e,t){let i;return t=Object.assign({functions:!0,elements:!0,events:!0,exclude:[]},t??{}),Array.isArray(e)?(i=Array.from(e),i.forEach((s,l)=>{i[l]=this.clone(s,t)})):this.isPlainObject(e)?(i={},Object.assign(i,e),t.exclude&&t.exclude.forEach(s=>{delete i[s]}),Object.keys(i).forEach(s=>{i[s]=this.clone(i[s],t),i[s]===void 0&&delete i[s]})):e instanceof Function&&!t.functions||e instanceof Node&&!t.elements||e instanceof Event&&!t.events||(i=e),i}extend(e,t){if(Array.isArray(e))if(Array.isArray(t))e.splice(0,e.length),t.forEach(i=>{e.push(this.clone(i))});else throw new Error("Arrays can be extended with arrays only");else{if(e instanceof Node||e instanceof Event)throw new Error("HTML elmenents and events cannot be extended");if(e&&typeof e=="object"&&t!=null){if(typeof t!="object")throw new Error("Object can be extended with other objects only.");Object.keys(t).forEach(i=>{if(e[i]!=null&&typeof e[i]=="object"&&t[i]!=null&&typeof t[i]=="object"){let s=this.clone(t[i]);e[i]instanceof Node||e[i]instanceof Event?e[i]=s:(Array.isArray(e[i])&&this.isPlainObject(s)&&(e[i]={}),this.extend(e[i],s))}else e[i]=this.clone(t[i])})}else if(t!=null)throw new Error("Object is not extendable, only {} or [] can be extended.")}if(arguments.length>2)for(let i=2;i<arguments.length;i++)this.extend(e,arguments[i]);return e}naturalCompare(e,t){let i,s,l=1,r=0,n=0,a=String.alphabet;function h(d,g,c){if(c){for(i=g;c=h(d,i),c<76&&c>65;)++i;return+d.slice(g-1,i)}return c=a&&a.indexOf(d.charAt(g)),c>-1?c+76:(c=d.charCodeAt(g)||0,c<45||c>127?c:c<46?65:c<48?c-1:c<58?c+18:c<65?c-11:c<91?c+11:c<97?c-37:c<123?c+5:c-63)}if((e+="")!=(t+="")){for(;l;)if(s=h(e,r++),l=h(t,n++),s<76&&l<76&&s>66&&l>66&&(s=h(e,r,r),l=h(t,n,r=i),n=i),s!=l)return s<l?-1:1}return 0}normMenu(e,t){if(Array.isArray(e))return e.forEach((i,s)=>{typeof i=="string"||typeof i=="number"?e[s]={id:i,text:String(i)}:i!=null?(i.caption!=null&&i.text==null&&(i.text=i.caption),i.text!=null&&i.id==null&&(i.id=i.text),i.text==null&&i.id!=null&&(i.text=i.id)):e[s]={id:null,text:"null"}}),e;if(typeof e=="function"){let i=e.call(this,e,t);return u.normMenu.call(this,i)}else if(typeof e=="object")return Object.keys(e).map(i=>({id:i,text:e[i]}))}prepareParams(e,t,i){let s=i??u.settings.dataType,l=t.body;switch(s){case"HTTPJSON":l={request:l},["PUT","DELETE"].includes(t.method)&&(t.method="POST"),r();break;case"HTTP":["PUT","DELETE"].includes(t.method)&&(t.method="POST"),r();break;case"RESTFULL":["PUT","DELETE"].includes(t.method)?t.headers["Content-Type"]="application/json":r();break;case"JSON":t.method=="GET"?(l={request:l},r()):(t.headers["Content-Type"]="application/json",t.method="POST");break}return t.body=typeof t.body=="string"?t.body:JSON.stringify(t.body),t;function r(){Object.keys(l).forEach(n=>{let a=l[n];typeof a=="object"&&(a=JSON.stringify(a)),e.searchParams.append(n,a)}),delete t.body}}bindEvents(e,t){e.length!=0&&(e?.[0]instanceof Node&&(e=Array.isArray(e)?e:e.get()),o(e).each(i=>{let s=o(i).data();Object.keys(s).forEach(l=>{if(["click","dblclick","mouseenter","mouseleave","mouseover","mouseout","mousedown","mousemove","mouseup","contextmenu","focus","focusin","focusout","blur","input","change","keydown","keyup","keypress"].indexOf(String(l).toLowerCase())==-1)return;let n=s[l];typeof n=="string"&&(n=n.split("|").map(h=>{h==="true"&&(h=!0),h==="false"&&(h=!1),h==="undefined"&&(h=void 0),h==="null"&&(h=null),parseFloat(h)==h&&(h=parseFloat(h));let d=["'",'"',"`"];return typeof h=="string"&&d.includes(h[0])&&d.includes(h[h.length-1])&&(h=h.substring(1,h.length-1)),h}));let a=n[0];n=n.slice(1),o(i).off(l+".w2utils-bind").on(l+".w2utils-bind",function(h){switch(a){case"alert":alert(n[0]);break;case"stop":h.stopPropagation();break;case"prevent":h.preventDefault();break;case"stopPrevent":return h.stopPropagation(),h.preventDefault(),!1;break;default:if(t[a]==null)throw new Error(`Cannot dispatch event as the method "${a}" does not exist.`);t[a].apply(t,n.map((d,g)=>{switch(String(d).toLowerCase()){case"event":return h;case"this":return this;default:return d}}))}})})}))}debounce(e,t=250){let i;return(...s)=>{clearTimeout(i),i=setTimeout(()=>{e(...s)},t)}}},u=new ye,we=class extends Y{constructor(){super(),this.defaults={title:"",text:"",body:"",buttons:"",width:450,height:250,focus:null,actions:null,style:"",speed:.3,modal:!1,maximized:!1,keyboard:!0,showClose:!0,showMax:!1,resizable:!1,transition:null,openMaximized:!1,moved:!1},this.name="popup",this.status="closed",this.onOpen=null,this.onClose=null,this.onMax=null,this.onMin=null,this.onToggle=null,this.onKeydown=null,this.onAction=null,this.onMove=null,this.tmp={},this.handleResize=e=>{this.options.moved||this.center(void 0,void 0,!0)}}open(e){let t=this;(this.status=="closing"||o("#w2ui-popup").hasClass("animating"))&&this.close(!0);let i=this.options;["string","number"].includes(typeof e)&&(e=u.extend({title:"Notification",body:`<div class="w2ui-centered">${e}</div>`,actions:{Ok(){t.close()}},cancelAction:"ok"},arguments[1]??{})),e.text!=null&&(e.body=`<div class="w2ui-centered w2ui-msg-text">${e.text}</div>`),e=Object.assign({},this.defaults,i,{title:"",body:""},e,{maximized:!1}),this.options=e,o("#w2ui-popup").length===0&&(this.off("*"),Object.keys(this).forEach(f=>{f.startsWith("on")&&f!="on"&&(this[f]=null)})),Object.keys(e).forEach(f=>{f.startsWith("on")&&f!="on"&&e[f]&&(this[f]=e[f])}),e.width=parseInt(e.width),e.height=parseInt(e.height);let s,l,r,{top:n,left:a}=this.center(),h={self:this,action(f){return t.on("action.prom",f),h},close(f){return t.on("close.prom",f),h},then(f){return t.on("open:after.prom",f),h}};e.actions!=null&&!e.buttons&&(e.buttons="",Object.keys(e.actions).forEach(f=>{let m=e.actions[f],w=f;typeof m=="function"&&(e.buttons+=`<button class="w2ui-btn w2ui-eaction" name="${f}" data-click='["action","${f}","event"]'>${f}</button>`),typeof m=="object"&&(e.buttons+=`<button class="w2ui-btn w2ui-eaction ${m.class||""}" name="${f}" data-click='["action","${f}","event"]'
                        style="${m.style}" ${m.attrs}>${m.text||f}</button>`,w=Array.isArray(e.actions)?m.text:f),typeof m=="string"&&(w=m[0].toLowerCase()+m.substr(1).replace(/\s+/g,""),e.buttons+=`<button class="w2ui-btn w2ui-eaction" name="${f}" data-click='["action","${w}","event"]'>${m}</button>`),typeof w=="string"&&(w=w[0].toLowerCase()+w.substr(1).replace(/\s+/g,"")),h[w]=function(b){return t.on("action.buttons",y=>{y.detail.action[0].toLowerCase()+y.detail.action.substr(1).replace(/\s+/g,"")==w&&b(y)}),h}}));let d="";if(e.showClose&&(d+=`<div class="w2ui-popup-button w2ui-popup-close">
                        <span class="w2ui-icon w2ui-icon-cross w2ui-eaction" data-mousedown="stop" data-click="close"></span>
                    </div>`),e.showMax&&(d+=`<div class="w2ui-popup-button w2ui-popup-max">
                        <span class="w2ui-icon w2ui-icon-box w2ui-eaction" data-mousedown="stop" data-click="toggle"></span>
                    </div>`),o("#w2ui-popup").length===0){if(s=this.trigger("open",{target:"popup",present:!1}),s.isCancelled===!0)return;this.status="opening",u.lock(document.body,{opacity:.3,onClick:e.modal?null:()=>{this.close()}});let f=`
                left: ${a}px;
                top: ${n}px;
                width: ${parseInt(e.width)}px;
                height: ${parseInt(e.height)}px;
                transition: ${e.speed}s
            `;l=`<div id="w2ui-popup" class="w2ui-popup w2ui-anim-open animating" style="${u.stripSpaces(f)}"></div>`,o("body").append(l),o("#w2ui-popup")[0]._w2popup={self:this,created:new Promise(m=>{this._promCreated=m}),opened:new Promise(m=>{this._promOpened=m}),closing:new Promise(m=>{this._promClosing=m}),closed:new Promise(m=>{this._promClosed=m})},f=`${e.title?"":"top: 0px !important;"} ${e.buttons?"":"bottom: 0px !important;"}`,l=`
                <span name="hidden-first" tabindex="0" style="position: absolute; top: -100px"></span>
                <div class="w2ui-popup-title-btns">${d}</div>
                <div class="w2ui-popup-title" style="${e.title?"":"display: none"}"></div>
                <div class="w2ui-box" style="${f}">
                    <div class="w2ui-popup-body ${!e.title||" w2ui-popup-no-title"}
                        ${!e.buttons||" w2ui-popup-no-buttons"}" style="${e.style}">
                    </div>
                </div>
                <div class="w2ui-popup-buttons" style="${e.buttons?"":"display: none"}"></div>
                <div class="w2ui-popup-resizer resize-point resize-icon"></div>
                <span name="hidden-last" tabindex="0" style="position: absolute; top: -100px"></span>
            `,o("#w2ui-popup").html(l),e.title&&o("#w2ui-popup .w2ui-popup-title").append(u.lang(e.title)),e.buttons&&o("#w2ui-popup .w2ui-popup-buttons").append(e.buttons),e.body&&o("#w2ui-popup .w2ui-popup-body").append(e.body),setTimeout(()=>{o("#w2ui-popup").css("transition",e.speed+"s").removeClass("w2ui-anim-open"),u.bindEvents("#w2ui-popup .w2ui-eaction",this),o("#w2ui-popup").find(".w2ui-popup-body").show(),this._promCreated()},1),clearTimeout(this._timer),this._timer=setTimeout(()=>{this.status="open",t.setFocus(e.focus),s.finish(),this._promOpened(),o("#w2ui-popup").removeClass("animating")},e.speed*1e3)}else{if(s=this.trigger("open",{target:"popup",present:!0}),s.isCancelled===!0)return;this.status="opening",i!=null&&(!i.maximized&&(i.width!=e.width||i.height!=e.height)&&this.resize(e.width,e.height),e.prevSize=e.width+"px:"+e.height+"px",e.maximized=i.maximized);let f=o("#w2ui-popup .w2ui-box").get(0).cloneNode(!0);o(f).removeClass("w2ui-box").addClass("w2ui-box-temp").find(".w2ui-popup-body").empty().append(e.body),o("#w2ui-popup .w2ui-box").after(f),e.buttons?(o("#w2ui-popup .w2ui-popup-buttons").show().html("").append(e.buttons),o("#w2ui-popup .w2ui-popup-body").removeClass("w2ui-popup-no-buttons"),o("#w2ui-popup .w2ui-box, #w2ui-popup .w2ui-box-temp").css("bottom","")):(o("#w2ui-popup .w2ui-popup-buttons").hide().html(""),o("#w2ui-popup .w2ui-popup-body").addClass("w2ui-popup-no-buttons"),o("#w2ui-popup .w2ui-box, #w2ui-popup .w2ui-box-temp").css("bottom","0px")),e.title?(o("#w2ui-popup .w2ui-popup-title").show().html(u.lang(e.title)),o("#w2ui-popup .w2ui-popup-body").removeClass("w2ui-popup-no-title"),o("#w2ui-popup .w2ui-box, #w2ui-popup .w2ui-box-temp").css("top","")):(o("#w2ui-popup .w2ui-popup-title").hide().html(""),o("#w2ui-popup .w2ui-popup-body").addClass("w2ui-popup-no-title"),o("#w2ui-popup .w2ui-box, #w2ui-popup .w2ui-box-temp").css("top","0px")),d?o("#w2ui-popup .w2ui-popup-title-btns").show().html(d):o("#w2ui-popup .w2ui-popup-title-btns").hide();let m=o("#w2ui-popup .w2ui-box")[0],w=o("#w2ui-popup .w2ui-box-temp")[0];o("#w2ui-popup").addClass("animating"),u.transition(m,w,e.transition,()=>{o(m).remove(),o(w).removeClass("w2ui-box-temp").addClass("w2ui-box");let b=o(w).find(".w2ui-popup-body");b.length==1&&(b[0].style.cssText=e.style,b.show()),t.setFocus(e.focus),o("#w2ui-popup").removeClass("animating")}),this.status="open",s.finish(),u.bindEvents("#w2ui-popup .w2ui-eaction",this),o("#w2ui-popup").find(".w2ui-popup-body").show()}return e.openMaximized&&this.max(),e._last_focus=document.activeElement,e.keyboard&&o(document.body).off(".w2popup").on("keydown.w2popup",f=>{this.keydown(f)}),o(window).on("resize",this.handleResize),r={changing:!1,mvMove:c,mvStop:p},o("#w2ui-popup .w2ui-popup-title").off("mousedown").on("mousedown",function(f){t.options.maximized||g(f)}),e.resizable?(o("#w2ui-popup .w2ui-popup-resizer").show(),o("#w2ui-popup .w2ui-popup-resizer").off("mousedown").on("mousedown",f=>{g(f,!0)})):o("#w2ui-popup .w2ui-popup-resizer").hide(),h;function g(f,m){f||(f=window.event),t.status=m?"resizing":"moving";let w=o("#w2ui-popup").get(0).getBoundingClientRect();if(Object.assign(r,{changing:!0,isLocked:o("#w2ui-popup > .w2ui-lock").length==1,x:f.screenX,y:f.screenY,pos_x:w.x,pos_y:w.y,width:w.width,height:w.height}),r.isLocked||t.lock({opacity:0}),o(document.body).on("mousemove.w2ui-popup",r.mvMove).on("mouseup.w2ui-popup",r.mvStop),f.stopPropagation?f.stopPropagation():f.cancelBubble=!0,f.preventDefault)f.preventDefault();else return!1}function c(f){if(r.changing!=!0)return;f||(f=window.event),r.div_x=f.screenX-r.x,r.div_y=f.screenY-r.y;let m=t.trigger("move",{target:"popup",div_x:r.div_x,div_y:r.div_y,originalEvent:f});m.isCancelled!==!0&&(t.status=="moving"?(o("#w2ui-popup").css({transition:"none",transform:"translate3d("+r.div_x+"px, "+r.div_y+"px, 0px)"}),t.options.moved=!0):o("#w2ui-popup").css({transition:"none",width:r.width+r.div_x+"px",height:r.height+r.div_y+"px"}),m.finish())}function p(f){r.changing==!0&&(f||(f=window.event),r.div_x=f.screenX-r.x,r.div_y=f.screenY-r.y,t.status=="moving"?o("#w2ui-popup").css({left:r.pos_x+r.div_x+"px",top:r.pos_y+r.div_y+"px"}).css({transition:"none",transform:"translate3d(0px, 0px, 0px)"}):(o("#w2ui-popup").css({transition:"none",width:r.width+r.div_x+"px",height:r.height+r.div_y+"px"}),t.resizeMessages()),r.changing=!1,t.status="open",o(document.body).off(".w2ui-popup"),r.isLocked||t.unlock())}}load(e){return new Promise((t,i)=>{if(typeof e=="string"&&(e={url:e}),e.url==null){console.log("ERROR: The url is not defined."),i("The url is not defined");return}this.status="loading";let[s,l]=String(e.url).split("#");s&&fetch(s).then(r=>r.text()).then(r=>{t(this.template(r,l,e))})})}template(e,t,i={}){let s;try{s=o(e)}catch{s=o.html(e)}return t&&(s=s.filter("#"+t)),Object.assign(i,{width:parseInt(o(s).css("width")),height:parseInt(o(s).css("height")),title:o(s).find("[rel=title]").html(),body:o(s).find("[rel=body]").html(),buttons:o(s).find("[rel=buttons]").html(),style:o(s).find("[rel=body]").get(0).style.cssText}),this.open(i)}action(e,t){let i=this.options.actions[e];i instanceof Object&&i.onClick&&(i=i.onClick);let s=this.trigger("action",{action:e,target:"popup",self:this,originalEvent:t,value:this.input?this.input.value:null});s.isCancelled!==!0&&(typeof i=="function"&&i.call(this,t),s.finish())}keydown(e){if(this.options&&!this.options.keyboard)return;let t=this.trigger("keydown",{target:"popup",originalEvent:e});if(t.isCancelled!==!0){switch(e.keyCode){case 27:e.preventDefault(),o("#w2ui-popup .w2ui-message").length==0&&(this.options.cancelAction?this.action(this.options.cancelAction):this.close());break}t.finish()}}close(e){let t=this.trigger("close",{target:"popup"});if(t.isCancelled===!0)return;let i=()=>{o("#w2ui-popup").remove(),this.options._last_focus&&this.options._last_focus.length>0&&this.options._last_focus.focus(),this.status="closed",this.options={},t.finish(),this._promClosed()};if(!(o("#w2ui-popup").length===0||this.status=="closed")){if(this.status=="opening"&&(e=!0),this.status=="closing"&&e===!0){i(),clearTimeout(this.tmp.closingTimer),u.unlock(document.body,0);return}this.status="closing",o("#w2ui-popup").css("transition",this.options.speed+"s").addClass("w2ui-anim-close animating"),u.unlock(document.body,300),this._promClosing(),e?i():this.tmp.closingTimer=setTimeout(i,this.options.speed*1e3),this.options.keyboard&&o(document.body).off("keydown",this.keydown),o(window).off("resize",this.handleResize)}}toggle(){let e=this.trigger("toggle",{target:"popup"});e.isCancelled!==!0&&(this.options.maximized===!0?this.min():this.max(),setTimeout(()=>{e.finish()},this.options.speed*1e3+50))}max(){if(this.options.maximized===!0)return;let e=this.trigger("max",{target:"popup"});if(e.isCancelled===!0)return;this.status="resizing";let t=o("#w2ui-popup").get(0).getBoundingClientRect();this.options.prevSize=t.width+":"+t.height,this.resize(1e4,1e4,()=>{this.status="open",this.options.maximized=!0,e.finish()})}min(){if(this.options.maximized!==!0)return;let e=this.options.prevSize.split(":"),t=this.trigger("min",{target:"popup"});t.isCancelled!==!0&&(this.status="resizing",this.options.maximized=!1,this.resize(parseInt(e[0]),parseInt(e[1]),()=>{this.status="open",this.options.prevSize=null,t.finish()}))}clear(){o("#w2ui-popup .w2ui-popup-title").html(""),o("#w2ui-popup .w2ui-popup-body").html(""),o("#w2ui-popup .w2ui-popup-buttons").html("")}reset(){this.open(this.defaults)}message(e){return u.message({owner:this,box:o("#w2ui-popup").get(0),after:".w2ui-popup-title"},e)}confirm(e){return u.confirm({owner:this,box:o("#w2ui-popup"),after:".w2ui-popup-title"},e)}setFocus(e){let t=o("#w2ui-popup"),i="input, button, select, textarea, [contentEditable], [tabindex], .w2ui-input";if(e!=null)(isNaN(e)?t.find(i).filter(e).get(0):t.find(i).get(e))?.focus();else{let s=t.find("[name=hidden-first]").get(0);s&&s.focus()}o(t).find(i).off(".keep-focus").on("blur.keep-focus",function(s){setTimeout(()=>{let l=document.activeElement,r=o(t).find(i).filter(l).length>0,n=o(l).attr("name");!r&&l&&l!==document.body&&o(t).find(i).get(0)?.focus(),n=="hidden-last"&&o(t).find(i).get(1)?.focus(),n=="hidden-first"&&o(t).find(i).get(-2)?.focus()},1)})}lock(e,t){let i=Array.from(arguments);i.unshift(o("#w2ui-popup")),u.lock(...i)}unlock(e){u.unlock(o("#w2ui-popup"),e)}center(e,t,i){let s,l;window.innerHeight==null?(s=parseInt(document.documentElement.offsetWidth),l=parseInt(document.documentElement.offsetHeight)):(s=parseInt(window.innerWidth),l=parseInt(window.innerHeight)),e=parseInt(e??this.options.width),t=parseInt(t??this.options.height),this.options.maximized===!0&&(e=s,t=l),s-10<e&&(e=s-10),l-10<t&&(t=l-10);let r=(l-t)/3,n=(s-e)/2;return i&&(o("#w2ui-popup").css({transition:"none",top:r+"px",left:n+"px",width:e+"px",height:t+"px"}),this.resizeMessages()),{top:r,left:n,width:e,height:t}}resize(e,t,i){let s=this;this.options.speed==null&&(this.options.speed=0);let{top:l,left:r,width:n,height:a}=this.center(e,t),h=this.options.speed;o("#w2ui-popup").css({transition:`${h}s width, ${h}s height, ${h}s left, ${h}s top`,top:l+"px",left:r+"px",width:n+"px",height:a+"px"});let d=setInterval(()=>{s.resizeMessages()},10);setTimeout(()=>{clearInterval(d),s.resizeMessages(),typeof i=="function"&&i()},this.options.speed*1e3+50)}resizeMessages(){o("#w2ui-popup .w2ui-message").each(e=>{let t=e._msg_options,i=o("#w2ui-popup");parseInt(t.width)<10&&(t.width=10),parseInt(t.height)<10&&(t.height=10);let s=i[0].getBoundingClientRect(),l=parseInt(i.find(".w2ui-popup-title")[0].clientHeight),r=parseInt(s.width),n=parseInt(s.height);t.width=t.originalWidth,t.width>r-10&&(t.width=r-10),t.height=t.originalHeight,t.height>n-l-5&&(t.height=n-l-5),t.originalHeight<0&&(t.height=n+t.originalHeight-l),t.originalWidth<0&&(t.width=r+t.originalWidth*2),o(e).css({left:(r-t.width)/2+"px",width:t.width+"px",height:t.height+"px"})})}};function Ce(I,e,t){let i,s={title:u.lang(e??"Notification"),body:`<div class="w2ui-centered w2ui-msg-text">${I}</div>`,showClose:!1,actions:{ok:"Ok"},cancelAction:"ok"};return o("#w2ui-popup").length>0&&U.status!="closing"?i=U.message(s):i=U.open(s),i.ok(l=>{typeof l.detail.self?.close=="function"&&l.detail.self.close(),typeof t=="function"&&t()}),i}var U=new we,V=class I{static active={};constructor(){this.defaults={name:null,html:"",style:"",class:"",position:"top|bottom",align:"",anchor:null,contextMenu:!1,anchorClass:"",anchorStyle:"",autoShow:!1,autoShowOn:null,autoHideOn:null,arrowSize:8,screenMargin:2,autoResize:!0,margin:1,offsetX:0,offsetY:0,maxWidth:null,maxHeight:null,watchScroll:null,watchResize:null,hideOn:null,onThen:null,onShow:null,onHide:null,onUpdate:null,onMove:null}}static observeRemove=new MutationObserver(e=>{let t=0;Object.keys(I.active).forEach(i=>{let s=I.active[i];s.displayed&&(!s.anchor||!s.anchor.isConnected?s.hide():t++)}),t===0&&I.observeRemove.disconnect()});trigger(e,t){if(arguments.length==2){let i=e;e=t,t.type=i}if(e.overlay)return e.overlay.trigger(e);console.log("ERROR: cannot find overlay where to trigger events")}get(e){return arguments.length==0?Object.keys(I.active):e===!0?I.active:I.active[e.replace(/[\s\.#]/g,"_")]}attach(e,t){let i,s,l=this;if(arguments.length==0)return;arguments.length==1&&e instanceof Object?(i=e,e=i.anchor):arguments.length===2&&typeof t=="string"?(i={anchor:e,html:t},t=i.html):arguments.length===2&&t!=null&&typeof t=="object"&&(i=t,t=i.html),i=u.extend({},this.defaults,i||{}),!t&&i.text&&(t=i.text),!t&&i.html&&(t=i.html),delete i.anchor;let r=i.name?i.name:e?.id;if((e==document||e==null)&&(e=document.body),i.contextMenu&&(e=document.body,r=r??"context-menu"),r||(r="noname-"+Object.keys(I.active).length,console.log("NOTICE: name property is not defined for tooltip, could lead to too many instances")),r=r.replace(/[\s\.#]/g,"_"),I.active[r]?(s=I.active[r],s.prevOptions=s.options,s.options=i,s.anchor=e,(s.prevOptions.html!=s.options.html||s.prevOptions.class!=s.options.class||s.prevOptions.style!=s.options.style)&&(s.needsUpdate=!0),i=s.options,Object.keys(s).forEach(a=>{let h=s[a];a.startsWith("on")&&typeof h=="function"&&delete s[a]})):(s=new Y,Object.assign(s,{id:"w2overlay-"+r,name:r,options:i,anchor:e,self:l,displayed:!1,tmp:{observeResize:new ResizeObserver(()=>{this.resize(s.name)})},hide(){l.hide(r)}}),I.active[r]=s),Object.keys(s.options).forEach(a=>{let h=s.options[a];a.startsWith("on")&&typeof h=="function"&&(s[a]=h,delete s.options[a])}),i.autoShow===!0&&(i.autoShowOn=i.autoShowOn??"mouseenter",i.autoHideOn=i.autoHideOn??"mouseleave",i.autoShow=!1,i._keep=!0),i.autoShowOn){let a="autoShow-"+s.name;o(e).off(`.${a}`).on(`${i.autoShowOn}.${a}`,h=>{l.show(s.name),h.stopPropagation()}),delete i.autoShowOn,i._keep=!0}if(i.autoHideOn){let a="autoHide-"+s.name;o(e).off(`.${a}`).on(`${i.autoHideOn}.${a}`,h=>{l.hide(s.name),h.stopPropagation()}),delete i.autoHideOn,i._keep=!0}s.off(".attach");let n={overlay:s,then:a=>(s.on("show:after.attach",h=>{a(h)}),n),show:a=>(s.on("show.attach",h=>{a(h)}),n),hide:a=>(s.on("hide.attach",h=>{a(h)}),n),update:a=>(s.on("update.attach",h=>{a(h)}),n),move:a=>(s.on("move.attach",h=>{a(h)}),n)};return n}update(e,t){let i=I.active[e];i?(i.needsUpdate=!0,i.options.html=t,this.show(e)):console.log(`Tooltip "${e}" is not displayed. Cannot update it.`)}show(e){if(e instanceof HTMLElement||e instanceof Object){let g=e;e instanceof HTMLElement&&(g=arguments[1]||{},g.anchor=e);let c=this.attach(g);return c.overlay.tmp.hidden=!1,o(c.overlay.anchor).off(".autoShow-"+c.overlay.name).off(".autoHide-"+c.overlay.name),setTimeout(()=>{c.overlay.tmp.hidden||(this.show(c.overlay.name),this.initControls&&this.initControls(c.overlay))},1),c}let t,i=this,s=I.active[e.replace(/[\s\.#]/g,"_")];if(!s)return;let l=s.options;if(!s||s.displayed&&!s.needsUpdate){this.resize(s?.name);return}let r=l.position.split("|"),n=["top","bottom"].includes(r[0]),a=l.align=="both"&&n?"":"white-space: nowrap;";if(l.maxWidth&&u.getStrWidth(l.html,"")>l.maxWidth&&(a="width: "+l.maxWidth+"px; white-space: inherit; overflow: auto;"),a+=" max-height: "+(l.maxHeight?l.maxHeight:window.innerHeight-4)+"px;",l.html===""||l.html==null){i.hide(e);return}else if(s.box){if(t=this.trigger("update",{target:e,overlay:s}),t.isCancelled===!0){s.prevOptions&&(s.options=s.prevOptions,delete s.prevOptions);return}o(s.box).find(".w2ui-overlay-body").attr("style",(l.style||"")+"; "+a).removeClass().addClass("w2ui-overlay-body "+l.class).html(l.html),this.resize(s.name)}else{if(t=this.trigger("show",{target:e,overlay:s}),t.isCancelled===!0)return;o("body").append(`<div id="${s.id}" name="${e}" style="display: none; pointer-events: none" class="w2ui-overlay"
                        data-click="stop" data-focusin="stop">
                    <style></style>
                    <div class="w2ui-overlay-body ${l.class}" style="${l.style||""}; ${a}">
                        ${l.html}
                    </div>
                </div>`),s.box=o("#"+u.escapeId(s.id))[0],s.displayed=!0;let g=o(s.anchor).data("tooltipName")??[];g.push(e),o(s.anchor).data("tooltipName",g),u.bindEvents(s.box,{}),s.tmp.originalCSS="",o(s.anchor).length>0&&(s.tmp.originalCSS=o(s.anchor)[0].style.cssText),this.resize(s.name)}return l.anchorStyle&&(s.anchor.style.cssText+=";"+l.anchorStyle),l.anchorClass&&(l.anchorClass=="w2ui-focus"&&s.anchor==document.body||o(s.anchor).addClass(l.anchorClass)),typeof l.hideOn=="string"&&(l.hideOn=[l.hideOn]),Array.isArray(l.hideOn)||(l.hideOn=[]),Object.assign(s.tmp,{scrollLeft:document.body.scrollLeft,scrollTop:document.body.scrollTop}),d(),h(document.body),o(s.box).show(),s.tmp.observeResize.observe(s.box),I.observeRemove.observe(document.body,{subtree:!0,childList:!0}),o(s.box).css("opacity",1).find(".w2ui-overlay-body").html(l.html),setTimeout(()=>{o(s.box).css({"pointer-events":"auto"}).data("ready","yes")},100),delete s.needsUpdate,s.box.overlay=s,t&&t.finish(),{overlay:s};function h(g){let c="tooltip-"+s.name,p=g;g.tagName=="BODY"&&(p=g.ownerDocument),o(p).off(`.${c}`).on(`scroll.${c}`,f=>{Object.assign(s.tmp,{scrollLeft:g.scrollLeft,scrollTop:g.scrollTop}),i.resize(s.name)})}function d(){let g=f=>{i.hide(s.name)},c=o(s.anchor),p="tooltip-"+s.name;o("html").off(`.${p}`),l.hideOn.includes("doc-click")&&(["INPUT","TEXTAREA"].includes(s.anchor.tagName)&&c.off(`.${p}-doc`).on(`click.${p}-doc`,f=>{f.stopPropagation()}),o("html").on(`click.${p}`,g)),l.hideOn.includes("focus-change")&&o("html").on(`focusin.${p}`,f=>{document.activeElement!=s.anchor&&i.hide(s.name)}),["INPUT","TEXTAREA"].includes(s.anchor.tagName)&&(c.off(`.${p}`),l.hideOn.forEach(f=>{["doc-click","focus-change"].indexOf(f)==-1&&c.on(`${f}.${p}`,{once:!0},g)}))}}hide(e){let t;if(arguments.length==0){Object.keys(I.active).forEach(a=>{this.hide(a)});return}if(e instanceof HTMLElement){(o(e).data("tooltipName")??[]).forEach(h=>{this.hide(h)});return}if(typeof e=="string"&&(e=e.replace(/[\s\.#]/g,"_"),t=I.active[e]),t?.tmp&&(t.tmp.hidden=!0),!t||!t.box)return;let i=this.trigger("hide",{target:e,overlay:t});if(i.isCancelled===!0)return;t.options._keep||delete I.active[e];let s="tooltip-"+t.name;t.tmp.observeResize?.disconnect(),t.options.watchScroll&&o(t.options.watchScroll).off(".w2scroll-"+t.name);let l=0;Object.keys(I.active).forEach(a=>{I.active[a].displayed&&l++}),l==0&&I.observeRemove.disconnect(),o("html").off(`.${s}`),o(document).off(`.${s}`),t.box?.remove(),t.box=null,t.displayed=!1;let r=o(t.anchor).data("tooltipName")??[];r.indexOf(t.name)!=-1&&r.splice(r.indexOf(t.name),1),r.length==0?o(t.anchor).removeData("tooltipName"):o(t.anchor).data("tooltipName",r),t.options.anchorStyle&&(t.anchor.style.cssText=t.tmp.originalCSS),o(t.anchor).off(`.${s}`).removeClass(t.options.anchorClass),t.options.url&&(t.options.items.splice(0),t.tmp.remote.hasMore=!0,t.tmp.remote.search=null),i.finish()}resize(e){if(arguments.length==0){Object.keys(I.active).forEach(r=>{let n=I.active[r];n.displayed&&this.resize(n.name)});return}let t=I.active[e.replace(/[\s\.#]/g,"_")],i=this.getPosition(t.name),s=i.left+"x"+i.top,l;t.tmp.lastPos!=s&&(l=this.trigger("move",{target:e,overlay:t,pos:i})),o(t.box).css({left:i.left+"px",top:i.top+"px"}).then(r=>{i.width!=null&&r.css("width",i.width+"px").find(".w2ui-overlay-body").css("width","100%"),i.height!=null&&r.css("height",i.height+"px").find(".w2ui-overlay-body").css("height","100%")}).find(".w2ui-overlay-body").removeClass("w2ui-arrow-right w2ui-arrow-left w2ui-arrow-top w2ui-arrow-bottom").addClass(i.arrow.class).closest(".w2ui-overlay").find("style").text(i.arrow.style),t.tmp.lastPos!=s&&l&&(t.tmp.lastPos=s,l.finish())}getPosition(e){let t=I.active[e.replace(/[\s\.#]/g,"_")];if(!t||!t.box)return;let i=t.options;(t.tmp.resizedY||t.tmp.resizedX)&&o(t.box).css({width:"",height:"",scroll:"auto"});let s=u.scrollBarSize(),l=document.body.scrollWidth!=document.body.clientWidth,r=document.body.scrollHeight!=document.body.clientHeight,n={width:window.innerWidth-(r?s:0),height:window.innerHeight-(l?s:0)},a=i.position=="auto"?"top|bottom|right|left".split("|"):Array.isArray(i.position)?i.position:i.position.split("|"),h=["top","bottom"].includes(a[0]),d=t.box.getBoundingClientRect(),g=t.anchor?.getBoundingClientRect?.();if(t.anchor==document.body){let T=i.originalEvent;for(;T?.originalEvent;)T=T.originalEvent;let{x:R,y:E,width:z,height:M}=T??{x:i.x,y:i.y,width:0,height:10};g={left:R-(i.contextMenu?4:0),top:E-(i.contextMenu?4:0),width:z??0,height:M??10,arrow:i.contextMenu?"none":null}}let c=i.arrowSize;g.arrow=="none"&&(c=0);let p={top:g.top-c,bottom:n.height-c-(g.top+g.height)-(l?s:0)-2,left:g.left,right:n.width-(g.left+g.width)+(r?s:0)};d.width<22&&(d.width=22),d.height<14&&(d.height=14);let f,m,w,b,y="",x={offset:0,class:"",style:`#${t.id} { --tip-size: ${c}px; }`},C={left:0,top:0},_={posX:"",x:0,posY:"",y:0};a.forEach(T=>{["top","bottom"].includes(T)&&(!y&&d.height+c/1.893<p[T]&&(y=T),p[T]>_.y&&Object.assign(_,{posY:T,y:p[T]})),["left","right"].includes(T)&&(!y&&d.width+c/1.893<p[T]&&(y=T),p[T]>_.x&&Object.assign(_,{posX:T,x:p[T]}))}),y||(h?y=_.posY:y=_.posX),i.autoResize&&(["top","bottom"].includes(y)&&(d.height>p[y]?(b=p[y],t.tmp.resizedY=!0):t.tmp.resizedY=!1),["left","right"].includes(y)&&(d.width>p[y]?(w=p[y],t.tmp.resizedX=!0):t.tmp.resizedX=!1)),D(y),h&&S(),m+=parseFloat(i.offsetY*(y=="top"?-1:1)),f+=parseFloat(i.offsetX*(y=="left"?-1:1)),A();let v=y=="top"?-i.margin:y=="bottom"?i.margin:0,k=y=="left"?-i.margin:y=="right"?i.margin:0;return m=Math.floor((m+parseFloat(v))*100)/100,f=Math.floor((f+parseFloat(k))*100)/100,{left:f,top:m,arrow:x,adjust:C,width:w,height:b,pos:y};function D(T){switch(x.class=g.arrow?g.arrow:`w2ui-arrow-${T}`,T){case"top":{f=g.left+(g.width-(w??d.width))/2,m=g.top-(b??d.height)-c/1.5+1;break}case"bottom":{f=g.left+(g.width-(w??d.width))/2,m=g.top+g.height+c/1.25+1;break}case"left":{f=g.left-(w??d.width)-c/1.2-1,m=g.top+(g.height-(b??d.height))/2;break}case"right":{f=g.left+g.width+c/1.2+1,m=g.top+(g.height-(b??d.height))/2;break}}}function S(){if(i.align=="left"&&(C.left=g.left-f,f=g.left),i.align=="right"&&(C.left=g.left+g.width-(w??d.width)-f,f=g.left+g.width-(w??d.width)),["top","bottom"].includes(y)&&i.align.startsWith("both")){let T=i.align.split(":")[1]??50;g.width>=T&&(f=g.left,w=g.width)}if(i.align=="top"&&(C.top=g.top-m,m=g.top),i.align=="bottom"&&(C.top=g.top+g.height-(b??d.height)-m,m=g.top+g.height-(b??d.height)),["left","right"].includes(y)&&i.align.startsWith("both")){let T=i.align.split(":")[1]??50;g.height>=T&&(m=g.top,b=g.height)}}function A(){let T;(["left","right"].includes(i.align)&&g.width<(w??d.width)||["top","bottom"].includes(i.align)&&g.height<(b??d.height))&&(T=!0);let R=y=="right"?c:i.screenMargin,E=y=="bottom"?c:i.screenMargin,z=n.width-(w??d.width)-(y=="left"?c:i.screenMargin),M=n.height-(b??d.height)-(y=="top"?c:i.screenMargin)+3;if((["top","bottom"].includes(y)||i.autoResize)&&(f<R&&(T=!0,C.left-=f,f=R),f>z&&(T=!0,C.left-=f-z,f+=z-f)),(["left","right"].includes(y)||i.autoResize)&&(m<E&&(T=!0,C.top-=m,m=E),m>M&&(T=!0,C.top-=m-M,m+=M-m)),T){let L=h?"left":"top",H=h?"width":"height";x.offset=-C[L];let P=d[H]/2-c;Math.abs(x.offset)>P+c&&(x.class=""),Math.abs(x.offset)>P&&(x.offset=x.offset<0?-P:P),x.style=u.stripSpaces(`#${t.id} .w2ui-overlay-body:after,
                            #${t.id} .w2ui-overlay-body:before {
                                --tip-size: ${c}px;
                                margin-${L}: ${x.offset}px;
                            }`)}}}},xe=class extends V{constructor(){super(),this.palette=[["000000","333333","555555","777777","888888","999999","AAAAAA","CCCCCC","DDDDDD","EEEEEE","F7F7F7","FFFFFF"],["FF011B","FF9838","FFC300","FFFD59","86FF14","14FF7A","2EFFFC","2693FF","006CE7","9B24F4","FF21F5","FF0099"],["FFEAEA","FCEFE1","FCF4DC","FFFECF","EBFFD9","D9FFE9","E0FFFF","E8F4FF","ECF4FC","EAE6F4","FFF5FE","FCF0F7"],["F4CCCC","FCE5CD","FFF1C2","FFFDA1","D5FCB1","B5F7D0","BFFFFF","D6ECFF","CFE2F3","D9D1E9","FFE3FD","FFD9F0"],["EA9899","F9CB9C","FFE48C","F7F56F","B9F77E","84F0B1","83F7F7","B5DAFF","9FC5E8","B4A7D6","FAB9F6","FFADDE"],["E06666","F6B26B","DEB737","E0DE51","8FDB48","52D189","4EDEDB","76ACE3","6FA8DC","8E7CC3","E07EDA","F26DBD"],["CC0814","E69138","AB8816","B5B20E","6BAB30","27A85F","1BA8A6","3C81C7","3D85C6","674EA7","A14F9D","BF4990"],["99050C","B45F17","80650E","737103","395E14","10783D","13615E","094785","0A5394","351C75","780172","782C5A"]],this.defaults=u.extend({},this.defaults,{advanced:!1,transparent:!0,position:"top|bottom",class:"w2ui-white",color:"",updateInput:!0,arrowSize:12,autoResize:!1,anchorClass:"w2ui-focus",autoShowOn:"focus",hideOn:["doc-click","focus-change"],onSelect:null,onLiveUpdate:null})}attach(e,t){let i;arguments.length==1&&e instanceof Object?(i=e,e=i.anchor):arguments.length===2&&t!=null&&typeof t=="object"&&(i=t,i.anchor=e);let s=i.hideOn;i=u.extend({},this.defaults,i||{}),s&&(i.hideOn=s),i.style+="; padding: 0;",i.transparent&&this.palette[0][1]=="333333"&&(this.palette[0].splice(1,1),this.palette[0].push("TRANSPARENT")),!i.transparent&&this.palette[0][1]!="333333"&&(this.palette[0].splice(1,0,"333333"),this.palette[0].pop()),i.color&&(i.color=String(i.color).toUpperCase()),typeof i.color=="string"&&i.color.substr(0,1)==="#"&&(i.color=i.color.substr(1)),this.index=[-1,-1];let l=super.attach(i),r=l.overlay;return r.options.html=this.getColorHTML(r.name,i),r.on("show.attach",n=>{let a=n.detail.overlay,h=a.anchor,d=a.options;["INPUT","TEXTAREA"].includes(h.tagName)&&!d.color&&h.value&&(a.tmp.initColor=h.value),delete a.newColor}),r.on("show:after.attach",n=>{if(l.overlay?.box){let a=o(l.overlay.box).find(".w2ui-eaction");u.bindEvents(a,this),this.initControls(l.overlay)}}),r.on("update:after.attach",n=>{if(l.overlay?.box){let a=o(l.overlay.box).find(".w2ui-eaction");u.bindEvents(a,this),this.initControls(l.overlay)}}),r.on("hide.attach",n=>{let a=n.detail.overlay,h=a.anchor,d=a.newColor??a.options.color??"";if(d!==""){["INPUT","TEXTAREA"].includes(h.tagName)&&h.value!=d&&a.options.updateInput&&(h.value=d);let g=this.trigger("select",{color:d,target:a.name,overlay:a});if(g.isCancelled===!0)return;g.finish()}}),l.liveUpdate=n=>(r.on("liveUpdate.attach",a=>{n(a)}),l),l.select=n=>(r.on("select.attach",a=>{n(a)}),l),l}select(e,t){let i;this.index=[-1,-1],typeof t!="string"&&(i=t.target,this.index=o(i).attr("index").split(":"),t=o(i).closest(".w2ui-overlay").attr("name"));let s=this.get(t),l=this.trigger("liveUpdate",{color:e,target:t,overlay:s,param:arguments[1]});l.isCancelled!==!0&&(["INPUT","TEXTAREA"].includes(s.anchor.tagName)&&s.options.updateInput&&o(s.anchor).val(e),s.newColor=e,o(s.box).find(".w2ui-color.w2ui-selected").removeClass("w2ui-selected"),i&&o(i).addClass("w2ui-selected"),l.finish())}nextColor(e){let t=this.palette;switch(e){case"up":this.index[0]--;break;case"down":this.index[0]++;break;case"right":this.index[1]++;break;case"left":this.index[1]--;break}return this.index[0]<0&&(this.index[0]=0),this.index[0]>t.length-2&&(this.index[0]=t.length-2),this.index[1]<0&&(this.index[1]=0),this.index[1]>t[0].length-1&&(this.index[1]=t[0].length-1),t[this.index[0]][this.index[1]]}tabClick(e,t){typeof t!="string"&&(t=o(t.target).closest(".w2ui-overlay").attr("name"));let i=this.get(t),s=o(i.box).find(`.w2ui-color-tab:nth-child(${e})`);o(i.box).find(".w2ui-color-tab").removeClass("w2ui-selected"),o(s).addClass("w2ui-selected"),o(i.box).find(".w2ui-tab-content").hide().closest(".w2ui-colors").find(".tab-"+e).show()}getColorHTML(e,t){let i=`
            <div class="w2ui-colors">
                <div class="w2ui-tab-content tab-1">`;for(let s=0;s<this.palette.length;s++){i+='<div class="w2ui-color-row">';for(let l=0;l<this.palette[s].length;l++){let r=this.palette[s][l],n="";r==="FFFFFF"&&(n="; border: 1px solid #efefef"),i+=`
                    <div class="w2ui-color w2ui-eaction ${r==="TRANSPARENT"?"w2ui-no-color":""} ${t.color==r?"w2ui-selected":""}"
                        style="background-color: #${r+n};" name="${r}" index="${s}:${l}"
                        data-mousedown="select|'${r}'|event" data-mouseup="hide|${e}">&nbsp;
                    </div>`}i+="</div>",s<2&&(i+='<div style="height: 8px"></div>')}return i+="</div>",i+=`
            <div class="w2ui-tab-content tab-2" style="display: none">
                <div class="color-info">
                    <div class="color-preview-bg"><div class="color-preview"></div><div class="color-original"></div></div>
                    <div class="color-part">
                        <span>H</span> <input class="w2ui-input" name="h" maxlength="3" max="360" tabindex="101">
                        <span>R</span> <input class="w2ui-input" name="r" maxlength="3" max="255" tabindex="104">
                    </div>
                    <div class="color-part">
                        <span>S</span> <input class="w2ui-input" name="s" maxlength="3" max="100" tabindex="102">
                        <span>G</span> <input class="w2ui-input" name="g" maxlength="3" max="255" tabindex="105">
                    </div>
                    <div class="color-part">
                        <span>V</span> <input class="w2ui-input" name="v" maxlength="3" max="100" tabindex="103">
                        <span>B</span> <input class="w2ui-input" name="b" maxlength="3" max="255" tabindex="106">
                    </div>
                    <div class="color-part opacity">
                        <span>${u.lang("Opacity")}</span>
                        <input class="w2ui-input" name="a" maxlength="5" max="1" tabindex="107">
                    </div>
                </div>
                <div class="palette" name="palette">
                    <div class="palette-bg"></div>
                    <div class="value1 move-x move-y"></div>
                </div>
                <div class="rainbow" name="rainbow">
                    <div class="value2 move-x"></div>
                </div>
                <div class="alpha" name="alpha">
                    <div class="alpha-bg"></div>
                    <div class="value2 move-x"></div>
                </div>
            </div>`,i+=`
            <div class="w2ui-color-tabs">
                <div class="w2ui-color-tab w2ui-selected w2ui-eaction" data-click="tabClick|1|event|this"><span class="w2ui-icon w2ui-icon-colors"></span></div>
                <div class="w2ui-color-tab w2ui-eaction" data-click="tabClick|2|event|this"><span class="w2ui-icon w2ui-icon-settings"></span></div>
                <div style="padding: 5px; width: 100%; text-align: right;">
                    ${typeof t.html=="string"?t.html:""}
                </div>
            </div>`,i}initControls(e){let t,i=this,s=e.options,l=s.color||e.tmp.initColor,r=u.parseColor(l);r==null&&(r={r:140,g:150,b:160,a:1});let n=u.rgb2hsv(r);s.advanced===!0&&this.tabClick(2,e.name),g(n,!0,l??""),o(e.box).off(".w2color").on("contextmenu.w2color",b=>{b.preventDefault()}).find("input").off(".w2color").on("change.w2color",b=>{let y=o(b.target),x=parseFloat(y.val()),C=parseFloat(y.attr("max"));isNaN(x)&&(x=0,y.val(0)),C>1&&(x=parseInt(x)),C>0&&x>C&&(y.val(C),x=C),x<0&&(y.val(0),x=0);let _=y.attr("name"),v={};["r","g","b","a"].indexOf(_)!==-1?(r[_]=x,n=u.rgb2hsv(r)):["h","s","v"].indexOf(_)!==-1&&(v[_]=x),g(v,!0)}),o(e.box).find(".color-original").off(".w2color").on("click.w2color",b=>{let y=u.parseColor(o(b.target).css("background-color"));y!=null&&(r=y,n=u.rgb2hsv(r),g(n,!0))});let a=`${u.isMobile?"touchstart":"mousedown"}.w2color`,h=`${u.isMobile?"touchend":"mouseup"}.w2color`,d=`${u.isMobile?"touchmove":"mousemove"}.w2color`;o(e.box).find(".palette, .rainbow, .alpha").off(".w2color").on(`${a}.w2color`,f);return;function g(b,y,x){b.h!=null&&(n.h=b.h),b.s!=null&&(n.s=b.s),b.v!=null&&(n.v=b.v),b.a!=null&&(r.a=b.a,n.a=b.a),r=u.hsv2rgb(n);let C="rgba("+r.r+","+r.g+","+r.b+","+r.a+")",_=[Number(r.r).toString(16).toUpperCase(),Number(r.g).toString(16).toUpperCase(),Number(r.b).toString(16).toUpperCase(),Math.round(Number(r.a)*255).toString(16).toUpperCase()];if(_.forEach((v,k)=>{v.length===1&&(_[k]="0"+v)}),C=_[0]+_[1]+_[2]+_[3],r.a===1&&(C=_[0]+_[1]+_[2]),o(e.box).find(".color-preview").css("background-color","#"+C),o(e.box).find("input").each(v=>{v.name&&(r[v.name]!=null&&(v.value=r[v.name]),n[v.name]!=null&&(v.value=n[v.name]),v.name==="a"&&(v.value=r.a))}),x!=null){let v=e.tmp.initColor||C;o(e.box).find(".color-original").css("background-color","#"+v),o(e.box).find(".w2ui-color.w2ui-selected").removeClass("w2ui-selected"),o(e.box).find(`.w2ui-colors [name="${v}"], .w2ui-colors [name="${x}"]`).addClass("w2ui-selected"),C.length==8&&i.tabClick(2,e.name)}else i.select(C,e.name);y&&(c(),p())}function c(){let b=o(e.box).find(".palette .value1"),y=o(e.box).find(".rainbow .value2"),x=o(e.box).find(".alpha .value2");if(!b[0]||!y[0]||!x[0])return;let C=parseInt(b[0].clientWidth)/2,_=parseInt(y[0].clientWidth)/2;b.css({left:n.s*150/100-C+"px",top:(100-n.v)*125/100-C+"px"}),y.css("left",n.h/(360/150)-_+"px"),x.css("left",r.a*150-_+"px")}function p(){let b=u.hsv2rgb(n.h,100,100),y=`${b.r},${b.g},${b.b}`;o(e.box).find(".palette").css("background-image",`linear-gradient(90deg, rgba(${y},0) 0%, rgba(${y},1) 100%)`)}function f(b){let y=o(this).find(".value1, .value2"),x=parseInt(y.prop("clientWidth"))/2;y.hasClass("move-x")&&y.css({left:b.offsetX-x+"px"}),y.hasClass("move-y")&&y.css({top:b.offsetY-x+"px"}),t={el:y,x:b.pageX,y:b.pageY,width:y.prop("parentNode").clientWidth,height:y.prop("parentNode").clientHeight,left:parseInt(y.css("left")),top:parseInt(y.css("top"))},w(b),o("html").off(".w2color").on(d,w).on(h,m)}function m(b){o("html").off(".w2color")}function w(b){let y=t.el,x=b.pageX-t.x,C=b.pageY-t.y,_=t.left+x,v=t.top+C,k=parseInt(y.prop("clientWidth"))/2;_<-k&&(_=-k),v<-k&&(v=-k),_>t.width-k&&(_=t.width-k),v>t.height-k&&(v=t.height-k),y.hasClass("move-x")&&y.css({left:_+"px"}),y.hasClass("move-y")&&y.css({top:v+"px"});let D=o(y.get(0).parentNode).attr("name"),S=parseInt(y.css("left"))+k,A=parseInt(y.css("top"))+k;if(D==="palette"&&g({s:Math.round(S/t.width*100),v:Math.round(100-A/t.height*100)}),D==="rainbow"){let T=Math.round(2.4*S);g({h:T}),p()}D==="alpha"&&g({a:parseFloat(Number(S/150).toFixed(2))})}}},ve=class extends V{constructor(){super(),this.defaults=u.extend({},this.defaults,{type:"normal",items:[],index:null,render:null,spinner:!1,msgNoItems:u.lang("No items found"),topHTML:"",menuStyle:"",filter:!1,markSearch:!1,prefilter:!1,match:"contains",search:!1,altRows:!1,arrowSize:10,align:"left",position:"bottom|top",class:"w2ui-white",anchorClass:"w2ui-focus",autoShowOn:"focus",hideOn:["doc-click","focus-change","select"],onSelect:null,onSubMenu:null,onRemove:null})}attach(e,t){let i;arguments.length==1&&e instanceof Object?(i=e,e=i.anchor):arguments.length===2&&t!=null&&typeof t=="object"&&(i=t,i.anchor=e);let s=i.hideOn;i=u.extend({},this.defaults,i||{}),s&&(i.hideOn=s),i.style+="; padding: 0;",i.items==null&&(i.items=[]),i.cacheMax<=0&&console.log(`The option "cacheMax" is ${i.cacheMax} but should be more than 0`),i.items=u.normMenu(i.items),i.html=this.getMenuHTML(i);let l=super.attach(i),r=l.overlay;return r.on("show:after.attach, update:after.attach",n=>{if(l.overlay?.box){let a="";r.selected=null,["INPUT","TEXTAREA"].includes(r.anchor.tagName)&&(a=r.anchor.value,r.selected=r.anchor.dataset.selectedIndex);let h=o(l.overlay.box).find(".w2ui-eaction");u.bindEvents(h,this),this.applyFilter(r.name,null,a).then(d=>{V.active[r.name].displayed&&(r.tmp.searchCount=d.count,r.tmp.search=d.search,i.prefilter&&this.refreshSearch(r.name),this.initControls(l.overlay),this.refreshIndex(r.name,!0))})}}),r.next=()=>{let n=this.getActiveChain(r.name);if(r.selected==null||r.selected?.length==0)r.selected=n[0];else{let a=n.indexOf(r.selected);a==-1&&(r.selected=n[0]),a<n.length-1&&(r.selected=n[a+1])}this.refreshIndex(r.name)},r.prev=()=>{let n=this.getActiveChain(r.name);if(r.selected==null||r.selected?.length==0)r.selected=n[n.length-1];else{let a=n.indexOf(r.selected);a==-1&&(r.selected=n[n.length-1]),a>0&&(r.selected=n[a-1])}this.refreshIndex(r.name)},r.click=()=>{$(r.box).find(".w2ui-selected").click()},r.on("hide:after.attach",n=>{O.hide(r.name+"-tooltip")}),l.select=n=>(r.on("select.attach",a=>{n(a)}),l),l.remove=n=>(r.on("remove.attach",a=>{n(a)}),l),l.subMenu=n=>(r.on("subMenu.attach",a=>{n(a)}),l),l}update(e,t){let i=V.active[e];if(i){let s=i.options;s.items!=t&&(s.items=t);let l=this.getMenuHTML(s);s.html!=l&&(s.html=l,i.needsUpdate=!0,this.show(e))}else console.log(`Tooltip "${e}" is not displayed. Cannot update it.`)}initControls(e){o(e.box).find(".w2ui-menu:not(.w2ui-sub-menu)").off(".w2menu").on("contextmenu.w2menu",t=>{t.preventDefault()}).on("mouseDown.w2menu",{delegate:".w2ui-menu-item"},t=>{let i=t.delegate.dataset;this.menuDown(e,t,i.index,i.parents)}).on((u.isMobile?"touchStart":"click")+".w2menu",{delegate:".w2ui-menu-item"},t=>{let i=t.delegate.dataset;this.menuClick(e,t,parseInt(i.index),i.parents)}).find(".w2ui-menu-item").off(".w2menu").on("mouseEnter.w2menu",t=>{let i=t.target.dataset,s=e.options.items[i.index]?.tooltip;s&&O.show({name:e.name+"-tooltip",anchor:t.target,html:s,position:"right|left",hideOn:["doc-click"]});let l=o(t.target).closest(".w2ui-menu").get(0);if(l._evt&&l._evt.target!=t.target&&this.closeSubMenu(l._evt),i.hassubmenu=="yes"){let r={index:parseInt(i.index),parents:l.dataset.parents!==""?l.dataset.parents.split("-").map(n=>parseInt(n)):[],target:t.target,originalEvent:t,overlay:e};l._evt=r,this.openSubMenu(r)}}).on("mouseLeave.w2menu",t=>{O.hide(e.name+"-tooltip")}).find(".menu-help").off(".w2menu").on("mouseEnter.w2menu",t=>{let i=t.target.parentNode.parentNode.dataset,s=e.options.items[i.index]?.help;s&&O.show({name:e.name+"-help-tp",anchor:t.target,html:s,position:"right|left",hideOn:["doc-click"]})}).on("mouseLeave.w2menu",t=>{O.hide(e.name+"-help-tp")}),["INPUT","TEXTAREA"].includes(e.anchor.tagName)&&o(e.anchor).off(".w2menu").on("input.w2menu",t=>{}).on("keyup.w2menu",t=>{t._searchType="filter",this.keyUp(e,t)}),e.options.search&&o(e.box).find("#menu-search").off(".w2menu").on("keyup.w2menu",t=>{t._searchType="search",this.keyUp(e,t)})}getCurrent(e,t){let i=V.active[e.replace(/[\s\.#]/g,"_")],s=i.options,l=(t||(i.selected??"")).split("-"),r=l.length-1,n=l[r],a=l.slice(0,l.length-1).join("-");n=u.isInt(n)?parseInt(n):0;let h=s.items;return l.forEach((d,g)=>{g<l.length-1&&(h=h[d].items)}),{last:r,index:n,items:h,item:h[n],parents:a}}getMenuHTML(e){if(e.spinner)return`
            <div class="w2ui-menu">
                <div class="w2ui-no-items">
                    <div class="w2ui-spinner"></div>
                    ${u.lang("Loading...")}
                </div>
            </div>`;let t=e.parents??[],i=e.items;Array.isArray(i)||(i=[]);let s=0,l=null,r="";e.search&&(r+=`
                <div class="w2ui-menu-search">
                    <span class="w2ui-icon w2ui-icon-search"></span>
                    <input id="menu-search" class="w2ui-input" type="text"/>
                </div>`,i.forEach(a=>a.hidden=!1)),e.topHTML&&(r+=`<div class="w2ui-menu-top">${e.topHTML}</div>`);let n=`
            ${r}
            <div class="w2ui-menu" style="${e.menuStyle}" data-parents="${t.join("-")}">
        `;if(i.forEach((a,h)=>{l=a.icon;let d=(t.length>0?t.join("-")+"-":"")+h;if(l==null&&(l=null),["radio","check"].indexOf(e.type)!=-1&&!Array.isArray(a.items)&&a.group!==!1&&(a.checked===!0?l="w2ui-icon-check":l="w2ui-icon-empty"),a.hidden!==!0){let g=a.text,c="";if(typeof e.render=="function"&&(g=e.render(a,e)),typeof g=="function"&&(g=g(a,e)),l&&(String(l).slice(0,1)!=="<"&&(l=`<span class="w2ui-icon ${l}"></span>`),c=`<div class="menu-icon">${l}</span></div>`),a.removable==null&&a.remove!=null&&(a.removable=a.remove),a.type!=="break"&&g!=null&&g!==""&&String(g).substr(0,2)!="--"){let p=["w2ui-menu-item"];e.altRows==!0&&p.push(s%2===0?"w2ui-even":"w2ui-odd");let f=1;c===""&&f++,a.count==null&&a.hotkey==null&&a.removable!==!0&&a.items==null&&f++,a.tooltip==null&&a.hint!=null&&(a.tooltip=a.hint);let m="";a.removable===!0?m='<span class="menu-remove">x</span>':a.items!=null?(p.push("has-sub-menu"),m='<span style="background-color: transparent; border: transparent; box-shadow: none;"></span>'):(a.count!=null&&(m+="<span>"+a.count+"</span>"),a.hotkey!=null&&(m+='<span class="menu-hotkey">'+a.hotkey+"</span>"),a.help!=null&&(m+='<span class="menu-help">?</span>')),a.disabled===!0&&p.push("w2ui-disabled"),a._noSearchInside===!0&&p.push("w2ui-no-search-inside"),n+=`
                        <div index="${d}" class="${p.join(" ")}" style="${a.style?a.style:""}"
                            data-index="${h}" data-hasSubmenu="${a.items!=null?"yes":""}">
                                <div style="width: ${parseInt(a.indent??0)}px"></div>
                                ${c}
                                <div class="menu-text" colspan="${f}">${u.lang(g)}</div>
                                <div class="menu-extra">${m}</div>
                        </div>`,s++}else{let p=(g??"").replace(/^-+/g,"");n+=`
                        <div index="${d}" class="w2ui-menu-divider ${p!=""?"has-text":""}">
                            <div class="line"></div>
                            ${p?`<div class="text">${p}</div>`:""}
                        </div>`}}i[h]=a}),s===0&&e.msgNoItems){let h=V.active[e.name.replace(/[\s\.#]/g,"_")]?.tmp.remote,d=e.msgNoItems;e.url&&(s==0&&h?.hasMore===!1?d=e.msgNoItems:d=e.msgSearch),n+=`
                <div class="w2ui-no-items">
                    ${u.lang(d)}
                </div>`}return n+="</div>",n}openSubMenu(e){let t=o(e.originalEvent.target).get(0),{overlay:i}=e,{items:s}=i.options,l=s[e.index],r=[];typeof l.items=="function"?r=l.items(l):Array.isArray(l.items)&&(r=l.items);let n=j.get(i.name+"-submenu");n&&n.hide(),o(e.target).addClass("expanded"),j.show({name:i.name+"-submenu",anchor:t,items:r,class:i.options.class,offsetX:-7,arrowSize:0,parentOverlay:i,parents:[...e.parents,e.index],position:"right|left",hideOn:["doc-click"]}).hide(a=>{o(e.target).removeClass("expanded")}).select(a=>{let h=a.detail.overlay.options.parents,d=i;for(;d.options.parentOverlay;)d=d.options.parentOverlay;this.menuClick(d,a.detail.originalEvent,parseInt(a.detail.index),h)}),setTimeout(()=>{o("#w2overlay-"+i.name+"-submenu").on("mouseenter",a=>{a.target._keepSubOpen=!0}).on("mouseleave",a=>{a.target._keepSubOpen=!1})},10)}closeSubMenu(e){let{overlay:t}=e;if(e.target._keepSubOpen!==!0){let i=j.get(t.name+"-submenu");i&&i.hide()}}refreshIndex(e,t){let i=V.active[e.replace(/[\s\.#]/g,"_")];if(!i)return;i.displayed||this.show(i.name);let s=o(i.box).find(".w2ui-overlay-body").get(0),l=o(i.box).find(".w2ui-menu-search, .w2ui-menu-top").get(0);o(i.box).find(".w2ui-menu-item.w2ui-selected").removeClass("w2ui-selected");let r=o(i.box).find(`.w2ui-menu-item[index="${i.selected}"]`).addClass("w2ui-selected").get(0);r&&(r.offsetTop+r.clientHeight>s.clientHeight+s.scrollTop&&r.scrollIntoView({behavior:t?"instant":"smooth",block:t?"center":"start",inline:t?"center":"start"}),r.offsetTop<s.scrollTop+(l?l.clientHeight:0)&&r.scrollIntoView({behavior:t?"instant":"smooth",block:t?"center":"end",inline:t?"center":"end"}))}refreshSearch(e){let t=V.active[e.replace(/[\s\.#]/g,"_")];t&&(t.displayed||this.show(t.name),o(t.box).find(".w2ui-no-items").hide(),o(t.box).find(".w2ui-menu-item, .w2ui-menu-divider").each(i=>{if(this.getCurrent(e,i.getAttribute("index")).item?.hidden)o(i).hide();else{let l=t.tmp?.search;t.options.markSearch&&u.marker(i,l,{onlyFirst:t.options.match=="begins"}),o(i).show()}}),o(t.box).find(".w2ui-sub-menu").each(i=>{let s=o(i).find(".w2ui-menu-item").get().some(r=>r.style.display!="none");this.getCurrent(e,i.dataset.parent).item.expanded&&(s?o(i).parent().show():o(i).parent().hide())}),(t.tmp.searchCount==0||t.options?.items?.length==0)&&(o(t.box).find(".w2ui-no-items").length==0&&o(t.box).find(".w2ui-menu:not(.w2ui-sub-menu)").append(`
                    <div class="w2ui-no-items">
                        ${u.lang(t.options.msgNoItems)}
                    </div>`),o(t.box).find(".w2ui-no-items").show()))}applyFilter(e,t,i,s){let l=0,r=V.active[e.replace(/[\s\.#]/g,"_")],n=r.options,a,h,d=new Promise((f,m)=>{a=f,h=m});i==null&&(["INPUT","TEXTAREA"].includes(r.anchor.tagName)?i=r.anchor.value:i="");let g=[];n.selected&&(Array.isArray(n.selected)?g=n.selected.map(f=>f?.id??f):n.selected?.id&&(g=[n.selected.id])),r.tmp.activeChain=null;let c=r.tmp.remote??{hasMore:!0,emptySet:!1,search:null,cached:-1};if(c.hasMore==!1){let f=c.hasMore_search.length;i.substr(0,f)!=c.hasMore_search&&(c.hasMore=!0)}if(t==null&&n.url&&c.hasMore&&c.search!==i){let f=!0,m=u.lang("Loading...");return i.length<n.minLength&&c.emptySet!==!0&&(m=u.lang("${count} letters or more...",{count:n.minLength}),f=!1,i===""&&(m=u.lang(n.msgSearch)),n.items?.length>0&&(this.update(e,[]),this.applyFilter(e,null,i))),o(r.box).find(".w2ui-no-items").html(m),c.search=i,n.items=[],r.tmp.remote=c,f&&this.request(r,i,s).then(w=>{this.update(e,w),this.applyFilter(e,null,i).then(b=>{a(b)})}).catch(w=>{console.log("Server Request error",w)}),d}let p;return t==null&&(p=this.trigger("search",{search:i,overlay:r,prom:d,resolve:a,reject:h}),p.isCancelled===!0)?d:(t==null&&(t=r.options.items),n.filter===!1?(a({count:-1,search:i}),d):(t.forEach(f=>{let m="",w="";["is","begins","begins with"].indexOf(n.match)!==-1&&(m="^"),["is","ends","ends with"].indexOf(n.match)!==-1&&(w="$");try{new RegExp(m+i+w,"i").test(f.text)||f.text==="..."?f.hidden=!1:f.hidden=!0}catch{}n.hideSelected&&g.includes(f.id)&&(f.hidden=!0),Array.isArray(f.items)&&f.items.length>0&&(delete f._noSearchInside,this.applyFilter(e,f.items,i).then(b=>{let y=b.count;y>0&&(l+=y,f.hidden&&(f._noSearchInside=!0),i&&(f.expanded=!0),f.hidden=!1)})),f.hidden!==!0&&l++}),a({count:l,search:i}),p?.finish(),d))}request(e,t,i){let s=e.options,l=e.tmp.remote,r,n;return(s.items.length===0&&l.cached!==0||l.cached==s.cacheMax&&t.length>l.search.length||t.length>=l.search.length&&t.substr(0,l.search.length)!==l.search||t.length<l.search.length)&&(l.controller&&l.controller.abort(),l.loading=!0,clearTimeout(l.timeout),l.timeout=setTimeout(()=>{let a=s.url,h={search:t,max:s.cacheMax};Object.assign(h,s.postData);let d=this.trigger("request",{search:t,overlay:e,url:a,postData:h,httpMethod:s.method??"GET",httpHeaders:{}});if(d.isCancelled===!0)return;a=new URL(d.detail.url,location);let g=u.prepareParams(a,{method:d.detail.httpMethod,headers:d.detail.httpHeaders,body:d.detail.postData});l.controller=new AbortController,g.signal=l.controller.signal,fetch(a,g).then(c=>c.json()).then(c=>{l.controller=null;let p=e.trigger("load",{search:h.search,overlay:e,data:c});if(p.isCancelled!==!0){if(c=p.detail.data,typeof c=="string"&&(c=JSON.parse(c)),Array.isArray(c)&&(c={records:c}),c.records==null&&c.items!=null&&(c.records=c.items,delete c.items),!c.error&&c.records==null&&(c.records=[]),!Array.isArray(c.records)){console.error("ERROR: server did not return proper data structure",`
`," - it should return",{records:[{id:1,text:"item"}]},`
`," - or just an array ",[{id:1,text:"item"}],`
`," - or if errorr ",{error:!0,message:"error message"});return}c.records.length>=s.cacheMax?(c.records.splice(s.cacheMax,c.records.length),l.hasMore=!0):(l.hasMore=!1,l.hasMore_search=t),s.recId==null&&s.recid!=null&&(s.recId=s.recid),(s.recId||s.recText)&&c.records.forEach(f=>{typeof s.recId=="string"&&(f.id=f[s.recId]),typeof s.recId=="function"&&(f.id=s.recId(f)),typeof s.recText=="string"&&(f.text=f[s.recText]),typeof s.recText=="function"&&(f.text=s.recText(f))}),l.loading=!1,l.search=t,l.cached=c.records.length==0?-1:c.records.length,l.lastError="",l.emptySet=t===""&&c.records.length===0,p.finish(),r(u.normMenu(c.records))}}).catch(c=>{let p=this.trigger("error",{overlay:e,search:t,error:c});p.isCancelled!==!0&&(c?.name!=="AbortError"&&console.error("ERROR: Server communication failed.",`
`," - it should return",{records:[{id:1,text:"item"}]},`
`," - or just an array ",[{id:1,text:"item"}],`
`," - or if errorr ",{error:!0,message:"error message"}),l.loading=!1,l.search="",l.cached=-1,l.emptySet=!0,l.lastError=p.detail.error||"Server communication failed",s.items=[],p.finish(),n())}),d.finish()},i?s.debounce??350:0)),new Promise((a,h)=>{r=a,n=h})}getActiveChain(e,t,i=[],s=[],l){let r=V.active[e.replace(/[\s\.#]/g,"_")];return r.tmp.activeChain!=null?r.tmp.activeChain:(t==null&&(t=r.options.items),t.forEach((n,a)=>{!n.hidden&&!n.disabled&&!n?.text?.startsWith("--")&&(s.push(i.concat([a]).join("-")),Array.isArray(n.items)&&n.items.length>0&&n.expanded&&(i.push(a),this.getActiveChain(e,n.items,i,s,!0),i.pop()))}),l==null&&(r.tmp.activeChain=s),s)}menuDown(e,t,i,s){let l=e.options,r=l.items,n=o(t.delegate).find(".w2ui-icon"),a=o(t.target).closest(".w2ui-menu:not(.w2ui-sub-menu)");typeof s=="string"&&s!==""&&s.split("-").forEach(c=>{r=r[c].items}),typeof r=="function"&&(r=r({overlay:e,index:i,parents:s,event:t}));let h=r[i];if(h==null||h.disabled)return;let d=(g,c)=>{g.forEach((p,f)=>{p.id!=h.id&&(p.group===h.group&&p.checked&&(a.find(`.w2ui-menu-item[index="${(c?c+"-":"")+f}"] .w2ui-icon`).removeClass("w2ui-icon-check").addClass("w2ui-icon-empty"),g[f].checked=!1),Array.isArray(p.items)&&d(p.items,f))})};(l.type==="check"||l.type==="radio")&&h.group!==!1&&!o(t.target).hasClass("menu-remove")&&!o(t.target).hasClass("menu-help")&&!o(t.target).closest(".w2ui-menu-item").hasClass("has-sub-menu")&&(h.checked=l.type=="radio"?!0:!h.checked,h.checked?(l.type==="radio"&&o(t.target).closest(".w2ui-menu").find(".w2ui-icon").removeClass("w2ui-icon-check").addClass("w2ui-icon-empty"),l.type==="check"&&h.group!=null&&d(l.items),n.removeClass("w2ui-icon-empty").addClass("w2ui-icon-check")):l.type==="check"&&n.removeClass("w2ui-icon-check").addClass("w2ui-icon-empty")),!o(t.target).hasClass("menu-remove")&&!o(t.target).hasClass("menu-help")&&(a.find(".w2ui-menu-item").removeClass("w2ui-selected"),o(t.delegate).hasClass("has-sub-menu")||o(t.delegate).addClass("w2ui-selected"))}menuClick(e,t,i,s){let l=e.options,r=l.items,n=o(t.delegate).closest(".w2ui-menu-item"),a=!l.hideOn.includes("select");(t.shiftKey||t.metaKey||t.ctrlKey)&&(a=!0),typeof s=="string"&&s!==""?s=s.split("-"):Array.isArray(s)||(s=null),s&&s.forEach(g=>{r=r[g].items}),typeof r=="function"&&(r=r({overlay:e,index:i,parents:s,event:t}));let h=r[i];if(!h||h.disabled&&!o(t.target).hasClass("menu-remove"))return;let d;if(o(t.target).hasClass("menu-remove")){if(d=this.trigger("remove",{originalEvent:t,target:e.name,overlay:e,item:h,index:i,parents:s,el:n[0]}),d.isCancelled===!0)return;a=!l.hideOn.includes("item-remove"),n.remove()}else if(n.hasClass("has-sub-menu")){if(d=this.trigger("subMenu",{originalEvent:t,target:e.name,overlay:e,item:h,index:i,parents:s,el:n[0]}),d.isCancelled===!0)return;a=!0}else{let g=this.findChecked(l.items);if(e.selected=parseInt(n.attr("index")),d=this.trigger("select",{originalEvent:t,target:e.name,overlay:e,item:h,index:i,parents:s,selected:g,keepOpen:a,el:n[0]}),d.isCancelled===!0)return;h.keepOpen!=null&&(a=h.keepOpen),["INPUT","TEXTAREA"].includes(e.anchor.tagName)&&(e.anchor.dataset.selected=h.id,e.anchor.dataset.selectedIndex=e.selected)}a||this.hide(e.name),d.finish()}findChecked(e){let t=[];return e.forEach(i=>{i.checked&&t.push(i),Array.isArray(i.items)&&(t=t.concat(this.findChecked(i.items)))}),t}keyUp(e,t){let i=e.options,s=t.target.value,l=!0,r=!1;switch(t.keyCode){case 46:case 8:{s===""&&!e.displayed&&(l=!1);break}case 13:{if(!e.displayed||!e.selected)return;let{index:n,parents:a}=this.getCurrent(e.name);t.delegate=o(e.box).find(".w2ui-selected").get(0),this.menuClick(e,t,parseInt(n),a),l=!1;break}case 27:{if(l=!1,e.displayed)this.hide(e.name);else{let n=e.anchor;["INPUT","TEXTAREA"].includes(n.tagName)&&(n.value="",delete n.dataset.selected,delete n.dataset.selectedIndex)}break}case 37:{if(!e.displayed)return;let{item:n,index:a,parents:h}=this.getCurrent(e.name);h&&(n=i.items[h],a=parseInt(h),h="",r=!0),Array.isArray(n?.items)&&n.items.length>0&&n.expanded&&(t.delegate=o(e.box).find(`.w2ui-menu-item[index="${a}"]`).get(0),e.selected=a,this.menuClick(e,t,parseInt(a),h)),l=!1;break}case 39:{if(!e.displayed)return;let{item:n,index:a,parents:h}=this.getCurrent(e.name);Array.isArray(n?.items)&&n.items.length>0&&!n.expanded&&(t.delegate=o(e.box).find(".w2ui-selected").get(0),this.menuClick(e,t,parseInt(a),h)),l=!1;break}case 38:{if(!e.displayed)break;e.prev(),l=!1,t.preventDefault();break}case 40:{if(!e.displayed)break;e.next(),l=!1,t.preventDefault();break}}l&&e.displayed&&(i.filter&&t._searchType=="filter"||i.search&&t._searchType=="search")&&this.applyFilter(e.name,null,s,!0).then(n=>{e.tmp.searchCount=n.count,e.tmp.search=n.search,(n.count===0||!this.getActiveChain(e.name).includes(e.selected))&&(e.selected=null),this.refreshSearch(e.name)}),r&&this.refreshIndex(e.name)}},_e=class extends V{constructor(){super();let e=new Date;this.daysCount=[31,28,31,30,31,30,31,31,30,31,30,31],this.today=e.getFullYear()+"/"+(Number(e.getMonth())+1)+"/"+e.getDate(),this.defaults=u.extend({},this.defaults,{position:"top|bottom",class:"w2ui-calendar",type:"date",value:"",format:"",start:null,end:null,btnNow:!1,blockDates:[],blockWeekdays:[],colored:{},arrowSize:12,autoResize:!1,anchorClass:"w2ui-focus",autoShowOn:"focus",hideOn:["doc-click","focus-change"],onSelect:null})}attach(e,t){let i;arguments.length==1&&e instanceof Object?(i=e,e=i.anchor):arguments.length===2&&t!=null&&typeof t=="object"&&(i=t,i.anchor=e);let s=i.hideOn;if(i=u.extend({},this.defaults,i||{}),s&&(i.hideOn=s),!i.format){let a=u.settings.dateFormat,h=u.settings.timeFormat;i.type=="date"?i.format=a:i.type=="time"?i.format=h:i.format=a+"|"+h}let l=i.type=="time"?this.getHourHTML(i):this.getMonthHTML(i);i.style+="; padding: 0;",i.html=l.html;let r=super.attach(i),n=r.overlay;return Object.assign(n.tmp,l),n.on("show.attach",a=>{let h=a.detail.overlay,d=h.anchor,g=h.options;["INPUT","TEXTAREA"].includes(d.tagName)&&!g.value&&d.value&&(h.tmp.initValue=d.value),delete h.newValue,delete h.newDate}),n.on("show:after.attach",a=>{r.overlay?.box&&this.initControls(r.overlay)}),n.on("update:after.attach",a=>{r.overlay?.box&&this.initControls(r.overlay)}),n.on("hide.attach",a=>{let h=a.detail.overlay,d=h.anchor;if(h.newValue!=null){h.newDate&&(h.newValue=h.newDate+" "+h.newValue),["INPUT","TEXTAREA"].includes(d.tagName)&&d.value!=h.newValue&&(d.value=h.newValue);let g=this.trigger("select",{date:h.newValue,target:h.name,overlay:h});if(g.isCancelled===!0)return;g.finish()}}),r.select=a=>(n.on("select.attach",h=>{a(h)}),r),r}initControls(e){let t=e.options,i=l=>{let{month:r,year:n}=e.tmp;r+=l,r>12&&(r=1,n++),r<1&&(r=12,n--);let a=this.getMonthHTML(t,r,n);Object.assign(e.tmp,a),o(e.box).find(".w2ui-overlay-body").html(a.html),this.initControls(e)},s=(l,r)=>{o(l.target).parent().find(".w2ui-jump-month, .w2ui-jump-year").removeClass("w2ui-selected"),o(l.target).addClass("w2ui-selected");let n=new Date,{jumpMonth:a,jumpYear:h}=e.tmp;if(r&&(h==null&&(h=n.getFullYear()),a==null&&(a=n.getMonth()+1)),a&&h){let d=this.getMonthHTML(t,a,h);Object.assign(e.tmp,d),o(e.box).find(".w2ui-overlay-body").html(d.html),e.tmp.jump=!1,this.initControls(e)}};o(e.box).find(".w2ui-cal-title").off(".calendar").on("click.calendar",l=>{if(Object.assign(e.tmp,{jumpYear:null,jumpMonth:null}),e.tmp.jump){let{month:r,year:n}=e.tmp,a=this.getMonthHTML(t,r,n);o(e.box).find(".w2ui-overlay-body").html(a.html),e.tmp.jump=!1}else{o(e.box).find(".w2ui-overlay-body .w2ui-cal-days").replace(this.getYearHTML());let r=o(e.box).find(`[name="${e.tmp.year}"]`).get(0);r&&r.scrollIntoView(!0),e.tmp.jump=!0}this.initControls(e),l.stopPropagation()}).find(".w2ui-cal-previous").off(".calendar").on("click.calendar",l=>{i(-1),l.stopPropagation()}).parent().find(".w2ui-cal-next").off(".calendar").on("click.calendar",l=>{i(1),l.stopPropagation()}),o(e.box).find(".w2ui-cal-now").off(".calendar").on("click.calendar",l=>{t.type=="datetime"?e.newDate?e.newValue=u.formatTime(new Date,t.format.split("|")[1]):e.newValue=u.formatDateTime(new Date,t.format):t.type=="date"?e.newValue=u.formatDate(new Date,t.format):t.type=="time"&&(e.newValue=u.formatTime(new Date,t.format)),this.hide(e.name)}),o(e.box).off(".calendar").on("contextmenu.calendar",l=>{l.preventDefault()}).on("click.calendar",{delegate:".w2ui-day.w2ui-date"},l=>{t.type=="datetime"?(e.newDate=o(l.target).attr("date"),o(e.box).find(".w2ui-overlay-body").html(this.getHourHTML(e.options).html),this.initControls(e)):(e.newValue=o(l.target).attr("date"),this.hide(e.name))}).on("click.calendar",{delegate:".w2ui-jump-month"},l=>{e.tmp.jumpMonth=parseInt(o(l.target).attr("name")),s(l)}).on("dblclick.calendar",{delegate:".w2ui-jump-month"},l=>{e.tmp.jumpMonth=parseInt(o(l.target).attr("name")),s(l,!0)}).on("click.calendar",{delegate:".w2ui-jump-year"},l=>{e.tmp.jumpYear=parseInt(o(l.target).attr("name")),s(l)}).on("dblclick.calendar",{delegate:".w2ui-jump-year"},l=>{e.tmp.jumpYear=parseInt(o(l.target).attr("name")),s(l,!0)}).on("click.calendar",{delegate:".w2ui-time.hour"},l=>{let r=o(l.target).attr("hour"),n=this.str2min(t.value)%60;if(e.tmp.initValue&&!t.value&&(n=this.str2min(e.tmp.initValue)%60),t.noMinutes)e.newValue=this.min2str(r*60,t.format),this.hide(e.name);else{e.newValue=r+":"+n;let a=this.getMinHTML(r,t).html;o(e.box).find(".w2ui-overlay-body").html(a),this.initControls(e)}}).on("click.calendar",{delegate:".w2ui-time.min"},l=>{let n=Math.floor(this.str2min(e.newValue)/60)*60+parseInt(o(l.target).attr("min"));e.newValue=this.min2str(n,t.format),this.hide(e.name)})}getMonthHTML(e,t,i){let s=u.settings.fulldays.slice(),l=u.settings.shortdays.slice();u.settings.weekStarts!=="M"&&(s.unshift(s.pop()),l.unshift(l.pop()));let r=new Date,n=1e3*60*60*24,a=e.type==="datetime"?u.isDateTime(e.value,e.format,!0):u.isDate(e.value,e.format,!0),h=u.formatDate(a);(t==null||i==null)&&(i=a?a.getFullYear():r.getFullYear(),t=a?a.getMonth()+1:r.getMonth()+1),t>12&&(t-=12,i++),(t<1||t===0)&&(t+=12,i--),i/4==Math.floor(i/4)?this.daysCount[1]=29:this.daysCount[1]=28,e.current=t+"/"+i,r=new Date(i,t-1,1);let d=r.getDay(),g="",c=u.settings.weekStarts;for(let y=0;y<l.length;y++){let x=c=="M"&&y==5||c!="M"&&y==6,C=c=="M"&&y==6||c!="M"&&y==0;g+=`<div class="w2ui-day w2ui-weekday ${x?"w2ui-sunday":""} ${C?"w2ui-saturday":""}">${l[y]}</div>`}let p=`
            <div class="w2ui-cal-title">
                <div class="w2ui-cal-previous">
                    <div></div>
                </div>
                <div class="w2ui-cal-next">
                    <div></div>
                </div>
                ${u.settings.fullmonths[t-1]}, ${i}
                <span class="arrow-down"></span>
            </div>
            <div class="w2ui-cal-days">
                ${g}
        `,f=new Date(`${i}/${t}/1`);f=new Date(f.getTime()+n*.5);let m=f.getDay();u.settings.weekStarts=="M"&&d--;let w=6,b=0;m>0?f=new Date(f.getTime()-d*n):(w=w+d,b=b+d,w<0&&(w=6+w+1),b<0&&(b=6+b+1));for(let y=0;y<42;y++){let x=[],C=`${f.getFullYear()}/${f.getMonth()+1}/${f.getDate()}`;f.getDay()===w&&x.push("w2ui-saturday"),f.getDay()===b&&x.push("w2ui-sunday"),f.getMonth()+1!==t&&x.push("outside"),C==this.today&&x.push("w2ui-today");let _=f.getDate(),v="",k="",D,S;if(e.type==="datetime"?(D=u.formatDateTime(C,e.format),S=u.formatDate(C,u.settings.dateFormat)):(D=u.formatDate(C,e.format),S=D),e.colored&&e.colored[S]!==void 0){let A=e.colored[S].split("|");k="background-color: "+A[0]+";",v="color: "+A[1]+";"}p+=`<div class="w2ui-day ${this.inRange(D,e,!0)?"w2ui-date "+(S==h?"w2ui-selected":""):"w2ui-blocked"} ${x.join(" ")}"
                       style="${v+k}" date="${S}" data-date="${f.getTime()}">
                            ${_}
                    </div>`,f=new Date(f.getTime()+n)}if(p+="</div>",e.btnNow){let y=u.lang("Today"+(e.type=="datetime"?" & Now":""));p+=`<div class="w2ui-cal-now">${y}</div>`}return{html:p,month:t,year:i}}getYearHTML(){let e="",t="";for(let i=0;i<u.settings.fullmonths.length;i++)e+=`<div class="w2ui-jump-month" name="${i+1}">${u.settings.shortmonths[i]}</div>`;for(let i=u.settings.dateStartYear;i<=u.settings.dateEndYear;i++)t+=`<div class="w2ui-jump-year" name="${i}">${i}</div>`;return`<div class="w2ui-cal-jump">
            <div id="w2ui-jump-month">${e}</div>
            <div id="w2ui-jump-year">${t}</div>
        </div>`}getHourHTML(e){e=e??{},e.format||(e.format=u.settings.timeFormat);let t=e.format.indexOf("h24")>-1,i=e.value?e.value:e.anchor?e.anchor.value:"",s=[];for(let r=0;r<24;r++){let n=(r>=12&&!t?r-12:r)+":00"+(t?"":r<12?" am":" pm");r==12&&!t&&(n="12:00 pm"),s[Math.floor(r/8)]||(s[Math.floor(r/8)]="");let a=this.min2str(this.str2min(n)),h=this.min2str(this.str2min(n)+59);if(e.type==="datetime"){let g=u.isDateTime(i,e.format,!0),c=e.format.split("|")[0].trim();a=u.formatDate(g,c)+" "+a,h=u.formatDate(g,c)+" "+h}let d=this.inRange(a,e)||this.inRange(h,e);s[Math.floor(r/8)]+=`<span hour="${r}"
                class="hour ${d?"w2ui-time ":"w2ui-blocked"}">${n}</span>`}return{html:`<div class="w2ui-calendar">
            <div class="w2ui-time-title">${u.lang("Select Hour")}</div>
            <div class="w2ui-cal-time">
                <div class="w2ui-cal-column">${s[0]}</div>
                <div class="w2ui-cal-column">${s[1]}</div>
                <div class="w2ui-cal-column">${s[2]}</div>
            </div>
            ${e.btnNow?`<div class="w2ui-cal-now">${u.lang("Now")}</div>`:""}
        </div>`}}getMinHTML(e,t){e==null&&(e=0),t=t??{},t.format||(t.format=u.settings.timeFormat);let i=t.format.indexOf("h24")>-1,s=t.value?t.value:t.anchor?t.anchor.value:"",l=[];for(let n=0;n<60;n+=5){let a=(e>12&&!i?e-12:e)+":"+(n<10?0:"")+n+" "+(i?"":e<12?"am":"pm"),h=a,d=n<20?0:n<40?1:2;if(l[d]||(l[d]=""),t.type==="datetime"){let g=u.isDateTime(s,t.format,!0),c=t.format.split("|")[0].trim();h=u.formatDate(g,c)+" "+h}l[d]+=`<span min="${n}" class="min ${this.inRange(h,t)?"w2ui-time ":"w2ui-blocked"}">${a}</span>`}return{html:`<div class="w2ui-calendar">
            <div class="w2ui-time-title">${u.lang("Select Minute")}</div>
            <div class="w2ui-cal-time">
                <div class="w2ui-cal-column">${l[0]}</div>
                <div class="w2ui-cal-column">${l[1]}</div>
                <div class="w2ui-cal-column">${l[2]}</div>
            </div>
            ${t.btnNow?`<div class="w2ui-cal-now">${u.lang("Now")}</div>`:""}
        </div>`}}inRange(e,t,i){let s=!1;if(t.type==="date"){let l=u.isDate(e,t.format,!0);if(l){if(t.start||t.end){let r=typeof t.start=="string"?t.start:o(t.start).val(),n=typeof t.end=="string"?t.end:o(t.end).val(),a=u.isDate(r,t.format,!0),h=u.isDate(n,t.format,!0),d=new Date(l);a||(a=d),h||(h=d),d>=a&&d<=h&&(s=!0)}else s=!0;Array.isArray(t.blockDates)&&t.blockDates.includes(e)&&(s=!1),Array.isArray(t.blockWeekdays)&&t.blockWeekdays.includes(l.getDay())&&(s=!1)}}else if(t.type==="time")if(t.start||t.end){let l=this.str2min(e),r=this.str2min(t.start),n=this.str2min(t.end);r||(r=l),n||(n=l),l>=r&&l<=n&&(s=!0)}else s=!0;else if(t.type==="datetime"){let l=u.isDateTime(e,t.format,!0);if(l){let r=t.format.split("|").map(n=>n.trim());if(i){let n=u.formatDate(l,r[0]),a=u.extend({},t,{type:"date",format:r[0]});this.inRange(n,a)&&(s=!0)}else{let n=u.formatTime(l,r[1]),a={type:"time",format:r[1],start:t.startTime,end:t.endTime};this.inRange(n,a)&&(s=!0)}}}return s}str2min(e){if(typeof e!="string")return null;let t=e.split(":");if(t.length===2)t[0]=parseInt(t[0]),t[1]=parseInt(t[1]),e.indexOf("pm")!==-1&&t[0]!==12&&(t[0]+=12),e.includes("am")&&t[0]==12&&(t[0]=0);else return null;return t[0]*60+t[1]}min2str(e,t){let i="";e>=24*60&&(e=e%(24*60)),e<0&&(e=24*60+e);let s=Math.floor(e/60),l=(e%60<10?"0":"")+e%60;return t||(t=u.settings.timeFormat),t.indexOf("h24")!==-1?i=s+":"+l:i=(s<=12?s:s-12)+":"+l+" "+(s>=12?"pm":"am"),i}},O=new V,j=new ve,Ne=new xe,re=new _e,Z=class extends Y{constructor(e){super(e.name),this.box=null,this.name=null,this.routeData={},this.items=[],this.right="",this.tooltip="top|left",this.onClick=null,this.onChange=null,this.onMouseDown=null,this.onMouseUp=null,this.onMouseEnter=null,this.onMouseLeave=null,this.onRender=null,this.onRefresh=null,this.onResize=null,this.onDestroy=null,this.item_template={id:null,type:"button",text:null,html:"",tooltip:null,count:null,hidden:!1,disabled:!1,checked:!1,icon:null,route:null,arrow:null,style:null,group:null,items:null,selected:null,color:null,backColor:null,overlay:{anchorClass:""},onClick:null,onRefresh:null},this.last={badge:{},pendingRefresh:{}},this._refresh=({effected:i,resize:s,refreshTooltip:l})=>{let r=this.last.pendingRefresh;r.ids??=[],r.ids.push(...i),Object.assign(r,{resize:s,refreshTooltip:l}),this._refreshDebounced()},this._refreshDebounced=u.debounce(()=>{let i=this.last.pendingRefresh;new Set(i.ids).forEach(s=>{this.refresh(s),i.hideTooltip&&this.tooltipHide(s)}),i.resize&&this.resize(),this.last.pendingRefresh={}},15);let t=e.items;delete e.items,Object.assign(this,e),Array.isArray(t)&&this.add(t,!0),e.items=t,typeof this.box=="string"&&(this.box=o(this.box).get(0)),this.box&&this.render(this.box)}add(e,t){this.insert(null,e,t)}insert(e,t,i){Array.isArray(t)||(t=[t]),t.forEach((s,l,r)=>{typeof s=="string"&&(s=r[l]={id:s,text:s});let n=["button","check","radio","drop","menu","menu-radio","menu-check","color","text-color","html","label","input","group","break","spacer","new-line"];if(!n.includes(String(s.type))){console.log('ERROR: The parameter "type" should be one of the following:',n,`, but ${s.type} is supplied.`,s);return}if(s.id==null&&!["break","spacer","new-line"].includes(s.type)){console.log('ERROR: The parameter "id" is required but not supplied.',s);return}if(s.type==null){console.log('ERROR: The parameter "type" is required but not supplied.',s);return}if(!u.checkUniqueId(s.id,this.items,"toolbar",this.name))return;let a=u.extend({},this.item_template,s);if(a.type=="menu-check"?(Array.isArray(a.selected)||(a.selected=[]),Array.isArray(a.items)&&a.items.forEach(h=>{typeof h=="string"&&(h=r[l]={id:h,text:h}),h.checked&&!a.selected.includes(h.id)&&a.selected.push(h.id),!h.checked&&a.selected.includes(h.id)&&(h.checked=!0),h.checked==null&&(h.checked=!1)})):a.type=="menu-radio"&&Array.isArray(a.items)&&a.items.forEach((h,d,g)=>{typeof h=="string"&&(h=g[d]={id:h,text:h}),h.checked&&a.selected==null?a.selected=h.id:h.checked=!1,!h.checked&&a.selected==h.id&&(h.checked=!0),h.checked==null&&(h.checked=!1)}),e==null)this.items.push(a);else{let h=this.get(e,!0);this.items=this.items.slice(0,h).concat([a],this.items.slice(h))}a.line=a.line??1,i!==!0&&this.refresh(a.id)}),i!==!0&&this.resize()}remove(){let e=0;return Array.from(arguments).forEach(t=>{let i=this.get(t);if(!i||String(t).indexOf(":")!=-1)return;e++,o(this.box).find("#tb_"+this.name+"_item_"+u.escapeId(i.id)).remove();let s=this.get(i.id,!0);s!=null&&this.items.splice(s,1)}),this.resize(),e}set(e,t){let i=this.get(e);return i==null?!1:(Object.assign(i,t),this.refresh(String(e).split(":")[0]),!0)}get(e,t,i){if(arguments.length===0){let l=[];for(let r=0;r<this.items.length;r++){let n=this.items[r];if(n.id!=null&&l.push(n.id),n.type=="group")for(let a=0;a<n.items.length;a++)n.items[a].id!=null&&l.push(n.items[a].id)}return l}let s=String(e).split(":");i==null&&(i=this.items);for(let l=0;l<i.length;l++){let r=i[l];if(["menu","menu-radio","menu-check"].includes(r.type)&&s.length==2&&r.id==s[0]){let n=r.items;typeof n=="function"&&(n=n(this));for(let a=0;a<n.length;a++){let h=n[a];if(h.id==s[1]||h.id==null&&h.text==s[1])return t==!0?a:h;if(Array.isArray(h.items)){for(let d=0;d<h.items.length;d++)if(h.items[d].id==s[1]||h.items[d].id==null&&h.items[d].text==s[1])return t==!0?a:h.items[d]}}}else{if(r.id==s[0])return t==!0?l:r;if(r.type=="group"){let n=this.get(e,t,r.items);if(n!=null)return n}}}return null}setCount(e,t,i,s){let l=o(this.box).find(`#tb_${this.name}_item_${u.escapeId(e)} .w2ui-tb-count > span`);if(l.length>0){l.removeClass().addClass(i??"").text(t).get(0).style.cssText=s??"",this.last.badge[e]={className:i??"",style:s??""};let r=this.get(e);r.count=t}else this.set(e,{count:t}),this.setCount(...arguments)}show(){let e=[];return Array.from(arguments).forEach(t=>{let i=this.get(t);i&&(i.hidden=!1,e.push(String(t).split(":")[0]),i.type=="group"&&i.items.forEach(s=>this.show(s.id)))}),this._refresh({effected:e,resize:!0}),e}hide(){let e=[];return Array.from(arguments).forEach(t=>{let i=this.get(t);i&&(i.hidden=!0,e.push(String(t).split(":")[0]),i.type=="group"&&i.items.forEach(s=>this.hide(s.id)))}),this._refresh({effected:e,hideTooltip:!0,resize:!0}),e}enable(){let e=[];return Array.from(arguments).forEach(t=>{let i=this.get(t);i&&(i.type=="group"?i.items.forEach(s=>this.enable(s.id)):(i.disabled=!1,e.push(String(t).split(":")[0])))}),this._refresh({effected:e}),e}disable(){let e=[];return Array.from(arguments).forEach(t=>{let i=this.get(t);i&&(i.type=="group"?i.items.forEach(s=>this.disable(s.id)):(i.disabled=!0,e.push(String(t).split(":")[0])))}),this._refresh({effected:e,hideTooltip:!0}),e}check(){let e=[];return Array.from(arguments).forEach(t=>{let i=this.get(t);!i||String(t).indexOf(":")!=-1||(i.type=="group"?i.items.forEach(s=>this.check(s.id)):(i.checked=!0,e.push(String(t).split(":")[0])))}),this._refresh({effected:e}),e}uncheck(){let e=[];return Array.from(arguments).forEach(t=>{let i=this.get(t);!i||String(t).indexOf(":")!=-1||(["menu","menu-radio","menu-check","drop","color","text-color"].includes(i.type)&&i.checked&&O.hide(this.name+"-drop"),i.type=="group"?i.items.forEach(s=>this.uncheck(s.id)):(i.checked=!1,e.push(String(t).split(":")[0])))}),this._refresh({effected:e}),e}click(e,t){let i=String(e).split(":"),s=this.get(i[0]),l=s&&s.items?u.normMenu.call(this,s.items,s):[];if(i.length>1){let r=this.get(e);r&&!r.disabled&&this.menuClick({name:this.name,item:s,subItem:r,originalEvent:t});return}if(s&&!s.disabled){let r=this.trigger("click",{target:e??this.name,item:s,object:s,originalEvent:t});if(r.isCancelled===!0)return;l=s&&s.items?u.normMenu.call(this,s.items,s):[];let n="#tb_"+this.name+"_item_"+u.escapeId(s.id);if(o(this.box).find(n).removeClass("down"),s.type=="radio"){for(let a=0;a<this.items.length;a++){let h=this.items[a];if(h.type=="group")for(let d=0;d<h.items.length;d++){let g=h.items[d];g==null||g.id==s.id||g.type!=="radio"||g.group==s.group&&g.checked&&(g.checked=!1,this.refresh(g.id))}h==null||h.id==s.id||h.type!=="radio"||h.group==s.group&&h.checked&&(h.checked=!1,this.refresh(h.id))}s.checked=!0,o(this.box).find(n).addClass("checked")}if(["menu","menu-radio","menu-check","drop","color","text-color"].includes(s.type))if(this.tooltipHide(e),s.checked){O.hide(this.name+"-drop");return}else{let a=O.get(this.name+"-drop");a?.displayed&&a.hide(),a?.listeners?.splice(0),setTimeout(()=>{let h=(g,c)=>{let p=this;return function(){p.set(g,{checked:!1})}},d=o(this.box).find("#tb_"+this.name+"_item_"+u.escapeId(s.id));if(u.isPlainObject(s.overlay)||(s.overlay={}),s.type=="drop"&&O.show(u.extend({html:s.html,class:"w2ui-white",hideOn:["doc-click"]},s.overlay,{anchor:d[0],name:this.name+"-drop",data:{item:s,btn:n}})).hide(h(s.id,n)),["menu","menu-radio","menu-check"].includes(s.type)){let g="normal";s.type=="menu-radio"&&(g="radio",l.forEach(c=>{s.selected==c.id?c.checked=!0:c.checked=!1})),s.type=="menu-check"&&(g="check",l.forEach(c=>{Array.isArray(s.selected)&&s.selected.includes(c.id)?c.checked=!0:c.checked=!1})),j.show(u.extend({items:l,align:s.text?"left":"none"},s.overlay,{type:g,name:this.name+"-drop",anchor:d[0],data:{item:s,btn:n}})).hide(h(s.id,n)).remove(c=>{this.menuClick({name:this.name,remove:!0,item:s,subItem:c.detail.item,originalEvent:c})}).select(c=>{this.menuClick({name:this.name,item:s,subItem:c.detail.item,originalEvent:c})})}["color","text-color"].includes(s.type)&&Ne.show(u.extend({color:s.color},s.overlay,{anchor:d[0],name:this.name+"-drop",data:{item:s,btn:n}})).hide(h(s.id,n)).select(g=>{g.detail.color!=null&&this.colorClick({name:this.name,item:s,color:g.detail.color})})},0)}if(["check","menu","menu-radio","menu-check","drop","color","text-color"].includes(s.type)&&(s.checked=!s.checked,s.checked?o(this.box).find(n).addClass("checked"):o(this.box).find(n).removeClass("checked")),s.route){let a=("/"+s.route).replace(/\/{2,}/g,"/"),h=u.parseRoute(a);if(h.keys.length>0)for(let d=0;d<h.keys.length;d++)a=a.replace(new RegExp(":"+h.keys[d].name,"g"),this.routeData[h.keys[d].name]);setTimeout(()=>{window.location.hash=a},1)}this.tooltipShow(e),r.finish()}}scroll(e,t,i){return new Promise((s,l)=>{let r=o(this.box).find(`.w2ui-tb-line:nth-child(${t}) .w2ui-scroll-wrapper`),n=r.get(0).scrollLeft,a=r.find(".w2ui-tb-right").get(0),h=r.parent().get(0).getBoundingClientRect().width,d=n+parseInt(a.offsetLeft)+parseInt(a.clientWidth);switch(e){case"left":{scroll=n-h+50,scroll<=0&&(scroll=0),r.get(0).scrollTo({top:0,left:scroll,behavior:i?"atuo":"smooth"});break}case"right":{scroll=n+h-50,scroll>=d-h&&(scroll=d-h),r.get(0).scrollTo({top:0,left:scroll,behavior:i?"atuo":"smooth"});break}}setTimeout(()=>{this.resize(),s()},i?0:600)})}render(e){let t=Date.now();typeof e=="string"&&(e=o(e).get(0));let i=this.trigger("render",{target:this.name,box:e??this.box});if(i.isCancelled===!0||(e!=null&&(this.unmount(),this.box=e),!this.box))return;Array.isArray(this.right)||(this.right=[this.right]);let s="",l=0;for(let r=0;r<this.items.length;r++){let n=this.items[r];n!=null&&(n.id==null&&(n.id="item_"+r),n.caption!=null&&console.log("NOTICE: toolbar item.caption property is deprecated, please use item.text. Item -> ",n),n.hint!=null&&console.log("NOTICE: toolbar item.hint property is deprecated, please use item.tooltip. Item -> ",n),(r===0||n.type=="new-line")&&(l++,s+=`
                    <div class="w2ui-tb-line">
                        <div class="w2ui-scroll-wrapper w2ui-eaction" data-mousedown="resize">
                            <div class="w2ui-tb-right">${this.right[l-1]??""}</div>
                        </div>
                        <div class="w2ui-scroll-left w2ui-eaction" data-click='["scroll", "left", "${l}"]'></div>
                        <div class="w2ui-scroll-right w2ui-eaction" data-click='["scroll", "right", "${l}"]'></div>
                    </div>
                `),n.line=l)}return o(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-toolbar").html(s),o(this.box).length>0&&(o(this.box)[0].style.cssText+=this.style),u.bindEvents(o(this.box).find(".w2ui-tb-line .w2ui-eaction"),this),this.last.observeResize=new ResizeObserver(()=>{this.resize()}),this.last.observeResize.observe(this.box),this.refresh(),this.resize(),i.finish(),Date.now()-t}refresh(e){let t=Date.now(),i=this.trigger("refresh",{target:e??this.name,item:this.get(e)});if(i.isCancelled===!0)return;let s;if(e==null){for(let h=0;h<this.items.length;h++){let d=this.items[h];d.id==null&&(d.id="item_"+h),this.refresh(d.id)}return}let l=this.get(e);if(l==null)return!1;if(typeof l.onRefresh=="function"&&(s=this.trigger("refresh",{target:e,item:l,object:l}),s.isCancelled===!0))return;let r=`#tb_${this.name}_item_${u.escapeId(l.id)}`,n=o(this.box).find(r),a=this.getItemHTML(l);if(this.tooltipHide(e),l.type=="spacer"&&o(this.box).find(`.w2ui-tb-line:nth-child(${l.line}`).find(".w2ui-tb-right").css("width","auto"),n.length===0){let h=parseInt(this.get(e,!0))+1,d=o(this.box).find(`#tb_${this.name}_item_${u.escapeId(this.items[h]?this.items[h].id:"")}`);d.length==0?d=o(this.box).find(`.w2ui-tb-line:nth-child(${l.line}`).find(".w2ui-tb-right").before(a):d.after(a),u.bindEvents(o(this.box).find(`${r}, ${r} .w2ui-eaction`),this)}else{o(this.box).find(r).replace(o.html(a));let h=o(this.box).find(r);u.bindEvents(h,this),u.bindEvents(h.find(".w2ui-eaction"),this);let d=O.get(!0);Object.keys(d).forEach(g=>{d[g].anchor==n.get(0)&&(d[g].anchor=h.get(0))})}if(["menu","menu-radio","menu-check"].includes(l.type)&&l.checked){let h=Array.isArray(l.selected)?l.selected:[l.selected],d=typeof l.items=="function"?l.items(l):[...l.items];d.forEach(g=>{h.includes(g.id)?g.checked=!0:g.checked=!1}),j.update(this.name+"-drop",d)}return typeof l.onRefresh=="function"&&s.finish(),i.finish(),Date.now()-t}resize(){let e=Date.now(),t=this.trigger("resize",{target:this.name});if(t.isCancelled!==!0)return o(this.box).find(".w2ui-tb-line").each(i=>{let s=o(i);s.find(".w2ui-scroll-left, .w2ui-scroll-right").hide();let l=s.find(".w2ui-scroll-wrapper").get(0),r=s.find(".w2ui-tb-right"),n=s.get(0).getBoundingClientRect().width,a=r.length>0?r[0].offsetLeft+r[0].clientWidth:0;n<a&&(l.scrollLeft>0&&s.find(".w2ui-scroll-left").show(),n<a-l.scrollLeft&&s.find(".w2ui-scroll-right").show())}),t.finish(),Date.now()-e}destroy(){let e=this.trigger("destroy",{target:this.name});e.isCancelled!==!0&&(o(this.box).find(".w2ui-scroll-wrapper").length>0&&this.unmount(),delete N[this.name],e.finish())}unmount(){super.unmount(),this.last.observeResize?.disconnect()}getItemHTML(e){let t="";e.caption!=null&&e.text==null&&(e.text=e.caption),e.text==null&&(e.text=""),e.tooltip==null&&e.hint!=null&&(e.tooltip=e.hint),e.tooltip==null&&(e.tooltip=""),typeof e.get!="function"&&(Array.isArray(e.items)||typeof e.items=="function")&&(e.get=function(n){let a=e.items;return typeof a=="function"&&(a=e.items(e)),a.find(h=>h.id==n)});let i="",s=typeof e.text=="function"?e.text.call(this,e):e.text;e.icon&&(i=e.icon,typeof e.icon=="function"&&(i=e.icon.call(this,e)),String(i).slice(0,1)!=="<"&&(i=`<span class="${i}" ${e.icon_style?`style="${e.icon_style}"`:""}></span>`),i=`<div class="w2ui-tb-icon">${i}</div>`);let l=["w2ui-tb-button","w2ui-eaction"];switch(e.checked&&l.push("checked"),e.disabled&&l.push("disabled"),e.hidden&&l.push("hidden"),i||l.push("no-icon"),e.type){case"color":case"text-color":if(typeof e.color=="string"&&(e.color.slice(0,1)=="#"&&(e.color=e.color.slice(1)),[3,6,8].includes(e.color.length)&&(e.color="#"+e.color)),e.type=="color"&&(s=`<span class="w2ui-tb-color-box" style="background-color: ${e.color!=null?e.color:"#fff"}"></span>
                           ${e.text?`<div style="margin-left: 17px;">${u.lang(e.text)}</div>`:""}`),e.type=="text-color"){let r=e.color!=null?e.color:"#444",n=e.backColor;e.backColor===!0&&(n="#fff",u.colorContrast("#fff",r)<2&&(n="#555")),s=`<span style="color: ${r}">${e.text?u.lang(e.text):e.backColor?`<b style="background-color: ${n??"transparent"}; padding: 2px 5px; border-radius: 3px;">Ab</b>`:"<b>Ab</b>"}</span>`}case"menu":case"menu-check":case"menu-radio":case"button":case"check":case"radio":case"label":case"drop":{let r=e.arrow===!0||e.arrow!==!1&&["menu","menu-radio","menu-check","drop","color","text-color"].includes(e.type);t=`
                    <div id="tb_${this.name}_item_${e.id}" class="${l.join(" ")} ${e.class?e.class:""}"
                        style="${e.hidden?"display: none":""} ${e.type=="label"?e.style??"":""}"
                        ${e.disabled?"":`data-click='["click","${e.id}", "event"]'
                               data-mouseenter='["mouseAction", "event", "this", "Enter", "${e.id}"]'
                               data-mouseleave='["mouseAction", "event", "this", "Leave", "${e.id}"]'
                               data-mousedown='["mouseAction", "event", "this", "Down", "${e.id}"]'
                               data-mouseup='["mouseAction", "event", "this", "Up", "${e.id}"]'`}
                    >
                        ${i}
                        ${s!=""&&s!=null||e.count!=null||r?`<div class="w2ui-tb-text" style="${e.type!="label"?e.style??"":""}; ${s?"":"padding-left: 0; margin-left: 23px;"}">
                                    ${u.lang(s)}
                                    ${e.count!=null?u.stripSpaces(`
                                            <span class="w2ui-tb-count">
                                                <span class="${this.last.badge[e.id]?this.last.badge[e.id].className??"":""}"
                                                        style="${this.last.badge[e.id]?this.last.badge[e.id].style??"":""}">${e.count}</span>
                                            </span>`):""}
                                    ${r?`<span class="w2ui-tb-down" ${!s&&!e.count?'style="margin-left: -3px"':""}><span></span></span>`:""}
                                </div>`:""}
                    </div>
                `;break}case"break":{t=`<div id="tb_${this.name}_item_${e.id}" class="w2ui-tb-break"
                            style="${e.hidden?"display: none":""}; ${e.style?e.style:""}">
                            &#160;
                        </div>`;break}case"spacer":{t=`<div id="tb_${this.name}_item_${e.id}" class="w2ui-tb-spacer"
                            style="${e.hidden?"display: none":""}; ${e.style?e.style:""}">
                        </div>`;break}case"html":{t=`<div id="tb_${this.name}_item_${e.id}" class="w2ui-tb-html ${l.join(" ")}"
                            style="${e.hidden?"display: none":""}; ${e.style?e.style:""}">
                            ${typeof e.html=="function"?e.html.call(this,e):e.html}
                        </div>`;break}case"input":{let r=e.placeholder,n=e.value;if(n!=null&&String(n).trim()!==""&&e.spinner){let a=e.spinner?.step??1,h=e.spinner.precision??String(a).split(".")[1]?.length??0;n=n.toFixed(h)}t=`<div id="tb_${this.name}_item_${e.id}" class="w2ui-tb-input w2ui-eaction ${l.join(" ")}"
                            style="${e.hidden?"display: none":""}; ${e.style?e.style:""}"
                        >
                            <span class="w2ui-input-label">${e.text??""}</span>
                            ${e.spinner?`<span class="w2ui-spinner-dec w2ui-eaction" data-click='["spinner", "${e.id}", "dec", "event"]'> \u2013 </span>`:""}
                            <input class="w2ui-toolbar-input w2ui-eaction ${e.spinner?"w2ui-has-spinner":""}"
                                ${r?`placeholder="${r}"`:""} style="${e.spinner?.style??""}" value="${n??""}${e.spinner?.suffix??""}"
                                data-change='["change", "${e.id}", "this"]'
                                data-keydown='["spinner", "${e.id}", "key", "event"]'
                                data-mouseenter='["mouseAction", "event", "this", "Enter", "${e.id}"]'
                                data-mouseleave='["mouseAction", "event", "this", "Leave", "${e.id}"]'
                            >
                            ${e.spinner?`<span class="w2ui-spinner-inc w2ui-eaction" data-click='["spinner", "${e.id}", "inc", "event"]'> + </span>`:""}
                        </div>`;break}case"group":t=`<div id="tb_${this.name}_item_${e.id}" class="w2ui-tb-group"
                    style="display: flex; ${e.hidden?"display: none":""}; ${e.style?e.style:""}">`,Array.isArray(e.items)?e.items.forEach(r=>{t+=this.getItemHTML(r)}):console.log("ERROR: toolbar group is empty"),t+="</div>"}return t}spinner(e,t,i){let s=this.get(e),l=0;switch(t){case"inc":{l=s.spinner?.step??1;break}case"dec":{l=-(s.spinner?.step??1);break}case"key":{if(s.spinner){let r=1;switch((i.shiftKey||i.metaKey)&&(r=10),i.altKey&&(r=.1),i.key){case"ArrowUp":{l=(s.spinner?.step??1)*r,i.preventDefault();break}case"ArrowDown":{l=-(s.spinner?.step??1)*r,i.preventDefault();break}}}break}}l!==0&&this.change(e,(s.value??0)+l)}change(e,t){let i=this.get(e),s=o(this.box).find("#tb_"+this.name+"_item_"+u.escapeId(e)).find("input.w2ui-toolbar-input");if(t instanceof HTMLInputElement&&(t=t.value),t==null&&(t=s.val()),i.spinner&&(t=parseFloat(t)),i.spinner?.min!=null&&i.spinner.min>t&&(t=i.spinner.min),i.spinner?.max!=null&&i.spinner.max<t&&(t=i.spinner.max),i.spinner){isNaN(t)&&(t=i.spinner.min??0);let r=i.spinner?.step??1,n=i.spinner.precision??String(r).split(".")[1]?.length??0;t=t.toFixed(n)}let l=this.trigger("change",{target:e,id:e,value:t,item:i});l.isCancelled||(i.value=i.spinner?parseFloat(t):t,s.val(t+(i.spinner?.suffix??"")),l.finish())}tooltipShow(e){if(this.tooltip==null)return;let t=o(this.box).find("#tb_"+this.name+"_item_"+u.escapeId(e)).get(0),i=this.get(e),s=typeof this.tooltip=="string"?{position:this.tooltip}:this.tooltip,l=i.tooltip;typeof l=="function"&&(l=l.call(this,i)),!(["menu","menu-radio","menu-check","drop","color","text-color"].includes(i.type)&&i.checked==!0)&&O.show({anchor:t,name:this.name+"-tooltip",html:l,...s})}tooltipHide(e){this.tooltip!=null&&O.hide(this.name+"-tooltip")}menuClick(e){if(e.item&&!e.item.disabled){let t=this.trigger(e.remove!==!0?"click":"remove",{target:e.item.id+":"+e.subItem.id,item:e.item,subItem:e.subItem,originalEvent:e.originalEvent});if(t.isCancelled===!0)return;let i=e.subItem,s=this.get(e.item.id),l=s.items;if(typeof l=="function"&&(l=s.items()),s.type=="menu"&&(s.selected=i.id),s.type=="menu-radio"&&(s.selected=i.id,Array.isArray(l)&&l.forEach(r=>{r.checked===!0&&delete r.checked,Array.isArray(r.items)&&r.items.forEach(n=>{n.checked===!0&&delete n.checked})}),i.checked=!0),s.type=="menu-check"){if(Array.isArray(s.selected)||(s.selected=[]),i.group==null){let r=s.selected.indexOf(i.id);r==-1?(s.selected.push(i.id),i.checked=!0):(s.selected.splice(r,1),i.checked=!1)}else if(i.group!==!1){let r=[],n=s.selected.indexOf(i.id),a=h=>{h.forEach(d=>{if(d.group===i.group){let g=s.selected.indexOf(d.id);g!=-1&&(d.id!=i.id&&r.push(d.id),s.selected.splice(g,1))}Array.isArray(d.items)&&a(d.items)})};a(l),n==-1&&(s.selected.push(i.id),i.checked=!0)}}if(typeof i.route=="string"){let r=i.route!==""?("/"+i.route).replace(/\/{2,}/g,"/"):"",n=u.parseRoute(r);if(n.keys.length>0)for(let a=0;a<n.keys.length;a++)this.routeData[n.keys[a].name]!=null&&(r=r.replace(new RegExp(":"+n.keys[a].name,"g"),this.routeData[n.keys[a].name]));setTimeout(()=>{window.location.hash=r},1)}this.refresh(e.item.id),t.finish()}}colorClick(e){let t=this;if(e.item&&!e.item.disabled){let i=this.trigger("click",{target:e.item.id,item:e.item,color:e.color,final:!0});if(i.isCancelled===!0)return;e.item.color=e.color,t.refresh(e.item.id),i.finish()}}mouseAction(e,t,i,s){let l=this.get(s),r=this.trigger("mouse"+i,{target:s,item:l,object:l,originalEvent:e});if(!(r.isCancelled===!0||l.disabled||l.hidden)){switch(i){case"Enter":["label","input"].includes(l.type)||o(t).addClass("over"),this.tooltipShow(s);break;case"Leave":["label","input"].includes(l.type)||o(t).removeClass("over down"),this.tooltipHide(s);break;case"Down":["label","input"].includes(l.type)||o(t).addClass("down");break;case"Up":["label","input"].includes(l.type)||o(t).removeClass("down");break}r.finish()}}},de=class extends Y{constructor(e){super(e.name),this.name=null,this.box=null,this.sidebar=null,this.parent=null,this.nodes=[],this.menu=[],this.routeData={},this.selected=null,this.icon=null,this.style="",this.topHTML="",this.bottomHTML="",this.multi=!1,this.editable=!1,this.reorder=!1,this.flatButton=!1,this.keyboard=!0,this.flat=!1,this.hasFocus=!1,this.levelPadding=12,this.toggleAlign="right",this.skipRefresh=!1,this.tabIndex=null,this.handle={width:0,style:"",text:"",tooltip:""},this.badge=null,this.onClick=null,this.onSelect=null,this.onUnselect=null,this.onDblClick=null,this.onMouseEnter=null,this.onMouseLeave=null,this.onContextMenu=null,this.onMenuClick=null,this.onExpand=null,this.onCollapse=null,this.onKeydown=null,this.onRender=null,this.onRefresh=null,this.onResize=null,this.onDestroy=null,this.onFocus=null,this.onBlur=null,this.onFlat=null,this.onEdit=null,this.onRename=null,this.onReorder=null,this.onDragStart=null,this.onDragOver=null,this.node_template={id:null,text:"",order:null,count:null,icon:null,nodes:[],style:"",route:null,selected:!1,expanded:!1,hidden:!1,disabled:!1,group:!1,groupShowHide:!0,collapsible:!1,plus:!1,childOffset:0,onClick:null,onDblClick:null,onContextMenu:null,onExpand:null,onCollapse:null,parent:null,sidebar:null},this.last={badge:{},renaming:!1,move:null};let t=e.nodes;delete e.nodes,Object.assign(this,e),Array.isArray(t)&&this.add(t),e.nodes=t,typeof this.box=="string"&&(this.box=o(this.box).get(0)),this.box&&this.render(this.box)}add(e,t){return arguments.length==1&&(t=arguments[0],e=this),typeof e=="string"&&(e=this.get(e)),(e==null||e=="")&&(e=this),this.insert(e,null,t)}insert(e,t,i){let s,l,r,n,a;if(arguments.length==2&&typeof e=="string")if(i=arguments[1],t=arguments[0],t!=null){if(l=this.get(t),l==null)return Array.isArray(i)||(i=[i]),i[0].caption!=null&&i[0].text==null&&(console.log("NOTICE: sidebar node.caption property is deprecated, please use node.text. Node -> ",i[0]),i[0].text=i[0].caption),s=i[0].text,console.log('ERROR: Cannot insert node "'+s+'" because cannot find node "'+t+'" to insert before.'),null;e=this.get(t).parent}else e=this;typeof e=="string"&&(e=this.get(e)),(e==null||e=="")&&(e=this),Array.isArray(i)||(i=[i]);for(let h=0;h<i.length;h++){if(n=i[h],n.caption!=null&&n.text==null&&(console.log("NOTICE: sidebar node.caption property is deprecated, please use node.text"),n.text=n.caption),typeof n.id==null){s=n.text,console.log('ERROR: Cannot insert node "'+s+'" because it has no id.');continue}if(this.get(this,n.id)!=null){console.log("ERROR: Cannot insert node with id="+n.id+" (text: "+n.text+") because another node with the same id already exists.");continue}if(r=Object.assign({},this.node_template,n),r.sidebar=this,r.parent=e,a=r.nodes||[],r.nodes=[],t==null)e.nodes.push(r);else{if(l=this.get(e,t,!0),l==null)return console.log('ERROR: Cannot insert node "'+n.text+'" because cannot find node "'+t+'" to insert before.'),null;e.nodes.splice(l,0,r)}a.length>0&&this.insert(r,null,a)}return this.skipRefresh||this.refresh(e.id),r}remove(){let e=0,t;return Array.from(arguments).forEach(i=>{if(t=this.get(i),t==null)return;this.selected!=null&&(Array.isArray(this.selected)?this.selected.splice(this.selected.indexOf(t.id),1):this.selected===t.id&&(this.selected=null));let s=this.get(t.parent,i,!0);s!=null&&(t.parent.nodes[s].selected&&t.sidebar.unselect(t.id),t.parent.nodes.splice(s,1),t.parent.collapsible=t.parent.nodes.length>0,e++)}),this.skipRefresh||(e>0&&arguments.length==1?this.refresh(t.parent.id):this.refresh()),e}set(e,t,i){if(arguments.length==2&&(i=t,t=e,e=this),typeof e=="string"&&(e=this.get(e)),e.nodes==null)return null;for(let s=0;s<e.nodes.length;s++)if(e.nodes[s].id===t){let l=this.update(t,i);if(Object.keys(l).length!=0){let r=i.nodes;u.extend(e.nodes[s],i,r!=null?{nodes:[]}:{}),r!=null&&this.add(e.nodes[s],r),this.skipRefresh||this.refresh(t)}return!0}else if(this.set(e.nodes[s],t,i))return!0;return!1}get(e,t,i){if(arguments.length===0){let s=[],l=this.find({});for(let r=0;r<l.length;r++)l[r].id!=null&&s.push(l[r].id);return s}else{if((arguments.length==1||arguments.length==2&&t===!0)&&(i=t,t=e,e=this),typeof e=="string"&&(e=this.get(e)),e.nodes==null)return null;for(let s=0;s<e.nodes.length;s++){if(e.nodes[s].id==t)return i===!0?s:e.nodes[s];{let l=this.get(e.nodes[s],t,i);if(l||l===0)return l}}return null}}setCount(e,t,i={}){let s=o(this.box).find(`#node_${u.escapeId(e)} .w2ui-node-badge`);if(s.length>0){s.removeClass().addClass(`w2ui-node-badge ${i.className??"w2ui-node-count"}`).text(t).get(0).style.cssText=i.style||"",this.last.badge[e]={className:i.className??"",style:i.style??""};let l=this.get(e);l.count=t}else this.set(e,{count:t}),this.setCount(...arguments)}find(e,t,i){if(arguments.length==1&&(t=e,e=this),i||(i=[]),typeof e=="string"&&(e=this.get(e)),e.nodes==null)return i;for(let s=0;s<e.nodes.length;s++){let l=!0;for(let r in t)e.nodes[s][r]!=t[r]&&(l=!1);l&&i.push(e.nodes[s]),e.nodes[s].nodes.length>0&&(i=this.find(e.nodes[s],t,i))}return i}sort(e,t){(!e||typeof e!="object")&&(e={}),e.foldersFirst==null&&(e.foldersFirst=!0),e.caseSensitive==null&&(e.caseSensitive=!1),e.reverse==null&&(e.reverse=!1),t==null&&(t=this.nodes),t.sort((i,s)=>{let l=i.nodes&&i.nodes.length>0,r=s.nodes&&s.nodes.length>0;if(e.foldersFirst===!1||!l&&!r||l&&r){let n=i.text,a=s.text;e.caseSensitive||(n=n.toLowerCase(),a=a.toLowerCase()),i.order!=null&&(n=i.order),s.order!=null&&(a=s.order);let h=u.naturalCompare(n,a);return(h===1||h===-1)&e.reverse?-h:h}if(l&&!r)return e.reverse?1:-1;if(!l&&r)return e.reverse?-1:1}),t.forEach(i=>{i.nodes&&i.nodes.length>0&&this.sort(e,i.nodes)})}each(e,t){t==null&&(t=this.nodes),t.forEach(i=>{e.call(this,i),i.nodes&&i.nodes.length>0&&this.each(e,i.nodes)})}search(e,t=null){let i=0,s=e.toLowerCase();return this.each(r=>{let n=!1;typeof t=="function"?n=t(e,r):n=r.text.toLowerCase().indexOf(s)!==-1,n?(i++,l(r),r.hidden=!1):r.hidden=!0}),this.refresh(),i;function l(r){r.parent&&(r.parent.hidden=!1,l(r.parent))}}show(){let e=[];return Array.from(arguments).forEach(t=>{let i=this.get(t);i==null||i.hidden===!1||(i.hidden=!1,e.push(i.id))}),e.length>0&&(arguments.length==1?this.refresh(arguments[0]):this.refresh()),e}hide(){let e=[];return Array.from(arguments).forEach(t=>{let i=this.get(t);i==null||i.hidden===!0||(i.hidden=!0,e.push(i.id))}),e.length>0&&(arguments.length==1?this.refresh(arguments[0]):this.refresh()),e}enable(){let e=[];return Array.from(arguments).forEach(t=>{let i=this.get(t);i==null||i.disabled===!1||(i.disabled=!1,e.push(i.id))}),e.length>0&&(arguments.length==1?this.refresh(arguments[0]):this.refresh()),e}disable(){let e=[];return Array.from(arguments).forEach(t=>{let i=this.get(t);i==null||i.disabled===!0||(i.disabled=!0,i.selected&&this.unselect(i.id),e.push(i.id))}),e.length>0&&(arguments.length==1?this.refresh(arguments[0]):this.refresh()),e}select(e){if(Array.isArray(e)){[...e].forEach(l=>this.select(l));return}let t=this.get(e);if(!t)return!1;let i=this.trigger("select",{target:e,id:e,node:t});if(i.isCancelled===!0)return!0;if(!this.multi&&this.selected==e&&t.selected)return!1;let s=o(this.box).find("#node_"+u.escapeId(e));return s.addClass("w2ui-selected").find(".w2ui-icon").addClass("w2ui-icon-selected"),s.length>0&&(this.inView(e)||this.scrollIntoView(e)),t.selected=!0,this.multi?(Array.isArray(this.selected)||(this.selected=this.selected?[this.selected]:[]),this.selected.push(e)):this.selected=this.multi?[e]:e,i.finish(),!0}unselect(e){if(arguments.length===0&&(e=this.selected),Array.isArray(e)){[...e].forEach(s=>this.unselect(s));return}let t=this.get(e);if(!t)return!1;let i=this.trigger("unselect",{target:e,id:e,node:t});if(i.isCancelled===!0)return!0;if(t.selected=!1,o(this.box).find("#node_"+u.escapeId(e)).removeClass("w2ui-selected").find(".w2ui-icon").removeClass("w2ui-icon-selected"),typeof this.selected=="string"&&this.selected==e&&(this.selected=null),this.multi&&Array.isArray(this.selected)){let s=this.selected.indexOf(e);s!=-1&&this.selected.splice(s,1)}return i.finish(),!0}toggle(e){let t=this.get(e);if(t==null)return!1;if(t.plus){this.set(e,{plus:!1}),this.expand(e),this.refresh(e);return}return t.nodes.length===0||!t.collapsible?!1:this.get(e).expanded?this.collapse(e):this.expand(e)}collapse(e){let t=this.get(e);if(t==null)return!1;let i=this.trigger("collapse",{target:e,object:t,node:t});if(i.isCancelled!==!0)return o(this.box).find("#node_"+u.escapeId(e)+"_sub").hide(),o(this.box).find("#node_"+u.escapeId(e)+" .w2ui-expanded").removeClass("w2ui-expanded").addClass("w2ui-collapsed"),t.expanded=!1,i.finish(),this.refresh(e),!0}expand(e){let t=this.get(e),i=this.trigger("expand",{target:e,object:t,node:t});if(i.isCancelled!==!0)return o(this.box).find("#node_"+u.escapeId(e)+"_sub").show(),o(this.box).find("#node_"+u.escapeId(e)+" .w2ui-collapsed").removeClass("w2ui-collapsed").addClass("w2ui-expanded"),t.expanded=!0,i.finish(),this.refresh(e),!0}collapseAll(e){if(e==null&&(e=this),typeof e=="string"&&(e=this.get(e)),e.nodes==null)return!1;for(let t=0;t<e.nodes.length;t++)e.nodes[t].expanded===!0&&(e.nodes[t].expanded=!1),e.nodes[t].nodes&&e.nodes[t].nodes.length>0&&this.collapseAll(e.nodes[t]);return this.refresh(e.id),!0}expandAll(e){if(e==null&&(e=this),typeof e=="string"&&(e=this.get(e)),e.nodes==null)return!1;for(let t=0;t<e.nodes.length;t++)e.nodes[t].expanded===!1&&(e.nodes[t].expanded=!0),e.nodes[t].nodes&&e.nodes[t].nodes.length>0&&this.expandAll(e.nodes[t]);this.refresh(e.id)}expandParents(e){let t=this.get(e);return t==null?!1:(t.parent&&(t.parent.expanded||(t.parent.expanded=!0,this.refresh(t.parent.id)),this.expandParents(t.parent.id)),!0)}click(e,t){let i=this,s=this.get(e);if(s==null)return;if(s.disabled||s.group){i.trigger("click",{target:e,originalEvent:t,node:s,object:s}).finish();return}let l=o(i.box).find("#node_"+u.escapeId(e));l.addClass("w2ui-selected").find(".w2ui-icon").addClass("w2ui-icon-selected"),setTimeout(()=>{let r=i.trigger("click",{target:e,originalEvent:t,node:s,object:s});if(r.isCancelled===!0){l.removeClass("w2ui-selected").find(".w2ui-icon").removeClass("w2ui-icon-selected");return}if(this.multi){let n=t?.shiftKey??!1,a=(t?.ctrlKey||t?.metaKey)??!1;if(typeof this.selected=="string"&&(this.selected=[this.selected]),a&&!n)if(this.selected?.includes(e)){this.unselect(e);return}else this.select(e);else if(!a&&n){let h=this.getChain(),d=Math.min(this.selected.map(c=>h.indexOf(c))),g=h.indexOf(e);for(let c=Math.min(d,g);c<h.length&&c<=Math.max(d,g);c++){let p=this.get(h[c]);!this.selected.includes(h[c])&&p.hidden!=!0&&this.select(h[c])}}else{let h=this.selected?.filter(d=>d!=e&&this.selected.includes(d));this.unselect(h),this.selected?.includes(e)||this.select(e)}}else if(this.selected!==e&&(this.selected!=null&&this.unselect(this.selected),this.select(e),typeof s.route=="string")){let n=s.route!==""?("/"+s.route).replace(/\/{2,}/g,"/"):"",a=u.parseRoute(n);if(a.keys.length>0)for(let h=0;h<a.keys.length;h++)i.routeData[a.keys[h].name]!=null&&(n=n.replace(new RegExp(":"+a.keys[h].name,"g"),i.routeData[a.keys[h].name]));setTimeout(()=>{window.location.hash=n},1)}r.finish()},1)}focus(e){let t=this,i=this.trigger("focus",{target:this.name,originalEvent:e});if(i.isCancelled===!0)return!1;this.hasFocus=!0,o(this.box).find(".w2ui-sidebar-body").addClass("w2ui-focus"),setTimeout(()=>{let s=o(t.box).find("#sidebar_"+t.name+"_focus").get(0);document.activeElement!=s&&s.focus()},10),i.finish()}blur(e){let t=this.trigger("blur",{target:this.name,originalEvent:e});if(t.isCancelled===!0)return!1;this.hasFocus=!1,o(this.box).find(".w2ui-sidebar-body").removeClass("w2ui-focus"),t.finish()}next(e,t){if(e==null)return null;let i=e.parent,s=this.get(e.id,!0),l=null;if(e.expanded&&e.nodes.length>0&&t!==!0){let r=e.nodes[0];r.hidden||r.disabled||r.group?l=this.next(r):l=r}else i&&s+1<i.nodes.length?l=i.nodes[s+1]:l=this.next(i,!0);return l!=null&&(l.hidden||l.disabled||l.group)&&(l=this.next(l)),l}prev(e){if(e==null)return null;let t=e.parent,i=this.get(e.id,!0),s=r=>{if(r.expanded&&r.nodes.length>0){let n=r.nodes[r.nodes.length-1];return n.hidden||n.disabled||n.group?this.prev(n):s(n)}return r},l=i>0?s(t.nodes[i-1]):t;return l!=null&&(l.hidden||l.disabled||l.group)&&(l=this.prev(l)),l}getChain(e,t={}){t.returnDisabled??=!1,t.returnGroups??=!1;let i=[];return e==null&&(e=this.nodes),e.forEach(s=>{(!s.disabled&&!s.group||s.disabled&&t.returnDisabled||s.group&&t.returnGroups)&&i.push(s.id),Array.isArray(s.nodes)&&s.expanded&&i.push(...this.getChain(s.nodes,t))}),i}keydown(e){let t=this,i=Array.isArray(this.selected)?this.selected[0]:this.selected,s=t.get(i);if(this.keyboard!==!0)return;if(s||(s=this.nodes[0]),e.keyCode==27){let a=this.last.move;if(a?.reorder&&a?.moved){a.restore();return}}let l=this.trigger("keydown",{target:this.name,originalEvent:e});if(l.isCancelled===!0)return;(e.keyCode==13||e.keyCode==32)&&(e.keyCode==13&&this.editable&&!e.ctrlKey&&!e.metaKey?this.edit(i):s.nodes.length>0&&this.toggle(i)),e.keyCode==37&&(s.nodes.length>0&&s.expanded?this.collapse(i):(r(s.parent),s.parent.group||this.collapse(s.parent.id))),e.keyCode==39&&(s.nodes.length>0||s.plus)&&!s.expanded&&this.expand(i),e.keyCode==38&&(this.get(i)==null?r(this.nodes[0]||null):r(n(s,this.prev))),e.keyCode==40&&(this.get(i)==null?r(this.nodes[0]||null):r(n(s,this.next))),[13,32,37,38,39,40].includes(e.keyCode)&&(e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation()),l.finish();function r(a,h){a!=null&&!a.hidden&&!a.disabled&&!a.group&&(t.click(a.id,h),t.inView(a.id)||t.scrollIntoView(a.id))}function n(a,h){for(a=h.call(t,a);a!=null&&(a.hidden||a.disabled)&&!a.group;)a=h(a);return a}}inView(e){let t=o(this.box).find("#node_"+u.escapeId(e)).get(0);if(!t)return!1;let i=o(this.box).find(".w2ui-sidebar-body").get(0);return!(t.offsetTop<i.scrollTop||t.offsetTop+t.clientHeight>i.clientHeight+i.scrollTop)}scrollIntoView(e,t){return new Promise((i,s)=>{if(e==null&&(e=Array.isArray(this.selected)?this.selected[0]:this.selected),this.get(e)==null)return;o(this.box).find("#node_"+u.escapeId(e)).get(0).scrollIntoView({block:"center",inline:"center",behavior:t?"atuo":"smooth"}),setTimeout(()=>{this.resize(),i()},t?0:500)})}dblClick(e,t){let i=this.get(e),s=this.trigger("dblClick",{target:e,originalEvent:t,object:i});s.isCancelled!==!0&&(this.editable?this.edit(e):this.toggle(e),s.finish())}mouseDown(e,t){let i=this;if(this.reorder){this.last.move={x:t.screenX,y:t.screenY,divX:0,divY:0,reorder:!0,moved:!1};let r=this.last.move,n=o(this.box).find(".w2ui-sidebar-body");if(!r.ghost){let a=o(this.box).find(`#node_${u.escapeId(e)}`);r.offsetY=t.offsetY,r.target=e,r.pos={top:a.get(0).offsetTop-1,left:a.get(0).offsetLeft};let h=o(a.find(".w2ui-node-data").get(0).cloneNode(!0));r.node=a,r.nodeSub=a.next(),n.append('<div id="sidebar_'+this.name+'_ghost" class="w2ui-node w2ui-ghost"></div>'),o(this.box).find("#sidebar_"+this.name+"_ghost").append(h),r.ghost=o(this.box).find("#sidebar_"+this.name+"_ghost"),r.ghost.css({display:"none"}),r.restore=()=>{r.resetReorder(),this.refresh()},r.resetReorder=()=>{this.last.move=null,o(this.box).find(`#sidebar_${this.name}_ghost`).remove(),o(document).off(`.w2ui-${this.name}-reorder`)}}o(document).on(`mousemove.w2ui-${this.name}-reorder`,s).on(`mouseup.w2ui-${this.name}-reorder`,l)}function s(r){if(!r.target.tagName)return;let n=i.last.move;if(n.divX=r.screenX-n.x,n.divY=r.screenY-n.y,Math.abs(n.divX)<=1&&Math.abs(n.divY)<=1)return;if(i.reorder==!0&&n.reorder&&!n.moved){let d=i.trigger("dragStart",{target:n.target,moved:!0,node:i.get(n.target),mv:n,originalEvent:r});if(d.isCancelled===!0){n.restore();return}let g=n.node.get(0).getBoundingClientRect();if(n.moved=!0,n.node.html("").removeAttr("id","data-id").addClass("w2ui-reorder-empty").css({height:g.height+"px"}),n.node.next().css("display")!=="none"){let c=n.node.next().get(0).getBoundingClientRect();n.node.next().html('<div class="w2ui-reorder-empty-sub"></div>').css({height:c.height+"px"})}n.ghost.css({display:"block"}),d.finish()}n.ghost.css({top:n.pos.top+n.divY+"px",left:0});let h=o(r.target).closest(".w2ui-node, .w2ui-node-group").attr("data-id");if(o(r.target).hasClass("w2ui-sidebar-body")&&r.layerY>5&&!n.append){let d=i.trigger("dragOver",{target:n.target,append:!0,mv:n,originalEvent:r});if(d.isCancelled===!0)return;n.ghost.before(n.node),n.ghost.before(n.nodeSub),n.append=!0,n.moveBefore=null,d.finish()}else if(h!=null&&h!=n.moveBefore){n.append=!1,n.moveBefore=h;let d=i.trigger("dragOver",{target:n.target,moveBefore:h,mv:n,originalEvent:r});if(d.isCancelled===!0)return;let g=o(i.box).find(`#node_${u.escapeId(h)}`);g.before(n.node),g.before(n.nodeSub),d.finish()}}function l(r){let n=i.last.move;if(n.resetReorder(),n.moved)if(n.moveBefore!=null&&n.target!=n.moveBefore||n.append){let a=i.trigger("reorder",{target:n.target,moveBefore:n.moveBefore,append:n.append,originalEvent:r});if(a.isCancelled===!0){i.refresh();return}let h=i.get(n.target),d=h.parent.nodes.indexOf(h),g=h.parent.nodes.splice(d,1);if(n.append)i.nodes.push(...g),g.forEach(c=>c.parent=i);else{let c=i.get(n.moveBefore),p=c.parent.nodes.indexOf(c);g.forEach(f=>f.parent=c.parent),c.parent.nodes.splice(p,0,...g)}i.refresh(),a.finish()}else i.refresh()}}edit(e){let t=this,i=o(this.box).find("#node_"+u.escapeId(e)),s=i.find(".w2ui-node-text"),l=this.trigger("edit",{target:e,el:i,textEl:s});if(l.isCancelled===!0)return;this.last.renaming=!0,i.addClass("w2ui-editing"),s.addClass("w2ui-focus").css("pointer-events","all").attr("contenteditable",u.isFirefox?"true":"plaintext-only").on("blur.node-editing",a=>{setTimeout(n,0)}).on("keydown.node-editing",a=>{a.keyCode==13&&n(a),a.keyCode==27&&n(a,!0)}).get(0).focus();let r=s.text();return u.setCursorPosition(s[0],0,s.text().length),l.finish(),s.get(0);function n(a,h){let d=s.text();if(i.removeClass("w2ui-editing"),s.removeClass("w2ui-focus").css("pointer-events","none").removeAttr("contenteditable").off(".node-editing"),!h&&t.last.renaming&&r!==d){let g=t.trigger("rename",{target:e,text_previous:r,text_new:d,originalEvent:a});if(g.isCancelled===!0){s.text(r),t.last.renaming=!1,t.focus();return}t.set(e,{text:d}),g.finish()}h&&t.set(e,{text:r}),t.last.renaming=!1,t.focus()}}contextMenu(e,t){let i=this.get(e);Array.isArray(this.selected)?this.selected.includes(e)||this.click(e):e!=this.selected&&this.click(e);let s=this.trigger("contextMenu",{target:e,originalEvent:t,object:i,allowOnDisabled:!1});s.isCancelled!==!0&&(i.disabled&&!s.allowOnDisabled||(this.menu.length>0&&j.show({name:this.name+"_menu",anchor:document.body,items:this.menu,originalEvent:t}).select(l=>{this.menuClick(e,parseInt(l.detail.index),t)}),t.preventDefault&&t.preventDefault(),s.finish()))}menuClick(e,t,i){let s=this.trigger("menuClick",{target:e,originalEvent:i,menuIndex:t,menuItem:this.menu[t]});s.isCancelled!==!0&&s.finish()}goFlat(){let e=this.trigger("flat",{goFlat:!this.flat});e.isCancelled!==!0&&(this.flat=!this.flat,this.refresh(),e.finish())}render(e){let t=Date.now(),i=this;typeof e=="string"&&(e=o(e).get(0));let s=this.trigger("render",{target:this.name,box:e??this.box});if(s.isCancelled===!0||(e!=null&&(this.unmount(),this.box=e),!this.box))return;o(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-sidebar").html(`<div>
                <div class="w2ui-sidebar-top"></div>
                <input id="sidebar_${this.name}_focus" ${this.tabIndex?'tabindex="'+this.tabIndex+'"':""}
                    style="position: absolute; top: 0; right: 0; width: 1px; z-index: -1; opacity: 0"
                    ${u.isMobile?"readonly":""}/>
                <div class="w2ui-sidebar-body"></div>
                <div class="w2ui-sidebar-bottom"></div>
            </div>`);let l=o(this.box).get(0).getBoundingClientRect();o(this.box).find(":scope > div").css({width:l.width+"px",height:l.height+"px"}),o(this.box).get(0).style.cssText+=this.style;let r;o(this.box).find("#sidebar_"+this.name+"_focus").on("focus",function(a){clearTimeout(r),i.hasFocus||i.focus(a)}).on("blur",function(a){r=setTimeout(()=>{i.hasFocus&&i.blur(a)},100)}).on("keydown",function(a){N[i.name].keydown.call(N[i.name],a)}),o(this.box).off("mousedown").on("mousedown",function(a){setTimeout(()=>{if(["INPUT","TEXTAREA","SELECT"].indexOf(a.target.tagName.toUpperCase())==-1){let h=o(i.box).find("#sidebar_"+i.name+"_focus");document.activeElement!=h.get(0)&&h.length>0&&h.get(0).focus()}},1)});let n=`<div class="w2ui-flat w2ui-flat-${this.flat?"right":"left"}" ${this.flatButton==!1?'style="display: none"':""}></div>`;return(this.topHTML!==""||n!=="")&&(o(this.box).find(".w2ui-sidebar-top").html(this.topHTML+n),o(this.box).find(".w2ui-sidebar-body").css("top",o(this.box).find(".w2ui-sidebar-top").get(0)?.clientHeight+"px"),o(this.box).find(".w2ui-flat").off("click").on("click",a=>{this.goFlat()})),this.bottomHTML!==""&&(o(this.box).find(".w2ui-sidebar-bottom").html(this.bottomHTML),o(this.box).find(".w2ui-sidebar-body").css("bottom",o(this.box).find(".w2ui-sidebar-bottom").get(0)?.clientHeight+"px")),this.last.observeResize=new ResizeObserver(()=>{this.resize()}),this.last.observeResize.observe(this.box),s.finish(),this.refresh(),Date.now()-t}update(e,t={}){let i=this.get(e),s;if(i){let l=o(this.box).find("#node_"+u.escapeId(i.id));if(i.group)t.text&&(i.text=t.text,l.find(".w2ui-group-text").replace(typeof i.text=="function"?i.text.call(this,i):'<span class="w2ui-group-text">'+i.text+"</span>"),delete t.text),t.class&&(i.class=t.class,s=l.data("level"),l.get(0).className="w2ui-node-group w2ui-level-"+s+(i.class?" "+i.class:""),delete t.class),t.style&&(i.style=t.style,l.get(0).nextElementSibling.style=i.style+";"+(!i.hidden&&i.expanded?"":"display: none;"),delete t.style);else{if(t.icon){let r=l.find(".w2ui-node-image > span");r.length>0&&(i.icon=t.icon,r[0].className=typeof i.icon=="function"?i.icon.call(this,i):i.icon,delete t.icon)}if(t.count){i.count=t.count;let r=i.count??this.badge.text,n=this.badge.style,a=this.last.badge[i.id];typeof r=="function"&&(r=r.call(this,i,s)),l.find(".w2ui-node-badge").html(r).attr("style",`${n}; ${a?.style??""}`),l.find(".w2ui-node-badge").length>0&&delete t.count}if(t.class&&l.length>0&&(i.class=t.class,s=l.data("level"),l[0].className="w2ui-node w2ui-level-"+s+(i.selected?" w2ui-selected":"")+(i.disabled?" w2ui-disabled":"")+(i.class?" "+i.class:""),delete t.class),t.text&&(i.text=t.text,l.find(".w2ui-node-text").html(typeof i.text=="function"?i.text.call(this,i):i.text),delete t.text),t.style&&l.length>0){let r=l.find(".w2ui-node-text");i.style=t.style,r[0].style=i.style,delete t.style}}}return t}refresh(e,t){if(this.box==null)return;let i=Date.now(),s=this,l=this.trigger("refresh",{target:e??this.name,nodeId:e??null,fullRefresh:e==null});if(l.isCancelled===!0)return;if(this.flatButton==!0?o(this.box).find(".w2ui-sidebar-top .w2ui-flat").show().removeClass("w2ui-flat-left w2ui-flat-right").addClass(` w2ui-flat-${this.flat?"right":"left"}`):o(this.box).find(".w2ui-sidebar-top .w2ui-flat").hide(),o(this.box).find(":scope > div").removeClass("w2ui-sidebar-flat").addClass(this.flat?"w2ui-sidebar-flat":"").css({width:o(this.box).get(0)?.clientWidth+"px",height:o(this.box).get(0)?.clientHeight+"px"}),this.nodes.length>0&&this.nodes[0].parent==null){let f=this.nodes;this.nodes=[],this.add(this,f)}let r=this,n,a;if(e==null)n=this,a=".w2ui-sidebar-body";else{if(n=this.get(e),n==null)return;a="#node_"+u.escapeId(n.id)+"_sub"}let h="#node_"+u.escapeId(n.id),d;n!==this&&(d=p(n),o(this.box).find(h).before('<div id="sidebar_'+this.name+'_tmp"></div>'),o(this.box).find(h).remove(),o(this.box).find(a).remove(),o(this.box).find("#sidebar_"+this.name+"_tmp").before(d),o(this.box).find("#sidebar_"+this.name+"_tmp").remove());let g=o(this.box).find(":scope > div").get(0),c={top:g?.scrollTop,left:g?.scrollLeft};o(this.box).find(a).html("");for(let f=0;f<n.nodes.length;f++){let m=n.nodes[f];if(d=p(m),o(this.box).find(a).append(d),m.nodes.length!==0)this.refresh(m.id,!0);else{let w=this.trigger("refresh",{target:m.id});if(w.isCancelled===!0)return;w.finish()}}if(g&&(g.scrollTop=c.top,g.scrollLeft=c.left),!t){let f=o(this.box).find(`${h}, ${h} .w2ui-eaction, ${a} .w2ui-eaction`);u.bindEvents(f,this)}return l.finish(),Date.now()-i;function p(f){let m="",w=f.icon;w==null&&(w=r.icon);let b=f.parent,y=0;for(;b&&b.parent!=null;)b=b.parent,y++;if(f.caption!=null&&f.text==null&&(f.text=f.caption),f.caption!=null&&(console.log("NOTICE: sidebar node.caption property is deprecated, please use node.text. Node -> ",f),f.text=f.caption),Array.isArray(f.nodes)&&f.nodes.length>0&&(f.collapsible=!0),f.group){let x=u.lang(typeof f.text=="function"?f.text.call(r,f,y):f.text);String(x).substr(0,5)!="<span"&&(x=`<span class="w2ui-group-text">${x}</span>`),m=`
                    <div id="node_${f.id}" data-id="${f.id}" data-level="${y}" style="${f.hidden?"display: none":""}"
                        class="w2ui-node-group w2ui-level-${y} ${f.class?f.class:""} w2ui-eaction"
                        data-click="toggle|${f.id}"
                        data-contextmenu="contextMenu|${f.id}|event"
                        data-mouseenter="showPlus|this|inherit"
                        data-mouseleave="showPlus|this|transparent">
                        ${f.groupShowHide&&f.collapsible?`<span>${!f.hidden&&f.expanded?u.lang("Hide"):u.lang("Show")}</span>`:"<span></span>"} ${x}
                    </div>
                    <div class="w2ui-node-sub" id="node_${f.id}_sub" style="${f.style}; ${!f.hidden&&f.expanded?"":"display: none;"}">
                </div>`,r.flat&&(m=`
                        <div class="w2ui-node-group" id="node_${f.id}" data-id="${f.id}"><span>&#160;</span></div>
                        <div id="node_${f.id}_sub" style="${f.style}; ${!f.hidden&&f.expanded?"":"display: none;"}"></div>`)}else{f.selected&&!f.disabled&&(r.multi?(r.selected??=[],r.selected.includes(f.id)||r.selected.push(f.id)):r.selected=f.id);let x="";if(w)if(w instanceof Object){let S=typeof w.text=="function"?w.text.call(r,f,y)??"":w.text;x=`
                            <div class="w2ui-node-image w2ui-eaction" style="${r.icon.style??""}; pointer-events: all"
                                data-mouseEnter="mouseAction|Enter|this|${f.id}|event|icon"
                                data-mouseLeave="mouseAction|Leave|this|${f.id}|event|icon"
                                data-click="mouseAction|click|this|${f.id}|event|icon">
                                    ${S}
                            </div>
                        `}else x=`
                            <div class="w2ui-node-image">
                                <span class="${typeof w=="function"?w.call(r,f,y):w}"></span>
                            </div>`;let C="",_="";if(s.badge!=null||f.count!=null){let S=f.count??s.badge?.text,A=s.badge?.style,T=r.last.badge[f.id];typeof S=="function"&&(S=S.call(s,f,y)),S&&(_=`
                            <div class="w2ui-node-badge w2ui-eaction ${f.count!=null?"w2ui-node-count":""} ${T?.className??""}"
                                style="${A??""};${T?.style??""}"
                                data-mouseEnter="mouseAction|Enter|this|${f.id}|event|badge"
                                data-mouseLeave="mouseAction|Leave|this|${f.id}|event|badge"
                                data-click="mouseAction|click|this|${f.id}|event|badge"
                            >
                                ${S}
                            </div>`)}let v=["w2ui-node",`w2ui-level-${y}`,"w2ui-eaction"];if(f.selected&&v.push("w2ui-selected"),f.disabled&&v.push("w2ui-disabled"),f.class&&v.push(f.class),f.collapsible===!0){let S=["w2ui-sb-toggle","w2ui-eaction",f.expanded?"w2ui-expanded":"w2ui-collapsed"];s.toggleAlign=="left"&&S.push("w2ui-left-toggle"),C=`<div class="${S.join(" ")}" data-click="toggle|${f.id}"><span></span></div>`,v.push("w2ui-has-children")}let k=u.lang(typeof f.text=="function"?f.text.call(r,f,y):f.text),D=f.parent?.childOffset??0;y===0&&f.collapsible===!0&&s.toggleAlign=="left"&&(D+=12),m=`
                    <div id="node_${f.id}" class="${v.join(" ")}" data-id="${f.id}" data-level="${y}"
                        style="${f.hidden?"display: none;":""}"
                        data-click="click|${f.id}|event"
                        data-dblclick="dblClick|${f.id}|event"
                        data-mouseDown="mouseDown|${f.id}|event"
                        data-contextmenu="contextMenu|${f.id}|event"
                        data-mouseEnter="mouseAction|Enter|this|${f.id}|event"
                        data-mouseLeave="mouseAction|Leave|this|${f.id}|event"
                    >
                        ${r.handle.text?`<div class="w2ui-node-handle w2ui-eaction" style="width: ${r.handle.width}px; ${r.handle.style}"
                                    data-mouseEnter="mouseAction|Enter|this|${f.id}|event|handle"
                                    data-mouseLeave="mouseAction|Leave|this|${f.id}|event|handle"
                                    data-click="mouseAction|click|this|${f.id}|event|handle"
                                >
                                   ${typeof r.handle.text=="function"?r.handle.text.call(r,f,y)??"":r.handle.text}
                              </div>`:""}
                      <div class="w2ui-node-data" style="margin-left: ${y*r.levelPadding+D+r.handle.width}px">
                            ${C} ${x} ${_}
                            <div class="w2ui-node-text ${x?"":"no-icon"}" style="${f.style||""}">${k}</div>
                       </div>
                    </div>
                    <div class="w2ui-node-sub" id="node_${f.id}_sub" style="${f.style}; ${!f.hidden&&f.expanded?"":"display: none;"}"></div>`,r.flat&&(m=`
                        <div id="node_${f.id}" class="${v.join(" ")}" data-id="${f.id}" style="${f.hidden?"display: none;":""}"
                            data-click="click|${f.id}|event"
                            data-dblclick="dblClick|${f.id}|event"
                            data-contextmenu="contextMenu|${f.id}|event"
                            data-mouseEnter="mouseAction|Enter|this|${f.id}|event|tooltip"
                            data-mouseLeave="mouseAction|Leave|this|${f.id}|event|tooltip"
                        >
                            <div class="w2ui-node-data w2ui-node-flat">${x}</div>
                        </div>
                        <div class="w2ui-node-sub" id="node_${f.id}_sub" style="${f.style}; ${!f.hidden&&f.expanded?"":"display: none;"}"></div>`)}return m}}mouseAction(e,t,i,s,l){let r,n=this.get(i);if(l==null&&(r=this.trigger("mouse"+e,{target:n.id,node:n,originalEvent:s})),l=="tooltip"){let h=u.lang(typeof n.text=="function"?n.text.call(this,n):n.text)+(n.count||n.count===0?' - <span class="w2ui-node-badge w2ui-node-count">'+n.count+"</span>":"");e=="Leave"&&(h=""),this.tooltip(t,h)}if(l=="handle")if(e=="click"){let a=this.handle.onClick;typeof a=="function"&&a.call(this,n,s)}else{let a=this.handle.tooltip;typeof a=="function"&&(a=a.call(this,n,s)),e=="Leave"&&(a=""),this.otherTooltip(t,a)}if(l=="icon")if(e=="click"){let a=this.icon.onClick;typeof a=="function"&&a.call(this,n,s)}else{let a=this.icon.tooltip;typeof a=="function"&&(a=a.call(this,n,s)),e=="Leave"&&(a=""),this.otherTooltip(t,a)}if(l=="badge")if(e=="click"){let a=this.badge?.onClick;typeof a=="function"&&a.call(this,n,s)}else{let a=this.badge?.tooltip;typeof a=="function"&&(a=a.call(this,n,s)),e=="Leave"&&(a=""),this.otherTooltip(t,a)}r?.finish()}tooltip(e,t){let i=o(e).find(".w2ui-node-data");t!==""?O.show({anchor:i.get(0),name:this.name+"_tooltip",html:t,position:"right|left"}):O.hide(this.name+"_tooltip")}otherTooltip(e,t){t!==""?O.show({anchor:e,name:this.name+"_tooltip",html:t,position:"top|bottom"}):O.hide(this.name+"_tooltip")}showPlus(e,t){o(e).find("span:nth-child(1)").css("color",t)}resize(){let e=Date.now(),t=this.trigger("resize",{target:this.name});if(t.isCancelled!==!0){if(this.box!=null){let i=o(this.box).get(0).getBoundingClientRect();o(this.box).css("overflow","hidden"),o(this.box).find(":scope > div").css({width:i.width+"px",height:i.height+"px"})}return t.finish(),Date.now()-e}}destroy(){let e=this.trigger("destroy",{target:this.name});e.isCancelled!==!0&&(o(this.box).find(".w2ui-sidebar-body").length>0&&this.unmount(),delete N[this.name],e.finish())}unmount(){super.unmount(),this.last.observeResize?.disconnect()}lock(e,t){let i=Array.from(arguments);i.unshift(this.box),u.lock(...i)}unlock(e){u.unlock(this.box,e)}},ce=class extends Y{constructor(e){super(e.name),this.box=null,this.name=null,this.active=null,this.reorder=!1,this.flow="down",this.tooltip="top|left",this.tabs=[],this.routeData={},this.last={},this.right="",this.style="",this.onClick=null,this.onMouseEnter=null,this.onMouseLeave=null,this.onMouseDown=null,this.onMouseUp=null,this.onClose=null,this.onRender=null,this.onRefresh=null,this.onResize=null,this.onDestroy=null,this.tab_template={id:null,text:null,route:null,hidden:!1,disabled:!1,closable:!1,tooltip:null,style:"",onClick:null,onRefresh:null,onClose:null};let t=e.tabs;delete e.tabs,Object.assign(this,e),Array.isArray(t)&&this.add(t),e.tabs=t,typeof this.box=="string"&&(this.box=o(this.box).get(0)),this.box&&this.render(this.box)}add(e){return this.insert(null,e)}insert(e,t){Array.isArray(t)||(t=[t]);let i=[];return t.forEach(s=>{if(s.id==null){console.log(`ERROR: The parameter "id" is required but not supplied. (obj: ${this.name})`);return}if(!u.checkUniqueId(s.id,this.tabs,"tabs",this.name))return;let l=Object.assign({},this.tab_template,s);if(e==null)this.tabs.push(l),i.push(this.animateInsert(null,l));else{let r=this.get(e,!0),n=this.tabs[r].id;this.tabs.splice(r,0,l),i.push(this.animateInsert(n,l))}}),Promise.all(i)}remove(){let e=0;return Array.from(arguments).forEach(t=>{let i=this.get(t);i&&(e++,this.tabs.splice(this.get(i.id,!0),1),o(this.box).find(`#tabs_${this.name}_tab_${u.escapeId(i.id)}`).remove())}),this.resize(),e}select(e){return this.active==e||this.get(e)==null?!1:(this.active=e,this.refresh(),!0)}set(e,t){let i=this.get(e,!0);return i==null?!1:(u.extend(this.tabs[i],t),this.refresh(e),!0)}get(e,t){if(arguments.length===0){let i=[];for(let s=0;s<this.tabs.length;s++)this.tabs[s].id!=null&&i.push(this.tabs[s].id);return i}else for(let i=0;i<this.tabs.length;i++)if(this.tabs[i].id==e)return t===!0?i:this.tabs[i];return null}show(){let e=[];return Array.from(arguments).forEach(t=>{let i=this.get(t);!i||i.hidden===!1||(i.hidden=!1,e.push(i.id))}),setTimeout(()=>{e.forEach(t=>{this.refresh(t),this.resize()})},15),e}hide(){let e=[];return Array.from(arguments).forEach(t=>{let i=this.get(t);!i||i.hidden===!0||(i.hidden=!0,e.push(i.id))}),setTimeout(()=>{e.forEach(t=>{this.refresh(t),this.resize()})},15),e}enable(){let e=[];return Array.from(arguments).forEach(t=>{let i=this.get(t);!i||i.disabled===!1||(i.disabled=!1,e.push(i.id))}),setTimeout(()=>{e.forEach(t=>{this.refresh(t)})},15),e}disable(){let e=[];return Array.from(arguments).forEach(t=>{let i=this.get(t);!i||i.disabled===!0||(i.disabled=!0,e.push(i.id))}),setTimeout(()=>{e.forEach(t=>{this.refresh(t)})},15),e}dragMove(e){if(!this.last.reordering)return;let t=this,i=this.last.moving,s=this.tabs[i.index],l=a(i.index,1),r=a(i.index,-1),n=o(this.box).find("#tabs_"+this.name+"_tab_"+u.escapeId(s.id));if(i.divX>0&&l){let h=o(this.box).find("#tabs_"+this.name+"_tab_"+u.escapeId(l.id)),d=parseInt(n.get(0).clientWidth),g=parseInt(h.get(0).clientWidth);if(d<g?(d=Math.floor(d/3),g=g-d):(d=Math.floor(g/3),g=g-d),i.divX>g){let c=this.tabs.indexOf(l);this.tabs.splice(i.index,0,this.tabs.splice(c,1)[0]),i.$tab.before(h.get(0)),i.$tab.css("opacity",0),Object.assign(this.last.moving,{index:c,divX:-d,x:e.pageX+d,left:i.left+i.divX+d});return}}if(i.divX<0&&r){let h=o(this.box).find("#tabs_"+this.name+"_tab_"+u.escapeId(r.id)),d=parseInt(n.get(0).clientWidth),g=parseInt(h.get(0).clientWidth);if(d<g?(d=Math.floor(d/3),g=g-d):(d=Math.floor(g/3),g=g-d),Math.abs(i.divX)>g){let c=this.tabs.indexOf(r);this.tabs.splice(i.index,0,this.tabs.splice(c,1)[0]),h.before(i.$tab),i.$tab.css("opacity",0),Object.assign(i,{index:c,divX:d,x:e.pageX-d,left:i.left+i.divX-d});return}}function a(h,d){h+=d;let g=t.tabs[h];return g&&g.hidden&&(g=a(h,d)),g}}mouseAction(e,t,i){let s=this.get(t),l=this.trigger("mouse"+e,{target:t,tab:s,object:s,originalEvent:i});if(!(l.isCancelled===!0||s?.disabled||s?.hidden)){switch(e){case"Enter":this.tooltipShow(t);break;case"Leave":this.tooltipHide(t);break;case"Down":this.initReorder(t,i);break;case"Up":break}l.finish()}}tooltipShow(e){let t=this.get(e),i=o(this.box).find("#tabs_"+this.name+"_tab_"+u.escapeId(e)).get(0);if(this.tooltip==null||t?.disabled||this.last.reordering)return;let s=this.tooltip,l=t?.tooltip;typeof l=="function"&&(l=l.call(this,t)),O.show({anchor:i,name:this.name+"_tooltip",html:l,position:s})}tooltipHide(e){this.tooltip!=null&&O.hide(this.name+"_tooltip")}getTabHTML(e){let t=this.get(e,!0),i=this.tabs[t];if(i==null)return!1;i.text==null&&i.caption!=null&&(i.text=i.caption),i.tooltip==null&&i.hint!=null&&(i.tooltip=i.hint),i.caption!=null&&console.log("NOTICE: tabs tab.caption property is deprecated, please use tab.text. Tab -> ",i),i.hint!=null&&console.log("NOTICE: tabs tab.hint property is deprecated, please use tab.tooltip. Tab -> ",i);let s=i.text;typeof s=="function"&&(s=s.call(this,i)),s==null&&(s="");let l="",r="";return i.hidden&&(r+="display: none;"),i.disabled&&(r+="opacity: 0.2;"),i.closable&&!i.disabled&&(l=`<div class="w2ui-tab-close w2ui-eaction ${this.active===i.id?"active":""}"
                data-mousedown="stop" data-mouseup="clickClose|${i.id}|event">
            </div>`),`
            <div id="tabs_${this.name}_tab_${i.id}" style="${r} ${i.style}"
                class="w2ui-tab w2ui-eaction ${this.active===i.id?"active":""} ${i.closable?"closable":""} ${i.class?i.class:""}"
                data-mouseenter="mouseAction|Enter|${i.id}|event]"
                data-mouseleave="mouseAction|Leave|${i.id}|event]"
                data-mousedown="mouseAction|Down|${i.id}|event"
                data-mouseup="mouseAction|Up|${i.id}|event"
                data-click="click|${i.id}|event"
               >
                    ${u.lang(s)+l}
            </div>`}refresh(e){let t=Date.now();this.flow=="up"?o(this.box).addClass("w2ui-tabs-up"):o(this.box).removeClass("w2ui-tabs-up");let i=this.trigger("refresh",{target:e??this.name,object:this.get(e)});if(i.isCancelled!==!0){if(e==null)for(let s=0;s<this.tabs.length;s++)this.refresh(this.tabs[s].id);else{let s="#tabs_"+this.name+"_tab_"+u.escapeId(e),l=o(this.box).find(s),r=this.getTabHTML(e);l.length===0?o(this.box).find("#tabs_"+this.name+"_right").before(r):o(this.box).find(".tab-animate-insert").length==0&&l.replace(r),u.bindEvents(o(this.box).find(`${s}, ${s} .w2ui-eaction`),this)}return o(this.box).find("#tabs_"+this.name+"_right").html(this.right),i.finish(),Date.now()-t}}render(e){let t=Date.now();typeof e=="string"&&(e=o(e).get(0));let i=this.trigger("render",{target:this.name,box:e??this.box});if(i.isCancelled===!0)return;if(e!=null&&(this.unmount(),this.box=e),!this.box)return!1;let s=`
            <div class="w2ui-tabs-line"></div>
            <div class="w2ui-scroll-wrapper w2ui-eaction" data-mousedown="resize">
                <div id="tabs_${this.name}_right" class="w2ui-tabs-right">${this.right}</div>
            </div>
            <div class="w2ui-scroll-left w2ui-eaction" data-click='["scroll","left"]'></div>
            <div class="w2ui-scroll-right w2ui-eaction" data-click='["scroll","right"]'></div>`;return o(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-tabs").html(s),o(this.box).length>0&&(o(this.box)[0].style.cssText+=this.style),u.bindEvents(o(this.box).find(".w2ui-eaction"),this),this.last.observeResize=new ResizeObserver(()=>{this.resize()}),this.last.observeResize.observe(this.box),i.finish(),this.refresh(),this.resize(),Date.now()-t}initReorder(e,t){if(!this.reorder)return;let i=this,s=o(this.box).find("#tabs_"+this.name+"_tab_"+u.escapeId(e)),l=this.get(e,!0),r=o(s.get(0).cloneNode(!0)),n;r.attr("id","#tabs_"+this.name+"_tab_ghost"),this.last.moving={index:l,indexFrom:l,$tab:s,$ghost:r,divX:0,left:s.get(0).getBoundingClientRect().left,parentX:o(this.box).get(0).getBoundingClientRect().left,x:t.pageX,opacity:s.css("opacity")},o(document).off(".w2uiTabReorder").on("mousemove.w2uiTabReorder",function(a){if(!i.last.reordering){if(n=i.trigger("reorder",{target:i.tabs[l].id,indexFrom:l,tab:i.tabs[l]}),n.isCancelled===!0)return;O.hide(this.name+"_tooltip"),i.last.reordering=!0,r.addClass("moving"),r.css({"pointer-events":"none",position:"absolute",left:s.get(0).getBoundingClientRect().left}),s.css("opacity",0),o(i.box).find(".w2ui-scroll-wrapper").append(r.get(0)),o(i.box).find(".w2ui-tab-close").hide()}i.last.moving.divX=a.pageX-i.last.moving.x,r.css("left",i.last.moving.left-i.last.moving.parentX+i.last.moving.divX+"px"),i.dragMove(a)}).on("mouseup.w2uiTabReorder",function(){o(document).off(".w2uiTabReorder"),r.css({transition:"0.1s",left:i.last.moving.$tab.get(0).getBoundingClientRect().left-i.last.moving.parentX}),o(i.box).find(".w2ui-tab-close").show(),r.remove(),s.css({opacity:i.last.moving.opacity}),i.last.reordering&&n.finish({indexTo:i.last.moving.index}),i.last.reordering=!1})}scroll(e,t){return new Promise((i,s)=>{let l=o(this.box).find(".w2ui-scroll-wrapper"),r=l.get(0).scrollLeft,n=l.find(".w2ui-tabs-right").get(0),a=l.parent().get(0).getBoundingClientRect().width,h=r+parseInt(n.offsetLeft)+parseInt(n.clientWidth);switch(e){case"left":{let d=r-a+50;d<=0&&(d=0),l.get(0).scrollTo({top:0,left:d,behavior:t?"atuo":"smooth"});break}case"right":{let d=r+a-50;d>=h-a&&(d=h-a),l.get(0).scrollTo({top:0,left:d,behavior:t?"atuo":"smooth"});break}}setTimeout(()=>{this.resize(),i()},t?0:350)})}scrollIntoView(e,t){return new Promise((i,s)=>{if(e==null&&(e=this.active),this.get(e)==null)return;o(this.box).find("#tabs_"+this.name+"_tab_"+u.escapeId(e)).get(0).scrollIntoView({block:"start",inline:"center",behavior:t?"atuo":"smooth"}),setTimeout(()=>{this.resize(),i()},t?0:500)})}resize(){let e=Date.now();if(this.box==null)return;let t=this.trigger("resize",{target:this.name});if(t.isCancelled!==!0){if(this.box!=null){let i=o(this.box);i.find(".w2ui-scroll-left, .w2ui-scroll-right").hide();let s=i.find(".w2ui-scroll-wrapper").get(0),l=i.find(".w2ui-tabs-right"),r=i.get(0).getBoundingClientRect().width,n=l.length>0?l[0].offsetLeft+l[0].clientWidth:0;r<n&&(s.scrollLeft>0&&i.find(".w2ui-scroll-left").show(),r<n-s.scrollLeft&&i.find(".w2ui-scroll-right").show())}return t.finish(),Date.now()-e}}destroy(){let e=this.trigger("destroy",{target:this.name});e.isCancelled!==!0&&(o(this.box).find("#tabs_"+this.name+"_right").length>0&&this.unmount(),delete N[this.name],e.finish())}unmount(){super.unmount(),this.last.observeResize?.disconnect()}click(e,t){let i=this.get(e);if(i==null||i.disabled||this.last.reordering)return!1;let s=this.trigger("click",{target:e,tab:i,object:i,originalEvent:t});if(s.isCancelled!==!0){if(o(this.box).find("#tabs_"+this.name+"_tab_"+u.escapeId(this.active)).removeClass("active"),this.active=i.id,o(this.box).find("#tabs_"+this.name+"_tab_"+u.escapeId(this.active)).addClass("active"),typeof i.route=="string"){let l=i.route!==""?("/"+i.route).replace(/\/{2,}/g,"/"):"",r=u.parseRoute(l);if(r.keys.length>0)for(let n=0;n<r.keys.length;n++)this.routeData[r.keys[n].name]!=null&&(l=l.replace(new RegExp(":"+r.keys[n].name,"g"),this.routeData[r.keys[n].name]));setTimeout(()=>{window.location.hash=l},1)}s.finish()}}clickClose(e,t){let i=this.get(e);if(i==null||i.disabled)return!1;let s=this.trigger("close",{target:e,object:i,tab:i,originalEvent:t});s.isCancelled!==!0&&(this.animateClose(e).then(()=>{this.remove(e),s.finish(),this.refresh()}),t&&t.stopPropagation())}animateClose(e){return new Promise((t,i)=>{let s=o(this.box).find("#tabs_"+this.name+"_tab_"+u.escapeId(e)),r=`<div class="tab-animate-close" style="display: inline-block; flex-shrink: 0; width: ${parseInt(s.get(0).clientWidth||0)}px; transition: width 0.25s"></div>`,n=s.replace(r);setTimeout(()=>{n.css({width:"0px"})},1),setTimeout(()=>{n.remove(),this.resize(),t()},500)})}animateInsert(e,t){return new Promise((i,s)=>{let l=o(this.box).find("#tabs_"+this.name+"_tab_"+u.escapeId(e)),r=o.html(this.getTabHTML(t.id));if(l.length==0)l=o(this.box).find("#tabs_tabs_right"),l.before(r),this.resize();else{r.css({opacity:0}),o(this.box).find("#tabs_tabs_right").before(r.get(0));let a=o(this.box).find("#"+r.attr("id")).get(0)?.clientWidth??0,h=o.html('<div class="tab-animate-insert" style="flex-shrink: 0; width: 0; transition: width 0.25s"></div>');l.before(h),r.hide(),h.before(r[0]),setTimeout(()=>{h.css({width:a+"px"})},1),setTimeout(()=>{h.remove(),r.css({opacity:1}).show(),this.refresh(t.id),this.resize(),i()},500)}})}},B=["top","left","main","preview","right","bottom"],ue=class extends Y{constructor(e){super(e.name),this.box=null,this.name=null,this.panels=[],this.last={},this.padding=1,this.resizer=4,this.style="",this.onShow=null,this.onHide=null,this.onResizing=null,this.onResizerClick=null,this.onRender=null,this.onRefresh=null,this.onChange=null,this.onResize=null,this.onDestroy=null,this.panel_template={type:null,title:"",size:100,minSize:20,maxSize:!1,hidden:!1,resizable:!1,overflow:"auto",style:"",html:"",tabs:null,toolbar:null,width:null,height:null,show:{toolbar:!1,tabs:!1},removed:null,onRefresh:null,onShow:null,onHide:null},Object.assign(this,e),Array.isArray(this.panels)||(this.panels=[]),this.panels.forEach((s,l)=>{this.panels[l]=u.extend({},this.panel_template,s),(u.isPlainObject(s.tabs)||Array.isArray(s.tabs))&&t(this,s.type),(u.isPlainObject(s.toolbar)||Array.isArray(s.toolbar))&&i(this,s.type)}),B.forEach(s=>{this.get(s)==null&&this.panels.push(u.extend({},this.panel_template,{type:s,hidden:s!=="main",size:50}))}),typeof this.box=="string"&&(this.box=o(this.box).get(0)),this.box&&this.render(this.box);function t(s,l,r){let n=s.get(l);if(n!=null&&r==null&&(r=n.tabs),n==null||r==null)return!1;Array.isArray(r)&&(r={tabs:r});let a=s.name+"_"+l+"_tabs";return N[a]&&N[a].destroy(),n.tabs=new ce(u.extend({},r,{owner:s,name:s.name+"_"+l+"_tabs"})),n.show.tabs=!0,!0}function i(s,l,r){let n=s.get(l);if(n!=null&&r==null&&(r=n.toolbar),n==null||r==null)return!1;Array.isArray(r)&&(r={items:r});let a=s.name+"_"+l+"_toolbar";return N[a]&&N[a].destroy(),n.toolbar=new Z(u.extend({},r,{owner:s,name:s.name+"_"+l+"_toolbar"})),n.show.toolbar=!0,!0}}html(e,t,i){let s=this.get(e),l={panel:e,html:s.html,error:!1,cancelled:!1,removed(d){typeof d=="function"&&(s.removed=d)}};if(typeof s.removed=="function"&&(s.removed({panel:e,html:s.html,html_new:t,transition:i||"none"}),s.removed=null),e=="css")return o(this.box).find("#layout_"+this.name+"_panel_css").html("<style>"+t+"</style>"),l.status=!0,l;if(s==null)return console.log("ERROR: incorrect panel name. Panel name can be main, left, right, top, bottom, preview or css"),l.error=!0,l;if(t==null)return l;let r=this.trigger("change",{target:e,panel:s,html_new:t,transition:i});if(r.isCancelled===!0)return l.cancelled=!0,l;let n="#layout_"+this.name+"_panel_"+s.type,a=o(this.box).find(n+'> [data-role="panel-content"]'),h=0;if(a.length>0&&(o(this.box).find(n).get(0).scrollTop=0,h=o(a).css("top")),typeof s.html.unmount=="function"&&s.html.unmount(),a.addClass("w2ui-panel-content"),a.removeAttr("style"),this.resizeBoxes(e),s.html==="")s.html=t,this.refresh(e);else if(s.html=t,!s.hidden)if(i!=null&&i!==""){o(this.box).addClass("animating");let d=o(this.box).find(n+'> [data-role="panel-content"]');d.after('<div class="w2ui-panel-content new-panel" data-role="panel-content" style="'+d[0].style.cssText+'"></div>');let g=o(this.box).find(n+'> [data-role="panel-content"].new-panel');d.css("top",h),g.css("top",h),typeof t=="object"?(t.box=g[0],t.render()):g.hide().html(t),u.transition(d[0],g[0],i,()=>{d.remove(),g.removeClass("new-panel"),g.css("overflow",s.overflow),o(o(this.box).find(n+'> [data-role="panel-content"]').get(1)).remove(),o(this.box).removeClass("animating"),this.refresh(e)})}else this.refresh(e);return r.finish(),l}message(e,t){let i=this.get(e),s=o(this.box).find("#layout_"+this.name+"_panel_"+i.type),l=s.css("overflow");s.css("overflow","hidden");let r=u.message({owner:this,box:s.get(0),after:".w2ui-panel-title",param:e},t);return r&&r.self.on("close:after",()=>{s.css("overflow",l)}),r}confirm(e,t){let i=this.get(e),s=o(this.box).find("#layout_"+this.name+"_panel_"+i.type),l=s.css("overflow");s.css("overflow","hidden");let r=u.confirm({owner:this,box:s.get(0),after:".w2ui-panel-title",param:e},t);return r&&r.self.on("close:after",()=>{s.css("overflow",l)}),r}load(e,t,i){return new Promise((s,l)=>{(e=="css"||this.get(e)!=null)&&t!=null?fetch(t).then(r=>r.text()).then(r=>{this.resize(),s(this.html(e,r,i))}):l()})}sizeTo(e,t,i){return this.get(e)==null?!1:(o(this.box).find(":scope > div > .w2ui-panel").css("transition",i!==!0?".2s":"0s"),setTimeout(()=>{this.set(e,{size:t})},1),setTimeout(()=>{o(this.box).find(":scope > div > .w2ui-panel").css("transition","0s"),this.resize()},300),!0)}show(e,t){let i=this.trigger("show",{target:e,thisect:this.get(e),immediate:t});if(i.isCancelled===!0)return;let s=this.get(e);return s==null?!1:(s.hidden=!1,t===!0?(o(this.box).find("#layout_"+this.name+"_panel_"+e).css({opacity:"1"}),i.finish(),this.resize()):(o(this.box).addClass("animating"),o(this.box).find("#layout_"+this.name+"_panel_"+e).css({opacity:"0"}),o(this.box).find(":scope > div > .w2ui-panel").css("transition",".2s"),setTimeout(()=>{this.resize()},1),setTimeout(()=>{o(this.box).find("#layout_"+this.name+"_panel_"+e).css({opacity:"1"})},250),setTimeout(()=>{o(this.box).find(":scope > div > .w2ui-panel").css("transition","0s"),o(this.box).removeClass("animating"),i.finish(),this.resize()},300)),!0)}hide(e,t){let i=this.trigger("hide",{target:e,object:this.get(e),immediate:t});if(i.isCancelled===!0)return;let s=this.get(e);return s==null?!1:(s.hidden=!0,t===!0?(o(this.box).find("#layout_"+this.name+"_panel_"+e).css({opacity:"0"}),i.finish(),this.resize()):(o(this.box).addClass("animating"),o(this.box).find(":scope > div > .w2ui-panel").css("transition",".2s"),o(this.box).find("#layout_"+this.name+"_panel_"+e).css({opacity:"0"}),setTimeout(()=>{this.resize()},1),setTimeout(()=>{o(this.box).find(":scope > div > .w2ui-panel").css("transition","0s"),o(this.box).removeClass("animating"),i.finish(),this.resize()},300)),!0)}toggle(e,t){let i=this.get(e);return i==null?!1:i.hidden?this.show(e,t):this.hide(e,t)}set(e,t){let i=this.get(e,!0);return i==null?!1:(u.extend(this.panels[i],t),(t.html!=null||t.resizable!=null)&&this.refresh(e),this.resize(),!0)}get(e,t){for(let i=0;i<this.panels.length;i++)if(this.panels[i].type==e)return t===!0?i:this.panels[i];return null}el(e){let t=o(this.box).find("#layout_"+this.name+"_panel_"+e+'> [data-role="panel-content"]');return t.length!=1?null:t[0]}hideToolbar(e){let t=this.get(e);t&&(t.show.toolbar=!1,o(this.box).find(`#layout_${this.name}_panel_${e} > [data-role="panel-toolbar"]`).hide(),this.resize())}showToolbar(e){let t=this.get(e);t&&(t.show.toolbar=!0,o(this.box).find(`#layout_${this.name}_panel_${e} > [data-role="panel-toolbar"]`).show(),this.resize())}toggleToolbar(e){let t=this.get(e);t&&(t.show.toolbar?this.hideToolbar(e):this.showToolbar(e))}assignToolbar(e,t){typeof t=="string"&&N[t]!=null&&(t=N[t]);let i=this.get(e);i.toolbar=t;let s=o(this.box).find(e+'> [data-role="panel-toolbar"]');i.toolbar!=null?(s.attr("name")!=i.toolbar.name?i.toolbar.render(s.get(0)):i.toolbar!=null&&i.toolbar.refresh(),t.owner=this,this.showToolbar(e),this.refresh(e)):(s.html(""),this.hideToolbar(e))}hideTabs(e){let t=this.get(e);t&&(t.show.tabs=!1,o(this.box).find("#layout_"+this.name+"_panel_"+e+'> [data-role="panel-tabs"]').hide(),this.resize())}showTabs(e){let t=this.get(e);t&&(t.show.tabs=!0,o(this.box).find("#layout_"+this.name+"_panel_"+e+'> [data-role="panel-tabs"]').show(),this.resize())}toggleTabs(e){let t=this.get(e);t&&(t.show.tabs?this.hideTabs(e):this.showTabs(e))}render(e){let t=Date.now(),i=this;typeof e=="string"&&(e=o(e).get(0));let s=this.trigger("render",{target:this.name,box:e??this.box});if(s.isCancelled===!0)return;if(e!=null&&(this.unmount(),this.box=e),!this.box)return!1;o(this.box).attr("name",this.name).addClass("w2ui-layout").html("<div></div>"),o(this.box).length>0&&(o(this.box)[0].style.cssText+=this.style);for(let a=0;a<B.length;a++){let h='<div id="layout_'+this.name+"_panel_"+B[a]+'" class="w2ui-panel">    <div class="w2ui-panel-title"></div>    <div class="w2ui-panel-tabs" data-role="panel-tabs"></div>    <div class="w2ui-panel-toolbar" data-role="panel-toolbar"></div>    <div class="w2ui-panel-content" data-role="panel-content"></div></div><div id="layout_'+this.name+"_resizer_"+B[a]+'" class="w2ui-resizer"></div>';o(this.box).find(":scope > div").append(h)}return o(this.box).find(":scope > div").append('<div id="layout_'+this.name+'_panel_css" style="position: absolute; top: 10000px;"></div>'),this.refresh(),this.last.observeResize=new ResizeObserver(()=>{this.resize()}),this.last.observeResize.observe(this.box),s.finish(),setTimeout(()=>{i.last.events={resizeStart:l,mouseMove:n,mouseUp:r},this.resize()},0),Date.now()-t;function l(a,h){if(!i.box)return;h||(h=window.event),o(document).off("mousemove",i.last.events.mouseMove).on("mousemove",i.last.events.mouseMove),o(document).off("mouseup",i.last.events.mouseUp).on("mouseup",i.last.events.mouseUp),i.last.resize={type:a,x:h.screenX,y:h.screenY,diff_x:0,diff_y:0,value:0},B.forEach(g=>{let c=o(i.el(g)).find(".w2ui-lock");c.length>0?c.data("locked","yes"):i.lock(g,{opacity:0})});let d=o(i.box).find("#layout_"+i.name+"_resizer_"+a).get(0);(a=="left"||a=="right")&&(i.last.resize.value=parseInt(d.style.left)),(a=="top"||a=="preview"||a=="bottom")&&(i.last.resize.value=parseInt(d.style.top))}function r(a){if(i.box&&(a||(a=window.event),o(document).off("mousemove",i.last.events.mouseMove),o(document).off("mouseup",i.last.events.mouseUp),i.last.resize!=null)){if(B.forEach(h=>{let d=o(i.el(h)).find(".w2ui-lock");d.data("locked")=="yes"?d.removeData("locked"):i.unlock(h)}),i.last.diff_x!==0||i.last.resize.diff_y!==0){let h=i.get("top"),d=i.get("bottom"),g=i.get(i.last.resize.type),c=u.getSize(o(i.box),"width"),p=u.getSize(o(i.box),"height"),f=String(g.size),m,w;switch(i.last.resize.type){case"top":m=parseInt(g.sizeCalculated)+i.last.resize.diff_y,w=0;break;case"bottom":m=parseInt(g.sizeCalculated)-i.last.resize.diff_y,w=0;break;case"preview":m=parseInt(g.sizeCalculated)-i.last.resize.diff_y,w=(h&&!h.hidden?h.sizeCalculated:0)+(d&&!d.hidden?d.sizeCalculated:0);break;case"left":m=parseInt(g.sizeCalculated)+i.last.resize.diff_x,w=0;break;case"right":m=parseInt(g.sizeCalculated)-i.last.resize.diff_x,w=0;break}f.substr(f.length-1)=="%"?g.size=Math.floor(m*100/(g.type=="left"||g.type=="right"?c:p-w)*100)/100+"%":String(g.size).substr(0,1)=="-"?g.size=parseInt(g.size)-g.sizeCalculated+m:g.size=m,i.resize()}o(i.box).find("#layout_"+i.name+"_resizer_"+i.last.resize.type).removeClass("active"),delete i.last.resize}}function n(a){if(!i.box||(a||(a=window.event),i.last.resize==null))return;let h=i.get(i.last.resize.type),d=i.last.resize,g=i.trigger("resizing",{target:i.name,object:h,originalEvent:a,panel:d?d.type:"all",diff_x:d?d.diff_x:0,diff_y:d?d.diff_y:0});if(g.isCancelled===!0)return;let c=o(i.box).find("#layout_"+i.name+"_resizer_"+d.type),p=a.screenX-d.x,f=a.screenY-d.y,m=i.get("main");switch(c.hasClass("active")||c.addClass("active"),d.type){case"left":h.minSize-p>h.width&&(p=h.minSize-h.width),h.maxSize&&h.width+p>h.maxSize&&(p=h.maxSize-h.width),m.minSize+p>m.width&&(p=m.width-m.minSize);break;case"right":h.minSize+p>h.width&&(p=h.width-h.minSize),h.maxSize&&h.width-p>h.maxSize&&(p=h.width-h.maxSize),m.minSize-p>m.width&&(p=m.minSize-m.width);break;case"top":h.minSize-f>h.height&&(f=h.minSize-h.height),h.maxSize&&h.height+f>h.maxSize&&(f=h.maxSize-h.height),m.minSize+f>m.height&&(f=m.height-m.minSize);break;case"preview":case"bottom":h.minSize+f>h.height&&(f=h.height-h.minSize),h.maxSize&&h.height-f>h.maxSize&&(f=h.height-h.maxSize),m.minSize-f>m.height&&(f=m.minSize-m.height);break}switch(d.diff_x=p,d.diff_y=f,d.type){case"top":case"preview":case"bottom":d.diff_x=0,c.length>0&&(c[0].style.top=d.value+d.diff_y+"px");break;case"left":case"right":d.diff_y=0,c.length>0&&(c[0].style.left=d.value+d.diff_x+"px");break}g.finish()}}unmount(){super.unmount(),this.panels.forEach(e=>{e.tabs?.unmount?.(),e.toolbar?.unmount?.()}),this.last.observeResize?.disconnect()}destroy(){let e=this.trigger("destroy",{target:this.name});if(e.isCancelled!==!0)return N[this.name]==null?!1:(this.panels.forEach(t=>{t.tabs?.destroy?.(),t.toolbar?.destroy?.()}),o(this.box).find("#layout_"+this.name+"_panel_main").length>0&&this.unmount(),delete N[this.name],e.finish(),this.last.events&&this.last.events.resize&&o(window).off("resize",this.last.events.resize),!0)}refresh(e){let t=this;e==null&&(e=null);let i=Date.now(),s=t.trigger("refresh",{target:e??t.name,object:t.get(e)});if(s.isCancelled!==!0){if(typeof e=="string"){let l=t.get(e);if(l==null)return;let r="#layout_"+t.name+"_panel_"+l.type,n="#layout_"+t.name+"_resizer_"+l.type;o(t.box).find(r).css({display:l.hidden?"none":"block"}),l.resizable?o(t.box).find(n).show():o(t.box).find(n).hide(),typeof l.html=="object"&&typeof l.html.render=="function"?(l.html.box=o(t.box).find(r+'> [data-role="panel-content"]')[0],setTimeout(()=>{o(t.box).find(r+'> [data-role="panel-content"]').length>0&&(o(t.box).find(r+'> [data-role="panel-content"]').removeClass().removeAttr("name").addClass("w2ui-panel-content").css("overflow",l.overflow)[0].style.cssText+=";"+l.style),l.html&&typeof l.html.render=="function"&&l.html.render()},1)):o(t.box).find(r+'> [data-role="panel-content"]').length>0&&(o(t.box).find(r+'> [data-role="panel-content"]').removeClass().removeAttr("name").addClass("w2ui-panel-content").html(l.html).css("overflow",l.overflow)[0].style.cssText+=";"+l.style);let a=o(t.box).find(r+'> [data-role="panel-tabs"]');l.show.tabs?(a.attr("name")!=l.tabs.name&&l.tabs!=null?l.tabs.render(a.get(0)):l.tabs.refresh(),a.addClass("w2ui-panel-tabs")):a.html("").removeAttr("name").removeClass("w2ui-tabs").hide(),a=o(t.box).find(r+'> [data-role="panel-toolbar"]'),l.show.toolbar?(a.attr("name")!=l.toolbar.name&&l.toolbar!=null?l.toolbar.render(a.get(0)):l.toolbar.refresh(),a.addClass("w2ui-panel-toolbar")):a.html("").removeAttr("name").removeClass("w2ui-toolbar").hide(),a=o(t.box).find(r+"> .w2ui-panel-title"),l.title?a.html(l.title).show():a.html("").hide()}else{if(o(t.box).find("#layout_"+t.name+"_panel_main").length===0){t.render();return}t.resize();for(let l=0;l<this.panels.length;l++)t.refresh(this.panels[l].type)}return s.finish(),Date.now()-i}}resize(){if(!this.box)return!1;let e=Date.now(),t=this.last.resize,i=this.trigger("resize",{target:this.name,panel:t?t.type:"all",diff_x:t?t.diff_x:0,diff_y:t?t.diff_y:0});if(i.isCancelled===!0)return;this.padding<0&&(this.padding=0);let s=u.getSize(o(this.box),"width"),l=u.getSize(o(this.box),"height"),r=this,n=this.get("main"),a=this.get("preview"),h=this.get("left"),d=this.get("right"),g=this.get("top"),c=this.get("bottom"),p=a!=null&&a.hidden!==!0,f=h!=null&&h.hidden!==!0,m=d!=null&&d.hidden!==!0,w=g!=null&&g.hidden!==!0,b=c!=null&&c.hidden!==!0,y,x,C,_;for(let v=0;v<B.length;v++){if(B[v]==="main"||(t=this.get(B[v]),!t))continue;let k=String(t.size||0);if(k.substr(k.length-1)=="%"){let D=l;t.type=="preview"&&(D=D-(g&&!g.hidden?g.sizeCalculated:0)-(c&&!c.hidden?c.sizeCalculated:0)),t.sizeCalculated=parseInt((t.type=="left"||t.type=="right"?s:D)*parseFloat(t.size)/100)}else t.sizeCalculated=parseInt(t.size);t.sizeCalculated=Math.max(t.sizeCalculated,parseInt(t.minSize))}return String(d.size).substr(0,1)=="-"&&(f&&String(h.size).substr(0,1)=="-"?console.log("ERROR: you cannot have both left panel.size and right panel.size be negative."):d.sizeCalculated=s-(f?h.sizeCalculated:0)+parseInt(d.size)),String(h.size).substr(0,1)=="-"&&(m&&String(d.size).substr(0,1)=="-"?console.log("ERROR: you cannot have both left panel.size and right panel.size be negative."):h.sizeCalculated=s-(m?d.sizeCalculated:0)+parseInt(h.size)),g!=null&&g.hidden!==!0?(y=0,x=0,C=s,_=g.sizeCalculated,o(this.box).find("#layout_"+this.name+"_panel_top").css({display:"block",left:y+"px",top:x+"px",width:C+"px",height:_+"px"}),g.width=C,g.height=_,g.resizable&&(x=g.sizeCalculated-(this.padding===0?this.resizer:0),_=this.resizer>this.padding?this.resizer:this.padding,o(this.box).find("#layout_"+this.name+"_resizer_top").css({display:"block",left:y+"px",top:x+"px",width:C+"px",height:_+"px",cursor:"ns-resize"}).off("mousedown").on("mousedown",function(v){v.preventDefault();let k=r.trigger("resizerClick",{target:"top",originalEvent:v});if(k.isCancelled!==!0)return N[r.name].last.events.resizeStart("top",v),k.finish(),!1}))):(o(this.box).find("#layout_"+this.name+"_panel_top").hide(),o(this.box).find("#layout_"+this.name+"_resizer_top").hide()),h!=null&&h.hidden!==!0?(y=0,x=0+(w?g.sizeCalculated+this.padding:0),C=h.sizeCalculated,_=l-(w?g.sizeCalculated+this.padding:0)-(b?c.sizeCalculated+this.padding:0),o(this.box).find("#layout_"+this.name+"_panel_left").css({display:"block",left:y+"px",top:x+"px",width:C+"px",height:_+"px"}),h.width=C,h.height=_,h.resizable&&(y=h.sizeCalculated-(this.padding===0?this.resizer:0),C=this.resizer>this.padding?this.resizer:this.padding,o(this.box).find("#layout_"+this.name+"_resizer_left").css({display:"block",left:y+"px",top:x+"px",width:C+"px",height:_+"px",cursor:"ew-resize"}).off("mousedown").on("mousedown",function(v){v.preventDefault();let k=r.trigger("resizerClick",{target:"left",originalEvent:v});if(k.isCancelled!==!0)return N[r.name].last.events.resizeStart("left",v),k.finish(),!1}))):(o(this.box).find("#layout_"+this.name+"_panel_left").hide(),o(this.box).find("#layout_"+this.name+"_resizer_left").hide()),d!=null&&d.hidden!==!0?(y=s-d.sizeCalculated,x=0+(w?g.sizeCalculated+this.padding:0),C=d.sizeCalculated,_=l-(w?g.sizeCalculated+this.padding:0)-(b?c.sizeCalculated+this.padding:0),o(this.box).find("#layout_"+this.name+"_panel_right").css({display:"block",left:y+"px",top:x+"px",width:C+"px",height:_+"px"}),d.width=C,d.height=_,d.resizable&&(y=y-this.padding,C=this.resizer>this.padding?this.resizer:this.padding,o(this.box).find("#layout_"+this.name+"_resizer_right").css({display:"block",left:y+"px",top:x+"px",width:C+"px",height:_+"px",cursor:"ew-resize"}).off("mousedown").on("mousedown",function(v){v.preventDefault();let k=r.trigger("resizerClick",{target:"right",originalEvent:v});if(k.isCancelled!==!0)return N[r.name].last.events.resizeStart("right",v),k.finish(),!1}))):(o(this.box).find("#layout_"+this.name+"_panel_right").hide(),o(this.box).find("#layout_"+this.name+"_resizer_right").hide()),c!=null&&c.hidden!==!0?(y=0,x=l-c.sizeCalculated,C=s,_=c.sizeCalculated,o(this.box).find("#layout_"+this.name+"_panel_bottom").css({display:"block",left:y+"px",top:x+"px",width:C+"px",height:_+"px"}),c.width=C,c.height=_,c.resizable&&(x=x-(this.padding===0?0:this.padding),_=this.resizer>this.padding?this.resizer:this.padding,o(this.box).find("#layout_"+this.name+"_resizer_bottom").css({display:"block",left:y+"px",top:x+"px",width:C+"px",height:_+"px",cursor:"ns-resize"}).off("mousedown").on("mousedown",function(v){v.preventDefault();let k=r.trigger("resizerClick",{target:"bottom",originalEvent:v});if(k.isCancelled!==!0)return N[r.name].last.events.resizeStart("bottom",v),k.finish(),!1}))):(o(this.box).find("#layout_"+this.name+"_panel_bottom").hide(),o(this.box).find("#layout_"+this.name+"_resizer_bottom").hide()),y=0+(f?h.sizeCalculated+this.padding:0),x=0+(w?g.sizeCalculated+this.padding:0),C=s-(f?h.sizeCalculated+this.padding:0)-(m?d.sizeCalculated+this.padding:0),_=l-(w?g.sizeCalculated+this.padding:0)-(b?c.sizeCalculated+this.padding:0)-(p?a.sizeCalculated+this.padding:0),o(this.box).find("#layout_"+this.name+"_panel_main").css({display:"block",left:y+"px",top:x+"px",width:C+"px",height:_+"px"}),n.width=C,n.height=_,a!=null&&a.hidden!==!0?(y=0+(f?h.sizeCalculated+this.padding:0),x=l-(b?c.sizeCalculated+this.padding:0)-a.sizeCalculated,C=s-(f?h.sizeCalculated+this.padding:0)-(m?d.sizeCalculated+this.padding:0),_=a.sizeCalculated,o(this.box).find("#layout_"+this.name+"_panel_preview").css({display:"block",left:y+"px",top:x+"px",width:C+"px",height:_+"px"}),a.width=C,a.height=_,a.resizable&&(x=x-(this.padding===0?0:this.padding),_=this.resizer>this.padding?this.resizer:this.padding,o(this.box).find("#layout_"+this.name+"_resizer_preview").css({display:"block",left:y+"px",top:x+"px",width:C+"px",height:_+"px",cursor:"ns-resize"}).off("mousedown").on("mousedown",function(v){v.preventDefault();let k=r.trigger("resizerClick",{target:"preview",originalEvent:v});if(k.isCancelled!==!0)return N[r.name].last.events.resizeStart("preview",v),k.finish(),!1}))):(o(this.box).find("#layout_"+this.name+"_panel_preview").hide(),o(this.box).find("#layout_"+this.name+"_resizer_preview").hide()),this.resizeBoxes(),i.finish(),Date.now()-e}resizeBoxes(e){let t=B;!e&&typeof e=="string"&&(t=[e]),t.forEach((i,s)=>{let l=this.get(B[s]),r=`#layout_${this.name}_panel_${i} > `,n=0;if(l){if(l.title){let a=o(this.box).find(r+".w2ui-panel-title").css({top:n+"px",display:"block"});n+=u.getSize(a,"height")}if(l.show.tabs){let a=o(this.box).find(r+'[data-role="panel-tabs"]').css({top:n+"px",display:"block"});n+=u.getSize(a,"height")}if(l.show.toolbar){let a=o(this.box).find(r+'[data-role="panel-toolbar"]').css({top:n+"px",display:"block"});n+=u.getSize(a,"height")}}o(this.box).find(r+'[data-role="panel-content"]').css({display:"block",top:n+"px"})})}lock(e,t,i){if(B.indexOf(e)==-1){console.log("ERROR: First parameter needs to be the a valid panel name.");return}let s=Array.from(arguments);s[0]="#layout_"+this.name+"_panel_"+e,u.lock(...s)}unlock(e,t){if(B.indexOf(e)==-1){console.log("ERROR: First parameter needs to be the a valid panel name.");return}let i="#layout_"+this.name+"_panel_"+e;u.unlock(i,t)}},Q=class extends Y{constructor(e){if(super(e.name),this.name=null,this.box=null,this.columns=[],this.columnGroups=[],this.records=[],this.summary=[],this.searches=[],this.toolbar={},this.ranges=[],this.contextMenu=[],this.searchMap={},this.searchData=[],this.sortMap={},this.sortData=[],this.savedSearches=[],this.defaultSearches=[],this.total=0,this.recid=null,this.last={field:"",label:"",logic:"AND",search:"",searchIds:[],selection:{indexes:[],columns:{}},saved_sel:null,multi:!1,fetch:{action:"",offset:null,start:0,response:0,options:null,controller:null,loaded:!1,hasMore:!1},vscroll:{scrollTop:0,scrollLeft:0,recIndStart:null,recIndEnd:null,colIndStart:0,colIndEnd:0,pull_more:!1,pull_refresh:!0,show_extra:0},sel_ind:null,sel_col:null,sel_type:null,sel_recid:null,idCache:{},move:null,cancelClick:null,inEditMode:!1,_edit:null,kbd_timer:null,marker_timer:null,click_time:null,click_recid:null,bubbleEl:null,colResizing:!1,tmp:null,copy_event:null,userSelect:"",columnDrag:!1,state:null,toolbar_height:0},this.header="",this.url="",this.limit=100,this.offset=0,this.postData={},this.routeData={},this.httpHeaders={},this.show={header:!1,toolbar:!1,footer:!1,columnMenu:!0,columnHeaders:!0,lineNumbers:!1,expandColumn:!1,selectColumn:!1,emptyRecords:!0,toolbarReload:!0,toolbarColumns:!1,toolbarSearch:!0,toolbarAdd:!1,toolbarEdit:!1,toolbarDelete:!1,toolbarSave:!1,searchAll:!0,searchLogic:!0,searchHiddenMsg:!1,searchSave:!0,statusRange:!0,statusBuffered:!1,statusRecordID:!0,statusSelection:!0,statusResponse:!0,statusSort:!1,statusSearch:!1,recordTitles:!1,selectionBorder:!0,selectionResizer:!0,skipRecords:!0,saveRestoreState:!0},this.stateId=null,this.hasFocus=!1,this.autoLoad=!0,this.fixedBody=!0,this.recordHeight=32,this.lineNumberWidth=34,this.keyboard=!0,this.selectType="row",this.liveSearch=!1,this.multiSearch=!0,this.multiSelect=!0,this.multiSort=!0,this.reorderColumns=!1,this.reorderRows=!1,this.showExtraOnSearch=0,this.markSearch=!0,this.columnTooltip="top|bottom",this.disableCVS=!1,this.nestedFields=!0,this.vs_start=150,this.vs_extra=5,this.style="",this.tabIndex=null,this.dataType=null,this.parser=null,this.advanceOnEdit=!0,this.useLocalStorage=!0,this.colTemplate={text:"",field:"",size:null,min:20,max:null,gridMinWidth:null,sizeCorrected:null,sizeCalculated:null,sizeOriginal:null,sizeType:null,hidden:!1,sortable:!1,sortMode:null,searchable:!1,resizable:!0,hideable:!0,autoResize:null,attr:"",style:"",render:null,title:null,tooltip:null,editable:{},frozen:!1,info:null,clipboardCopy:!1},this.stateColProps={text:!1,field:!0,size:!0,min:!1,max:!1,gridMinWidth:!1,sizeCorrected:!1,sizeCalculated:!0,sizeOriginal:!0,sizeType:!0,hidden:!0,sortable:!1,sortMode:!0,searchable:!1,resizable:!1,hideable:!1,autoResize:!1,attr:!1,style:!1,render:!1,title:!1,tooltip:!1,editable:!1,frozen:!0,info:!1,clipboardCopy:!1},this.msgDelete="Are you sure you want to delete ${count} ${records}?",this.msgNotJSON="Returned data is not in valid JSON format.",this.msgHTTPError="HTTP error. See console for more details.",this.msgServerError="Server error",this.msgRefresh="Refreshing...",this.msgNeedReload="Your remote data source record count has changed, reloading from the first record.",this.msgEmpty="",this.buttons={reload:{type:"button",id:"w2ui-reload",icon:"w2ui-icon-reload",tooltip:"Reload data in the list"},columns:{type:"menu-check",id:"w2ui-column-on-off",icon:"w2ui-icon-columns",tooltip:"Show/hide columns",overlay:{align:"none"}},search:{type:"html",id:"w2ui-search",html:'<div class="w2ui-icon w2ui-icon-search w2ui-search-down w2ui-action" data-click="searchShowFields"></div>'},add:{type:"button",id:"w2ui-add",text:"Add New",tooltip:"Add new record",icon:"w2ui-icon-plus"},edit:{type:"button",id:"w2ui-edit",text:"Edit",tooltip:"Edit selected record",icon:"w2ui-icon-pencil",batch:1,disabled:!0},delete:{type:"button",id:"w2ui-delete",text:"Delete",tooltip:"Delete selected records",icon:"w2ui-icon-cross",batch:!0,disabled:!0},save:{type:"button",id:"w2ui-save",text:"Save",tooltip:"Save changed records",icon:"w2ui-icon-check"}},this.operators={text:["is","begins","contains","ends"],number:["=","between",">","<",">=","<="],date:["is",{oper:"less",text:"before"},{oper:"more",text:"since"},"between"],list:["is"],hex:["is","between"],color:["is","begins","contains","ends"],enum:["in","not in"]},this.defaultOperator={text:"begins",number:"=",date:"is",list:"is",enum:"in",hex:"begins",color:"begins"},this.operatorsMap={text:"text",int:"number",float:"number",money:"number",currency:"number",percent:"number",hex:"hex",alphanumeric:"text",color:"color",date:"date",time:"date",datetime:"date",list:"list",combo:"text",enum:"enum",file:"enum",select:"list",radio:"list",checkbox:"list",toggle:"list"},this.onAdd=null,this.onEdit=null,this.onRequest=null,this.onLoad=null,this.onDelete=null,this.onSave=null,this.onSelect=null,this.onClick=null,this.onDblClick=null,this.onContextMenu=null,this.onContextMenuClick=null,this.onColumnClick=null,this.onColumnDblClick=null,this.onColumnContextMenu=null,this.onColumnResize=null,this.onColumnAutoResize=null,this.onSort=null,this.onSearch=null,this.onSearchOpen=null,this.onChange=null,this.onRestore=null,this.onExpand=null,this.onCollapse=null,this.onError=null,this.onKeydown=null,this.onToolbar=null,this.onColumnOnOff=null,this.onCopy=null,this.onPaste=null,this.onSelectionExtend=null,this.onEditField=null,this.onRender=null,this.onRefresh=null,this.onReload=null,this.onResize=null,this.onDestroy=null,this.onStateSave=null,this.onStateRestore=null,this.onFocus=null,this.onBlur=null,this.onReorderRow=null,this.onSearchSave=null,this.onSearchRemove=null,this.onSearchSelect=null,this.onColumnSelect=null,this.onColumnDragStart=null,this.onColumnDragEnd=null,this.onResizerDblClick=null,this.onMouseEnter=null,this.onMouseLeave=null,u.extend(this,e),Array.isArray(this.records)){let i=[];this.records.forEach((s,l)=>{s[this.recid]!=null&&(s.recid=s[this.recid]),s.recid==null&&console.log("ERROR: Cannot add records without recid. (obj: "+this.name+")"),s.w2ui?.summary===!0&&(this.summary.push(s),i.push(l))}),i.sort();for(let s=i.length-1;s>=0;s--)this.records.splice(i[s],1)}Array.isArray(this.columns)&&this.columns.forEach((i,s)=>{i=u.extend({},this.colTemplate,i),this.columns[s]=i;let l=i.searchable;if(!(l==null||l===!1||this.getSearch(i.field)!=null))if(u.isPlainObject(l))this.addSearch(u.extend({field:i.field,label:i.text,type:"text"},l));else{let r=i.searchable,n="";i.searchable===!0&&(r="text",n='size="20"'),this.addSearch({field:i.field,label:i.text,type:r,attr:n})}}),Array.isArray(this.defaultSearches)&&this.defaultSearches.forEach((i,s)=>{i.id="default-"+s,i.icon??="w2ui-icon-search"});let t=this.cache("searches");Array.isArray(t)&&t.forEach(i=>{this.savedSearches.push({id:i.id??"none",text:i.text??"none",icon:"w2ui-icon-search",remove:!0,logic:i.logic??"AND",data:i.data??[]})}),this.initToolbar(),typeof this.box=="string"&&(this.box=o(this.box).get(0)),this.box&&this.render(this.box)}add(e,t){Array.isArray(e)||(e=[e]);let i=0;for(let l=0;l<e.length;l++){let r=e[l];if(r[this.recid]!=null&&(r.recid=r[this.recid]),r.recid==null){console.log("ERROR: Cannot add record without recid. (obj: "+this.name+")");continue}r.w2ui?.summary===!0?t?this.summary.unshift(r):this.summary.push(r):t?this.records.unshift(r):this.records.push(r),i++}if(this.url?.get??this.url)this.refresh();else{this.total=this.records.length,this.localSort(!1,!0),this.localSearch();let l=this.records.length-e.length,r=l+e.length;this.last.vscroll.recIndStart<=r&&this.last.vscroll.recIndEnd>=l?this.refresh():o(this.box).find("#grid_"+this.name+"_footer .w2ui-footer-right .w2ui-total").html(u.formatNumber(this.total))}return i}find(e,t,i){e==null&&(e={});let s=[],l=!1;for(let a in e)String(a).indexOf(".")!=-1&&(l=!0);let r=i?this.last.vscroll.recIndStart:0,n=i?this.last.vscroll.recIndEnd+1:this.records.length;n>this.records.length&&(n=this.records.length);for(let a=r;a<n;a++){let h=!0;for(let d in e){let g=this.records[a][d];l&&String(d).indexOf(".")!=-1&&(g=this.parseField(this.records[a],d)),e[d]=="not-null"?(g==null||g==="")&&(h=!1):e[d]!=g&&(h=!1)}h&&t!==!0&&s.push(this.records[a].recid),h&&t===!0&&s.push(a)}return s}set(e,t,i){if(typeof e=="object"&&e!==null&&(i=t,t=e,e=null),e==null){for(let s=0;s<this.records.length;s++)u.extend(this.records[s],t);i!==!0&&this.refresh()}else{let s=this.get(e,!0);if(s==null)return!1;this.records[s]?.recid!=e?u.extend(this.summary[s],t):u.extend(this.records[s],t),i!==!0&&this.refreshRow(e,s)}return!0}replace(e,t,i){let s=this.get(e,!0);return s==null?!1:(this.records[s]?.recid!=e?this.summary[s]=t:this.records[s]=t,i!==!0&&this.refreshRow(e,s),!0)}get(e,t){if(Array.isArray(e)){let i=[];for(let s=0;s<e.length;s++){let l=this.get(e[s],t);l!==null&&i.push(l)}return i}else{let i=this.last.idCache;i||(this.last.idCache=i={});let s=i[e];if(typeof s=="number"){if(s>=0&&s<this.records.length&&this.records[s].recid==e)return t===!0?s:this.records[s];if(s=~s,s>=0&&s<this.summary.length&&this.summary[s].recid==e)return t===!0?s:this.summary[s];this.last.idCache=i={}}for(let l=0;l<this.records.length;l++)if(this.records[l].recid==e)return i[e]=l,t===!0?l:this.records[l];for(let l=0;l<this.summary.length;l++)if(this.summary[l].recid==e)return i[e]=~l,t===!0?l:this.summary[l];return null}}getFirst(e){if(this.records.length==0)return null;let t=this.records[0],i=this.last.searchIds;return this.searchData.length>0&&(Array.isArray(i)&&i.length>0?t=this.records[i[e||0]]:t=null),t}remove(){let e=0;for(let i=0;i<arguments.length;i++){for(let s=this.records.length-1;s>=0;s--)this.records[s].recid==arguments[i]&&(this.records.splice(s,1),e++);for(let s=this.summary.length-1;s>=0;s--)this.summary[s].recid==arguments[i]&&(this.summary.splice(s,1),e++)}return(this.url?.get??this.url)||(this.localSort(!1,!0),this.localSearch(),this.total=this.records.length),this.refresh(),e}addColumn(e,t){let i=0;arguments.length==1?(t=e,e=this.columns.length):(typeof e=="string"&&(e=this.getColumn(e,!0)),e==null&&(e=this.columns.length)),Array.isArray(t)||(t=[t]);for(let s=0;s<t.length;s++){let l=u.extend({},this.colTemplate,t[s]);if(this.columns.splice(e,0,l),t[s].searchable){let r=t[s].searchable,n="";t[s].searchable===!0&&(r="text",n='size="20"'),this.addSearch({field:t[s].field,label:t[s].text,type:r,attr:n})}e++,i++}return this.refresh(),i}removeColumn(){let e=0;for(let t=0;t<arguments.length;t++)for(let i=this.columns.length-1;i>=0;i--)this.columns[i].field==arguments[t]&&(this.columns[i].searchable&&this.removeSearch(arguments[t]),this.columns.splice(i,1),e++);return this.refresh(),e}getColumn(e,t){if(arguments.length===0){let i=[];for(let s=0;s<this.columns.length;s++)i.push(this.columns[s].field);return i}for(let i=0;i<this.columns.length;i++)if(this.columns[i].field==e)return t===!0?i:this.columns[i];return null}updateColumn(e,t){let i=0;return e=Array.isArray(e)?e:[e],e.forEach(s=>{this.columns.forEach(l=>{if(l.field==s){let r=u.clone(t);Object.keys(r).forEach(n=>{typeof r[n]=="function"&&(r[n]=r[n](l)),l[n]!=r[n]&&i++}),u.extend(l,r)}})}),i>0&&this.refresh(),i}toggleColumn(){return this.updateColumn(Array.from(arguments),{hidden(e){return!e.hidden}})}showColumn(){return this.updateColumn(Array.from(arguments),{hidden:!1})}hideColumn(){return this.updateColumn(Array.from(arguments),{hidden:!0})}addSearch(e,t){let i=0;arguments.length==1?(t=e,e=this.searches.length):(typeof e=="string"&&(e=this.getSearch(e,!0)),e==null&&(e=this.searches.length)),Array.isArray(t)||(t=[t]);for(let s=0;s<t.length;s++)this.searches.splice(e,0,t[s]),e++,i++;return this.searchClose(),i}removeSearch(){let e=0;for(let t=0;t<arguments.length;t++)for(let i=this.searches.length-1;i>=0;i--)this.searches[i].field==arguments[t]&&(this.searches.splice(i,1),e++);return this.searchClose(),e}getSearch(e,t){if(arguments.length===0){let i=[];for(let s=0;s<this.searches.length;s++)i.push(this.searches[s].field);return i}for(let i=0;i<this.searches.length;i++)if(this.searches[i].field==e)return t===!0?i:this.searches[i];return null}toggleSearch(){let e=0;for(let t=0;t<arguments.length;t++)for(let i=this.searches.length-1;i>=0;i--)this.searches[i].field==arguments[t]&&(this.searches[i].hidden=!this.searches[i].hidden,e++);return this.searchClose(),e}showSearch(){let e=0;for(let t=0;t<arguments.length;t++)for(let i=this.searches.length-1;i>=0;i--)this.searches[i].field==arguments[t]&&this.searches[i].hidden!==!1&&(this.searches[i].hidden=!1,e++);return this.searchClose(),e}hideSearch(){let e=0;for(let t=0;t<arguments.length;t++)for(let i=this.searches.length-1;i>=0;i--)this.searches[i].field==arguments[t]&&this.searches[i].hidden!==!0&&(this.searches[i].hidden=!0,e++);return this.searchClose(),e}getSearchData(e){for(let t=0;t<this.searchData.length;t++)if(this.searchData[t].field==e)return this.searchData[t];return null}localSort(e,t){let i=this;if(this.url?.get??this.url)return console.log("ERROR: grid.localSort can only be used on local data source, grid.url should be empty."),0;if(Object.keys(this.sortData).length===0){let c=this.last.originalSort;return c&&this.records.sort((p,f)=>{let m=c.indexOf(p.recid),w=c.indexOf(f.recid);return m>w?1:-1}),0}let l=Date.now();this.selectionSave(),this.prepareData(),t||this.reset();for(let c=0;c<this.sortData.length;c++){let p=this.getColumn(this.sortData[c].field);if(!p)return;typeof p.render=="string"&&(["date","age"].indexOf(p.render.split(":")[0])!=-1&&(this.sortData[c].field_=p.field+"_"),["time"].indexOf(p.render.split(":")[0])!=-1&&(this.sortData[c].field_=p.field+"_"))}return r(),this.records.sort((c,p)=>a(c,p)),n(),this.selectionRestore(t),l=Date.now()-l,e!==!0&&this.show.statusSort&&setTimeout(()=>{this.status(u.lang("Sorting took ${count} seconds",{count:l/1e3}))},10),l;function r(){for(let c=0;c<i.records.length;c++){let p=i.records[c];p.w2ui?.parent_recid!=null&&(p.w2ui._path=h(p))}}function n(){for(let c=0;c<i.records.length;c++){let p=i.records[c];p.w2ui?.parent_recid!=null&&(p.w2ui._path=null)}}function a(c,p){if((!c.w2ui||c.w2ui.parent_recid==null)&&(!p.w2ui||p.w2ui.parent_recid==null))return d(c,p);let f=h(c),m=h(p);for(let w=0;w<Math.min(f.length,m.length);w++){let b=d(f[w],m[w]);if(b!==0)return b}return f.length>m.length?1:f.length<m.length?-1:(console.log("ERROR: two paths should not be equal."),0)}function h(c){if(!c.w2ui||c.w2ui.parent_recid==null)return[c];if(c.w2ui._path)return c.w2ui._path;let p=i.get(c.w2ui.parent_recid);return p?h(p).concat(c):(console.log("ERROR: no parent record: "+c.w2ui.parent_recid),[c])}function d(c,p){if(c===p)return 0;for(let m=0;m<i.sortData.length;m++){let w=i.sortData[m].field,b=i.sortData[m].field_?i.sortData[m].field_:w,y=c[b],x=p[b];String(w).indexOf(".")!=-1&&(y=i.parseField(c,b),x=i.parseField(p,b));let C=i.getColumn(w);C&&Object.keys(C.editable).length>0&&(u.isPlainObject(y)&&y.text&&(y=y.text),u.isPlainObject(x)&&x.text&&(x=x.text));let _=g(y,x,m,i.sortData[m].direction,C.sortMode||"default");if(_!==0)return _}return g(c.recid,p.recid,-1,"asc")}function g(c,p,f,m,w){if(c===p)return 0;if((c==null||c==="")&&p!=null&&p!=="")return 1;if(c!=null&&c!==""&&(p==null||p===""))return-1;let b=m.toLowerCase()==="asc"?1:-1;if(typeof c!=typeof p)return typeof c>typeof p?b:-b;if(c.constructor.name!=p.constructor.name)return c.constructor.name>p.constructor.name?b:-b;c&&typeof c=="object"&&(c=c.valueOf()),p&&typeof p=="object"&&(p=p.valueOf());let y={}.toString;switch(c&&typeof c=="object"&&c.toString!=y&&(c=String(c)),p&&typeof p=="object"&&p.toString!=y&&(p=String(p)),typeof c=="string"&&(c=c.toLowerCase().trim()),typeof p=="string"&&(p=p.toLowerCase().trim()),w){case"natural":w=u.naturalCompare;break;case"i18n":w=u.i18nCompare;break}return typeof w=="function"?w(c,p)*b:c>p?b:c<p?-b:0}}localSearch(e){let t=this,i=this.url?.get??this.url;if(i){console.log("ERROR: grid.localSearch can only be used on local data source, grid.url should be empty.");return}let s=Date.now(),l={}.toString,r={};if(this.total=this.records.length,this.last.searchIds=[],this.prepareData(),this.searchData.length>0&&!i){this.total=0;for(let h=0;h<this.records.length;h++){let d=this.records[h];if(n(d))if(d?.w2ui&&a(d.w2ui.parent_recid),this.showExtraOnSearch>0){let c=this.showExtraOnSearch,p=this.showExtraOnSearch;if(h<c&&(c=h),h+p>this.records.length&&(p=this.records.length-h),c>0)for(let f=h-c;f<h;f++)this.last.searchIds.indexOf(f)<0&&this.last.searchIds.push(f);if(this.last.searchIds.indexOf(h)<0&&this.last.searchIds.push(h),p>0)for(let f=h+1;f<=h+p;f++)this.last.searchIds.indexOf(f)<0&&this.last.searchIds.push(f)}else this.last.searchIds.push(h)}this.total=this.last.searchIds.length}return s=Date.now()-s,e!==!0&&this.show.statusSearch&&setTimeout(()=>{this.status(u.lang("Search took ${count} seconds",{count:s/1e3}))},10),s;function n(h){let d=0,g,c,p,f,m=!1;for(let w=0;w<t.searchData.length;w++){let b=t.searchData[w],y=t.getSearch(b.field);if(b==null)continue;y==null&&(y={field:b.field,type:b.type});let x=t.parseField(h,y.field);switch(g=x!=null&&(typeof x!="object"||x.toString!=l)?String(x).toLowerCase():"",b.value!=null&&(Array.isArray(b.value)?(c=b.value[0],p=b.value[1]):c=String(b.value).toLowerCase()),b.operator){case"=":case"is":t.parseField(h,y.field)==b.value?d++:y.type=="date"?(f=t.parseField(h,y.field+"_")instanceof Date?t.parseField(h,y.field+"_"):t.parseField(h,y.field),g=u.formatDate(f,"yyyy-mm-dd"),c=u.formatDate(u.isDate(c,u.settings.dateFormat,!0),"yyyy-mm-dd"),g==c&&d++):y.type=="time"?(f=t.parseField(h,y.field+"_")instanceof Date?t.parseField(h,y.field+"_"):t.parseField(h,y.field),g=u.formatTime(f,"hh24:mi"),c=u.formatTime(c,"hh24:mi"),g==c&&d++):y.type=="datetime"&&(f=t.parseField(h,y.field+"_")instanceof Date?t.parseField(h,y.field+"_"):t.parseField(h,y.field),g=u.formatDateTime(f,"yyyy-mm-dd|hh24:mm:ss"),c=u.formatDateTime(u.isDateTime(c,u.settings.datetimeFormat,!0),"yyyy-mm-dd|hh24:mm:ss"),g==c&&d++);break;case"between":["int","float","money","currency","percent"].indexOf(y.type)!=-1?parseFloat(t.parseField(h,y.field))>=parseFloat(c)&&parseFloat(t.parseField(h,y.field))<=parseFloat(p)&&d++:y.type=="date"?(f=t.parseField(h,y.field+"_")instanceof Date?t.parseField(h,y.field+"_"):t.parseField(h,y.field),g=u.isDate(f,u.settings.dateFormat,!0),c=u.isDate(c,u.settings.dateFormat,!0),p=u.isDate(p,u.settings.dateFormat,!0),p!=null&&(p=new Date(p.getTime()+864e5)),g>=c&&g<p&&d++):y.type=="time"?(g=t.parseField(h,y.field+"_")instanceof Date?t.parseField(h,y.field+"_"):t.parseField(h,y.field),c=u.isTime(c,!0),p=u.isTime(p,!0),c=new Date().setHours(c.hours,c.minutes,c.seconds?c.seconds:0,0),p=new Date().setHours(p.hours,p.minutes,p.seconds?p.seconds:0,0),g>=c&&g<p&&d++):y.type=="datetime"&&(g=t.parseField(h,y.field+"_")instanceof Date?t.parseField(h,y.field+"_"):t.parseField(h,y.field),c=u.isDateTime(c,u.settings.datetimeFormat,!0),p=u.isDateTime(p,u.settings.datetimeFormat,!0),p&&(p=new Date(p.getTime()+864e5)),g>=c&&g<p&&d++);break;case"<=":m=!0;case"<":case"less":["int","float","money","currency","percent"].indexOf(y.type)!=-1?(g=parseFloat(t.parseField(h,y.field)),c=parseFloat(b.value),(g<c||m&&g===c)&&d++):y.type=="date"?(f=t.parseField(h,y.field+"_")instanceof Date?t.parseField(h,y.field+"_"):t.parseField(h,y.field),g=u.isDate(f,u.settings.dateFormat,!0),c=u.isDate(c,u.settings.dateFormat,!0),(g<c||m&&g===c)&&d++):y.type=="time"?(f=t.parseField(h,y.field+"_")instanceof Date?t.parseField(h,y.field+"_"):t.parseField(h,y.field),g=u.formatTime(f,"hh24:mi"),c=u.formatTime(c,"hh24:mi"),(g<c||m&&g===c)&&d++):y.type=="datetime"&&(f=t.parseField(h,y.field+"_")instanceof Date?t.parseField(h,y.field+"_"):t.parseField(h,y.field),g=u.formatDateTime(f,"yyyy-mm-dd|hh24:mm:ss"),c=u.formatDateTime(u.isDateTime(c,u.settings.datetimeFormat,!0),"yyyy-mm-dd|hh24:mm:ss"),g.length==c.length&&(g<c||m&&g===c)&&d++);break;case">=":m=!0;case">":case"more":["int","float","money","currency","percent"].indexOf(y.type)!=-1?(g=parseFloat(t.parseField(h,y.field)),c=parseFloat(b.value),(g>c||m&&g===c)&&d++):y.type=="date"?(f=t.parseField(h,y.field+"_")instanceof Date?t.parseField(h,y.field+"_"):t.parseField(h,y.field),g=u.isDate(f,u.settings.dateFormat,!0),c=u.isDate(c,u.settings.dateFormat,!0),(g>c||m&&g===c)&&d++):y.type=="time"?(f=t.parseField(h,y.field+"_")instanceof Date?t.parseField(h,y.field+"_"):t.parseField(h,y.field),g=u.formatTime(f,"hh24:mi"),c=u.formatTime(c,"hh24:mi"),(g>c||m&&g===c)&&d++):y.type=="datetime"&&(f=t.parseField(h,y.field+"_")instanceof Date?t.parseField(h,y.field+"_"):t.parseField(h,y.field),g=u.formatDateTime(f,"yyyy-mm-dd|hh24:mm:ss"),c=u.formatDateTime(u.isDateTime(c,u.settings.datetimeFormat,!0),"yyyy-mm-dd|hh24:mm:ss"),g.length==c.length&&(g>c||m&&g===c)&&d++);break;case"in":f=b.value,b.svalue&&(f=b.svalue),(f.indexOf(u.isFloat(x)?parseFloat(x):x)!==-1||f.indexOf(g)!==-1&&g!=="")&&d++;break;case"not in":f=b.value,b.svalue&&(f=b.svalue),f.indexOf(u.isFloat(x)?parseFloat(x):x)!==-1||f.indexOf(g)!==-1&&g!==""||d++;break;case"begins":case"begins with":g.indexOf(c)===0&&d++;break;case"contains":g.indexOf(c)>=0&&d++;break;case"null":t.parseField(h,y.field)==null&&d++;break;case"not null":t.parseField(h,y.field)!=null&&d++;break;case"ends":case"ends with":let C=g.lastIndexOf(c);C!==-1&&C==g.length-c.length&&d++;break}}if(t.last.logic=="OR"&&d!==0||t.last.logic=="AND"&&d==t.searchData.length)return!0;if(h.w2ui?.children&&h.w2ui?.expanded!==!0)for(let w=0;w<h.w2ui.children.length;w++){let b=h.w2ui.children[w];if(n(b))return!0}return!1}function a(h){let d=t.get(h,!0);if(d==null||h==null||r[h]||t.last.searchIds.includes(d))return;r[h]=!0;let g=t.records[d];g?.w2ui&&a(g.w2ui.parent_recid),t.last.searchIds.push(d)}}getRangeData(e,t){let i=this.get(e[0].recid,!0),s=this.get(e[1].recid,!0),l=e[0].column,r=e[1].column,n=[];if(l==r)for(let a=i;a<=s;a++){let h=this.records[a],d=h[this.columns[l].field]||null;t!==!0?n.push(d):n.push({data:d,column:l,index:a,record:h})}else if(i==s){let a=this.records[i];for(let h=l;h<=r;h++){let d=a[this.columns[h].field]||null;t!==!0?n.push(d):n.push({data:d,column:h,index:i,record:a})}}else for(let a=i;a<=s;a++){let h=this.records[a];n.push([]);for(let d=l;d<=r;d++){let g=h[this.columns[d].field];t!==!0?n[n.length-1].push(g):n[n.length-1].push({data:g,column:d,index:a,record:h})}}return n}addRange(e){let t=0,i,s;if(this.selectType=="row")return t;Array.isArray(e)||(e=[e]);for(let l=0;l<e.length;l++){if(typeof e[l]!="object"&&(e[l]={name:"selection"}),e[l].name=="selection"){if(this.show.selectionBorder===!1)continue;let r=this.getSelection();if(r.length===0){this.removeRange("selection");continue}else i=r[0],s=r[r.length-1]}else i=e[l].range[0],s=e[l].range[1];if(i){let r={name:e[l].name,range:[{recid:i.recid,column:i.column},{recid:s.recid,column:s.column}],style:e[l].style||"",class:e[l].class},n=!1;for(let a=0;a<this.ranges.length;a++)if(this.ranges[a].name==e[l].name){n=a;break}n!==!1?this.ranges[n]=r:this.ranges.push(r),t++}}return this.refreshRanges(),t}removeRange(){let e=0;for(let t=0;t<arguments.length;t++){let i=arguments[t];o(this.box).find("#grid_"+this.name+"_"+i).remove(),o(this.box).find("#grid_"+this.name+"_f"+i).remove();for(let s=this.ranges.length-1;s>=0;s--)this.ranges[s].name==i&&(this.ranges.splice(s,1),e++)}return e}refreshRanges(){if(this.ranges.length===0)return;let e=this,t,i=Date.now(),s=o(this.box).find(`#grid_${this.name}_frecords`),l=o(this.box).find(`#grid_${this.name}_records`);for(let c=0;c<this.ranges.length;c++){let p=this.ranges[c],f=p.range[0],m=p.range[1];f.index==null&&(f.index=this.get(f.recid,!0)),m.index==null&&(m.index=this.get(m.recid,!0));let w=o(this.box).find("#grid_"+this.name+"_rec_"+u.escapeId(f.recid)+' td[col="'+f.column+'"]'),b=o(this.box).find("#grid_"+this.name+"_rec_"+u.escapeId(m.recid)+' td[col="'+m.column+'"]'),y=o(this.box).find("#grid_"+this.name+"_frec_"+u.escapeId(f.recid)+' td[col="'+f.column+'"]'),x=o(this.box).find("#grid_"+this.name+"_frec_"+u.escapeId(m.recid)+' td[col="'+m.column+'"]'),C=m.column;f.column<this.last.vscroll.colIndStart&&m.column>this.last.vscroll.colIndStart&&(w=o(this.box).find("#grid_"+this.name+"_rec_"+u.escapeId(f.recid)+' td[col="start"]')),f.column<this.last.vscroll.colIndEnd&&m.column>this.last.vscroll.colIndEnd&&(b=o(this.box).find("#grid_"+this.name+"_rec_"+u.escapeId(m.recid)+' td[col="end"]'),C='"end"');let _=parseInt(o(this.box).find("#grid_"+this.name+"_rec_top").next().attr("index")),v=parseInt(o(this.box).find("#grid_"+this.name+"_rec_bottom").prev().attr("index")),k=parseInt(o(this.box).find("#grid_"+this.name+"_frec_top").next().attr("index")),D=parseInt(o(this.box).find("#grid_"+this.name+"_frec_bottom").prev().attr("index"));w.length===0&&f.index<_&&m.index>_&&(w=o(this.box).find("#grid_"+this.name+"_rec_top").next().find('td[col="'+f.column+'"]')),b.length===0&&m.index>v&&f.index<v&&(b=o(this.box).find("#grid_"+this.name+"_rec_bottom").prev().find('td[col="'+C+'"]')),y.length===0&&f.index<k&&m.index>k&&(y=o(this.box).find("#grid_"+this.name+"_frec_top").next().find('td[col="'+f.column+'"]')),x.length===0&&m.index>D&&f.index<D&&(x=o(this.box).find("#grid_"+this.name+"_frec_bottom").prev().find('td[col="'+m.column+'"]'));let A=o(this.box).find("#grid_"+this.name+"_editable").find(".w2ui-input"),T=A.attr("index"),R=this.records[T]?.recid,E=A.attr("column");if(!(p.name=="selection"&&p.range[0].recid==R&&p.range[0].column==E)){if(t=o(this.box).find("#grid_"+this.name+"_f"+p.name),y.length>0||x.length>0)if(t.length===0?(s.append('<div id="grid_'+this.name+"_f"+p.name+'" class="w2ui-selection" style="'+p.style+'">'+(p.name=="selection"&&this.show.selectionResizer?'<div id="grid_'+this.name+'_resizer" class="w2ui-selection-resizer"></div>':"")+"</div>"),t=o(this.box).find("#grid_"+this.name+"_f"+p.name)):(t.attr("style",p.style),t.find(".w2ui-selection-resizer").show()),x.length===0&&(x=o(this.box).find("#grid_"+this.name+"_frec_"+u.escapeId(m.recid)+" td:last-child"),x.length===0&&(x=o(this.box).find("#grid_"+this.name+"_frec_bottom td:first-child")),t.css("border-right","0px"),t.find(".w2ui-selection-resizer").hide()),f.recid!=null&&m.recid!=null&&y.length>0&&x.length>0){let z=getComputedStyle(x[0]),M=y.prop("offsetTop")-y.prop("scrollTop"),L=y.prop("offsetLeft")+y.prop("scrollLeft"),H=x.prop("offsetTop")-x.prop("scrollTop"),P=x.prop("offsetLeft")+x.prop("scrollLeft");t.show().css({top:(M>0?M:0)+"px",left:(L>0?L:0)+"px",width:P-L+parseFloat(z.width)-1+"px",height:H-M+parseFloat(z.height)-1+"px"})}else t.hide();else t.hide();if(t=o(this.box).find("#grid_"+this.name+"_"+p.name),w.length>0||b.length>0)if(t.length===0?(l.append(`
                        <div id="grid_${this.name}_${p.name}" class="w2ui-selection ${p.class??""}" style="${p.style}">
                            ${p.name=="selection"&&this.show.selectionResizer?`<div id="grid_${this.name}_resizer" class="w2ui-selection-resizer"></div>`:""}
                        </div>
                    `),t=o(this.box).find("#grid_"+this.name+"_"+p.name)):t.attr("style",p.style),w.length===0&&(w=o(this.box).find("#grid_"+this.name+"_rec_"+u.escapeId(f.recid)+" td:first-child"),w.length===0&&(w=o(this.box).find("#grid_"+this.name+"_rec_top td:first-child"))),x.length!==0&&t.css("border-left","0px"),f.recid!=null&&m.recid!=null&&w.length>0&&b.length>0){let z=getComputedStyle(b[0]),M=w.prop("offsetTop")-w.prop("scrollTop"),L=w.prop("offsetLeft")+w.prop("scrollLeft"),H=b.prop("offsetTop")-b.prop("scrollTop"),P=b.prop("offsetLeft")+b.prop("scrollLeft");t.show().css({top:(M>0?M:0)+"px",left:(L>0?L:0)+"px",width:P-L+parseFloat(z.width)-1+"px",height:H-M+parseFloat(z.height)-1+"px"})}else t.hide();else t.hide()}}o(this.box).find(".w2ui-selection-resizer").off(".resizer").on("mousedown.resizer",h).on("dblclick.resizer",c=>{let p=this.trigger("resizerDblClick",{target:this.name,originalEvent:c});p.isCancelled!==!0&&p.finish()});let r,n={target:this.name,originalRange:null,newRange:null},a="abcdefghijklmnopqrstuvwxyz";return Date.now()-i;function h(c){let p=e.getSelection(),f=p[0],m=p[p.length-1];e.last.move={type:"expand",x:c.screenX,y:c.screenY,divX:0,divY:0,index:f.index,recid:f.recid,column:f.column,name:a[f.column]+(f.index+1)+":"+a[m.column]+(m.index+1),originalRange:[u.clone(f),u.clone(m)],newRange:[u.clone(f),u.clone(m)]},n.originalName=e.last.move.name,n.originalRange=e.last.move.originalRange,o("body").off(".w2ui-"+e.name).on("mousemove.w2ui-"+e.name,d).on("mouseup.w2ui-"+e.name,g),c.preventDefault()}function d(c){let p=e.last.move;if(!p||p.type!="expand")return;p.divX=c.screenX-p.x,p.divY=c.screenY-p.y;let f,m,w,b=c.target;if(b.tagName.toUpperCase()!="TD"&&(b=o(b).closest("td")[0]),o(b).attr("col")!=null&&(w=parseInt(o(b).attr("col"))),w==null||(b=o(b).closest("tr")[0],m=parseInt(o(b).attr("index")),f=e.records[m]?.recid,p.newRange[1].recid==f&&p.newRange[1].column==w))return;let y=u.clone(p.newRange);if(p.newRange=[{recid:p.recid,index:p.index,column:p.column},{recid:f,index:m,column:w}],n.newName=a[p.column]+(p.index+1)+":"+a[w]+(m+1),n.newRange=u.clone(p.newRange),r=e.trigger("selectionExtend",n),r.isCancelled===!0){p.newRange=y,n.newRange=y;return}else e.addRange({name:"selection-expand",range:p.newRange,class:"w2ui-selection-expand"})}function g(c){e.removeRange("selection-expand"),o("body").off(".w2ui-"+e.name),e.last.move?.type=="expand"&&r.finish&&r.finish(),delete e.last.move}}select(){if(arguments.length===0)return 0;let e=0,t=this.last.selection;this.multiSelect||this.selectNone(!0);let i=Array.from(arguments);Array.isArray(i[0])&&(i=i[0]);let s={target:this.name};if(i.length==1?(s.multiple=!1,u.isPlainObject(i[0])?s.clicked={recid:i[0].recid,column:i[0].column}:s.recid=i[0]):(s.multiple=!0,s.clicked={recids:i}),this.compareSelection(i).select.length==0)return;let l=this.trigger("select",s);if(l.isCancelled===!0)return 0;if(this.selectType=="row")for(let a=0;a<i.length;a++){let h=typeof i[a]=="object"?i[a].recid:i[a],d=this.get(h,!0);if(d==null)continue;let g=null,c=null;if((this.searchData.length!==0||d+1>=this.last.vscroll.recIndStart&&d+1<=this.last.vscroll.recIndEnd)&&(g=o(this.box).find("#grid_"+this.name+"_frec_"+u.escapeId(h)),c=o(this.box).find("#grid_"+this.name+"_rec_"+u.escapeId(h))),this.selectType=="row"){if(t.indexes.indexOf(d)!=-1)continue;t.indexes.push(d),g&&c&&(g.addClass("w2ui-selected").find(".w2ui-col-number").addClass("w2ui-row-selected"),c.addClass("w2ui-selected").find(".w2ui-col-number").addClass("w2ui-row-selected"),g.find(".w2ui-grid-select-check").prop("checked",!0)),e++}}else{let a={};for(let d=0;d<i.length;d++){let g=typeof i[d]=="object"?i[d].recid:i[d],c=typeof i[d]=="object"?i[d].column:null;if(a[g]=a[g]||[],Array.isArray(c))a[g]=c;else if(u.isInt(c))a[g].push(c);else for(let p=0;p<this.columns.length;p++)this.columns[p].hidden||a[g].push(parseInt(p))}let h=[];for(let d in a){let g=this.get(d,!0);if(g==null)continue;let c=null,p=null;g+1>=this.last.vscroll.recIndStart&&g+1<=this.last.vscroll.recIndEnd&&(c=o(this.box).find("#grid_"+this.name+"_rec_"+u.escapeId(d)),p=o(this.box).find("#grid_"+this.name+"_frec_"+u.escapeId(d)));let f=t.columns[g]||[];t.indexes.indexOf(g)==-1&&t.indexes.push(g);for(let m=0;m<a[d].length;m++)f.indexOf(a[d][m])==-1&&f.push(a[d][m]);f.sort((m,w)=>m-w);for(let m=0;m<a[d].length;m++){let w=a[d][m];h.indexOf(w)==-1&&h.push(w),c&&(c.find("#grid_"+this.name+"_data_"+g+"_"+w).addClass("w2ui-selected"),c.find(".w2ui-col-number").addClass("w2ui-row-selected"),c.find(".w2ui-grid-select-check").prop("checked",!0)),p&&(p.find("#grid_"+this.name+"_data_"+g+"_"+w).addClass("w2ui-selected"),p.find(".w2ui-col-number").addClass("w2ui-row-selected"),p.find(".w2ui-grid-select-check").prop("checked",!0)),e++}t.columns[g]=f}for(let d=0;d<h.length;d++)o(this.box).find("#grid_"+this.name+"_column_"+h[d]+" .w2ui-col-header").addClass("w2ui-col-selected")}t.indexes.sort((a,h)=>a-h);let r=this.records.length>0&&t.indexes.length==this.records.length,n=t.indexes.length>0&&this.searchData.length!==0&&t.indexes.length==this.last.searchIds.length;return r||n?o(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!0):o(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1),this.status(),this.addRange("selection"),this.updateToolbar(t,r),l.finish(),e}unselect(){let e=0,t=this.last.selection,i=Array.from(arguments);Array.isArray(i[0])&&(i=i[0]);let s={target:this.name};if(i.length==1?(s.multiple=!1,u.isPlainObject(i[0])?s.clicked={recid:i[0].recid,column:i[0].column}:s.clicked={recid:i[0]}):(s.multiple=!0,s.recids=i),this.compareSelection(i).unselect.length==0)return;let l=this.trigger("select",s);if(l.isCancelled===!0)return 0;for(let a=0;a<i.length;a++){let h=typeof i[a]=="object"?i[a].recid:i[a],d=this.get(h);if(d==null)continue;let g=this.get(d.recid,!0),c=o(this.box).find("#grid_"+this.name+"_frec_"+u.escapeId(h)),p=o(this.box).find("#grid_"+this.name+"_rec_"+u.escapeId(h));if(this.selectType=="row"){if(t.indexes.indexOf(g)==-1)continue;t.indexes.splice(t.indexes.indexOf(g),1),c.removeClass("w2ui-selected w2ui-inactive").find(".w2ui-col-number").removeClass("w2ui-row-selected"),p.removeClass("w2ui-selected w2ui-inactive").find(".w2ui-col-number").removeClass("w2ui-row-selected"),c.length!=0&&(c[0].style.cssText="height: "+this.recordHeight+"px; "+c.attr("custom_style"),p[0].style.cssText="height: "+this.recordHeight+"px; "+p.attr("custom_style")),c.find(".w2ui-grid-select-check").prop("checked",!1),e++}else{let f=i[a].column;if(!u.isInt(f)){let x=[];for(let C=0;C<this.columns.length;C++)this.columns[C].hidden||x.push({recid:h,column:C});return this.unselect(x)}let m=t.columns[g];if(!Array.isArray(m)||m.indexOf(f)==-1)continue;m.splice(m.indexOf(f),1),o(this.box).find(`#grid_${this.name}_rec_${u.escapeId(h)} > td[col="${f}"]`).removeClass("w2ui-selected w2ui-inactive"),o(this.box).find(`#grid_${this.name}_frec_${u.escapeId(h)} > td[col="${f}"]`).removeClass("w2ui-selected w2ui-inactive");let w=!1,b=!1,y=this.getSelection();for(let x=0;x<y.length;x++)y[x].column==f&&(w=!0),y[x].recid==h&&(b=!0);w||o(this.box).find(`.w2ui-grid-columns td[col="${f}"] .w2ui-col-header, .w2ui-grid-fcolumns td[col="${f}"] .w2ui-col-header`).removeClass("w2ui-col-selected"),b||o(this.box).find("#grid_"+this.name+"_frec_"+u.escapeId(h)).find(".w2ui-col-number").removeClass("w2ui-row-selected"),e++,m.length===0&&(delete t.columns[g],t.indexes.splice(t.indexes.indexOf(g),1),c.find(".w2ui-grid-select-check").prop("checked",!1))}}let r=this.records.length>0&&t.indexes.length==this.records.length,n=t.indexes.length>0&&this.searchData.length!==0&&t.indexes.length==this.last.searchIds.length;return r||n?o(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!0):o(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1),this.status(),this.addRange("selection"),this.updateToolbar(t,r),l.finish(),e}compareSelection(e){let t=this.getSelection(),i=[],s=[];if(this.selectType=="row"){e.forEach((l,r)=>{typeof l=="object"&&(e[r]=l.recid)});for(let l=0;l<e.length;l++)t.includes(e[l])||i.push(e[l]);for(let l=0;l<e.length;l++)t.includes(e[l])&&s.push(e[l])}else{for(let l=0;l<e.length;l++){let r=!1;for(let n=0;n<t.length;n++)e[l].recid==t[n].recid&&e[l].column==t[n].column&&(r=!0);r||i.push({recid:e[l].recid,column:e[l].column})}for(let l=0;l<t.length;l++){let r=!1;for(let n=0;n<e.length;n++)e[n].recid==t[l].recid&&e[n].column==t[l].column&&(r=!0);r||s.push({recid:t[l].recid,column:t[l].column})}}return{select:i,unselect:s}}selectAll(){let e=Date.now();if(this.multiSelect===!1)return;let t=this.url?.get??this.url,i=u.clone(this.last.selection),s=[];for(let r=0;r<this.columns.length;r++)s.push(r);if(i.indexes=[],!t&&this.searchData.length!==0)for(let r=0;r<this.last.searchIds.length;r++)i.indexes.push(this.last.searchIds[r]),this.selectType!="row"&&(i.columns[this.last.searchIds[r]]=s.slice());else{let r=this.records.length;this.searchData.length!=0&&!t&&(r=this.last.searchIds.length);for(let n=0;n<r;n++)i.indexes.push(n),this.selectType!="row"&&(i.columns[n]=s.slice())}let l=this.trigger("select",{target:this.name,multiple:!0,all:!0,clicked:i});if(l.isCancelled!==!0)return this.last.selection=i,this.selectType=="row"?(o(this.box).find(".w2ui-grid-records tr:not(.w2ui-empty-record)").addClass("w2ui-selected").find(".w2ui-col-number").addClass("w2ui-row-selected"),o(this.box).find(".w2ui-grid-frecords tr:not(.w2ui-empty-record)").addClass("w2ui-selected").find(".w2ui-col-number").addClass("w2ui-row-selected"),o(this.box).find("input.w2ui-grid-select-check").prop("checked",!0)):(o(this.box).find(".w2ui-grid-columns td .w2ui-col-header, .w2ui-grid-fcolumns td .w2ui-col-header").addClass("w2ui-col-selected"),o(this.box).find(".w2ui-grid-records tr .w2ui-col-number").addClass("w2ui-row-selected"),o(this.box).find(".w2ui-grid-records tr:not(.w2ui-empty-record)").find(".w2ui-grid-data:not(.w2ui-col-select)").addClass("w2ui-selected"),o(this.box).find(".w2ui-grid-frecords tr .w2ui-col-number").addClass("w2ui-row-selected"),o(this.box).find(".w2ui-grid-frecords tr:not(.w2ui-empty-record)").find(".w2ui-grid-data:not(.w2ui-col-select)").addClass("w2ui-selected"),o(this.box).find("input.w2ui-grid-select-check").prop("checked",!0)),i=this.getSelection(!0),this.addRange("selection"),o(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!0),this.status(),this.updateToolbar({indexes:i},!0),l.finish(),Date.now()-e}selectNone(e){let t=Date.now(),i;if(!e&&(i=this.trigger("select",{target:this.name,clicked:[]}),i.isCancelled===!0))return;let s=this.last.selection;return this.selectType=="row"?(o(this.box).find(".w2ui-grid-records tr.w2ui-selected").removeClass("w2ui-selected w2ui-inactive").find(".w2ui-col-number").removeClass("w2ui-row-selected"),o(this.box).find(".w2ui-grid-frecords tr.w2ui-selected").removeClass("w2ui-selected w2ui-inactive").find(".w2ui-col-number").removeClass("w2ui-row-selected"),o(this.box).find("input.w2ui-grid-select-check").prop("checked",!1)):(o(this.box).find(".w2ui-grid-columns td .w2ui-col-header, .w2ui-grid-fcolumns td .w2ui-col-header").removeClass("w2ui-col-selected"),o(this.box).find(".w2ui-grid-records tr .w2ui-col-number").removeClass("w2ui-row-selected"),o(this.box).find(".w2ui-grid-frecords tr .w2ui-col-number").removeClass("w2ui-row-selected"),o(this.box).find(".w2ui-grid-data.w2ui-selected").removeClass("w2ui-selected w2ui-inactive"),o(this.box).find("input.w2ui-grid-select-check").prop("checked",!1)),s.indexes=[],s.columns={},this.removeRange("selection"),o(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1),this.status(),this.updateToolbar(s,!1),e||i.finish(),Date.now()-t}updateToolbar(e){let t=this,i=e&&e.indexes?e.indexes.length:0;if(!this.toolbar.render)return;this.toolbar.items.forEach(l=>{s(l,""),Array.isArray(l.items)&&l.items.forEach(r=>{s(r,l.id+":")})}),this.show.toolbarSave&&(this.getChanges().length>0?this.toolbar.enable("w2ui-save"):this.toolbar.disable("w2ui-save"));function s(l,r){if(l.batch!=null){let n=!1;l.batch===!0?i>0&&(n=!0):typeof l.batch=="number"?i===l.batch&&(n=!0):typeof l.batch=="function"&&(n=l.batch({cnt:i,sel:e})),n?t.toolbar.enable(r+l.id):t.toolbar.disable(r+l.id)}}}getSelection(e){let t=[],i=this.last.selection;if(this.selectType=="row"){for(let s=0;s<i.indexes.length;s++)this.records[i.indexes[s]]&&(e===!0?t.push(i.indexes[s]):t.push(this.records[i.indexes[s]].recid));return t}else{for(let s=0;s<i.indexes.length;s++){let l=i.columns[i.indexes[s]];if(this.records[i.indexes[s]])for(let r=0;r<l.length;r++)t.push({recid:this.records[i.indexes[s]].recid,index:parseInt(i.indexes[s]),column:l[r]})}return t}}search(e,t){let i=this.url?.get??this.url,s=[],l=this.last.multi,r=this.last.logic,n=this.last.field,a=this.last.search,h=!1,d=o(`#w2overlay-${this.name}-search-overlay`);t===""&&(t=null);for(let c=0;c<this.searches.length;c++)!this.searches[c].hidden||this.searches[c].value==null||(s.push({field:this.searches[c].field,operator:this.searches[c].operator||"is",type:this.searches[c].type,value:this.searches[c].value||""}),h=!0);if(arguments.length===0&&d.length===0&&(this.multiSearch?(e=this.searchData,t=this.last.logic):(e=this.last.field,t=this.last.search)),arguments.length===0&&d.length!==0){this.focus(),r=d.find(`#grid_${this.name}_logic`).val(),a="";for(let c=0;c<this.searches.length;c++){let p=this.searches[c],f=d.find("#grid_"+this.name+"_operator_"+c).val(),m=d.find("#grid_"+this.name+"_field_"+c),w=d.find("#grid_"+this.name+"_field2_"+c),b=m.val(),y=w.val(),x=null,C=null;if(["int","float","money","currency","percent"].indexOf(p.type)!=-1){let _=m[0]._w2field,v=w[0]._w2field;_&&(b=_.clean(b)),v&&(y=v.clean(y))}if(["list","enum"].indexOf(p.type)!=-1||["in","not in"].indexOf(f)!=-1)if(b=m[0]._w2field.selected||{},Array.isArray(b)){x=[];for(let _=0;_<b.length;_++)x.push(u.isFloat(b[_].id)?parseFloat(b[_].id):String(b[_].id).toLowerCase()),delete b[_].hidden;Object.keys(b).length===0&&(b="")}else C=b.text||"",b=b.id||"";if(b!==""&&b!=null||y!=null&&y!==""){let _={field:p.field,type:p.type,operator:f};f=="between"?u.extend(_,{value:[b,y]}):f=="in"&&typeof b=="string"?u.extend(_,{value:b.split(",")}):f=="not in"&&typeof b=="string"?u.extend(_,{value:b.split(",")}):u.extend(_,{value:b}),x&&u.extend(_,{svalue:x}),C&&u.extend(_,{text:C});try{p.type=="date"&&f=="between"&&(_.value[0]=b,_.value[1]=y),p.type=="date"&&f=="is"&&(_.value=b)}catch{}s.push(_),l=!0}}}if(typeof e=="string"&&(arguments.length==1&&(t=e,e="all"),n=e,a=t,l=!1,r=h?"AND":"OR",t!=null))if(e.toLowerCase()=="all"){if(this.searches.length>0)for(let c=0;c<this.searches.length;c++){let p=this.searches[c];if(p.type=="text"||p.type=="alphanumeric"&&u.isAlphaNumeric(t)||p.type=="int"&&u.isInt(t)||p.type=="float"&&u.isFloat(t)||p.type=="percent"&&u.isFloat(t)||(p.type=="hex"||p.type=="color")&&u.isHex(t)||p.type=="currency"&&u.isMoney(t)||p.type=="money"&&u.isMoney(t)||p.type=="date"&&u.isDate(t)||p.type=="time"&&u.isTime(t)||p.type=="datetime"&&u.isDateTime(t)||p.type=="datetime"&&u.isDate(t)||p.type=="enum"&&u.isAlphaNumeric(t)||p.type=="list"&&u.isAlphaNumeric(t)){let f=this.defaultOperator[this.operatorsMap[p.type]],m={field:p.field,type:p.type,operator:p.operator!=null?p.operator:f,value:t};String(t).trim()!=""&&s.push(m)}if(["int","float","money","currency","percent"].indexOf(p.type)!=-1&&String(t).trim().split("-").length==2){let f=String(t).trim().split("-"),m={field:p.field,type:p.type,operator:p.operator!=null?p.operator:"between",value:[f[0],f[1]]};s.push(m)}if(["list","enum"].indexOf(p.type)!=-1){let f=[];p.options==null&&(p.options={}),Array.isArray(p.options.items)||(p.options.items=[]);for(let m=0;m<p.options.items;m++){let w=p.options.items[m];try{let b=new RegExp(t,"i");b.test(w)&&f.push(m),w.text&&b.test(w.text)&&f.push(w.id)}catch{}}if(f.length>0){let m={field:p.field,type:p.type,operator:p.operator!=null?p.operator:"in",value:f};s.push(m)}}}else for(let c=0;c<this.columns.length;c++){let p={field:this.columns[c].field,type:"text",operator:this.defaultOperator.text,value:t};s.push(p)}if(s.length==0){let c={field:"All",type:"text",operator:this.defaultOperator.text,value:t};s.push(c)}}else{let c=d.find("#grid_"+this.name+"_search_all"),p=this.getSearch(e);if(p==null&&(p={field:e,type:"text"}),p.field==e&&(this.last.label=p.label),t!==""){let f=this.defaultOperator[this.operatorsMap[p.type]],m=t;if(["date","time","datetime"].indexOf(p.type)!=-1&&(f="is"),["list","enum"].indexOf(p.type)!=-1){f="is";let b=c._w2field.get();b&&Object.keys(b).length>0?m=b.id:m=""}if(p.type=="int"&&t!==""){if(f="is",String(t).indexOf("-")!=-1){let b=t.split("-");b.length==2&&(f="between",m=[parseInt(b[0]),parseInt(b[1])])}if(String(t).indexOf(",")!=-1){let b=t.split(",");f="in",m=[];for(let y=0;y<b.length;y++)m.push(b[y])}}p.operator!=null&&(f=p.operator);let w={field:p.field,type:p.type,operator:f,value:m};s.push(w)}}if(Array.isArray(e)){let c="AND";typeof t=="string"&&(c=t.toUpperCase(),c!="OR"&&c!="AND"&&(c="AND")),a="",l=!0,r=c;for(let p=0;p<e.length;p++){let f=e[p];typeof f.value=="number"&&f.operator==null&&(f.operator=this.defaultOperator.number),typeof f.value=="string"&&f.operator==null&&(f.operator=this.defaultOperator.text),Array.isArray(f.value)&&f.operator==null&&(f.operator=this.defaultOperator.enum),u.isDate(f.value)&&f.operator==null&&(f.operator=this.defaultOperator.date),s.push(f)}}let g=this.trigger("search",{target:this.name,multi:arguments.length===0,searchField:e||"multi",searchValue:e?t:"multi",searchData:s,searchLogic:r});g.isCancelled!==!0&&(this.searchData=g.detail.searchData,this.last.field=n,this.last.search=a,this.last.multi=l,this.last.logic=g.detail.searchLogic,this.last.vscroll.scrollTop=0,this.last.vscroll.scrollLeft=0,this.last.selection.indexes=[],this.last.selection.columns={},this.searchClose(),i?(this.last.fetch.offset=0,this.reload()):(this.localSearch(),this.refresh()),g.finish())}searchOpen(){if(!this.box||this.searches.length===0)return;let e=this.trigger("searchOpen",{target:this.name});if(e.isCancelled===!0)return;let t=o(this.toolbar.box).find(".w2ui-grid-search-input .w2ui-search-drop");t.addClass("checked"),O.show({name:this.name+"-search-overlay",anchor:o(this.box).find("#grid_"+this.name+"_search_all").get(0),position:"bottom|top",html:this.getSearchesHTML(),align:"left",arrowSize:12,class:"w2ui-grid-search-advanced",hideOn:["doc-click"]}).then(i=>{this.initSearches(),this.last.search_opened=!0;let s=o(`#w2overlay-${this.name}-search-overlay`);s.data("gridName",this.name).off(".grid-search").on("click.grid-search",()=>{s.find("input, select").each(r=>{let n=o(r).data("tooltipName");n&&n.forEach(a=>{O.hide(a)})})}),u.bindEvents(s.find("select, input, button"),this);let l=o(`#w2overlay-${this.name}-search-overlay *[rel=search]`);l.length>0&&l[0].focus(),e.finish()}).hide(i=>{t.removeClass("checked"),this.last.search_opened=!1})}searchClose(){O.hide(this.name+"-search-overlay")}searchFieldTooltip(e,t,i){let s=this.searches[e],l=this.searchData[t],r=l.operator;r=="more"&&l.type=="date"&&(r="since"),r=="less"&&l.type=="date"&&(r="before");let n="",a=l.value;Array.isArray(l.value)?(l.value.forEach(h=>{n+=`<span class="value">${h.text||h}</span>`}),l.type=="date"&&(n="",l.value.forEach(h=>{n+=`<span class="value">${u.formatDate(h)}</span>`}))):l.type=="date"&&(a=u.formatDateTime(a)),O.hide(this.name+"-search-props"),O.show({name:this.name+"-search-props",anchor:i,class:"w2ui-white",hideOn:"doc-click",html:`
                <div class="w2ui-grid-search-single">
                    <span class="field">${s.label}</span>
                    <span class="operator">${u.lang(r)}</span>
                    ${Array.isArray(l.value)?`${n}`:`<span class="value">${a}</span>`}
                    <div class="buttons">
                        <button id="remove" class="w2ui-btn">${u.lang("Remove This Field")}</button>
                    </div>
                </div>`}).then(h=>{o(h.detail.overlay.box).find("#remove").on("click",()=>{this.searchData.splice(`${t}`,1),this.reload(),this.localSearch(),O.hide(this.name+"-search-props")})})}searchSuggest(e,t,i){if(clearTimeout(this.last.kbd_timer),clearTimeout(this.last.overlay_timer),this.searchShowFields(!0),this.searchClose(),t===!0){O.hide(this.name+"-search-suggest");return}if(o(`#w2overlay-${this.name}-search-suggest`).length>0)return;if(!e){this.last.overlay_timer=setTimeout(()=>{this.searchSuggest(!0)},100);return}let s=o(this.box).find(`#grid_${this.name}_search_all`).get(0),l=[...this.defaultSearches??[],...this.defaultSearches?.length>0&&this.savedSearches?.length>0?["--"]:[],...this.savedSearches??[]];Array.isArray(l)&&l.length>0&&j.show({name:this.name+"-search-suggest",anchor:s,align:"both",items:l,hideOn:["doc-click","sleect","remove"],render(r){let n=r.text;return r.isDefault&&(n=`<b>${n}</b>`),n}}).select(r=>{let n=this.trigger("searchSelect",{target:this.name,index:r.detail.index,item:r.detail.item});if(n.isCancelled===!0){r.preventDefault();return}r.detail.overlay.hide(),this.last.logic=r.detail.item.logic||"AND",this.last.search="",this.last.label="[Multiple Fields]",this.searchData=u.clone(r.detail.item.data),this.searchSelected=u.clone(r.detail.item,{exclude:["icon","remove"]}),this.reload(),n.finish()}).remove(r=>{let n=r.detail.item,a=this.trigger("searchRemove",{target:this.name,index:r.detail.index,item:n});if(a.isCancelled===!0){r.preventDefault();return}r.detail.overlay.hide(),this.confirm(u.lang('Do you want to delete search "${item}"?',{item:n.text})).yes(h=>{let d=this.savedSearches.findIndex(g=>g.id==n.id);d!==-1&&this.savedSearches.splice(d,1),this.cacheSave("searches",this.savedSearches.map(g=>u.clone(g,{exclude:["remove","icon"]}))),h.detail.self.close(),a.finish()}).no(h=>{h.detail.self.close()})})}searchSave(){let e="";this.searchSelected&&(e=this.searchSelected.text);let t=this.savedSearches.findIndex(s=>s.id==this.searchSelected?.id),i=this.trigger("searchSave",{target:this.name,saveLocalStorage:!0});i.isCancelled!==!0&&this.message({width:350,height:150,body:`<div class="w2ui-grid-save-search">
                        <span>${u.lang(t!=-1?"Update Search":"Save New Search")}</span>
                        <input class="search-name w2ui-input" placeholder="${u.lang("Search name")}">
                   </div>`,buttons:`
                <button id="grid-search-cancel" class="w2ui-btn">${u.lang("Cancel")}</button>
                <button id="grid-search-save" class="w2ui-btn w2ui-btn-blue" ${String(e).trim()==""?"disabled":""}>${u.lang("Save")}</button>
            `}).open(async s=>{o(s.detail.box).find("input, button").eq(0).val(e),await s.complete,o(s.detail.box).find("#grid-search-cancel").on("click",()=>{this.message()}),o(s.detail.box).find("#grid-search-save").on("click",()=>{let l=o(s.detail.box).find(".w2ui-message .search-name").val();this.searchSelected&&t!=-1?Object.assign(this.savedSearches[t],{id:l,text:l,logic:this.last.logic,data:u.clone(this.searchData)}):this.savedSearches.push({id:l,text:l,icon:"w2ui-icon-search",remove:!0,logic:this.last.logic,data:this.searchData}),this.cacheSave("searches",this.savedSearches.map(r=>u.clone(r,{exclude:["remove","icon"]}))),this.message(),this.searchSelected?(this.searchSelected.text=l,o(this.box).find(`#grid_${this.name}_search_name .name-text`).html(l)):(this.searchSelected={text:l,logic:this.last.logic,data:u.clone(this.searchData)},o(s.detail.box).find(`#grid_${this.name}_search_all`).val(" ").prop("readOnly",!0),o(s.detail.box).find(`#grid_${this.name}_search_name`).show().find(".name-text").html(l)),i.finish({name:l})}),o(s.detail.box).find("input, button").off(".message").on("keydown.message",l=>{let r=String(o(s.detail.box).find(".w2ui-message-body input").val()).trim();l.keyCode==13&&r!=""&&o(s.detail.box).find("#grid-search-save").trigger("click"),l.keyCode==27&&this.message()}).eq(0).on("input.message",l=>{let r=o(s.detail.box).closest(".w2ui-message").find("#grid-search-save");String(o(s.detail.box).val()).trim()===""?r.prop("disabled",!0):r.prop("disabled",!1)}).get(0).focus()})}cache(e){if(u.hasLocalStorage&&this.useLocalStorage)try{let t=JSON.parse(localStorage.w2ui||"{}");return t[this.stateId||this.name]??={},t[this.stateId||this.name][e]}catch{}return null}cacheSave(e,t){if(u.hasLocalStorage&&this.useLocalStorage)try{let i=JSON.parse(localStorage.w2ui||"{}");return i[this.stateId||this.name]??={},i[this.stateId||this.name][e]=t,localStorage.w2ui=JSON.stringify(i),!0}catch{delete localStorage.w2ui}return!1}searchReset(e){let t=[],i=!1;for(let n=0;n<this.searches.length;n++)!this.searches[n].hidden||this.searches[n].value==null||(t.push({field:this.searches[n].field,operator:this.searches[n].operator||"is",type:this.searches[n].type,value:this.searches[n].value||""}),i=!0);let s=this.trigger("search",{reset:!0,target:this.name,searchData:t});if(s.isCancelled===!0)return;let l=o(this.box).find("#grid_"+this.name+"_search_all");if(this.searchData=s.detail.searchData,this.searchSelected=null,this.last.search="",this.last.logic=i?"AND":"OR",l.next().hide(),this.searches.length>0)if(!this.multiSearch||!this.show.searchAll){let n=0;for(;n<this.searches.length&&(this.searches[n].hidden||this.searches[n].simple===!1);)n++;n>=this.searches.length?(this.last.field="",this.last.label=""):(this.last.field=this.searches[n].field,this.last.label=this.searches[n].label)}else this.last.field="all",this.last.label="All Fields",l.next().show();this.last.multi=!1,this.last.fetch.offset=0,this.last.vscroll.scrollTop=0,this.last.vscroll.scrollLeft=0,this.last.selection.indexes=[],this.last.selection.columns={},this.searchClose();let r=l.val("").get(0);r?._w2field&&r._w2field.reset(),e||this.reload(),s.finish()}searchShowFields(e){if(e===!0){O.hide(this.name+"-search-fields");return}let t=[];for(let i=-1;i<this.searches.length;i++){let s=this.searches[i],l=s?s.field:null,r=this.getColumn(l),n=!1,a=null;if(this.show.searchHiddenMsg==!0&&i!=-1&&(r==null||r.hidden===!0&&r.hideable!==!1)&&(n=!0,a=u.lang(`This column ${r==null?"does not exist":"is hidden"}`)),i==-1){if(!this.multiSearch||!this.show.searchAll)continue;s={field:"all",label:"All Fields"}}else if(r!=null&&r.hideable===!1||s.hidden===!0&&(a=u.lang("This column is hidden"),s.simple===!1))continue;s.label==null&&s.caption!=null&&(console.log("NOTICE: grid search.caption property is deprecated, please use search.label. Search ->",s),s.label=s.caption),t.push({id:s.field,text:u.lang(s.label),search:s,tooltip:a,disabled:n,checked:s.field==this.last.field})}j.show({type:"radio",name:this.name+"-search-fields",anchor:o(this.box).find("#grid_"+this.name+"_search_name").parent().find(".w2ui-search-down").get(0),items:t,align:"none",hideOn:["doc-click","select"]}).select(i=>{this.searchInitInput(i.detail.item.search.field)})}searchInitInput(e,t){let i,s=o(this.box).find("#grid_"+this.name+"_search_all");if(e=="all")i={field:"all",label:u.lang("All Fields")};else if(i=this.getSearch(e),i==null)return;this.last.search!=""?(this.last.label=i.label,this.search(i.field,this.last.search)):(this.last.field=i.field,this.last.label=i.label),s.attr("placeholder",u.lang("Search")+" "+u.lang(i.label||i.caption||i.field,!0)),this.searchSelected?(o(this.box).find(`#grid_${this.name}_search_all`).val(" ").prop("readOnly",!0),o(this.box).find(`#grid_${this.name}_search_name`).show().find(".name-text").html(this.searchSelected.text)):(o(this.box).find(`#grid_${this.name}_search_all`).prop("readOnly",!1),o(this.box).find(`#grid_${this.name}_search_name`).hide().find(".name-text").html(""))}clear(e){this.total=0,this.records=[],this.summary=[],this.last.fetch.offset=0,this.last.idCache={},this.last.selection={indexes:[],columns:{}},this.reset(!0),e||this.refresh()}reset(e){this.last.vscroll.scrollTop=0,this.last.vscroll.scrollLeft=0,this.last.vscroll.recIndStart=null,this.last.vscroll.recIndEnd=null,o(this.box).find(`#grid_${this.name}_records`).prop("scrollTop",0),e||this.refresh()}skip(e,t){this.url?.get??this.url?(this.offset=parseInt(e),this.offset>this.total&&(this.offset=this.total-this.limit),(this.offset<0||!u.isInt(this.offset))&&(this.offset=0),this.clear(!0),this.reload(t)):console.log("ERROR: grid.skip() can only be called when you have remote data source.")}load(e,t){return e==null?(console.log('ERROR: You need to provide url argument when calling .load() method of "'+this.name+'" object.'),new Promise((i,s)=>{s()})):(this.clear(!0),this.request("load",{},e,t))}reload(e){let t=this,i=this.url?.get??this.url;return t.selectionSave(),i?this.load(i,()=>{t.selectionRestore(),typeof e=="function"&&e()}):(this.reset(!0),this.localSearch(),this.selectionRestore(),typeof e=="function"&&e({status:"success"}),new Promise(s=>{s()}))}request(e,t,i,s){let l=this,r,n,a=new Promise((p,f)=>{r=p,n=f});if(t==null&&(t={}),i||(i=this.url),!i)return new Promise((p,f)=>{f()});u.isInt(this.offset)||(this.offset=0),u.isInt(this.last.fetch.offset)||(this.last.fetch.offset=0);let h,d={limit:this.limit,offset:parseInt(this.offset)+parseInt(this.last.fetch.offset),searchLogic:this.last.logic,search:this.searchData.map(p=>{let f=u.clone(p);return this.searchMap&&this.searchMap[f.field]&&(f.field=this.searchMap[f.field]),f}),sort:this.sortData.map(p=>{let f=u.clone(p);return this.sortMap&&this.sortMap[f.field]&&(f.field=this.sortMap[f.field]),f})};if(this.searchData.length===0&&(delete d.search,delete d.searchLogic),this.sortData.length===0&&delete d.sort,u.extend(d,this.postData),u.extend(d,t),(e=="delete"||e=="save")&&(delete d.limit,delete d.offset,d.action=e,e=="delete"&&(d[this.recid||"recid"]=this.getSelection())),e=="load"){if(h=this.trigger("request",{target:this.name,url:i,postData:d,httpMethod:"GET",httpHeaders:this.httpHeaders}),h.isCancelled===!0)return new Promise((p,f)=>{f()})}else h={detail:{url:i,postData:d,httpMethod:e=="save"?"PUT":"DELETE",httpHeaders:this.httpHeaders}};if(this.last.fetch.offset===0&&this.lock(u.lang(this.msgRefresh),!0),this.last.fetch.controller)try{this.last.fetch.controller.abort()}catch{}switch(i=h.detail.url,e){case"save":i?.save&&(i=i.save);break;case"delete":i?.remove&&(i=i.remove);break;default:i=i?.get??i}if(Object.keys(this.routeData).length>0){let p=u.parseRoute(i);if(p.keys.length>0)for(let f=0;f<p.keys.length;f++)this.routeData[p.keys[f].name]!=null&&(i=i.replace(new RegExp(":"+p.keys[f].name,"g"),this.routeData[p.keys[f].name]))}i=new URL(i,location);let g=u.prepareParams(i,{method:h.detail.httpMethod,headers:h.detail.httpHeaders,body:h.detail.postData},this.dataType);return Object.assign(this.last.fetch,{action:e,options:g,controller:new AbortController,start:Date.now(),loaded:!1}),g.signal=this.last.fetch.controller.signal,fetch(i,g).catch(c).then(p=>{if(p!=null){if(p?.status!=200){c(p??{});return}l.unlock(),p.json().catch(c).then(f=>{this.requestComplete(f,e,s,r,n)})}}),e=="load"&&h.finish(),a;function c(p){if(p?.name==="AbortError")return;l.unlock();let f=l.trigger("error",{response:p,lastFetch:l.last.fetch});f.isCancelled!==!0&&(p.status&&p.status!=200?p.json().then(m=>{l.error(p.status+": "+m.message)}).catch(()=>{l.error(p.status+": "+p.statusText)}):(console.log("ERROR: Server communication failed.",`
   EXPECTED:`,{total:5,records:[{recid:1,field:"value"}]},`
         OR:`,{error:!0,message:"error message"}),l.requestComplete({error:!0,message:u.lang(this.msgHTTPError),response:p},e,s,r,n)),f.finish())}}requestComplete(e,t,i,s,l){let r=e.error??!1;e.error==null&&e.status==="error"&&(r=!0),this.last.fetch.response=(Date.now()-this.last.fetch.start)/1e3,setTimeout(()=>{this.show.statusResponse&&this.status(u.lang("Server Response ${count} seconds",{count:this.last.fetch.response}))},10),this.last.vscroll.pull_more=!1,this.last.vscroll.pull_refresh=!0;let n="load";this.last.fetch.action=="save"&&(n="save"),this.last.fetch.action=="delete"&&(n="delete");let a=this.trigger(n,{target:this.name,error:r,data:e,lastFetch:this.last.fetch});if(a.isCancelled===!0){l();return}if(r)this.error(u.lang(e.message??this.msgServerError)),l(e);else if(typeof this.parser=="function"?(e=this.parser(e),typeof e!="object"&&console.log("ERROR: Your parser did not return proper object")):e==null?e={error:!0,message:u.lang(this.msgNotJSON)}:Array.isArray(e)&&(e={error:r,records:e,total:e.length}),t=="load"){if(e.total==null&&(e.total=-1),e.records==null&&(e.records=[]),e.records.length==this.limit){let d=this.records.length+e.records.length;this.last.fetch.hasMore=d!=this.total}else this.last.fetch.hasMore=!1,this.total=this.offset+this.last.fetch.offset+e.records.length;if(this.last.fetch.hasMore||o(this.box).find("#grid_"+this.name+"_rec_more, #grid_"+this.name+"_frec_more").hide(),this.last.fetch.offset===0)this.records=[],this.summary=[];else if(e.total!=-1&&parseInt(e.total)!=parseInt(this.total)){let d=this;return this.message(u.lang(this.msgNeedReload)).ok(()=>{delete d.last.fetch.offset,d.reload()}),new Promise(g=>{g()})}u.isInt(e.total)&&(this.total=parseInt(e.total)),e.records&&e.records.forEach(d=>{this.recid&&(d.recid=this.parseField(d,this.recid)),d.recid==null&&(d.recid="recid-"+this.records.length),d.w2ui?.summary===!0?this.summary.push(d):this.records.push(d)}),e.summary&&(this.summary=[],e.summary.forEach(d=>{this.recid&&(d.recid=this.parseField(d,this.recid)),d.recid==null&&(d.recid="recid-"+this.summary.length),this.summary.push(d)}))}else if(t=="delete")return this.reset(),this.reload();(this.url?.get??this.url)||(this.localSort(),this.localSearch()),this.total=parseInt(this.total),this.last.fetch.offset===0?this.refresh():(this.scroll(),this.resize()),typeof i=="function"&&i(e),s(e),a.finish(),this.last.fetch.loaded=!0}error(e){let t=this.trigger("error",{target:this.name,message:e});t.isCancelled!==!0&&(this.message(e),t.finish())}getChanges(e){let t=[];typeof e>"u"&&(e=this.records);for(let i=0;i<e.length;i++){let s=e[i];if(s?.w2ui){if(s.w2ui.changes!=null){let l={};l[this.recid||"recid"]=s.recid,t.push(u.extend(l,s.w2ui.changes))}s.w2ui.expanded!==!0&&s.w2ui.children&&s.w2ui.children.length&&t.push(...this.getChanges(s.w2ui.children))}}return t}mergeChanges(){let e=this.getChanges();for(let i=0;i<e.length;i++){let s=this.get(e[i][this.recid||"recid"]);for(let l in e[i])if(!(l=="recid"||this.recid&&l==this.recid)){typeof e[i][l]=="object"&&(e[i][l]=e[i][l].text);try{t(s,l,e[i][l])}catch(r){console.log("ERROR: Cannot merge. ",r.message||"",r)}s.w2ui&&delete s.w2ui.changes}}this.refresh();function t(i,s,l){let r=s.split(".");r.length==1?i[s]=l:(i=i[r[0]],r.shift(),t(i,r.join("."),l))}}save(e){let t=this.getChanges(),i=this.url?.save??this.url,s=this.trigger("save",{target:this.name,changes:t});s.isCancelled!==!0&&(i?this.request("save",{changes:s.detail.changes},null,l=>{l.error||this.mergeChanges(),s.finish(),typeof e=="function"&&e(l)}):(this.mergeChanges(),s.finish()))}editField(e,t,i,s){let l=this;if(this.last.inEditMode===!0){if(s&&s.keyCode==13){let{index:v,column:k,value:D}=this.last._edit;this.editChange({type:"custom",value:D},v,k,s),this.editDone(v,k,s)}else{let v=o(this.box).find("div.w2ui-edit-box .w2ui-input");v.length>0&&(v.get(0).tagName=="DIV"?(v.text(v.text()+i),u.setCursorPosition(v.get(0),v.text().length)):(v.val(v.val()+i),u.setCursorPosition(v.get(0),v.val().length)))}return}let r=this.get(e,!0),n=this.getCellEditable(r,t);if(!n||["checkbox","check"].includes(n.type))return;let a=this.records[r],h=this.columns[t],d=h.frozen===!0?"_f":"_";if(["enum","file"].indexOf(n.type)!=-1){console.log('ERROR: input types "enum" and "file" are not supported in inline editing.');return}let g=this.trigger("editField",{target:this.name,recid:e,column:t,value:i,index:r,originalEvent:s});if(g.isCancelled===!0)return;i=g.detail.value,this.last.inEditMode=!0,this.last.editColumn=t,this.last._edit={value:i,index:r,column:t,recid:e},this.selectNone(!0),this.select({recid:e,column:t});let c=o(this.box).find("#grid_"+this.name+d+"rec_"+u.escapeId(e)),p=c.find('[col="'+t+'"] > div');this.last._edit.tr=c,this.last._edit.div=p,o(this.box).find("div.w2ui-edit-box").remove(),this.selectType!="row"&&(o(this.box).find("#grid_"+this.name+d+"selection").attr("id","grid_"+this.name+"_editable").removeClass("w2ui-selection").addClass("w2ui-edit-box").prepend('<div style="position: absolute; top: 0px; bottom: 0px; left: 0px; right: 0px;"></div>').find(".w2ui-selection-resizer").remove(),p=o(this.box).find("#grid_"+this.name+"_editable > div:first-child")),n.attr=n.attr??"",n.text=n.text??"",n.style=n.style??"",n.items=n.items??[];let f=a.w2ui?.changes?.[h.field]!=null?u.stripTags(a.w2ui.changes[h.field]):u.stripTags(l.parseField(a,h.field));f==null&&(f="");let m=typeof f!="object"?f:"";g.detail.prevValue!=null&&(m=g.detail.prevValue),i!=null&&(f=i);let w=h.style!=null?h.style+";":"";typeof h.render=="string"&&["number","int","float","money","percent","size"].includes(h.render.split(":")[0])&&(w+="text-align: right;"),n.items.length>0&&!u.isPlainObject(n.items[0])&&(n.items=u.normMenu(n.items));let b,y=["date","time","datetime","color","list","combo"],x=getComputedStyle(c.find('[col="'+t+'"] > div').get(0)),C=`font-family: ${x["font-family"]}; font-size: ${x["font-size"]};`;switch(n.type){case"div":{p.addClass("w2ui-editable").html(u.stripSpaces(`<div id="grid_${this.name}_edit_${e}_${t}" class="w2ui-input w2ui-focus"
                        contenteditable autocorrect="off" autocomplete="off" spellcheck="false"
                        style="${C+w+n.style}"
                        field="${h.field}" recid="${e}" column="${t}" ${n.attr}>
                    </div>${n.text}`)),b=p.find("div.w2ui-input").get(0),b.innerText=typeof f!="object"?f:"",i!=null?u.setCursorPosition(b,b.innerText.length):u.setCursorPosition(b,0,b.innerText.length);break}default:{p.addClass("w2ui-editable").html(u.stripSpaces(`<input id="grid_${this.name}_edit_${e}_${t}" class="w2ui-input"
                        autocorrect="off" autocomplete="off" spellcheck="false" type="text"
                        style="${C+w+n.style}"
                        field="${h.field}" recid="${e}" column="${t}" ${n.attr}>${n.text}`)),b=p.find("input").get(0),n.type=="number"&&(f=u.formatNumber(f)),n.type=="date"&&(f=u.formatDate(u.isDate(f,n.format,!0)||new Date,n.format)),b.value=typeof f!="object"?f:"";let v=k=>{let D=this.last._edit?.escKey,S=!1,A=o(b).data("tooltipName");A&&O.get(A[0])?.selected!=null&&(S=!0),this.last.inEditMode&&!D&&y.includes(n.type)&&(k.detail.overlay.anchor?.id==this.last._edit.input?.id||n.type=="list")&&(this.editChange(),this.editDone(void 0,void 0,{keyCode:S?13:0}))};new ie(u.extend({},n,{el:b,selected:f,onSelect:v,onHide:v})),i==null&&b&&b.select()}}Object.assign(this.last._edit,{input:b,edit:n}),o(b).off(".w2ui-editable").on("blur.w2ui-editable",v=>{if(this.last.inEditMode){let k=this.last._edit.edit.type;if(o(b).data("tooltipName")&&y.includes(k)||v.target._keepOpen===!0){delete v.target._keepOpen;return}this.editChange(b,r,t,v),this.editDone()}}).on("mousedown.w2ui-editable",v=>{v.stopPropagation()}).on("click.w2ui-editable",v=>{_.call(b,v)}).on("paste.w2ui-editable",v=>{v.preventDefault();let k=v.clipboardData.getData("text/plain");document.execCommand("insertHTML",!1,k)}).on("keyup.w2ui-editable",v=>{_.call(b,v)}).on("keydown.w2ui-editable",v=>{switch(v.keyCode){case 8:n.type=="list"&&!b._w2field&&v.preventDefault();break;case 9:case 13:v.preventDefault();break;case 27:let k=o(b).data("tooltipName");if(k&&k.length>0){this.last._edit.escKey=!0,O.hide(k[0]),v.preventDefault();return}v.stopPropagation();break}setTimeout(()=>{switch(v.keyCode){case 9:{let k=v.shiftKey?l.prevCell(r,t,!0):l.nextCell(r,t,!0);if(k!=null){let D=l.records[k.index].recid;this.editChange(b,r,t,v),this.editDone(r,t,v),l.selectType!="row"?(l.selectNone(!0),l.select({recid:D,column:k.colIndex})):l.editField(D,k.colIndex,null,v),v.preventDefault&&v.preventDefault()}break}case 13:{let k=!1,D=o(b).data("tooltipName");D&&O.get(D[0]).selected!=null&&(k=!0),(!D||!k)&&b._keepOpen!==!0?(this.editChange(b,r,t,v),this.editDone(r,t,v)):delete b._keepOpen;break}case 27:{this.last._edit.escKey=!1;let k=l.parseField(a,h.field);a.w2ui?.changes?.[h.field]!=null&&(k=a.w2ui.changes[h.field]),b._prevValue!=null&&(k=b._prevValue),b.tagName=="DIV"?b.innerText=k??"":b.value=k??"",this.editDone(r,t,v),setTimeout(()=>{l.select({recid:e,column:t})},1);break}}_(b)},1)}),b&&(b._prevValue=m),n.type!="list"&&setTimeout(()=>{this.last.inEditMode&&b&&(b.focus(),clearTimeout(this.last.kbd_timer),b.resize=_,_(b))},50),g.finish({input:b});return;function _(v){try{let k=getComputedStyle(v),D=v.tagName.toUpperCase()=="DIV"?v.innerText:v.value,S=o(l.box).find("#grid_"+l.name+"_editable").get(0),A=`font-family: ${k["font-family"]}; font-size: ${k["font-size"]}; white-space: no-wrap;`,T=u.getStrWidth(D,A);T+20>S.clientWidth&&o(S).css("width",T+20+"px")}catch{}}}editChange(e,t,i,s){e=e??this.last._edit.input,t=t??this.last._edit.index,i=i??this.last._edit.column,s=s??{};let l=t<0;t=t<0?-t-1:t;let n=(l?this.summary:this.records)[t],a=this.columns[i],h=e?.tagName=="DIV"?e.innerText:e.value,d=e._w2field;d&&(d.type=="list"&&(h=d.selected),(h==null||Object.keys(h).length===0)&&(h=""),u.isPlainObject(h)||(h=d.clean(h))),e.type=="checkbox"&&(n.w2ui?.editable===!1&&(e.checked=!e.checked),h=e.checked);let g=this.parseField(n,a.field),c=n.w2ui?.changes&&n.w2ui.changes.hasOwnProperty(a.field)?n.w2ui.changes[a.field]:g,p={target:this.name,input:e,recid:n.recid,index:t,column:i,originalEvent:s,value:{new:h,previous:c,original:g}};s.target?._prevValue!=null&&(p.value.previous=s.target._prevValue);let f=0;for(;f<20;){if(f++,h=p.value.new,typeof h!="object"&&String(g)!=String(h)||typeof h=="object"&&h&&h.id!=g&&(typeof g!="object"||g==null||h.id!=g.id)){if(p=this.trigger("change",p),p.isCancelled!==!0){if(h!==p.detail.value.new)continue;(p.detail.value.new===""||p.detail.value.new==null)&&(c===""||c==null)||(n.w2ui=n.w2ui??{},n.w2ui.changes=n.w2ui.changes??{},n.w2ui.changes[a.field]=p.detail.value.new),p.finish()}}else if(p=this.trigger("restore",p),p.isCancelled!==!0){if(h!==p.detail.value.new)continue;n.w2ui?.changes&&(delete n.w2ui.changes[a.field],Object.keys(n.w2ui.changes).length===0&&delete n.w2ui.changes),p.finish()}break}}editDone(e,t,i){if(e=e??this.last._edit.index,t=t??this.last._edit.column,i=i??{},this.advanceOnEdit&&i.keyCode==13){let a=i.shiftKey?this.prevRow(e,t,1):this.nextRow(e,t,1);a==null&&(a=e),setTimeout(()=>{this.selectType!="row"?(this.selectNone(!0),this.select({recid:this.records[a].recid,column:t})):this.editField(this.records[a].recid,t,null,i)},1)}let s=e<0,l=o(this.last._edit?.tr).find('[col="'+t+'"]'),r=this.records[e],n=this.columns[t];this.last.inEditMode=!1,this.last._edit=null,s||(r.w2ui?.changes?.[n.field]!=null?l.addClass("w2ui-changed"):l.removeClass("w2ui-changed"),l.replace(this.getCellHTML(e,t,s))),o(this.box).find("div.w2ui-edit-box").remove(),this.updateToolbar(),setTimeout(()=>{let a=o(this.box).find(`#grid_${this.name}_focus`).get(0);document.activeElement!==a&&!this.last.inEditMode&&a.focus()},10)}delete(e){let t=this.trigger("delete",{target:this.name,force:e});if(e&&this.message(),t.isCancelled===!0)return;e=t.detail.force;let i=this.getSelection();if(i.length===0)return;if(this.msgDelete!=""&&!e){this.confirm({text:u.lang(this.msgDelete,{count:i.length,records:u.lang(i.length==1?"record":"records")}),width:380,height:170,yes_text:u.lang("Delete"),yes_class:"w2ui-btn-red",no_text:u.lang("Cancel")}).yes(l=>{l.detail.self.close(),this.delete(!0)}).no(l=>{l.detail.self.close()});return}if(typeof this.url!="object"?this.url:this.url.remove)this.request("delete");else if(typeof i[0]!="object")this.selectNone(),this.remove.apply(this,i);else{for(let l=0;l<i.length;l++){let r=this.columns[i[l].column].field,n=this.get(i[l].recid,!0),a=this.records[n];n!=null&&r!="recid"&&(this.records[n][r]="",a.w2ui?.changes&&delete a.w2ui.changes[r])}this.update()}t.finish()}click(e,t){let i=Date.now(),s=null;if(this.last.cancelClick==!0||t&&t.altKey)return;if(typeof e=="object"&&e!==null&&(s=e.column,e=e.recid),t==null&&(t={}),i-parseInt(this.last.click_time)<350&&this.last.click_recid==e&&t.type=="click"){this.dblClick(e,t);return}this.last.bubbleEl&&(this.last.bubbleEl=null),this.last.click_time=i;let l=this.last.click_recid;if(this.last.click_recid=e,s==null&&t.target){let f=t.target;f.tagName!="TD"&&(f=o(f).closest("td")[0]),o(f).attr("col")!=null&&(s=parseInt(o(f).attr("col")))}let r=this.trigger("click",{target:this.name,recid:e,column:s,originalEvent:t});if(r.isCancelled===!0)return;let n=this.getSelection();o(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1);let a=this.get(e,!0),h=[];this.last.sel_ind=a,this.last.sel_col=s,this.last.sel_recid=e,this.last.sel_type="click";let d,g,c,p;if(t.shiftKey&&n.length>0&&this.multiSelect){if(n[0].recid){d=this.get(n[0].recid,!0),g=this.get(e,!0),s>n[0].column?(c=n[0].column,p=s):(c=s,p=n[0].column);for(let w=c;w<=p;w++)h.push(w)}else d=this.get(l,!0),g=this.get(e,!0);let f=[];if(d>g){let w=d;d=g,g=w}let m=this.url?.get?this.url.get:this.url;for(let w=d;w<=g;w++)if(!(this.searchData.length>0&&!m&&!this.last.searchIds.includes(w)))if(this.selectType=="row")f.push(this.records[w].recid);else for(let b=0;b<h.length;b++)f.push({recid:this.records[w].recid,column:h[b]});this.select(f)}else{let f=this.last.selection,m=f.indexes.indexOf(a)!=-1,w=!1;o(t.target).closest("td").hasClass("w2ui-col-select")&&(w=!0),(!t.ctrlKey&&!t.shiftKey&&!t.metaKey&&!w||!this.multiSelect)&&!this.showSelectColumn?(this.selectType!="row"&&!f.columns[a]?.includes(s)&&(m=!1),m===!0&&n.length==1?this.unselect({recid:e,column:s}):(this.selectNone(!0),this.select({recid:e,column:s}))):(this.selectType!="row"&&(m=!1),m===!0?this.unselect({recid:e,column:s}):this.select({recid:e,column:s}))}this.status(),this.initResize(),r.finish()}columnClick(e,t){if(this.last.colResizing===!0)return;let i=this.trigger("columnClick",{target:this.name,field:e,originalEvent:t});if(i.isCancelled!==!0){if(this.selectType=="row"){let s=this.getColumn(e);s&&s.sortable&&this.sort(e,null,!!(t&&(t.ctrlKey||t.metaKey||t.shiftKey))),i.detail.field=="line-number"&&(this.getSelection().length>=this.records.length?this.selectNone():this.selectAll())}else{if(t.altKey){let s=this.getColumn(e);s&&s.sortable&&this.sort(e,null,!!(t&&(t.ctrlKey||t.metaKey||t.shiftKey)))}if(i.detail.field=="line-number")this.getSelection().length>=this.records.length?this.selectNone():this.selectAll();else{!t.shiftKey&&!t.metaKey&&!t.ctrlKey&&this.selectNone(!0);let s=this.getSelection(),l=this.getColumn(i.detail.field,!0),r=[],n=[];if(s.length!=0&&t.shiftKey){let a=l,h=s[0].column;a>h&&(a=s[0].column,h=l);for(let d=a;d<=h;d++)n.push(d)}else n.push(l);if(i=this.trigger("columnSelect",{target:this.name,columns:n}),i.isCancelled!==!0){for(let a=0;a<this.records.length;a++)r.push({recid:this.records[a].recid,column:n});this.select(r)}i.finish()}}i.finish()}}columnDblClick(e,t){let i=this.trigger("columnDblClick",{target:this.name,field:e,originalEvent:t});i.isCancelled!==!0&&i.finish()}columnContextMenu(e,t){let i=this.trigger("columnContextMenu",{target:this.name,field:e,originalEvent:t});i.isCancelled!==!0&&(this.show.columnMenu&&(j.show({type:"check",contextMenu:!0,originalEvent:t,items:this.initColumnOnOff()}).then(()=>{o("#w2overlay-context-menu .w2ui-grid-skip").off(".w2ui-grid").on("click.w2ui-grid",s=>{s.stopPropagation()}).on("keypress",s=>{s.keyCode==13&&(this.skip(s.target.value),this.toolbar.click("w2ui-column-on-off"))})}).select(s=>{let l=s.detail.item.id;["w2ui-stateSave","w2ui-stateReset"].includes(l)?this[l.substring(5)]():l=="w2ui-skip"||this.columnOnOff(s,s.detail.item.id),clearTimeout(this.last.kbd_timer)}),clearTimeout(this.last.kbd_timer)),t.preventDefault(),i.finish())}columnAutoSize(e){if(arguments.length==0){this.columns.forEach((n,a)=>this.columnAutoSize(a));return}let t=this.columns[e],i=o(`#grid_${this.name}_column_${e} .w2ui-col-header`)[0];if(t.autoResize===!1||t.hidden===!0||!i)return!0;let s=getComputedStyle(i),l=u.getStrWidth(i.innerHTML,`font-family: ${s.fontFamily}; font-size: ${s.fontSize}`,!0)+parseFloat(s.paddingLeft)+parseFloat(s.paddingRight)+4;o(this.box).find(`.w2ui-grid-records td[col="${e}"] > div`,this.box).each(n=>{let a=getComputedStyle(n),h=u.getStrWidth(n.innerHTML,`font-family: ${a.fontFamily}; font-size: ${a.fontSize}`,!0)+parseFloat(a.paddingLeft)+parseFloat(a.paddingRight)+4;l<h&&(l=h)});let r=this.trigger("columnAutoResize",{maxWidth:l,originalEvent:event,target:this.name,column:t});r.isCancelled!==!0&&(l>0&&(t.sizeOriginal==null&&(t.sizeOriginal=t.size),t.size=Math.min(Math.abs(l),t.max||1/0)+"px",this.resizeRecords(),this.resizeRecords(),this.scroll()),r.finish())}columnAutoSizeAll(){this.columns.forEach((e,t)=>this.columnAutoSize(t))}focus(e){let t=this.trigger("focus",{target:this.name,originalEvent:e});if(t.isCancelled===!0)return!1;this.hasFocus=!0,o(this.box).removeClass("w2ui-inactive").find(".w2ui-inactive").removeClass("w2ui-inactive"),setTimeout(()=>{let i=o(this.box).find(`#grid_${this.name}_focus`).get(0);i&&document.activeElement!=i&&i.focus()},10),t.finish()}blur(e){let t=this.trigger("blur",{target:this.name,originalEvent:e});if(t.isCancelled===!0)return!1;this.hasFocus=!1,o(this.box).addClass("w2ui-inactive").find(".w2ui-selected").addClass("w2ui-inactive"),o(this.box).find(".w2ui-selection").addClass("w2ui-inactive"),t.finish()}keydown(e){let t=this,i=typeof this.url!="object"?this.url:this.url.get;if(t.keyboard!==!0)return;let s=t.trigger("keydown",{target:t.name,originalEvent:e});if(s.isCancelled===!0)return;if(o(this.box).find(".w2ui-message").length>0){e.keyCode==27&&this.message();return}let l=!1,r=o(t.box).find("#grid_"+t.name+"_records"),n=t.getSelection();n.length===0&&(l=!0);let a=n[0]||null,h=[],d=n[n.length-1];if(typeof a=="object"&&a!=null){a=n[0].recid,h=[];let S=0;for(;!(!n[S]||n[S].recid!=a);)h.push(n[S].column),S++;d=n[n.length-1].recid}let g=t.get(a,!0),c=t.get(d,!0),p=o(t.box).find(`#grid_${t.name}_rec_${g!=null?u.escapeId(t.records[g].recid):"none"}`),f=Math.floor(r[0].clientHeight/t.recordHeight),m=!1,w=e.keyCode,b=e.shiftKey;switch(w){case 8:case 46:{t.delete(),m=!0,e.stopPropagation();break}case 27:{t.last.move?.type?(delete t.last.move,t.removeRange("selection-preview"),t.removeRange("selection-expand"),m=!0):(t.selectNone(),m=!0);break}case 65:{if(!e.metaKey&&!e.ctrlKey)break;t.selectAll(),m=!0;break}case 13:{if(this.selectType=="row"&&t.show.expandColumn===!0){if(p.length<=0)break;t.toggle(a,e),m=!0}else{for(let S=0;S<this.columns.length;S++)if(this.getCellEditable(g,S)){h.push(parseInt(S));break}this.selectType=="row"&&this.last._edit&&this.last._edit.column&&(h=[this.last._edit.column]),h.length>0&&(t.editField(a,h[0]??this.last.editColumn,null,e),m=!0)}break}case 37:{x();break}case 39:{C();break}case 33:{_(f);break}case 34:{v(f);break}case 35:{v(-1);break}case 36:{_(-1);break}case 38:{_(e.metaKey||e.ctrlKey?-1:1);break}case 40:{v(e.metaKey||e.ctrlKey?-1:1);break}case 17:case 91:{if(l)break;if(u.isSafari){t.last.copy_event=t.copy(!1,e);let S=o(t.box).find("#grid_"+t.name+"_focus");S.val(t.last.copy_event.detail.text),S[0].select()}break}case 67:{if(e.metaKey||e.ctrlKey)if(u.isSafari)t.copy(t.last.copy_event,e);else{t.last.copy_event=t.copy(!1,e);let S=o(t.box).find("#grid_"+t.name+"_focus");S.val(t.last.copy_event.detail.text),S[0].select(),t.copy(t.last.copy_event,e)}break}case 88:{if(l)break;if(e.ctrlKey||e.metaKey)if(u.isSafari)t.copy(t.last.copy_event,e);else{t.last.copy_event=t.copy(!1,e);let S=o(t.box).find("#grid_"+t.name+"_focus");S.val(t.last.copy_event.detail.text),S[0].select(),t.copy(t.last.copy_event,e)}break}}let y=[32,187,189,192,219,220,221,186,222,188,190,191];for(let S=48;S<=111;S++)y.push(S);y.indexOf(w)!=-1&&!e.ctrlKey&&!e.metaKey&&!m&&(h.length===0&&h.push(0),m=!1,setTimeout(()=>{let S=o(t.box).find("#grid_"+t.name+"_focus"),A=S.val();S.val(""),t.editField(a,h[0],A,e)},1)),m&&e.preventDefault&&e.preventDefault(),s.finish();function x(){if(l){k();return}if(t.selectType=="row"){if(p.length<=0)return;let S=t.records[g].w2ui||{};S&&S.parent_recid!=null&&(!Array.isArray(S.children)||S.children.length===0||!S.expanded)?(t.unselect(a),t.collapse(S.parent_recid,e),t.select(S.parent_recid)):t.collapse(a,e)}else{let S=t.prevCell(g,h[0]);if(S?.index!=g?S=null:S=S?.colIndex,!b&&S==null&&(t.selectNone(!0),S=0),S!=null)if(b&&t.multiSelect){if(D())return;let A=[],T=[],R=[];if(h.indexOf(t.last.sel_col)===0&&h.length>1){for(let E=0;E<n.length;E++)A.indexOf(n[E].recid)==-1&&A.push(n[E].recid),R.push({recid:n[E].recid,column:h[h.length-1]});t.unselect(R),t.scrollIntoView(g,h[h.length-1],!0)}else{for(let E=0;E<n.length;E++)A.indexOf(n[E].recid)==-1&&A.push(n[E].recid),T.push({recid:n[E].recid,column:S});t.select(T),t.scrollIntoView(g,S,!0)}}else t.click({recid:a,column:S},e),t.scrollIntoView(g,S,!0);else b||t.selectNone(!0)}m=!0}function C(){if(l){k();return}if(t.selectType=="row"){if(p.length<=0)return;t.expand(a,e)}else{let S=t.nextCell(g,h[h.length-1]);if(S.index!=g?S=null:S=S.colIndex,!b&&S==null&&(t.selectNone(!0),S=t.columns.length-1),S!=null)if(b&&w==39&&t.multiSelect){if(D())return;let A=[],T=[],R=[];if(h.indexOf(t.last.sel_col)==h.length-1&&h.length>1){for(let E=0;E<n.length;E++)A.indexOf(n[E].recid)==-1&&A.push(n[E].recid),R.push({recid:n[E].recid,column:h[0]});t.unselect(R),t.scrollIntoView(g,h[0],!0)}else{for(let E=0;E<n.length;E++)A.indexOf(n[E].recid)==-1&&A.push(n[E].recid),T.push({recid:n[E].recid,column:S});t.select(T),t.scrollIntoView(g,S,!0)}}else t.click({recid:a,column:S},e),t.scrollIntoView(g,S,!0);else b||t.selectNone(!0)}m=!0}function _(S){if(l&&k(),p.length<=0)return;let A=t.prevRow(g,t.selectType=="row"?0:n[0].column,S);if(!b&&A==null&&(t.searchData.length!=0&&!i?A=t.last.searchIds[0]:A=0),A!=null){if(b&&t.multiSelect){if(D())return;if(t.selectType=="row")t.last.sel_ind>A&&t.last.sel_ind!=c?t.unselect(t.records[c].recid):t.select(t.records[A].recid);else if(t.last.sel_ind>A&&t.last.sel_ind!=c){A=c;let T=[];for(let R=0;R<h.length;R++)T.push({recid:t.records[A].recid,column:h[R]});t.unselect(T)}else{let T=[];for(let R=0;R<h.length;R++)T.push({recid:t.records[A].recid,column:h[R]});t.select(T)}}else t.selectNone(!0),t.click({recid:t.records[A].recid,column:h[0]},e);t.scrollIntoView(A,null,!0,S!=1),e.preventDefault&&e.preventDefault()}else b||t.selectNone(!0)}function v(S){if(l&&k(),p.length<=0)return;let A=t.nextRow(c,t.selectType=="row"?0:n[0].column,S);if(!b&&A==null&&(t.searchData.length!=0&&!i?A=t.last.searchIds[t.last.searchIds.length-1]:A=t.records.length-1),A!=null){if(b&&t.multiSelect){if(D())return;if(t.selectType=="row")t.last.sel_ind<A&&t.last.sel_ind!=g?t.unselect(t.records[g].recid):t.select(t.records[A].recid);else if(t.last.sel_ind<A&&t.last.sel_ind!=g){A=g;let T=[];for(let R=0;R<h.length;R++)T.push({recid:t.records[A].recid,column:h[R]});t.unselect(T)}else{let T=[];for(let R=0;R<h.length;R++)T.push({recid:t.records[A].recid,column:h[R]});t.select(T)}}else t.selectNone(!0),t.click({recid:t.records[A].recid,column:h[0]},e);t.scrollIntoView(A,null,!0,S!=1),m=!0}else b||t.selectNone(!0)}function k(){if(!t.records||t.records.length===0)return;let S=Math.floor(r[0].scrollTop/t.recordHeight)+1;(!t.records[S]||S<2)&&(S=0),!(typeof t.records[S]>"u")&&t.select({recid:t.records[S].recid,column:0})}function D(){if(t.last.sel_type!="click")return!1;if(t.selectType!="row"){if(t.last.sel_type="key",n.length>1){for(let S=0;S<n.length;S++)if(n[S].recid==t.last.sel_recid&&n[S].column==t.last.sel_col){n.splice(S,1);break}return t.unselect(n),!0}return!1}else return t.last.sel_type="key",n.length>1?(n.splice(n.indexOf(t.records[t.last.sel_ind].recid),1),t.unselect(n),!0):!1}}scrollIntoView(e,t,i,s){let l=this.records.length;if(this.searchData.length!=0&&!this.url&&(l=this.last.searchIds.length),l===0)return;if(e==null){let c=this.getSelection();if(c.length===0)return;u.isPlainObject(c[0])?(e=c[0].index,t=c[0].column):e=this.get(c[0],!0)}let r=o(this.box).find(`#grid_${this.name}_records`),n=r[0].clientWidth,a=r[0].clientHeight,h=r[0].scrollTop,d=r[0].scrollLeft,g=this.last.searchIds.length;if(g>0&&(e=this.last.searchIds.indexOf(e)),r.css({"scroll-behavior":i?"auto":"smooth"}),a<this.recordHeight*(g>0?g:l)&&r.length>0){let c=Math.floor(h/this.recordHeight),p=c+Math.floor(a/this.recordHeight);e==c&&r.prop("scrollTop",h-a/1.3),e==p&&r.prop("scrollTop",h+a/1.3),(e<c||e>p)&&r.prop("scrollTop",(e-1)*this.recordHeight),s===!0&&r.prop("scrollTop",e*this.recordHeight)}if(t!=null){let c=0,p=0,f=u.scrollBarSize();for(let m=0;m<=t;m++){let w=this.columns[m];w.frozen||w.hidden||(c=p,p+=parseInt(w.sizeCalculated))}n<p-d?r.prop("scrollLeft",c-f):c<d&&r.prop("scrollLeft",p-n+f*2)}}scrollToColumn(e){if(e==null)return;let t=0,i=!1;for(let s=0;s<this.columns.length;s++){let l=this.columns[s];if(l.field==e){i=!0;break}if(l.frozen||l.hidden)continue;let r=parseInt(l.sizeCalculated?l.sizeCalculated:l.size);t+=r}i&&(this.last.vscroll.scrollLeft=t+1,this.scroll())}dblClick(e,t){let i=null;if(typeof e=="object"&&e!==null&&(i=e.column,e=e.recid),t==null&&(t={}),i==null&&t.target){let a=t.target;a.tagName.toUpperCase()!="TD"&&(a=o(a).closest("td")[0]),i=parseInt(o(a).attr("col"))}let s=this.get(e,!0),l=this.records[s],r=this.trigger("dblClick",{target:this.name,recid:e,column:i,originalEvent:t});if(r.isCancelled===!0)return;this.selectNone(!0),this.getCellEditable(s,i)?this.editField(e,i,null,t):(this.select({recid:e,column:i}),(this.show.expandColumn||l&&l.w2ui&&Array.isArray(l.w2ui.children))&&this.toggle(e)),r.finish()}showContextMenu(e,t,i){if(this.last.userSelect=="text")return;i==null&&(i={offsetX:0,offsetY:0,target:o(this.box).find(`#grid_${this.name}_rec_${e}`)[0]}),i.offsetX==null&&(i.offsetX=i.layerX-i.target.offsetLeft,i.offsetY=i.layerY-i.target.offsetTop);let s=this.getSelection();if(this.selectType=="row")s.indexOf(e)==-1&&this.click(e);else{let r=!1;for(let n=0;n<s.length;n++)(s[n].recid==e||s[n].column==t)&&(r=!0);!r&&e!=null&&this.click({recid:e,column:t}),!r&&t!=null&&this.columnClick(this.columns[t].field,i)}let l=this.trigger("contextMenu",{target:this.name,originalEvent:i,recid:e,column:t});l.isCancelled!==!0&&(this.contextMenu?.length>0&&j.show({contextMenu:!0,originalEvent:i,items:this.contextMenu}).select(r=>{clearTimeout(this.last.kbd_timer),this.contextMenuClick(e,t,r)}),i.preventDefault(),clearTimeout(this.last.kbd_timer),l.finish())}contextMenuClick(e,t,i){let s=this.trigger("contextMenuClick",{target:this.name,recid:e,column:t,originalEvent:i.detail.originalEvent,menuEvent:i,menuIndex:i.detail.index,menuItem:i.detail.item});s.isCancelled!==!0&&s.finish()}toggle(e){let t=this.get(e);if(t!=null)return t.w2ui=t.w2ui??{},t.w2ui.expanded===!0?this.collapse(e):this.expand(e)}expand(e,t){let i=this.get(e,!0),s=this.records[i];s.w2ui=s.w2ui??{};let l=u.escapeId(e),r=s.w2ui.children,n;if(Array.isArray(r)){if(s.w2ui.expanded===!0||r.length===0||(n=this.trigger("expand",{target:this.name,recid:e}),n.isCancelled===!0))return!1;s.w2ui.expanded=!0,r.forEach(h=>{h.w2ui=h.w2ui??{},h.w2ui.parent_recid=s.recid,h.w2ui.children==null&&(h.w2ui.children=[])}),this.records.splice.apply(this.records,[i+1,0].concat(r)),this.total!==-1&&(this.total+=r.length),(typeof this.url!="object"?this.url:this.url.get)||(this.localSort(!0,!0),this.searchData.length>0&&this.localSearch(!0)),t!==!0&&this.refresh(),n.finish()}else{if(o(this.box).find("#grid_"+this.name+"_rec_"+l+"_expanded_row").length>0||this.show.expandColumn!==!0||s.w2ui.expanded=="none")return!1;if(o(this.box).find("#grid_"+this.name+"_rec_"+l).after(`<tr id="grid_${this.name}_rec_${e}_expanded_row" class="w2ui-expanded-row">
                    <td colspan="100" class="w2ui-expanded2">
                        <div id="grid_${this.name}_rec_${e}_expanded"></div>
                    </td>
                    <td class="w2ui-grid-data-last"></td>
                </tr>`),o(this.box).find("#grid_"+this.name+"_frec_"+l).after(`<tr id="grid_${this.name}_frec_${e}_expanded_row" class="w2ui-expanded-row">
                    ${this.show.lineNumbers?'<td class="w2ui-col-number"></td>':""}
                    <td class="w2ui-grid-data w2ui-expanded1" colspan="100">
                       <div id="grid_${this.name}_frec_${e}_expanded"></div>
                    </td>
                </tr>`),n=this.trigger("expand",{target:this.name,recid:e,box_id:"grid_"+this.name+"_rec_"+e+"_expanded",fbox_id:"grid_"+this.name+"_frec_"+e+"_expanded"}),n.isCancelled===!0)return o(this.box).find("#grid_"+this.name+"_rec_"+l+"_expanded_row").remove(),o(this.box).find("#grid_"+this.name+"_frec_"+l+"_expanded_row").remove(),!1;let a=o(this.box).find("#grid_"+this.name+"_rec_"+e+"_expanded"),h=o(this.box).find("#grid_"+this.name+"_frec_"+e+"_expanded"),d=a.find(":scope div:first-child")[0]?.clientHeight??50;a[0].clientHeight<d&&a.css({height:d+"px"}),h[0].clientHeight<d&&h.css({height:d+"px"}),o(this.box).find("#grid_"+this.name+"_rec_"+l).attr("expanded","yes").addClass("w2ui-expanded"),o(this.box).find("#grid_"+this.name+"_frec_"+l).attr("expanded","yes").addClass("w2ui-expanded"),o(this.box).find("#grid_"+this.name+"_cell_"+this.get(e,!0)+"_expand div").html("-"),s.w2ui.expanded=!0,n.finish(),this.resizeRecords()}return!0}collapse(e,t){let i=this.get(e,!0),s=this.records[i];s.w2ui=s.w2ui||{};let l=u.escapeId(e),r=s.w2ui.children,n;if(Array.isArray(r)){if(s.w2ui.expanded!==!0||(n=this.trigger("collapse",{target:this.name,recid:e}),n.isCancelled===!0))return!1;a(s);let h=[];for(let p=s;p!=null;p=this.get(p.w2ui.parent_recid))h.push(p.w2ui.parent_recid);let d=i+1,g=d;for(;!(this.records.length<=g+1||this.records[g+1].w2ui==null||h.indexOf(this.records[g+1].w2ui.parent_recid)>=0);)g++;this.records.splice(d,g-d+1),this.total!==-1&&(this.total-=g-d+1),(typeof this.url!="object"?this.url:this.url.get)||this.searchData.length>0&&this.localSearch(!0),t!==!0&&this.refresh(),n.finish()}else{if(o(this.box).find("#grid_"+this.name+"_rec_"+l+"_expanded_row").length===0||this.show.expandColumn!==!0||(n=this.trigger("collapse",{target:this.name,recid:e,box_id:"grid_"+this.name+"_rec_"+e+"_expanded",fbox_id:"grid_"+this.name+"_frec_"+e+"_expanded"}),n.isCancelled===!0))return!1;o(this.box).find("#grid_"+this.name+"_rec_"+l).removeAttr("expanded").removeClass("w2ui-expanded"),o(this.box).find("#grid_"+this.name+"_frec_"+l).removeAttr("expanded").removeClass("w2ui-expanded"),o(this.box).find("#grid_"+this.name+"_cell_"+this.get(e,!0)+"_expand div").html("+"),o(this.box).find("#grid_"+this.name+"_rec_"+l+"_expanded").css("height","0px"),o(this.box).find("#grid_"+this.name+"_frec_"+l+"_expanded").css("height","0px"),setTimeout(()=>{o(this.box).find("#grid_"+this.name+"_rec_"+l+"_expanded_row").remove(),o(this.box).find("#grid_"+this.name+"_frec_"+l+"_expanded_row").remove(),s.w2ui.expanded=!1,n.finish(),this.resizeRecords()},300)}return!0;function a(h){h.w2ui.expanded=!1;for(let d=0;d<h.w2ui.children.length;d++){let g=h.w2ui.children[d];g.w2ui.expanded&&a(g)}}}sort(e,t,i){let s=this.trigger("sort",{target:this.name,field:e,direction:t,multiField:i});if(s.isCancelled===!0)return;if(e!=null){let r=this.sortData.length;for(let n=0;n<this.sortData.length;n++)if(this.sortData[n].field==e){r=n;break}if(t==null)if(t=this.sortData[r]?.direction,t==null)this.last.originalSort==null&&(this.last.originalSort=this.records.map(n=>n.recid)),t="asc";else switch(t.toLowerCase()){case"asc":{t="desc";break}case"desc":{t="";break}default:{t="asc";break}}i!=!0&&(this.sortData=[],r=0),t===""?this.sortData.splice(r,1):(this.sortData[r]??={},Object.assign(this.sortData[r],{field:e,direction:t}))}else this.sortData=[];(typeof this.url!="object"?this.url:this.url.get)?(s.finish({direction:t}),this.last.fetch.offset=0,this.reload()):(this.localSort(!1,!0),this.searchData.length>0&&this.localSearch(!0),this.last.vscroll.scrollTop=0,o(this.box).find(`#grid_${this.name}_records`).prop("scrollTop",0),s.finish({direction:t}),this.refresh())}copy(e,t){if(u.isPlainObject(e))return e.finish(),e.text;let i=this.getSelection();if(i.length===0)return"";let s="";if(typeof i[0]=="object"){let r=i[0].column,n=i[0].column,a=[];for(let h=0;h<i.length;h++)i[h].column<r&&(r=i[h].column),i[h].column>n&&(n=i[h].column),a.indexOf(i[h].index)==-1&&a.push(i[h].index);a.sort((h,d)=>h-d);for(let h=0;h<a.length;h++){let d=a[h];for(let g=r;g<=n;g++)this.columns[g].hidden!==!0&&(s+=this.getCellCopy(d,g)+"	");s=s.substr(0,s.length-1),s+=`
`}}else{for(let r=0;r<this.columns.length;r++){let n=this.columns[r];if(n.hidden===!0)continue;let a=n.text?n.text:n.field;n.text&&n.text.length<3&&n.tooltip&&(a=n.tooltip),s+='"'+u.stripTags(a)+'"	'}s=s.substr(0,s.length-1),s+=`
`;for(let r=0;r<i.length;r++){let n=this.get(i[r],!0);for(let a=0;a<this.columns.length;a++)this.columns[a].hidden!==!0&&(s+='"'+this.getCellCopy(n,a)+'"	');s=s.substr(0,s.length-1),s+=`
`}}s=s.substr(0,s.length-1);let l;if(e==null)return l=this.trigger("copy",{target:this.name,text:s,cut:t.keyCode==88,originalEvent:t}),l.isCancelled===!0?"":(s=l.detail.text,l.finish(),s);if(e===!1)return l=this.trigger("copy",{target:this.name,text:s,cut:t.keyCode==88,originalEvent:t}),l.isCancelled===!0?"":(s=l.detail.text,l)}getCellCopy(e,t){return u.stripTags(this.getCellHTML(e,t))}paste(e,t){let i=this.getSelection(),s=this.get(i[0].recid,!0),l=i[0].column,r=this.trigger("paste",{target:this.name,text:e,index:s,column:l,originalEvent:t});if(r.isCancelled===!0)return;if(e=r.detail.text,this.selectType=="row"||i.length===0){console.log("ERROR: You can paste only if grid.selectType = 'cell' and when at least one cell selected."),r.finish();return}if(typeof e!="object"){let a=[];e=e.split(`
`);for(let h=0;h<e.length;h++){let d=e[h].split("	"),g=0,c=this.records[s],p=[];if(c!=null){for(let f=0;f<d.length;f++)this.columns[l+g]&&(n(c,this.columns[l+g].field,d[f]),p.push(l+g),g++);for(let f=0;f<p.length;f++)a.push({recid:c.recid,column:p[f]});s++}}this.selectNone(!0),this.select(a)}else this.selectNone(!0),this.select([{recid:this.records[s],column:l}]);this.refresh(),r.finish();function n(a,h,d){a.w2ui=a.w2ui??{},a.w2ui.changes=a.w2ui.changes||{},a.w2ui.changes[h]=d}}resize(){let e=Date.now();if(!this.box||o(this.box).attr("name")!=this.name)return;let t=this.trigger("resize",{target:this.name});if(t.isCancelled!==!0)return this.box!=null&&(this.resizeBoxes(),this.resizeRecords()),t.finish(),Date.now()-e}update({cells:e,fullCellRefresh:t,ignoreColumns:i}={}){let s=Date.now(),l=this;if(this.box==null)return 0;if(Array.isArray(e))for(let n=0;n<e.length;n++){let a=e[n].index,h=e[n].column;if(a<0)continue;if(a==null||h==null){console.log("ERROR: Wrong argument for grid.update({ cells }), cells should be [{ index: X, column: Y }, ...]");continue}let d=this.records[a]??{};d.w2ui=d.w2ui??{},d.w2ui._update=d.w2ui._update??{cells:[]};let g=d.w2ui._update.row1,c=d.w2ui._update.row2;(g==null||!g.isConnected||c==null||!c.isColSelected)&&(g=this.box.querySelector(`#grid_${this.name}_rec_${u.escapeId(d.recid)}`),c=this.box.querySelector(`#grid_${this.name}_frec_${u.escapeId(d.recid)}`),d.w2ui._update.row1=g,d.w2ui._update.row2=c),r(d,g,c,a,h)}else for(let n=this.last.vscroll.recIndStart-1;n<=this.last.vscroll.recIndEnd;n++){let a=n;this.last.searchIds.length>0?a=this.last.searchIds[n]:a=n;let h=this.records[a];if(a<0||h==null)continue;h.w2ui=h.w2ui??{},h.w2ui._update=h.w2ui._update??{cells:[]};let d=h.w2ui._update.row1,g=h.w2ui._update.row2;(d==null||!d.isConnected||g==null||!g.isColSelected)&&(d=this.box.querySelector(`#grid_${this.name}_rec_${u.escapeId(h.recid)}`),g=this.box.querySelector(`#grid_${this.name}_frec_${u.escapeId(h.recid)}`),h.w2ui._update.row1=d,h.w2ui._update.row2=g);for(let c=0;c<this.columns.length;c++)r(h,d,g,a,c)}return Date.now()-s;function r(n,a,h,d,g){let c=l.columns[g];if(Array.isArray(i)&&(i.includes(g)||i.includes(c.field)))return;let p=n.w2ui._update.cells[g];if((p==null||!p.isConnected)&&(p=l.box.querySelector(`#grid_${l.name}_data_${d}_${g}`),n.w2ui._update.cells[g]=p),p!=null){if(t)o(p).replace(l.getCellHTML(d,g,!1)),p=l.box.querySelector(`#grid_${l.name}_data_${d}_${g}`),n.w2ui._update.cells[g]=p;else{let f=p.children[0],{value:m,style:w,className:b}=l.getCellValue(d,g,!1,!0);if(f.innerHTML!=m&&(f.innerHTML=m),w!=""&&p.style.cssText!=w&&(p.style.cssText=w),b!=""){let y=["w2ui-grid-data"],x=[],C=b.split(" ").filter(_=>!!_);p.classList.forEach(_=>{y.includes(_)||x.push(_)}),p.classList.remove(...x),p.classList.add(...C)}}if(l.columns[g].style&&l.columns[g].style!=p.style.cssText&&(p.style.cssText=l.columns[g].style??""),n.w2ui.class!=null){if(typeof n.w2ui.class=="string"){let f=["w2ui-odd","w2ui-even","w2ui-record"],m=[],w=n.w2ui.class.split(" ").filter(b=>!!b);a&&h&&(a.classList.forEach(b=>{f.includes(b)||m.push(b)}),a.classList.remove(...m),a.classList.add(...w),h.classList.remove(...m),h.classList.add(...w))}if(u.isPlainObject(n.w2ui.class)&&typeof n.w2ui.class[c.field]=="string"){let f=["w2ui-grid-data"],m=[],w=n.w2ui.class[c.field].split(" ").filter(b=>!!b);p.classList.forEach(b=>{f.includes(b)||m.push(b)}),p.classList.remove(...m),p.classList.add(...w)}}n.w2ui.style!=null&&(a&&h&&typeof n.w2ui.style=="string"&&a.style.cssText!==n.w2ui.style&&(a.style.cssText="height: "+l.recordHeight+"px;"+n.w2ui.style,a.setAttribute("custom_style",n.w2ui.style),h.style.cssText="height: "+l.recordHeight+"px;"+n.w2ui.style,h.setAttribute("custom_style",n.w2ui.style)),u.isPlainObject(n.w2ui.style)&&typeof n.w2ui.style[c.field]=="string"&&p.style.cssText!==n.w2ui.style[c.field]&&(p.style.cssText=n.w2ui.style[c.field]))}}}refreshCell(e,t){let i=this.get(e,!0),s=this.getColumn(t,!0),l=!(this.records[i]&&this.records[i].recid==e),r=o(this.box).find(`${l?".w2ui-grid-summary ":""}#grid_${this.name}_data_${i}_${s}`);return r.length==0?!1:(r.replace(this.getCellHTML(i,s,l)),!0)}refreshRow(e,t=null){let i=o(this.box).find("#grid_"+this.name+"_frec_"+u.escapeId(e)),s=o(this.box).find("#grid_"+this.name+"_rec_"+u.escapeId(e));if(i.length>0){t==null&&(t=this.get(e,!0));let l=i.attr("line"),r=!(this.records[t]&&this.records[t].recid==e),n=typeof this.url!="object"?this.url:this.url.get;if(this.searchData.length>0&&!n)for(let d=0;d<this.last.searchIds.length;d++)this.last.searchIds[d]==t&&(t=d);let a=this.getRecordHTML(t,l,r);i.replace(a[0]),s.replace(a[1]);let h=this.records[t].w2ui?this.records[t].w2ui.style:"";return typeof h=="string"&&(i=o(this.box).find("#grid_"+this.name+"_frec_"+u.escapeId(e)),s=o(this.box).find("#grid_"+this.name+"_rec_"+u.escapeId(e)),i.attr("custom_style",h),s.attr("custom_style",h),i.hasClass("w2ui-selected")&&(h=h.replace("background-color","none")),i[0].style.cssText="height: "+this.recordHeight+"px;"+h,s[0].style.cssText="height: "+this.recordHeight+"px;"+h),r&&this.resize(),!0}return!1}refresh(){let e=Date.now(),t=typeof this.url!="object"?this.url:this.url.get;if(this.total<=0&&!t&&this.searchData.length===0&&(this.total=this.records.length),!this.box)return;let i=this.trigger("refresh",{target:this.name});if(i.isCancelled===!0)return;this.show.header?o(this.box).find(`#grid_${this.name}_header`).html(u.lang(this.header)+"&#160;").show():o(this.box).find(`#grid_${this.name}_header`).hide(),this.show.toolbar?o(this.box).find("#grid_"+this.name+"_toolbar").show():o(this.box).find("#grid_"+this.name+"_toolbar").hide(),this.searchClose();let s=o(this.box).find("#grid_"+this.name+"_search_all");!this.multiSearch&&this.last.field=="all"&&this.searches.length>0&&(this.last.field=this.searches[0].field,this.last.label=this.searches[0].label);for(let h=0;h<this.searches.length;h++)this.searches[h].field==this.last.field&&(this.last.label=this.searches[h].label);if(this.last.multi?s.attr("placeholder","["+u.lang("Multiple Fields")+"]"):s.attr("placeholder",u.lang("Search")+" "+u.lang(this.last.label,!0)),s.val()!=this.last.search){let h=this.last.search,d=s._w2field;d&&(h=d.format(h)),s.val(h)}this.refreshSearch(),this.refreshBody(),this.show.footer?o(this.box).find(`#grid_${this.name}_footer`).html(this.getFooterHTML()).show():o(this.box).find(`#grid_${this.name}_footer`).hide();let l=this.last.selection,r=this.records.length>0&&l.indexes.length==this.records.length,n=l.indexes.length>0&&this.searchData.length!==0&&l.indexes.length==this.last.searchIds.length;r||n?o(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!0):o(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1),this.status();let a=this.find({"w2ui.expanded":!0},!0,!0);for(let h=0;h<a.length;h++){let d=this.records[a[h]].w2ui;d&&!Array.isArray(d.children)&&(d.expanded=!1)}return this.markSearch&&setTimeout(()=>{let h=[];for(let d=0;d<this.searchData.length;d++){let g=this.searchData[d],c=this.getSearch(g.field);if(!c||c.hidden)continue;let p=this.getColumn(g.field,!0);h.push({field:g.field,search:g.value,col:p})}h.length>0&&h.forEach(d=>{let g=o(this.box).find('td[col="'+d.col+'"]:not(.w2ui-head)');u.marker(g,d.search)})},50),this.updateToolbar(this.last.selection),i.finish(),this.resize(),this.addRange("selection"),setTimeout(()=>{this.resize(),this.scroll()},1),this.reorderColumns&&!this.last.columnDrag?this.last.columnDrag=this.initColumnDrag():!this.reorderColumns&&this.last.columnDrag&&this.last.columnDrag.remove(),Date.now()-e}refreshSearch(){if(this.multiSearch&&this.searchData.length>0){o(this.box).find(".w2ui-grid-searches").length==0&&o(this.box).find(".w2ui-grid-toolbar").css("height",this.last.toolbar_height+35+"px").append(`<div id="grid_${this.name}_searches" class="w2ui-grid-searches"></div>`);let e=`
                <span id="grid_${this.name}_search_logic" class="w2ui-grid-search-logic"></span>
                <div class="grid-search-line"></div>`;this.searchData.forEach((t,i)=>{let s=this.getSearch(t.field,!0),l=this.searches[s],r;if(l?.type=="enum"&&Array.isArray(t.value)?r=`<span class="grid-search-count">${t.value.length}</span>`:l?.type=="list"?r=t.text&&t.text!==t.value?`: ${t.text}`:`: ${t.value}`:r=`: ${t.value}`,l&&l.type=="date")if(t.operator=="between"){let n=t.value[0],a=t.value[1];Number(n)===n&&(n=u.formatDate(n)),Number(a)===a&&(a=u.formatDate(a)),r=`: ${n} - ${a}`}else{let n=t.value;Number(n)==n&&(n=u.formatDate(n));let a=t.operator;a=="more"&&(a="since"),a=="less"&&(a="before"),a.substr(0,5)=="more:"&&(a="since"),r=`: ${a} ${n}`}e+=`<span class="w2ui-action" data-click="searchFieldTooltip|${s}|${i}|this">
                    ${l?l.label??l.field:t.field}
                    ${r}
                    <span class="icon-chevron-down"></span>
                </span>`}),e+=`
                ${this.show.searchSave?`<div class="grid-search-line"></div>
                       <button class="w2ui-btn grid-search-btn" data-click="searchSave">${u.lang("Save")}</button>
                      `:""}
                <button class="w2ui-btn grid-search-btn btn-remove"
                    data-click="searchReset">X</button>
            `,o(this.box).find(`#grid_${this.name}_searches`).html(e),o(this.box).find(`#grid_${this.name}_search_logic`).html(u.lang(this.last.logic=="AND"?"All":"Any"))}else o(this.box).find(".w2ui-grid-toolbar").css("height",this.last.toolbar_height+"px").find(".w2ui-grid-searches").remove();this.searchSelected?(o(this.box).find(`#grid_${this.name}_search_all`).val(" ").prop("readOnly",!0),o(this.box).find(`#grid_${this.name}_search_name`).show().find(".name-text").html(this.searchSelected.text)):(o(this.box).find(`#grid_${this.name}_search_all`).prop("readOnly",!1),o(this.box).find(`#grid_${this.name}_search_name`).hide().find(".name-text").html("")),u.bindEvents(o(this.box).find(`#grid_${this.name}_searches .w2ui-action, #grid_${this.name}_searches button`),this)}refreshBody(){this.scroll();let e=this.getRecordsHTML(),t=this.getColumnsHTML(),i='<div id="grid_'+this.name+'_frecords" class="w2ui-grid-frecords" style="margin-bottom: '+(u.scrollBarSize()-1)+'px;">'+e[0]+'</div><div id="grid_'+this.name+'_records" class="w2ui-grid-records">'+e[1]+'</div><div id="grid_'+this.name+'_scroll1" class="w2ui-grid-scroll1" style="height: '+u.scrollBarSize()+'px"></div><div id="grid_'+this.name+'_fcolumns" class="w2ui-grid-fcolumns">    <table><tbody>'+t[0]+'</tbody></table></div><div id="grid_'+this.name+'_columns" class="w2ui-grid-columns">    <table><tbody>'+t[1]+`</tbody></table></div><div class="w2ui-intersection-marker" style="display: none; height: ${this.recordHeight-5}px">
               <div class="top-marker"></div>
               <div class="bottom-marker"></div>
            </div>`,s=o(this.box).find(`#grid_${this.name}_body`,this.box).html(i),l=o(this.box).find(`#grid_${this.name}_records`,this.box),r=o(this.box).find(`#grid_${this.name}_frecords`,this.box);if(this.selectType=="row"&&(l.on("mouseover mouseout",{delegate:"tr"},n=>{let a=o(n.delegate).attr("index"),h=this.records[a]?.recid;o(this.box).find(`#grid_${this.name}_frec_${u.escapeId(h)}`).toggleClass("w2ui-record-hover",n.type=="mouseover")}),r.on("mouseover mouseout",{delegate:"tr"},n=>{let a=o(n.delegate).attr("index"),h=this.records[a]?.recid;o(this.box).find(`#grid_${this.name}_rec_${u.escapeId(h)}`).toggleClass("w2ui-record-hover",n.type=="mouseover")})),u.isMobile?l.append(r).on("click",{delegate:"tr"},n=>{let a=o(n.delegate).attr("index"),h=this.records[a]?.recid;this.dblClick(h,n)}):l.add(r).on("click",{delegate:"tr"},n=>{let a=o(n.delegate).attr("index"),h=this.records[a]?.recid;h!="-none-"&&this.click(h,n)}).on("contextmenu",{delegate:"tr"},n=>{let a=o(n.delegate).attr("index"),h=this.records[a]?.recid,d=o(n.target).closest("td"),g=d.attr("col")?parseInt(d.attr("col")):null;this.showContextMenu(h,g,n)}).on("mouseover",{delegate:"tr"},n=>{this.last.rec_out=!1;let a=o(n.delegate).attr("index"),h=this.records[a]?.recid;a!==this.last.rec_over&&(this.last.rec_over=a,setTimeout(()=>{delete this.last.rec_out,this.trigger("mouseEnter",{target:this.name,originalEvent:n,index:a,recid:h}).finish()}))}).on("mouseout",{delegate:"tr"},n=>{let a=o(n.delegate).attr("index"),h=this.records[a]?.recid;this.last.rec_out=!0,setTimeout(()=>{let d=()=>{this.trigger("mouseLeave",{target:this.name,originalEvent:n,index:a,recid:h}).finish()};a!==this.last.rec_over&&d(),setTimeout(()=>{this.last.rec_out&&(delete this.last.rec_out,delete this.last.rec_over,d())})})}),s.data("scroll",{lastDelta:0,lastTime:0}).find(".w2ui-grid-frecords").on("mousewheel DOMMouseScroll ",n=>{n.preventDefault();let a=s.data("scroll"),h=s.find(".w2ui-grid-records"),d=typeof n.wheelDelta!=null?-n.wheelDelta:n.detail||n.deltaY,g=h.prop("scrollTop");a.lastDelta+=d,d=Math.round(a.lastDelta),s.data("scroll",a),h.get(0).scroll({top:g+d,behavior:"smooth"})}),l.off(".body-global").on("scroll.body-global",{delegate:".w2ui-grid-records"},n=>{this.scroll(n)}),o(this.box).find(".w2ui-grid-body").off(".body-global").on("click.body-global dblclick.body-global contextmenu.body-global",{delegate:"td.w2ui-head"},n=>{let a=o(n.delegate).attr("col"),h=this.columns[a]??{field:a};switch(n.type){case"click":this.columnClick(h.field,n);break;case"dblclick":this.columnDblClick(h.field,n);break;case"contextmenu":this.columnContextMenu(h.field,n);break}}).on("mouseover.body-global",{delegate:".w2ui-col-header"},n=>{let a=o(n.delegate).parent().attr("col");this.columnTooltipShow(a,n),o(n.delegate).off(".tooltip").on("mouseleave.tooltip",()=>{this.columnTooltipHide(a,n)})}).on("click.body-global",{delegate:"input.w2ui-select-all"},n=>{n.delegate.checked?this.selectAll():this.selectNone(),n.stopPropagation(),clearTimeout(this.last.kbd_timer)}).on("click.body-global",{delegate:".w2ui-show-children, .w2ui-col-expand"},n=>{n.stopPropagation();let a=o(n.target).parents("tr").attr("index");this.toggle(this.records[a].recid)}).on("click.body-global mouseover.body-global",{delegate:".w2ui-info"},n=>{let a=o(n.delegate).closest("td"),h=a.parent(),d=this.columns[a.attr("col")],g=h.parents(".w2ui-grid-body").hasClass("w2ui-grid-summary");["mouseenter","mouseover"].includes(d.info?.showOn?.toLowerCase())&&n.type=="mouseover"?this.showBubble(h.attr("index"),a.attr("col"),g).then(()=>{o(n.delegate).off(".tooltip").on("mouseleave.tooltip",()=>{O.hide(this.name+"-bubble")})}):n.type=="click"&&(O.hide(this.name+"-bubble"),this.showBubble(h.attr("index"),a.attr("col"),g))}).on("mouseover.body-global",{delegate:".w2ui-clipboard-copy"},n=>{if(n.delegate._tooltipShow)return;let a=o(n.delegate).parent(),h=a.parent(),d=this.columns[a.attr("col")],g=h.parents(".w2ui-grid-body").hasClass("w2ui-grid-summary");O.show({name:this.name+"-bubble",anchor:n.delegate,html:u.lang(typeof d.clipboardCopy=="string"?d.clipboardCopy:"Copy to clipboard"),position:"top|bottom",offsetY:-2}).hide(c=>{n.delegate._tooltipShow=!1,o(n.delegate).off(".tooltip")}),o(n.delegate).off(".tooltip").on("mouseleave.tooltip",c=>{O.hide(this.name+"-bubble")}).on("click.tooltip",c=>{c.stopPropagation(),O.update(this.name+"-bubble",u.lang("Copied")),this.clipboardCopy(h.attr("index"),a.attr("col"),g)}),n.delegate._tooltipShow=!0}).on("click.body-global",{delegate:".w2ui-editable-checkbox"},n=>{let a=o(n.delegate).data();this.editChange.call(this,n.delegate,a.changeind,a.colind,n),this.updateToolbar()}),this.records.length===0&&this.msgEmpty?o(this.box).find(`#grid_${this.name}_body`).append(`<div id="grid_${this.name}_empty_msg" class="w2ui-grid-empty-msg"><div>${u.lang(this.msgEmpty)}</div></div>`):o(this.box).find(`#grid_${this.name}_empty_msg`).length>0&&o(this.box).find(`#grid_${this.name}_empty_msg`).remove(),this.summary.length>0){let n=this.getSummaryHTML();o(this.box).find(`#grid_${this.name}_fsummary`).html(n[0]).show(),o(this.box).find(`#grid_${this.name}_summary`).html(n[1]).show()}else o(this.box).find(`#grid_${this.name}_fsummary`).hide(),o(this.box).find(`#grid_${this.name}_summary`).hide()}render(e){let t=Date.now(),i=this;typeof e=="string"&&(e=o(e).get(0));let s=this.trigger("render",{target:this.name,box:e??this.box});if(s.isCancelled===!0||(e!=null&&(this.unmount(),this.box=e),!this.box))return;let l=typeof this.url!="object"?this.url:this.url.get;if(this.reset(!0),!this.last.field)if(!this.multiSearch||!this.show.searchAll){let c=0;for(;c<this.searches.length&&(this.searches[c].hidden||this.searches[c].simple===!1);)c++;c>=this.searches.length?(this.last.field="",this.last.label=""):(this.last.field=this.searches[c].field,this.last.label=this.searches[c].label)}else this.last.field="all",this.last.label="All Fields";if(o(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-grid w2ui-inactive").html('<div class="w2ui-grid-box">    <div id="grid_'+this.name+'_header" class="w2ui-grid-header"></div>    <div id="grid_'+this.name+'_toolbar" class="w2ui-grid-toolbar"></div>    <div id="grid_'+this.name+'_body" class="w2ui-grid-body"></div>    <div id="grid_'+this.name+'_fsummary" class="w2ui-grid-body w2ui-grid-summary"></div>    <div id="grid_'+this.name+'_summary" class="w2ui-grid-body w2ui-grid-summary"></div>    <div id="grid_'+this.name+'_footer" class="w2ui-grid-footer"></div>    <textarea id="grid_'+this.name+'_focus" class="w2ui-grid-focus-input" '+(this.tabIndex?'tabindex="'+this.tabIndex+'"':"")+(u.isMobile?"readonly":"")+"></textarea></div>"),this.selectType!="row"&&o(this.box).addClass("w2ui-ss"),o(this.box).length>0&&(o(this.box)[0].style.cssText+=this.style),this.toolbar!=null&&this.toolbar.render(o(this.box).find("#grid_"+this.name+"_toolbar")[0]),this.last.toolbar_height=o(this.box).find(`#grid_${this.name}_toolbar`).prop("offsetHeight"),this.last.field&&this.last.field!="all"){let c=this.searchData;setTimeout(()=>{this.searchInitInput(this.last.field,c.length==1?c[0].value:null)},1)}o(this.box).find(`#grid_${this.name}_footer`).html(this.getFooterHTML()),this.last.state||(this.last.state=this.stateSave(!0)),this.stateRestore(),l&&(this.clear(),this.refresh());let r=!1;for(let c=0;c<this.searches.length;c++)if(this.searches[c].hidden){r=!0;break}r?(this.searchReset(!1),l||setTimeout(()=>{this.searchReset()},1)):this.reload(),o(this.box).find(`#grid_${this.name}_focus`).on("focus",c=>{clearTimeout(this.last.kbd_timer),this.hasFocus||this.focus()}).on("blur",c=>{clearTimeout(this.last.kbd_timer),this.last.kbd_timer=setTimeout(()=>{this.hasFocus&&this.blur()},100)}).on("paste",c=>{let p=c.clipboardData?c.clipboardData:null;if(p){let f=p.items;f.length==2&&(f.length==2&&f[1].kind=="file"&&(f=[f[1]]),f.length==2&&f[0].type=="text/plain"&&f[1].type=="text/html"&&(f=[f[1]]));let m=[];for(let w in f){let b=f[w];if(b.kind==="file"){let y=b.getAsFile();m.push({kind:"file",data:y})}else if(b.kind==="string"&&(b.type==="text/plain"||b.type==="text/html")){c.preventDefault();let y=p.getData("text/plain");y.indexOf("\r")!=-1&&y.indexOf(`
`)==-1&&(y=y.replace(/\r/g,`
`)),m.push({kind:b.type=="text/html"?"html":"text",data:y})}}m.length===1&&m[0].kind!="file"&&(m=m[0].data),N[this.name].paste(m,c),c.preventDefault()}}).on("keydown",function(c){N[i.name].keydown.call(N[i.name],c)});let n;return o(this.box).off("mousedown.mouseStart").on("mousedown.mouseStart",a),this.updateToolbar(),s.finish(),this.last.observeResize=new ResizeObserver(()=>{this.resize(),this.scroll()}),this.last.observeResize.observe(this.box),Date.now()-t;function a(c){if(c.which==1&&(i.last.userSelect=="text"&&(i.last.userSelect="",o(i.box).find(".w2ui-grid-body").css("user-select","none")),!(i.selectType=="row"&&(o(c.target).parents().hasClass("w2ui-head")||o(c.target).hasClass("w2ui-head")))&&!(i.last.move&&i.last.move.type=="expand"))){if(c.altKey)o(i.box).find(".w2ui-grid-body").css("user-select","text"),i.selectNone(),i.last.move={type:"text-select"},i.last.userSelect="text";else{let p=c.target,f={x:c.offsetX-10,y:c.offsetY-10},m=!1;for(;p&&!(p.classList&&p.classList.contains("w2ui-grid"));)p.tagName&&p.tagName.toUpperCase()=="TD"&&(m=!0),p.tagName&&p.tagName.toUpperCase()!="TR"&&m==!0&&(f.x+=p.offsetLeft,f.y+=p.offsetTop),p=p.parentNode;let w=o(c.target).parents("tr").attr("index"),b=i.records[w]?.recid;if(i.selectType=="cell"&&!c.shiftKey){let C=parseInt(o(c.target).closest("td").attr("col")),_=C;isNaN(C)&&(C=0,_=i.columns.length-1),i.addRange({name:"selection-preview",range:[{recid:b,column:C},{recid:b,column:_}],class:"w2ui-selection-preview"})}if(i.last.move={x:c.screenX,y:c.screenY,divX:0,divY:0,focusX:f.x,focusY:f.y,recid:b,column:parseInt(c.target.tagName.toUpperCase()=="TD"?o(c.target).attr("col"):o(c.target).parents("td").attr("col")),type:"select",ghost:!1,start:!0},i.last.move.recid==null&&i.records.length>0){i.last.move.type="select-column";let C=parseInt(o(c.target).closest("td").attr("col")),_=i.records[0].recid,v=i.records[i.records.length-1].recid;i.addRange({name:"selection-preview",range:[{recid:_,column:C},{recid:v,column:C}],class:"w2ui-selection-preview"})}let y=c.target,x=o(i.box).find("#grid_"+i.name+"_focus");if(i.last.move){let C=i.last.move.focusX,_=i.last.move.focusY,v=o(y).parents("table").parent();(v.hasClass("w2ui-grid-records")||v.hasClass("w2ui-grid-frecords")||v.hasClass("w2ui-grid-columns")||v.hasClass("w2ui-grid-fcolumns")||v.hasClass("w2ui-grid-summary"))&&(C=i.last.move.focusX-o(i.box).find("#grid_"+i.name+"_records").prop("scrollLeft"),_=i.last.move.focusY-o(i.box).find("#grid_"+i.name+"_records").prop("scrollTop")),(o(y).hasClass("w2ui-grid-footer")||o(y).parents("div.w2ui-grid-footer").length>0)&&(_=o(i.box).find("#grid_"+i.name+"_footer").get(0).offsetTop),v.hasClass("w2ui-scroll-wrapper")&&v.parent().hasClass("w2ui-toolbar")&&(C=i.last.move.focusX-v.prop("scrollLeft")),x.css({left:C-10,top:_})}setTimeout(()=>{i.last.inEditMode||(["INPUT","TEXTAREA","SELECT"].includes(y.tagName)?y.focus():x.get(0)!==document.active&&x.get(0)?.focus({preventScroll:!0}))},50),!i.multiSelect&&!i.reorderRows&&i.last.move.type=="drag"&&delete i.last.move}if(i.reorderRows==!0){let p=c.target;if(p.tagName.toUpperCase()!="TD"&&(p=o(p).parents("td")[0]),o(p).hasClass("w2ui-col-number")||o(p).hasClass("w2ui-col-order")){i.selectNone(),i.last.move.reorder=!0;let f=o(i.box).find(".w2ui-even.w2ui-empty-record").css("background-color"),m=o(i.box).find(".w2ui-odd.w2ui-empty-record").css("background-color");o(i.box).find(".w2ui-even td").filter(":not(.w2ui-col-number)").css("background-color",f),o(i.box).find(".w2ui-odd td").filter(":not(.w2ui-col-number)").css("background-color",m);let w=i.last.move,b=o(i.box).find(".w2ui-grid-records");if(!w.ghost){let x=o(i.box).find(`#grid_${i.name}_rec_${w.recid}`),C=x.parents("table").find("tr:first-child").get(0).cloneNode(!0);w.offsetY=c.offsetY,w.from=w.recid,w.pos={top:x.get(0).offsetTop-1,left:x.get(0).offsetLeft},w.ghost=o(x.get(0).cloneNode(!0)),w.ghost.removeAttr("id"),w.ghost.find("td").css({"border-top":"1px solid silver","border-bottom":"1px solid silver"}),x.find("td").remove(),x.append(`<td colspan="1000"><div class="w2ui-reorder-empty" style="height: ${i.recordHeight-2}px"></div></td>`),b.append('<div id="grid_'+i.name+'_ghost_line" style="position: absolute; z-index: 999999; pointer-events: none; width: 100%;"></div>'),b.append('<table id="grid_'+i.name+'_ghost" style="position: absolute; z-index: 999998; opacity: 0.9; pointer-events: none;"></table>'),o(i.box).find("#grid_"+i.name+"_ghost").append(C).append(w.ghost)}o(i.box).find("#grid_"+i.name+"_ghost").css({top:w.pos.top+"px",left:w.pos.left+"px"})}else i.last.move.reorder=!1}o(document).on("mousemove.w2ui-"+i.name,h).on("mouseup.w2ui-"+i.name,d),c.stopPropagation()}}function h(c){if(!c.target.tagName)return;let p=i.last.move;if(!p||!["select","select-column"].includes(p.type)||(p.divX=c.screenX-p.x,p.divY=c.screenY-p.y,Math.abs(p.divX)<=1&&Math.abs(p.divY)<=1))return;if(i.last.cancelClick=!0,i.reorderRows==!0&&i.last.move.reorder){let y=o(c.target).parents("tr").attr("index"),x=i.records[y]?.recid;if((x=="-none-"||x==null)&&(x="bottom"),x!=p.from){let _=o(i.box).find("#grid_"+i.name+"_rec_"+x);o(i.box).find(".insert-before"),_.addClass("insert-before"),p.lastY=c.screenY,p.to=x;let v={top:_.get(0)?.offsetTop,left:_.get(0)?.offsetLeft},k=o(i.box).find("#grid_"+i.name+"_ghost_line");v?k.css({top:v.top+"px",left:p.pos.left+"px","border-top":"2px solid #769EFC"}):k.css({"border-top":"2px solid transparent"})}o(i.box).find("#grid_"+i.name+"_ghost").css({top:p.pos.top+p.divY+"px",left:p.pos.left+"px"});return}i.selectType=="row"&&p.start&&p.recid&&(i.selectNone(),p.start=!1);let f=[],m=c.target.tagName.toUpperCase()=="TR"?o(c.target).attr("index"):o(c.target).parents("tr").attr("index"),w=i.records[m]?.recid;if(w==null){if(i.selectType=="row"||i.last.move&&i.last.move.type=="select")return;let b=parseInt(o(c.target).parents("td").attr("col"));if(isNaN(b))i.removeRange("column-selection"),o(i.box).find(".w2ui-grid-columns .w2ui-col-header, .w2ui-grid-fcolumns .w2ui-col-header").removeClass("w2ui-col-selected"),o(i.box).find(".w2ui-col-number").removeClass("w2ui-row-selected"),delete p.colRange;else{let y=b+"-"+b;p.column<b&&(y=p.column+"-"+b),p.column>b&&(y=b+"-"+p.column);let x=[],C=y.split("-");for(let _=parseInt(C[0]);_<=parseInt(C[1]);_++)x.push(_);if(p.colRange!=y&&p.type=="select-column"&&(n=i.trigger("columnSelect",{target:i.name,columns:x}),n.isCancelled!==!0)){p.colRange=y;let _=i.records[0].recid,v=i.records[i.records.length-1].recid;i.addRange({name:"selection-preview",range:[{recid:_,column:C[0]},{recid:v,column:C[1]}],class:"w2ui-selection-preview"})}}}else{let b=i.get(p.recid,!0);if(b==null||i.records[b]&&i.records[b].recid!=p.recid)return;let y=i.get(w,!0);if(y==null)return;let x=parseInt(p.column),C=parseInt(c.target.tagName.toUpperCase()=="TD"?o(c.target).attr("col"):o(c.target).parents("td").attr("col"));if(isNaN(x)&&isNaN(C)&&(x=0,C=i.columns.length-1),b>y){let v=b;b=y,y=v}let _="ind1:"+b+",ind2;"+y+",col1:"+x+",col2:"+C;if(p.range==_)return;p.range=_;for(let v=b;v<=y;v++)if(!(i.last.searchIds.length>0&&i.last.searchIds.indexOf(v)==-1))if(i.selectType!="row"){if(x>C){let k=x;x=C,C=k}for(let k=x;k<=C;k++)i.columns[k].hidden||f.push({recid:i.records[v].recid,column:parseInt(k)})}else f.push(i.records[v].recid);if(i.selectType!="row"){let v=f[0],k=f[f.length-1];i.addRange({name:"selection-preview",range:[{recid:v.recid,column:v.column},{recid:k.recid,column:k.column}],class:"w2ui-selection-preview"}),p.newRange=f}else if(i.multiSelect){let v=i.getSelection();for(let k=0;k<f.length;k++)v.indexOf(f[k])==-1&&i.select(f[k]);for(let k=0;k<v.length;k++)f.indexOf(v[k])==-1&&i.unselect(v[k])}}}function d(c){let p=i.last.move;if(setTimeout(()=>{delete i.last.cancelClick},1),!(o(c.target).parents().hasClass(".w2ui-head")||o(c.target).hasClass(".w2ui-head"))){if(i.removeRange("selection-preview"),p&&["select","select-column"].includes(p.type)){if(p.colRange!=null&&n.isCancelled!==!0){let f=p.colRange.split("-"),m=[];for(let w=0;w<i.records.length;w++){let b=[];for(let y=parseInt(f[0]);y<=parseInt(f[1]);y++)b.push(y);m.push({recid:i.records[w].recid,column:b})}n.finish(),i.selectNone(!0),i.select(m)}else p.newRange!=null&&(i.selectNone(!0),i.select(...p.newRange));if(i.reorderRows==!0&&i.last.move.reorder)if(p.to!=null){let f=i.trigger("reorderRow",{target:i.name,recid:p.from,moveBefore:p.to});if(f.isCancelled===!0){g(),delete i.last.move;return}let m=i.get(p.from,!0),w=i.get(p.to,!0);p.to=="bottom"&&(w=i.records.length);let b=i.records[m];m!=null&&w!=null&&(i.records.splice(m,1),m>w?i.records.splice(w,0,b):i.records.splice(w-1,0,b)),i.sortData=[],o(i.box).find(`#grid_${i.name}_columns .w2ui-col-header`).removeClass("w2ui-col-sorted"),g(),f.finish()}else g()}delete i.last.move,o(document).off(".w2ui-"+i.name)}}function g(){o(i.box).find(`#grid_${i.name}_ghost`).remove(),o(i.box).find(`#grid_${i.name}_ghost_line`).remove(),i.refresh(),delete i.last.move}}unmount(){super.unmount(),this.toolbar?.unmount(),this.last.observeResize?.disconnect()}destroy(){let e=this.trigger("destroy",{target:this.name});e.isCancelled!==!0&&(this.toolbar?.destroy?.(),o(this.box).find(`#grid_${this.name}_body`).length>0&&this.unmount(),delete N[this.name],e.finish())}initColumnOnOff(){let e=[{id:"line-numbers",text:"Line #",checked:this.show.lineNumbers}];for(let s=0;s<this.columns.length;s++){let l=this.columns[s],r=this.columns[s].text;l.hideable!==!1&&(!r&&this.columns[s].tooltip&&(r=this.columns[s].tooltip),r||(r="- column "+(parseInt(s)+1)+" -"),e.push({id:l.field,text:u.stripTags(r),checked:!l.hidden}))}if(((typeof this.url!="object"?this.url:this.url.get)&&this.show.skipRecords||this.show.saveRestoreState)&&e.push({text:"--"}),this.show.skipRecords){let s=u.lang("Skip")+`<input id="${this.name}_skip" type="text" class="w2ui-input w2ui-grid-skip" value="${this.offset}">`+u.lang("records");e.push({id:"w2ui-skip",text:s,group:!1,icon:"w2ui-icon-empty"})}this.show.saveRestoreState&&e.push({id:"w2ui-stateSave",text:u.lang("Save Grid State"),icon:"w2ui-icon-empty",group:!1},{id:"w2ui-stateReset",text:u.lang("Restore Default State"),icon:"w2ui-icon-empty",group:!1});let i=[];return e.forEach(s=>{s.text=u.lang(s.text),s.checked&&i.push(s.id)}),this.toolbar.set("w2ui-column-on-off",{selected:i,items:e}),e}initColumnDrag(e){if(this.columnGroups&&this.columnGroups.length)throw"Draggable columns are not currently supported with column groups.";let t=this,i={pressed:!1,targetPos:null,columnHead:null},s=(d,g)=>{let c=["w2ui-col-number","w2ui-col-expand","w2ui-col-select"];g!==!0&&c.push("w2ui-head-last");for(let p=0;p<c.length;p++)if(o(d).closest(".w2ui-head").hasClass(c[p]))return!0;return!1};o(t.box).off(".colDrag").on("mousedown.colDrag",l);function l(d){if(i.pressed||i.numberPreColumnsPresent===0||d.button!==0)return;let g,c,p,f,m=".w2ui-head.w2ui-col-number, .w2ui-head.w2ui-col-expand, .w2ui-head.w2ui-col-select";if(!o(d.target).parents().hasClass("w2ui-head")||s(d.target))return;if(i.pressed=!0,i.initialX=d.pageX,i.initialY=d.pageY,i.numberPreColumnsPresent=o(t.box).find(m).length,i.columnHead=p=o(d.target).closest(".w2ui-head"),i.originalPos=f=parseInt(p.attr("col"),10),g=t.trigger("columnDragStart",{originalEvent:d,origColumnNumber:f,target:p[0]}),g.isCancelled===!0)return!1;c=i.columns=o(t.box).find(".w2ui-head:not(.w2ui-head-last)"),o(document).on("mouseup.colDrag",n),o(document).on("mousemove.colDrag",r);let w=t.columns[i.originalPos],b=u.lang(typeof w.text=="function"?w.text(w):w.text);i.ghost=o.html(`<span col="${i.originalPos}">${b}</span>`)[0],o(document.body).append(i.ghost),o(i.ghost).css({display:"none",left:d.pageX,top:d.pageY,opacity:1,margin:"3px 0 0 20px",padding:"3px","background-color":"white",position:"fixed","z-index":999999}).addClass(".w2ui-grid-ghost"),i.offsets=[];for(let y=0,x=c.length;y<x;y++){let C=c[y].getBoundingClientRect();i.offsets.push(C.left)}g.finish()}function r(d){if(!i.pressed||!i.columnHead)return;let g=d.pageX,c=d.pageY;s(d.target,!0)||a(d),h(g,c)}function n(d){if(!i.pressed||!i.columnHead)return;i.pressed=!1;let g,c,p,f,m=()=>{let w=o(t.box).find(".w2ui-grid-ghost");o(t.box).find(".w2ui-intersection-marker").hide(),o(i.ghost).remove(),w.remove(),o(document).off(".colDrag"),i={}};if(d.pageX==i.initialX&&d.pageY==i.initialY){t.columnClick(t.columns[i.originalPos].field,d),m();return}if(g=t.trigger("columnDragEnd",{originalEvent:d,target:i.columnHead[0],dragData:i}),g.isCancelled===!0)return!1;p=t.columns[i.originalPos],f=t.columns,i.originalPos!=i.targetPos&&i.targetPos!=null&&(f.splice(i.targetPos,0,u.clone(p)),f.splice(f.indexOf(p),1)),m(),t.refresh(),g.finish({targetColumn:c-1})}function a(d){if(o(d.target).closest("td").length==0)return;let g=o(d.target).closest("td"),c=g.hasClass("w2ui-head-last")?t.columns.length:parseInt(g.attr("col"));if(i.targetPos!=c){let p=o(t.box).find(".w2ui-grid-body").get(0).getBoundingClientRect(),f=o(d.target).closest("td").get(0).getBoundingClientRect();o(t.box).find(".w2ui-intersection-marker").show().css({left:f.left-p.left+"px",height:f.height+"px"}),i.targetPos=c}}function h(d,g){o(i.ghost).css({left:d-10+"px",top:g-10+"px"}).show()}return{remove(){o(t.box).off(".colDrag"),t.last.columnDrag=!1}}}columnOnOff(e,t){let i=this.trigger("columnOnOff",{target:this.name,field:t,originalEvent:e});if(i.isCancelled===!0)return;let s=this.find({"w2ui.expanded":!0},!0);for(let l=0;l<s.length;l++){let r=this.records[l].w2ui;r&&!Array.isArray(r.children)&&(this.records[l].w2ui.expanded=!1)}if(t=="line-numbers")this.show.lineNumbers=!this.show.lineNumbers,this.refresh();else{let l=this.getColumn(t);l.hidden?this.showColumn(l.field):this.hideColumn(l.field)}i.finish()}initToolbar(){if(this.toolbar.render!=null)return;let e=this.toolbar.items||[];if(this.toolbar.items=[],this.toolbar=new Z(u.extend({},this.toolbar,{name:this.name+"_toolbar",owner:this})),this.show.toolbarReload&&this.toolbar.items.push(u.extend({},this.buttons.reload)),this.show.toolbarColumns&&this.toolbar.items.push(u.extend({},this.buttons.columns)),this.show.toolbarSearch){let t=`
                <div class="w2ui-grid-search-input">
                    ${this.buttons.search.html}
                    <div id="grid_${this.name}_search_name" class="w2ui-grid-search-name">
                        <span class="name-icon w2ui-icon-search"></span>
                        <span class="name-text"></span>
                        <span class="name-cross w2ui-action" data-click="searchReset">x</span>
                    </div>
                    <input type="text" id="grid_${this.name}_search_all" class="w2ui-search-all" tabindex="-1"
                        autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"
                        placeholder="${u.lang(this.last.label,!0)}" value="${this.last.search}"
                        data-focus="searchSuggest" data-click="stop"
                    >
                    <div class="w2ui-search-drop w2ui-action" data-click="searchOpen"
                            style="${this.multiSearch?"":"display: none"}">
                        <span class="w2ui-icon-drop"></span>
                    </div>
                </div>`;this.toolbar.items.push({id:"w2ui-search",type:"html",html:t,onRefresh:async i=>{await i.complete;let s=o(this.box).find(`#grid_${this.name}_search_all`);u.bindEvents(o(this.box).find(`#grid_${this.name}_search_all, .w2ui-action`),this);let l=u.debounce(r=>{let n=r.target.value;this.liveSearch&&this.last.liveText!=n&&(this.last.liveText=n,this.search(this.last.field,n))},250);s.on("blur",()=>{this.last.liveText=""}).on("keyup",r=>{switch(r.keyCode){case 40:{this.searchSuggest(!0);break}case 38:{this.searchSuggest(!0,!0);break}case 13:{this.search(this.last.field,r.target.value);break}default:{l(r);break}}})}})}if(Array.isArray(e)){let t=e.map(i=>i.id);this.show.toolbarAdd&&!t.includes(this.buttons.add.id)&&this.toolbar.items.push(u.extend({},this.buttons.add)),this.show.toolbarEdit&&!t.includes(this.buttons.edit.id)&&this.toolbar.items.push(u.extend({},this.buttons.edit)),this.show.toolbarDelete&&!t.includes(this.buttons.delete.id)&&this.toolbar.items.push(u.extend({},this.buttons.delete)),this.show.toolbarSave&&!t.includes(this.buttons.save.id)&&((this.show.toolbarAdd||this.show.toolbarDelete||this.show.toolbarEdit)&&this.toolbar.items.push({type:"break",id:"w2ui-break2"}),this.toolbar.items.push(u.extend({},this.buttons.save))),e=e.map(i=>this.buttons[i.name]?u.extend({},this.buttons[i.name],i):i)}this.toolbar.items.push(...e),this.toolbar.on("click",t=>{let i=this.trigger("toolbar",{target:t.target,originalEvent:t});if(i.isCancelled===!0)return;let s;switch(t.detail.item.id){case"w2ui-reload":if(s=this.trigger("reload",{target:this.name}),s.isCancelled===!0)return!1;this.reload(),s.finish();break;case"w2ui-column-on-off":if(t.detail.subItem){let l=t.detail.subItem.id;["w2ui-stateSave","w2ui-stateReset"].includes(l)?this[l.substring(5)]():l=="w2ui-skip"||this.columnOnOff(t,t.detail.subItem.id)}else this.initColumnOnOff(),setTimeout(()=>{o(`#w2overlay-${this.name}_toolbar-drop .w2ui-grid-skip`).off(".w2ui-grid").on("click.w2ui-grid",l=>{l.stopPropagation()}).on("keypress",l=>{l.keyCode==13&&(this.skip(l.target.value),this.toolbar.click("w2ui-column-on-off"))})},100);break;case"w2ui-add":if(s=this.trigger("add",{target:this.name,recid:null}),s.isCancelled===!0)return!1;s.finish();break;case"w2ui-edit":{let l=this.getSelection(),r=null;if(l.length==1&&(r=l[0]),s=this.trigger("edit",{target:this.name,recid:r}),s.isCancelled===!0)return!1;s.finish();break}case"w2ui-delete":this.delete();break;case"w2ui-save":this.save();break}i.finish()}),this.toolbar.on("refresh",t=>{if(t.target=="w2ui-search"){let i=this.searchData;setTimeout(()=>{this.searchInitInput(this.last.field,i.length==1?i[0].value:null)},1)}})}initResize(){let e=this;o(this.box).find(".w2ui-resizer").off(".grid-col-resize").on("click.grid-col-resize",function(t){t.stopPropagation(),t.preventDefault()}).on("mousedown.grid-col-resize",function(t){t||(t=window.event),e.last.colResizing=!0,e.last.tmp={x:t.screenX,y:t.screenY,gx:t.screenX,gy:t.screenY,col:parseInt(o(this).attr("name"))},e.last.tmp.tds=o(e.box).find("#grid_"+e.name+'_body table tr:first-child td[col="'+e.last.tmp.col+'"]'),t.stopPropagation(),t.preventDefault();for(let n=0;n<e.columns.length;n++)e.columns[n].hidden||(e.columns[n].sizeOriginal==null&&(e.columns[n].sizeOriginal=e.columns[n].size),e.columns[n].size=e.columns[n].sizeCalculated);let i=e.trigger("columnResize",{target:e.name,resizeBy:0,originalEvent:t,column:e.last.tmp.col,field:e.columns[e.last.tmp.col].field}),s,l=function(n){if(e.last.colResizing!=!0)return;n||(n=window.event);let a=e.trigger("columnResizeMove",u.extend(i.detail,{resizeBy:n.screenX-e.last.tmp.gx,originalEvent:n}));if(a.isCancelled===!0)return;e.last.tmp.x=n.screenX-e.last.tmp.x,e.last.tmp.y=n.screenY-e.last.tmp.y;let h=parseInt(e.columns[e.last.tmp.col].size)+e.last.tmp.x+"px";e.columns[e.last.tmp.col].size=h,s&&clearTimeout(s),s=setTimeout(()=>{e.resizeRecords(),e.scroll()},100),e.last.tmp.tds.css({width:h}),e.last.tmp.x=n.screenX,e.last.tmp.y=n.screenY,a.finish()},r=function(n){o(document).off(".grid-col-resize"),e.resizeRecords(),e.scroll(),i.finish({originalEvent:n}),setTimeout(()=>{e.last.colResizing=!1},1)};o(document).off(".grid-col-resize").on("mousemove.grid-col-resize",l).on("mouseup.grid-col-resize",r)}).on("dblclick.grid-col-resize",function(t){let i=parseInt(o(this).attr("name"));e.columnAutoSize(i),t.stopPropagation(),t.preventDefault()}).each(t=>{let i=o(t).get(0).parentNode;o(t).css({height:i.clientHeight+"px","margin-left":i.clientWidth-3+"px"})})}resizeBoxes(){let e=o(this.box).find(`#grid_${this.name}_header`),t=o(this.box).find(`#grid_${this.name}_toolbar`),i=o(this.box).find(`#grid_${this.name}_fsummary`),s=o(this.box).find(`#grid_${this.name}_summary`),l=o(this.box).find(`#grid_${this.name}_footer`),r=o(this.box).find(`#grid_${this.name}_body`);this.show.header&&e.css({top:"0px",left:"0px",right:"0px"}),this.show.toolbar&&t.css({top:0+(this.show.header?u.getSize(e,"height"):0)+"px",left:"0px",right:"0px"}),this.summary.length>0&&(i.css({bottom:0+(this.show.footer?u.getSize(l,"height"):0)+"px"}),s.css({bottom:0+(this.show.footer?u.getSize(l,"height"):0)+"px",right:"0px"})),this.show.footer&&l.css({bottom:"0px",left:"0px",right:"0px"}),r.css({top:0+(this.show.header?u.getSize(e,"height"):0)+(this.show.toolbar?u.getSize(t,"height"):0)+"px",bottom:0+(this.show.footer?u.getSize(l,"height"):0)+(this.summary.length>0?u.getSize(s,"height"):0)+"px",left:"0px",right:"0px"})}resizeRecords(){let e=this;o(this.box).find(".w2ui-empty-record").remove();let t=o(this.box),i=o(this.box).find(":scope > div.w2ui-grid-box"),s=o(this.box).find(`#grid_${this.name}_header`),l=o(this.box).find(`#grid_${this.name}_toolbar`),r=o(this.box).find(`#grid_${this.name}_summary`),n=o(this.box).find(`#grid_${this.name}_fsummary`),a=o(this.box).find(`#grid_${this.name}_footer`),h=o(this.box).find(`#grid_${this.name}_body`),d=o(this.box).find(`#grid_${this.name}_columns`),g=o(this.box).find(`#grid_${this.name}_fcolumns`),c=o(this.box).find(`#grid_${this.name}_records`),p=o(this.box).find(`#grid_${this.name}_frecords`),f=o(this.box).find(`#grid_${this.name}_scroll1`),m=String(this.total).length*8+10;m<34&&(m=34),this.lineNumberWidth!=null&&(m=this.lineNumberWidth);let w=!1,b=!1,y=0;for(let T=0;T<this.columns.length;T++){if(this.columns[T].frozen||this.columns[T].hidden)continue;let R=parseInt(this.columns[T].sizeCalculated?this.columns[T].sizeCalculated:this.columns[T].size);y+=R}if(c[0]?.clientWidth<y&&(w=!0),h[0]?.clientHeight-(d[0]?.clientHeight??0)<(o(c).find(":scope > table")[0]?.clientHeight??0)+(w?u.scrollBarSize():0)&&(b=!0),this.fixedBody){let T=i[0]?.clientHeight-(this.show.header?u.getSize(s,"height"):0)-(this.show.toolbar?u.getSize(l,"height"):0)-(r.css("display")!="none"?u.getSize(r,"height"):0)-(this.show.footer?u.getSize(a,"height"):0);h.css("height",T+"px")}else{let T=u.getSize(d,"height")+u.getSize(o(this.box).find("#grid_"+this.name+"_records table"),"height")+(w?u.scrollBarSize():0),R=T+(this.show.header?u.getSize(s,"height"):0)+(this.show.toolbar?u.getSize(l,"height"):0)+(r.css("display")!="none"?u.getSize(r,"height"):0)+(this.show.footer?u.getSize(a,"height"):0);i.css("height",R+"px"),h.css("height",T+"px"),t.css("height",u.getSize(i,"height")+"px")}let x=this.records.length,C=typeof this.url!="object"?this.url:this.url.get;if(this.searchData.length!=0&&!C&&(x=this.last.searchIds.length),this.fixedBody||(b=!1),w||b?(d.find(":scope > table > tbody > tr:nth-child(1) td.w2ui-head-last").css("width",u.scrollBarSize()+"px").show(),c.css({top:(this.columnGroups.length>0&&this.show.columns?1:0)+u.getSize(d,"height")+"px","-webkit-overflow-scrolling":"touch","overflow-x":w?"auto":"hidden","overflow-y":b?"auto":"hidden"})):(d.find(":scope > table > tbody > tr:nth-child(1) td.w2ui-head-last").hide(),c.css({top:(this.columnGroups.length>0&&this.show.columns?1:0)+u.getSize(d,"height")+"px",overflow:"hidden"}),c.length>0&&(this.last.vscroll.scrollTop=0,this.last.vscroll.scrollLeft=0)),w?(p.css("margin-bottom",u.scrollBarSize()+"px"),f.show()):(p.css("margin-bottom",0),f.hide()),p.css({overflow:"hidden",top:c.css("top")}),this.show.emptyRecords&&!b){let T=Math.floor((c[0]?.clientHeight??0)/this.recordHeight)-1,R=0;if(c[0]&&(R=c[0].scrollHeight-T*this.recordHeight),R>=this.recordHeight&&(R-=this.recordHeight,T++),this.fixedBody){for(let E=x;E<T;E++)_(E,this.recordHeight,this);_(T,R,this)}}function _(T,R,E){let z="",M="",L="";z+='<tr class="'+(T%2?"w2ui-even":"w2ui-odd")+' w2ui-empty-record" recid="-none-" style="height: '+R+'px">',M+='<tr class="'+(T%2?"w2ui-even":"w2ui-odd")+' w2ui-empty-record" recid="-none-" style="height: '+R+'px">',E.show.lineNumbers&&(z+='<td class="w2ui-col-number"></td>'),E.show.selectColumn&&(z+='<td class="w2ui-grid-data w2ui-col-select"></td>'),E.show.expandColumn&&(z+='<td class="w2ui-grid-data w2ui-col-expand"></td>'),M+='<td class="w2ui-grid-data-spacer" col="start" style="border-right: 0"></td>',E.reorderRows&&(M+='<td class="w2ui-grid-data w2ui-col-order" col="order"></td>');for(let H=0;H<E.columns.length;H++){let P=E.columns[H];(P.hidden||H<E.last.vscroll.colIndStart||H>E.last.vscroll.colIndEnd)&&!P.frozen||(L='<td class="w2ui-grid-data" '+(P.attr!=null?P.attr:"")+' col="'+H+'"></td>',P.frozen?z+=L:M+=L)}z+='<td class="w2ui-grid-data-last"></td> </tr>',M+='<td class="w2ui-grid-data-last" col="end"></td> </tr>',o(E.box).find("#grid_"+E.name+"_frecords > table").append(z),o(E.box).find("#grid_"+E.name+"_records > table").append(M)}let v,k;if(h.length>0){let T=parseInt(h[0].clientWidth)-(b?u.scrollBarSize():0)-(this.show.lineNumbers?m:0)-(this.reorderRows?26:0)-(this.show.selectColumn?26:0)-(this.show.expandColumn?26:0)-1;v=T,k=0;let R=!1;for(let E=0;E<this.columns.length;E++){let z=this.columns[E];z.gridMinWidth>0&&(z.gridMinWidth>v&&z.hidden!==!0&&(z.hidden=!0,R=!0),z.gridMinWidth<v&&z.hidden===!0&&(z.hidden=!1,R=!0))}if(R===!0){this.refresh();return}for(let E=0;E<this.columns.length;E++){let z=this.columns[E];z.hidden||(String(z.size).substr(String(z.size).length-2).toLowerCase()=="px"?(T-=parseFloat(z.size),this.columns[E].sizeCalculated=z.size,this.columns[E].sizeType="px"):(k+=parseFloat(z.size),this.columns[E].sizeType="%",delete z.sizeCorrected))}if(k!=100&&k>0)for(let E=0;E<this.columns.length;E++){let z=this.columns[E];z.hidden||z.sizeType=="%"&&(z.sizeCorrected=Math.round(parseFloat(z.size)*100*100/k)/100+"%")}for(let E=0;E<this.columns.length;E++){let z=this.columns[E];z.hidden||z.sizeType=="%"&&(this.columns[E].sizeCorrected!=null?this.columns[E].sizeCalculated=Math.floor(T*parseFloat(z.sizeCorrected)/100)-1+"px":this.columns[E].sizeCalculated=Math.floor(T*parseFloat(z.size)/100)-1+"px")}}let D=0;for(let T=0;T<this.columns.length;T++){let R=this.columns[T];R.hidden||(R.min==null&&(R.min=20),parseInt(R.sizeCalculated)<parseInt(R.min)&&(R.sizeCalculated=R.min+"px"),parseInt(R.sizeCalculated)>parseInt(R.max)&&(R.sizeCalculated=R.max+"px"),D+=parseInt(R.sizeCalculated))}let S=parseInt(v)-parseInt(D);if(S>0&&k>0){let T=0;for(;;){let R=this.columns[T];if(R==null){T=0;continue}if(R.hidden||R.sizeType=="px"){T++;continue}if(R.sizeCalculated=parseInt(R.sizeCalculated)+1+"px",S--,S===0)break;T++}}else S>0&&d.find(":scope > table > tbody > tr:nth-child(1) td.w2ui-head-last").css("width",u.scrollBarSize()+"px").show();let A=1;this.show.lineNumbers&&(A+=m),this.show.selectColumn&&(A+=26),this.show.expandColumn&&(A+=26);for(let T=0;T<this.columns.length;T++)this.columns[T].hidden||this.columns[T].frozen&&(A+=parseInt(this.columns[T].sizeCalculated));g.css("width",A+"px"),p.css("width",A+"px"),n.css("width",A+"px"),f.css("width",A+"px"),d.css("left",A+.5+"px"),c.css("left",A+"px"),r.css("left",A+"px"),d.find(":scope > table > tbody > tr:nth-child(1) td").add(g.find(":scope > table > tbody > tr:nth-child(1) td")).each(T=>{o(T).hasClass("w2ui-col-number")&&o(T).css("width",m+"px");let R=o(T).attr("col");if(R!=null){if(R=="start"){let E=0;for(let z=0;z<e.last.vscroll.colIndStart;z++)!e.columns[z]||e.columns[z].frozen||e.columns[z].hidden||(E+=parseInt(e.columns[z].sizeCalculated));o(T).css("width",E+"px")}e.columns[R]&&o(T).css("width",e.columns[R].sizeCalculated)}if(o(T).hasClass("w2ui-head-last"))if(e.last.vscroll.colIndEnd+1<e.columns.length){let E=0;for(let z=e.last.vscroll.colIndEnd+1;z<e.columns.length;z++)!e.columns[z]||e.columns[z].frozen||e.columns[z].hidden||(E+=parseInt(e.columns[z].sizeCalculated));o(T).css("width",E+"px")}else o(T).css("width",u.scrollBarSize()+(S>0&&k===0?S:0)+"px")}),d.find(":scope > table > tbody > tr").length==3&&d.find(":scope > table > tbody > tr:nth-child(1) td").add(g.find(":scope > table > tbody > tr:nth-child(1) td")).html("").css({height:"0",border:"0",padding:"0",margin:"0"}),c.find(":scope > table > tbody > tr:nth-child(1) td").add(p.find(":scope > table > tbody > tr:nth-child(1) td")).each(T=>{o(T).hasClass("w2ui-col-number")&&o(T).css("width",m+"px");let R=o(T).attr("col");if(R!=null){if(R=="start"){let E=0;for(let z=0;z<e.last.vscroll.colIndStart;z++)!e.columns[z]||e.columns[z].frozen||e.columns[z].hidden||(E+=parseInt(e.columns[z].sizeCalculated));o(T).css("width",E+"px")}e.columns[R]&&o(T).css("width",e.columns[R].sizeCalculated)}if(o(T).hasClass("w2ui-grid-data-last")&&o(T).parents(".w2ui-grid-frecords").length===0)if(e.last.vscroll.colIndEnd+1<e.columns.length){let E=0;for(let z=e.last.vscroll.colIndEnd+1;z<e.columns.length;z++)!e.columns[z]||e.columns[z].frozen||e.columns[z].hidden||(E+=parseInt(e.columns[z].sizeCalculated));o(T).css("width",E+"px")}else o(T).css("width",(S>0&&k===0?S:0)+"px")}),r.find(":scope > table > tbody > tr:nth-child(1) td").add(n.find(":scope > table > tbody > tr:nth-child(1) td")).each(T=>{o(T).hasClass("w2ui-col-number")&&o(T).css("width",m+"px");let R=o(T).attr("col");if(R!=null){if(R=="start"){let E=0;for(let z=0;z<e.last.vscroll.colIndStart;z++)!e.columns[z]||e.columns[z].frozen||e.columns[z].hidden||(E+=parseInt(e.columns[z].sizeCalculated));o(T).css("width",E+"px")}e.columns[R]&&o(T).css("width",e.columns[R].sizeCalculated)}o(T).hasClass("w2ui-grid-data-last")&&o(T).parents(".w2ui-grid-frecords").length===0&&o(T).css("width",u.scrollBarSize()+(S>0&&k===0?S:0)+"px")}),this.initResize(),this.refreshRanges(),(this.last.vscroll.scrollTop||this.last.vscroll.scrollLeft)&&c.length>0&&(d.prop("scrollLeft",this.last.vscroll.scrollLeft),c.prop("scrollTop",this.last.vscroll.scrollTop),c.prop("scrollLeft",this.last.vscroll.scrollLeft)),d.css("will-change","scroll-position")}getSearchesHTML(){let e=`
            <div class="search-title">
                ${u.lang("Advanced Search")}
                <span class="search-logic" style="${this.show.searchLogic?"":"display: none"}">
                    <select id="grid_${this.name}_logic" class="w2ui-input">
                        <option value="AND" ${this.last.logic=="AND"?"selected":""}>${u.lang("All")}</option>
                        <option value="OR" ${this.last.logic=="OR"?"selected":""}>${u.lang("Any")}</option>
                    </select>
                </span>
            </div>
            <table cellspacing="0"><tbody>
        `;for(let t=0;t<this.searches.length;t++){let i=this.searches[t];if(i.type=String(i.type).toLowerCase(),i.hidden)continue;i.attr==null&&(i.attr=""),i.text==null&&(i.text=""),i.style==null&&(i.style=""),i.type==null&&(i.type="text"),i.label==null&&i.caption!=null&&(console.log("NOTICE: grid search.caption property is deprecated, please use search.label. Search ->",i),i.label=i.caption);let s=`<select id="grid_${this.name}_operator_${t}" class="w2ui-input" data-change="initOperator|${t}">
                    ${this.getOperators(i.type,i.operators)}
                </select>`;e+=`<tr>
                        <td class="caption">${u.lang(i.label??i.field)||""}</td>
                        <td class="operator">${s}</td>
                        <td class="value">`;let l;switch(i.type){case"text":case"alphanumeric":case"hex":case"color":case"list":case"combo":case"enum":l="width: 250px;",["hex","color"].indexOf(i.type)!=-1&&(l="width: 90px;"),e+=`<input rel="search" type="text" id="grid_${this.name}_field_${t}" name="${i.field}"
                               class="w2ui-input" style="${l+i.style}" ${i.attr}>`;break;case"int":case"float":case"money":case"currency":case"percent":case"date":case"time":case"datetime":l="width: 90px;",i.type=="datetime"&&(l="width: 140px;"),e+=`<input id="grid_${this.name}_field_${t}" name="${i.field}" ${i.attr} rel="search" type="text"
                                class="w2ui-input" style="${l+i.style}">
                            <span id="grid_${this.name}_range_${t}" style="display: none">&#160;-&#160;&#160;
                                <input rel="search" type="text" class="w2ui-input" style="${l+i.style}" id="grid_${this.name}_field2_${t}" name="${i.field}" ${i.attr}>
                            </span>`;break;case"select":e+=`<select rel="search" class="w2ui-input" style="${i.style}" id="grid_${this.name}_field_${t}"
                                name="${i.field}" ${i.attr}></select>`;break}e+=i.text+"    </td></tr>"}return e+=`<tr>
            <td colspan="2" class="actions">
                <button type="button" class="w2ui-btn close-btn" data-click="searchClose">${u.lang("Close")}</button>
            </td>
            <td class="actions">
                <button type="button" class="w2ui-btn" data-click="searchReset">${u.lang("Reset")}</button>
                <button type="button" class="w2ui-btn w2ui-btn-blue" data-click="search">${u.lang("Search")}</button>
            </td>
        </tr></tbody></table>`,e}getOperators(e,t){let i=this.operators[this.operatorsMap[e]]||[];t!=null&&Array.isArray(t)&&(i=t);let s="";return i.forEach(l=>{let r=l,n=l;Array.isArray(l)?(r=l[1],n=l[0]):u.isPlainObject(l)&&(r=l.text,n=l.oper),r==null&&(r=l),s+=`<option name="11" value="${n}">${u.lang(r)}</option>
`}),s}initOperator(e){let t,i=this.searches[e],s=this.getSearchData(i.field),l=o(`#w2overlay-${this.name}-search-overlay`),r=l.find(`#grid_${this.name}_range_${e}`),n=l.find(`#grid_${this.name}_field_${e}`),a=l.find(`#grid_${this.name}_field2_${e}`),d=l.find(`#grid_${this.name}_operator_${e}`).val();switch(n.show(),r.hide(),d){case"between":r.css("display","inline");break;case"null":case"not null":n.hide(),n.val(d),n.trigger("change");break}switch(i.type){case"text":case"alphanumeric":let g=n[0]._w2field;g&&g.reset();break;case"int":case"float":case"hex":case"color":case"money":case"currency":case"percent":case"date":case"time":case"datetime":n[0]._w2field||(new ie(i.type,{el:n[0],...i.options}),new ie(i.type,{el:a[0],...i.options}),setTimeout(()=>{n.trigger("keydown"),a.trigger("keydown")},1));break;case"list":case"combo":case"enum":if(t=i.options,i.type=="list"&&(t.selected={}),i.type=="enum"&&(t.selected=[]),s&&(t.selected=s.value),!n[0]._w2field){let c=new ie(i.type,{el:n[0],...t});s&&s.text!=null&&c.set({id:s.value,text:s.text})}break;case"select":t='<option value="">--</option>';for(let c=0;c<i.options.items.length;c++){let p=i.options.items[c];if(u.isPlainObject(i.options.items[c])){let f=p.id,m=p.text;f==null&&p.value!=null&&(f=p.value),m==null&&p.text!=null&&(m=p.text),f==null&&(f=""),t+='<option value="'+f+'">'+m+"</option>"}else t+='<option value="'+p+'">'+p+"</option>"}n.html(t);break}}initSearches(){let e=o(`#w2overlay-${this.name}-search-overlay`);for(let t=0;t<this.searches.length;t++){let i=this.searches[t],s=this.getSearchData(i.field);i.type=String(i.type).toLowerCase(),typeof i.options!="object"&&(i.options={});let l=i.operator,r=[...this.operators[this.operatorsMap[i.type]]];i.operators&&(r=i.operators),u.isPlainObject(l)&&(l=l.oper),r.forEach((d,g)=>{u.isPlainObject(d)&&(r[g]=d.oper)}),s&&s.operator&&(l=s.operator);let n=this.defaultOperator[this.operatorsMap[i.type]];r.indexOf(l)==-1&&(l=n),e.find(`#grid_${this.name}_operator_${t}`).val(l),this.initOperator(t);let a=e.find(`#grid_${this.name}_field_${t}`),h=e.find(`#grid_${this.name}_field2_${t}`);s!=null&&(Array.isArray(s.value)?["in","not in"].includes(s.operator)?a[0]._w2field.set(s.value):(a.val(s.value[0]).trigger("change"),h.val(s.value[1]).trigger("change")):s.value!=null&&a.val(s.value).trigger("change"))}e.find(".w2ui-grid-search-advanced *[rel=search]").on("keypress",t=>{t.keyCode==13&&(this.search(),O.hide(this.name+"-search-overlay"))})}getColumnsHTML(){let e=this,t="",i="";if(this.show.columnHeaders)if(this.columnGroups.length>0){let r=l(!0),n=s(),a=l(!1);t=r[0]+n[0]+a[0],i=r[1]+n[1]+a[1]}else{let r=l(!0);t=r[0],i=r[1]}return[t,i];function s(){let r="<tr>",n="<tr>",a="",h=e.columnGroups.length-1;e.columnGroups[h].text==null&&e.columnGroups[h].caption!=null&&(console.log("NOTICE: grid columnGroup.caption property is deprecated, please use columnGroup.text. Group -> ",e.columnGroups[h]),e.columnGroups[h].text=e.columnGroups[h].caption),e.columnGroups[e.columnGroups.length-1].text!=""&&e.columnGroups.push({text:""}),e.show.lineNumbers&&(r+='<td class="w2ui-head w2ui-col-number" col="line-number">    <div>&#160;</div></td>'),e.show.selectColumn&&(r+='<td class="w2ui-head w2ui-col-select" col="select">    <div style="height: 25px">&#160;</div></td>'),e.show.expandColumn&&(r+='<td class="w2ui-head w2ui-col-expand" col="expand">    <div style="height: 25px">&#160;</div></td>');let d=0;n+=`<td id="grid_${e.name}_column_start" class="w2ui-head" col="start" style="border-right: 0"></td>`,e.reorderRows&&(n+='<td class="w2ui-head w2ui-col-order" col="order">    <div style="height: 25px">&#160;</div></td>');for(let g=0;g<e.columnGroups.length;g++){let c=e.columnGroups[g],p=e.columns[d]||{};c.colspan!=null&&(c.span=c.colspan),(c.span==null||c.span!=parseInt(c.span))&&(c.span=1),p.text==null&&p.caption!=null&&(console.log("NOTICE: grid column.caption property is deprecated, please use column.text. Column ->",p),p.text=p.caption);let f=0;for(let m=d;m<d+c.span;m++)e.columns[m]&&!e.columns[m].hidden&&f++;if(g==e.columnGroups.length-1&&(f=100),!(f<=0))if(c.main===!0){let m="";for(let y=0;y<e.sortData.length;y++)e.sortData[y].field==p.field&&((e.sortData[y].direction||"").toLowerCase()==="asc"&&(m="w2ui-sort-up"),(e.sortData[y].direction||"").toLowerCase()==="desc"&&(m="w2ui-sort-down"));let w="";p.resizable!==!1&&(w=`<div class="w2ui-resizer" name="${d}"></div>`);let b=u.lang(typeof p.text=="function"?p.text(p):p.text);a=`<td id="grid_${e.name}_column_${d}" class="w2ui-head ${m}" col="${d}"     rowspan="2" colspan="${f}">`+w+`    <div class="w2ui-col-group w2ui-col-header ${m?"w2ui-col-sorted":""}">        <div class="${m}"></div>`+(b||"&#160;")+"    </div></td>",p&&p.frozen?r+=a:n+=a}else{let m=u.lang(typeof c.text=="function"?c.text(c):c.text);a=`<td id="grid_${e.name}_column_${d}" class="w2ui-head" col="${d}" colspan="${f}">    <div class="w2ui-col-group" style="${c.style??""}">${m||"&#160;"}</div></td>`,p&&p.frozen?r+=a:n+=a}d+=c.span}return r+="<td></td></tr>",n+=`<td id="grid_${e.name}_column_end" class="w2ui-head" col="end"></td></tr>`,[r,n]}function l(r){let n="<tr>",a="<tr>";e.show.lineNumbers&&(n+='<td class="w2ui-head w2ui-col-number" col="line-number">    <div>#</div></td>'),e.show.selectColumn&&(n+=`<td class="w2ui-head w2ui-col-select" col="select">    <div>        <input type="checkbox" id="grid_${e.name}_check_all" class="w2ui-select-all" tabindex="-1"            style="${e.multiSelect==!1?"display: none;":""}"        >    </div></td>`),e.show.expandColumn&&(n+='<td class="w2ui-head w2ui-col-expand" col="expand">    <div>&#160;</div></td>');let h=0,d=0,g;a+=`<td id="grid_${e.name}_column_start" class="w2ui-head" col="start" style="border-right: 0"></td>`,e.reorderRows&&(a+='<td class="w2ui-head w2ui-col-order" col="order">    <div>&#160;</div></td>');for(let c=0;c<e.columns.length;c++){let p=e.columns[c];if(p.text==null&&p.caption!=null&&(console.log("NOTICE: grid column.caption property is deprecated, please use column.text. Column -> ",p),p.text=p.caption),p.size==null&&(p.size="100%"),c==d&&(g=e.columnGroups[h++]||{},d=d+g.span),!((c<e.last.vscroll.colIndStart||c>e.last.vscroll.colIndEnd)&&!p.frozen)&&!p.hidden&&(g.main!==!0||r)){let f=e.getColumnCellHTML(c);p&&p.frozen?n+=f:a+=f}}return n+='<td class="w2ui-head w2ui-head-last"><div>&#160;</div></td>',a+='<td class="w2ui-head w2ui-head-last" col="end"><div>&#160;</div></td>',n+="</tr>",a+="</tr>",[n,a]}}getColumnCellHTML(e){let t=this.columns[e];if(t==null)return"";let i=this.reorderColumns&&(!this.columnGroups||!this.columnGroups.length)?" w2ui-col-reorderable ":"",s="";for(let h=0;h<this.sortData.length;h++)this.sortData[h].field==t.field&&((this.sortData[h].direction||"").toLowerCase()==="asc"&&(s="w2ui-sort-up"),(this.sortData[h].direction||"").toLowerCase()==="desc"&&(s="w2ui-sort-down"));let l=this.last.selection.columns,r=!1;for(let h in l)for(let d=0;d<l[h].length;d++)l[h][d]==e&&(r=!0);let n=u.lang(typeof t.text=="function"?t.text(t):t.text);return'<td id="grid_'+this.name+"_column_"+e+'" col="'+e+'" class="w2ui-head '+s+i+'">'+(t.resizable!==!1?'<div class="w2ui-resizer" name="'+e+'"></div>':"")+'    <div class="w2ui-col-header '+(s?"w2ui-col-sorted":"")+" "+(r?"w2ui-col-selected":"")+'">        <div class="'+s+'"></div>'+(n||"&#160;")+"    </div></td>"}columnTooltipShow(e,t){let i=o(this.box).find("#grid_"+this.name+"_column_"+e),s=this.columns[e],l=this.columnTooltip;O.show({name:this.name+"-column-tooltip",anchor:i.get(0),html:s?.tooltip,position:l})}columnTooltipHide(e,t){O.hide(this.name+"-column-tooltip")}getRecordsHTML(){let e=this.records.length,t=typeof this.url!="object"?this.url:this.url.get;this.searchData.length!=0&&!t&&(e=this.last.searchIds.length),e>this.vs_start?this.last.vscroll.show_extra=this.vs_extra:this.last.vscroll.show_extra=this.vs_start;let i=o(this.box).find(`#grid_${this.name}_records`),s=Math.floor((i.get(0)?.clientHeight||0)/this.recordHeight)+this.last.vscroll.show_extra+1;s<this.vs_start&&(s=this.vs_start),(!this.fixedBody||s>e)&&(s=e);let l=this.getRecordHTML(-1,0),r="<table><tbody>"+l[0],n="<table><tbody>"+l[1];r+='<tr id="grid_'+this.name+'_frec_top" line="top" style="height: 0px">    <td colspan="2000"></td></tr>',n+='<tr id="grid_'+this.name+'_rec_top" line="top" style="height: 0px">    <td colspan="2000"></td></tr>';for(let h=0;h<s;h++)l=this.getRecordHTML(h,h+1),r+=l[0],n+=l[1];let a=(e-s)*this.recordHeight;return r+='<tr id="grid_'+this.name+'_frec_bottom" rec="bottom" line="bottom" style="height: '+a+'px; vertical-align: top">    <td colspan="2000" style="border: 0"></td></tr><tr id="grid_'+this.name+'_frec_more" style="display: none; ">    <td colspan="2000" class="w2ui-load-more"></td></tr></tbody></table>',n+='<tr id="grid_'+this.name+'_rec_bottom" rec="bottom" line="bottom" style="height: '+a+'px; vertical-align: top">    <td colspan="2000" style="border: 0"></td></tr><tr id="grid_'+this.name+'_rec_more" style="display: none">    <td colspan="2000" class="w2ui-load-more"></td></tr></tbody></table>',this.last.vscroll.recIndStart=0,this.last.vscroll.recIndEnd=s,[r,n]}getSummaryHTML(){if(this.summary.length===0)return;let e=this.getRecordHTML(-1,0),t="<table><tbody>"+e[0],i="<table><tbody>"+e[1];for(let s=0;s<this.summary.length;s++)e=this.getRecordHTML(s,s+1,!0),t+=e[0],i+=e[1];return t+="</tbody></table>",i+="</tbody></table>",[t,i]}scroll(e){let t=this,i=typeof this.url!="object"?this.url:this.url.get,s=o(this.box).find(`#grid_${this.name}_records`),l=o(this.box).find(`#grid_${this.name}_frecords`);if(e){let E=e.target.scrollTop,z=e.target.scrollLeft;this.last.vscroll.scrollTop=E,this.last.vscroll.scrollLeft=z;let M=o(this.box).find(`#grid_${this.name}_columns`)[0],L=o(this.box).find(`#grid_${this.name}_summary`)[0];M&&(M.scrollLeft=z),L&&(L.scrollLeft=z),l[0]&&(l[0].scrollTop=E)}this.last.bubbleEl&&(O.hide(this.name+"-bubble"),this.last.bubbleEl=null);let r=null,n=null;if(this.disableCVS||this.columnGroups.length>0)r=0,n=this.columns.length-1;else{let E=s.prop("clientWidth"),z=0;for(let M=0;M<this.columns.length;M++){if(this.columns[M].frozen||this.columns[M].hidden)continue;let L=parseInt(this.columns[M].sizeCalculated?this.columns[M].sizeCalculated:this.columns[M].size);z+L+30>this.last.vscroll.scrollLeft&&r==null&&(r=M),z+L-30>this.last.vscroll.scrollLeft+E&&n==null&&(n=M),z+=L}n==null&&(n=this.columns.length-1)}if(r!=null&&(r<0&&(r=0),n<0&&(n=0),r==n&&(r>0?r--:n++),r!=this.last.vscroll.colIndStart||n!=this.last.vscroll.colIndEnd)){let E=o(this.box),z=Math.abs(r-this.last.vscroll.colIndStart),M=Math.abs(n-this.last.vscroll.colIndEnd);if(z<5&&M<5){let L=E.find(`.w2ui-grid-columns #grid_${this.name}_column_start`),H=E.find(".w2ui-grid-columns .w2ui-head-last"),P=E.find(`#grid_${this.name}_records .w2ui-grid-data-spacer`),ge=E.find(`#grid_${this.name}_records .w2ui-grid-data-last`),oe=E.find(`#grid_${this.name}_summary .w2ui-grid-data-spacer`),me=E.find(`#grid_${this.name}_summary .w2ui-grid-data-last`);if(r>this.last.vscroll.colIndStart)for(let F=this.last.vscroll.colIndStart;F<r;F++)E.find("#grid_"+this.name+"_columns #grid_"+this.name+"_column_"+F).remove(),E.find("#grid_"+this.name+'_records td[col="'+F+'"]').remove(),E.find("#grid_"+this.name+'_summary td[col="'+F+'"]').remove();if(n<this.last.vscroll.colIndEnd)for(let F=this.last.vscroll.colIndEnd;F>n;F--)E.find("#grid_"+this.name+"_columns #grid_"+this.name+"_column_"+F).remove(),E.find("#grid_"+this.name+'_records td[col="'+F+'"]').remove(),E.find("#grid_"+this.name+'_summary td[col="'+F+'"]').remove();if(r<this.last.vscroll.colIndStart)for(let F=this.last.vscroll.colIndStart-1;F>=r;F--)this.columns[F]&&(this.columns[F].frozen||this.columns[F].hidden)||(L.after(this.getColumnCellHTML(F)),P.each(q=>{let G=o(q).parent().attr("index"),J='<td class="w2ui-grid-data" col="'+F+'" style="height: 0px"></td>';G!=null&&(J=this.getCellHTML(parseInt(G),F,!1)),o(q).after(J)}),oe.each(q=>{let G=o(q).parent().attr("index"),J='<td class="w2ui-grid-data" col="'+F+'" style="height: 0px"></td>';G!=null&&(J=this.getCellHTML(parseInt(G),F,!0)),o(q).after(J)}));if(n>this.last.vscroll.colIndEnd)for(let F=this.last.vscroll.colIndEnd+1;F<=n;F++)this.columns[F]&&(this.columns[F].frozen||this.columns[F].hidden)||(H.before(this.getColumnCellHTML(F)),ge.each(q=>{let G=o(q).parent().attr("index"),J='<td class="w2ui-grid-data" col="'+F+'" style="height: 0px"></td>';G!=null&&(J=this.getCellHTML(parseInt(G),F,!1)),o(q).before(J)}),me.each(q=>{let G=o(q).parent().attr("index")||-1,J=this.getCellHTML(parseInt(G),F,!0);o(q).before(J)}));this.last.vscroll.colIndStart=r,this.last.vscroll.colIndEnd=n,this.resizeRecords()}else{this.last.vscroll.colIndStart=r,this.last.vscroll.colIndEnd=n;let L=this.getColumnsHTML(),H=this.getRecordsHTML(),P=this.getSummaryHTML(),ge=E.find(`#grid_${this.name}_columns`),oe=E.find(`#grid_${this.name}_records`),me=E.find(`#grid_${this.name}_frecords`),F=E.find(`#grid_${this.name}_summary`);ge.find("tbody").html(L[1]),me.html(H[0]),oe.prepend(H[1]),P!=null&&F.html(P[1]),setTimeout(()=>{oe.find(":scope > table").filter(":not(table:first-child)").remove(),F[0]&&(F[0].scrollLeft=this.last.vscroll.scrollLeft)},1),this.resizeRecords()}}let a=this.records.length;if(a>this.total&&this.total!==-1&&(a=this.total),this.searchData.length!=0&&!i&&(a=this.last.searchIds.length),a===0||s.length===0||s.prop("clientHeight")===0)return;a>this.vs_start?this.last.vscroll.show_extra=this.vs_extra:this.last.vscroll.show_extra=this.vs_start;let h=Math.round(s.prop("scrollTop")/this.recordHeight+1),d=h+(Math.round(s.prop("clientHeight")/this.recordHeight)-1);if(h>a&&(h=a),d>=a-1&&(d=a),o(this.box).find("#grid_"+this.name+"_footer .w2ui-footer-right").html((this.show.statusRange?u.formatNumber(this.offset+h)+"-"+u.formatNumber(this.offset+d)+(this.total!=-1?" "+u.lang("of")+' <span class="w2ui-total">'+u.formatNumber(this.total)+"</span>":""):"")+(i&&this.show.statusBuffered?" ("+u.lang("buffered")+' <span class="w2ui-buffered">'+u.formatNumber(a)+"</span>"+(this.offset>0?', skip <span class="w2ui-skip">'+u.formatNumber(this.offset):"")+"</span>)":"")),!i&&(!this.fixedBody||this.total!=-1&&this.total<=this.vs_start))return;let g=Math.floor(s.prop("scrollTop")/this.recordHeight)-this.last.vscroll.show_extra,c=g+Math.floor(s.prop("clientHeight")/this.recordHeight)+this.last.vscroll.show_extra*2+1;g<1&&(g=1),c>this.total&&this.total!=-1&&(c=this.total);let p=s.find("#grid_"+this.name+"_rec_top"),f=s.find("#grid_"+this.name+"_rec_bottom"),m=l.find("#grid_"+this.name+"_frec_top"),w=l.find("#grid_"+this.name+"_frec_bottom");String(p.next().prop("id")).indexOf("_expanded_row")!=-1&&(p.next().remove(),m.next().remove()),this.total>c&&String(f.prev().prop("id")).indexOf("_expanded_row")!=-1&&(f.prev().remove(),w.prev().remove());let b=parseInt(p.next().attr("line")),y=parseInt(f.prev().attr("line")),x,C,_,v,k;if(b<=g||b==1||this.last.vscroll.pull_refresh){if(c<=y+this.last.vscroll.show_extra-2&&c!=this.total)return;for(this.last.vscroll.pull_refresh=!1;C=l.find("#grid_"+this.name+"_frec_top").next(),_=s.find("#grid_"+this.name+"_rec_top").next(),_.attr("line")!="bottom";)if(parseInt(_.attr("line"))<g)C.remove(),_.remove();else break;x=s.find("#grid_"+this.name+"_rec_bottom").prev(),v=x.attr("line"),v=="top"&&(v=g);for(let E=parseInt(v)+1;E<=c;E++)this.records[E-1]&&(_=this.records[E-1].w2ui,_&&!Array.isArray(_.children)&&(_.expanded=!1),k=this.getRecordHTML(E-1,E),f.before(k[1]),w.before(k[0]));R(),setTimeout(()=>{this.refreshRanges()},0)}else{if(g>=b-this.last.vscroll.show_extra+2&&g>1)return;for(;C=l.find("#grid_"+this.name+"_frec_bottom").prev(),_=s.find("#grid_"+this.name+"_rec_bottom").prev(),_.attr("line")!="top";)if(parseInt(_.attr("line"))>c)C.remove(),_.remove();else break;x=s.find("#grid_"+this.name+"_rec_top").next(),v=x.attr("line"),v=="bottom"&&(v=c);for(let E=parseInt(v)-1;E>=g;E--)this.records[E-1]&&(_=this.records[E-1].w2ui,_&&!Array.isArray(_.children)&&(_.expanded=!1),k=this.getRecordHTML(E-1,E),p.after(k[1]),m.after(k[0]));R(),setTimeout(()=>{this.refreshRanges()},0)}let D=(g-1)*this.recordHeight,S=(a-c)*this.recordHeight;S<0&&(S=0),p.css("height",D+"px"),m.css("height",D+"px"),f.css("height",S+"px"),w.css("height",S+"px"),this.last.vscroll.recIndStart=g,this.last.vscroll.recIndEnd=c,Math.floor(s.prop("scrollTop")/this.recordHeight)+Math.floor(s.prop("clientHeight")/this.recordHeight)+10>a&&this.last.vscroll.pull_more!==!0&&(a<this.total-this.offset||this.total==-1&&this.last.fetch.hasMore)&&(this.autoLoad===!0&&(this.last.vscroll.pull_more=!0,this.last.fetch.offset+=this.limit,this.request("load")),o(this.box).find("#grid_"+this.name+"_rec_more, #grid_"+this.name+"_frec_more").show().eq(1).off(".load-more").on("click.load-more",function(){o(this).find("td").html('<div><div style="width: 20px; height: 20px;" class="w2ui-spinner"></div></div>'),t.last.vscroll.pull_more=!0,t.last.fetch.offset+=t.limit,t.request("load")}).find("td").html(t.autoLoad?'<div><div style="width: 20px; height: 20px;" class="w2ui-spinner"></div></div>':'<div style="padding-top: 15px">'+u.lang("Load ${count} more...",{count:t.limit})+"</div>"));function R(){t.markSearch&&(clearTimeout(t.last.marker_timer),t.last.marker_timer=setTimeout(()=>{let E=[];for(let z=0;z<t.searchData.length;z++){let M=t.searchData[z],L=t.getSearch(M.field);if(!L||L.hidden)continue;let H=t.getColumn(M.field,!0);E.push({field:M.field,search:M.value,col:H})}E.length>0&&E.forEach(z=>{let M=o(t.box).find('td[col="'+z.col+'"]:not(.w2ui-head)');u.marker(M,z.search)})},50))}}getRecordHTML(e,t,i){let s="",l="",r="",n=this.last.selection,a;if(e==-1){l+='<tr line="0">',r+='<tr line="0">',this.show.lineNumbers&&(l+='<td class="w2ui-col-number" style="height: 0px"></td>'),this.show.selectColumn&&(l+='<td class="w2ui-col-select" style="height: 0px"></td>'),this.show.expandColumn&&(l+='<td class="w2ui-col-expand" style="height: 0px"></td>'),r+='<td class="w2ui-grid-data w2ui-grid-data-spacer" col="start" style="height: 0px; width: 0px"></td>',this.reorderRows&&(r+='<td class="w2ui-col-order" style="height: 0px"></td>');for(let m=0;m<this.columns.length;m++){let w=this.columns[m];if(s='<td class="w2ui-grid-data" col="'+m+'" style="height: 0px;"></td>',w.frozen&&!w.hidden)l+=s;else{if(w.hidden||m<this.last.vscroll.colIndStart||m>this.last.vscroll.colIndEnd)continue;r+=s}}return l+='<td class="w2ui-grid-data-last" style="height: 0px"></td>',r+='<td class="w2ui-grid-data-last" col="end" style="height: 0px"></td>',l+="</tr>",r+="</tr>",[l,r]}let h=typeof this.url!="object"?this.url:this.url.get;if(i!==!0)if(this.searchData.length>0&&!h){if(e>=this.last.searchIds.length)return"";e=this.last.searchIds[e],a=this.records[e]}else{if(e>=this.records.length)return"";a=this.records[e]}else{if(e>=this.summary.length)return"";a=this.summary[e]}if(!a)return"";if(a.recid==null&&this.recid!=null){let m=this.parseField(a,this.recid);m!=null&&(a.recid=m)}let d=!1;n.indexes.indexOf(e)!=-1&&(d=!0);let g=a.w2ui?a.w2ui.style:"";(g==null||typeof g!="string")&&(g="");let c=a.w2ui?a.w2ui.class:"";if((c==null||typeof c!="string")&&(c=""),l+='<tr id="grid_'+this.name+"_frec_"+a.recid+'" recid="'+a.recid+'" line="'+t+'" index="'+e+'"  class="'+(t%2===0?"w2ui-even":"w2ui-odd")+" w2ui-record "+c+(d&&this.selectType=="row"?" w2ui-selected":"")+(a.w2ui&&a.w2ui.editable===!1?" w2ui-no-edit":"")+(a.w2ui&&a.w2ui.expanded===!0?" w2ui-expanded":"")+'"  style="height: '+this.recordHeight+"px; "+(!d&&g!=""?g:g.replace("background-color","none"))+'" '+(g!=""?'custom_style="'+g+'"':"")+">",r+='<tr id="grid_'+this.name+"_rec_"+a.recid+'" recid="'+a.recid+'" line="'+t+'" index="'+e+'"  class="'+(t%2===0?"w2ui-even":"w2ui-odd")+" w2ui-record "+c+(d&&this.selectType=="row"?" w2ui-selected":"")+(a.w2ui&&a.w2ui.editable===!1?" w2ui-no-edit":"")+(a.w2ui&&a.w2ui.expanded===!0?" w2ui-expanded":"")+'"  style="height: '+this.recordHeight+"px; "+(!d&&g!=""?g:g.replace("background-color","none"))+'" '+(g!=""?'custom_style="'+g+'"':"")+">",this.show.lineNumbers&&(l+='<td id="grid_'+this.name+"_cell_"+e+"_number"+(i?"_s":"")+'"    class="w2ui-col-number '+(d?" w2ui-row-selected":"")+'"'+(this.reorderRows?' style="cursor: move"':"")+">"+(i!==!0?this.getLineHTML(t,a):"")+"</td>"),this.show.selectColumn&&(l+='<td id="grid_'+this.name+"_cell_"+e+"_select"+(i?"_s":"")+'" class="w2ui-grid-data w2ui-col-select">'+(i!==!0&&!(a.w2ui&&a.w2ui.hideCheckBox===!0)?'    <div>        <input class="w2ui-grid-select-check" type="checkbox" tabindex="-1" '+(d?'checked="checked"':"")+' style="pointer-events: none"/>    </div>':"")+"</td>"),this.show.expandColumn){let m="";a.w2ui?.expanded===!0?m="-":m="+",(a.w2ui?.expanded=="none"||!Array.isArray(a.w2ui?.children)||!a.w2ui?.children.length)&&(m="+"),a.w2ui?.expanded=="spinner"&&(m='<div class="w2ui-spinner" style="width: 16px; margin: -2px 2px;"></div>'),l+='<td id="grid_'+this.name+"_cell_"+e+"_expand"+(i?"_s":"")+'" class="w2ui-grid-data w2ui-col-expand">'+(i!==!0?`<div>${m}</div>`:"")+"</td>"}r+='<td class="w2ui-grid-data-spacer" col="start" style="border-right: 0"></td>',this.reorderRows&&(r+='<td id="grid_'+this.name+"_cell_"+e+"_order"+(i?"_s":"")+'" class="w2ui-grid-data w2ui-col-order" col="order">'+(i!==!0?'<div title="Drag to reorder">&nbsp;</div>':"")+"</td>");let p=0,f=0;for(;;){let m=1,w=this.columns[p];if(w==null)break;if(w.hidden){p++,f>0&&f--;continue}if(f>0){if(p++,this.columns[p]==null)break;a.w2ui.colspan[this.columns[p-1].field]=0,f--;continue}else if(a.w2ui){let y=a.w2ui.colspan,x=this.columns[p].field;y&&y[x]===0&&delete y[x]}if((p<this.last.vscroll.colIndStart||p>this.last.vscroll.colIndEnd)&&!w.frozen){p++;continue}if(a.w2ui&&typeof a.w2ui.colspan=="object"){let y=parseInt(a.w2ui.colspan[w.field])||null;if(y>1){let x=0;for(let C=p;C<p+y&&!(C>=this.columns.length);C++)this.columns[C].hidden&&x++;m=y-x,f=y-1}}let b=this.getCellHTML(e,p,i,m);w.frozen?l+=b:r+=b,p++}return l+='<td class="w2ui-grid-data-last"></td>',r+='<td class="w2ui-grid-data-last" col="end"></td>',l+="</tr>",r+="</tr>",[l,r]}getLineHTML(e){return"<div>"+e+"</div>"}getCellHTML(e,t,i,s){let l=this,r=this.columns[t];if(r==null)return"";let n=i!==!0?this.records[e]:this.summary[e],{value:a,style:h,className:d,attr:g,divAttr:c}=this.getCellValue(e,t,i,!0),p=e!==-1?this.getCellEditable(e,t):"",f="max-height: "+parseInt(this.recordHeight)+"px;"+(r.clipboardCopy?"margin-right: 20px":""),m=!i&&n?.w2ui?.changes&&n.w2ui.changes[r.field]!=null,w=this.last.selection,b=!1,y="";if(w.indexes.indexOf(e)!=-1&&(b=!0),s==null&&(n?.w2ui?.colspan&&n.w2ui.colspan[r.field]?s=n.w2ui.colspan[r.field]:s=1),t===0&&Array.isArray(n?.w2ui?.children)){let k=0,D=this.get(n.w2ui.parent_recid,!0);for(;D!=null;){k++;let A=this.records[D].w2ui;if(A!=null&&A.parent_recid!=null)D=this.get(A.parent_recid,!0);else break}if(n.w2ui.parent_recid)for(let A=0;A<k;A++)y+='<span class="w2ui-show-children w2ui-icon-empty"></span>';let S=n.w2ui.children.length>0?n.w2ui.expanded?"w2ui-icon-collapse":"w2ui-icon-expand":"w2ui-icon-empty";y+=`<span class="w2ui-show-children ${S}"></span>`}if(r.info===!0&&(r.info={}),r.info!=null){let k="w2ui-icon-info";typeof r.info.icon=="function"?k=r.info.icon(n,{self:this,index:e,colIndex:t,summary:!!i}):typeof r.info.icon=="object"?k=r.info.icon[this.parseField(n,r.field)]||"":typeof r.info.icon=="string"&&(k=r.info.icon);let D=r.info.style||"";typeof r.info.style=="function"?D=r.info.style(n,{self:this,index:e,colIndex:t,summary:!!i}):typeof r.info.style=="object"?D=r.info.style[this.parseField(n,r.field)]||"":typeof r.info.style=="string"&&(D=r.info.style),y+=`<span class="w2ui-info ${k}" style="${D}"></span>`}let x=a;if(p&&["checkbox","check"].indexOf(p.type)!=-1){let k=i?-(e+1):e;f+="text-align: center;",x=`<input tabindex="-1" type="checkbox" class="w2ui-editable-checkbox"
                            data-changeInd="${k}" data-colInd="${t}" ${x?'checked="checked"':""}>`,y=""}if(x=`<div style="${f}" ${v(x)} ${c}>${y}${String(x)}</div>`,x==null&&(x=""),typeof r.render=="string"){let k=r.render.toLowerCase().split(":");["number","int","float","money","currency","percent","size"].indexOf(k[0])!=-1&&(h+="text-align: right;")}n?.w2ui&&(typeof n.w2ui.style=="object"&&(typeof n.w2ui.style[t]=="string"&&(h+=n.w2ui.style[t]+";"),typeof n.w2ui.style[r.field]=="string"&&(h+=n.w2ui.style[r.field]+";")),typeof n.w2ui.class=="object"&&(typeof n.w2ui.class[t]=="string"&&(d+=n.w2ui.class[t]+" "),typeof n.w2ui.class[r.field]=="string"&&(d+=n.w2ui.class[r.field]+" ")));let C=!1;b&&w.columns[e]?.includes(t)&&(C=!0);let _;return r.clipboardCopy&&(_='<span class="w2ui-clipboard-copy w2ui-icon-paste"></span>'),x='<td class="w2ui-grid-data'+(C?" w2ui-selected":"")+" "+d+(m?" w2ui-changed":"")+'"    id="grid_'+this.name+"_data_"+e+"_"+t+'" col="'+t+'"    style="'+h+(r.style!=null?r.style:"")+'" '+(r.attr!=null?r.attr:"")+g+(s>1?'colspan="'+s+'"':"")+">"+x+(_&&u.stripTags(x)?_:"")+"</td>",e===-1&&i===!0&&(x='<td class="w2ui-grid-data" col="'+t+'" style="height: 0px; '+h+'" '+(s>1?'colspan="'+s+'"':"")+"></td>"),x;function v(k){let D;return l.show.recordTitles&&(r.title!=null?(typeof r.title=="function"&&(D=r.title.call(l,n,{self:this,index:e,colIndex:t,summary:!!i})),typeof r.title=="string"&&(D=r.title)):D=u.stripTags(String(k).replace(/"/g,"''"))),D!=null?'title="'+String(D)+'"':""}}clipboardCopy(e,t,i){let s=i?this.summary[e]:this.records[e],l=this.columns[t],r=l?this.parseField(s,l.field):"";typeof l.clipboardCopy=="function"&&(r=l.clipboardCopy(s,{self:this,index:e,colIndex:t,summary:!!i})),o(this.box).find("#grid_"+this.name+"_focus").text(r).get(0).select(),document.execCommand("copy")}showBubble(e,t,i){let s=this.columns[t].info;if(!s)return;let l="",r=this.records[e],n=o(this.box).find(`${i?".w2ui-grid-summary":""} #grid_${this.name}_data_${e}_${t} .w2ui-info`);if(this.last.bubbleEl&&O.hide(this.name+"-bubble"),this.last.bubbleEl=n,s.fields==null){s.fields=[];for(let h=0;h<this.columns.length;h++){let d=this.columns[h];s.fields.push(d.field+(typeof d.render=="string"?":"+d.render:""))}}let a=s.fields;if(typeof a=="function"&&(a=a(r,{self:this,index:e,colIndex:t,summary:!!i})),typeof s.render=="function")l=s.render(r,{self:this,index:e,colIndex:t,summary:!!i});else if(Array.isArray(a)){l='<table cellpadding="0" cellspacing="0">';for(let h=0;h<a.length;h++){let d=String(a[h]).split(":");if(d[0]==""||d[0]=="-"||d[0]=="--"||d[0]=="---"){l+='<tr><td colspan=2><div style="border-top: '+(d[0]==""?"0":"1")+'px solid #C1BEBE; margin: 6px 0px;"></div></td></tr>';continue}let g=this.getColumn(d[0]);g==null&&(g={field:d[0],caption:d[0]});let c=g?this.parseField(r,g.field):"";d.length>1&&(u.formatters[d[1]]?c=u.formatters[d[1]](c,d[2]||null,r):console.log('ERROR: w2utils.formatters["'+d[1]+'"] does not exists.')),!(s.showEmpty!==!0&&(c==null||c==""))&&(s.maxLength!=null&&typeof c=="string"&&c.length>s.maxLength&&(c=c.substr(0,s.maxLength)+"..."),l+="<tr><td>"+g.text+"</td><td>"+((c===0?"0":c)||"")+"</td></tr>")}l+="</table>"}else if(u.isPlainObject(a)){l='<table cellpadding="0" cellspacing="0">';for(let h in a){let d=a[h];if(d==""||d=="-"||d=="--"||d=="---"){l+='<tr><td colspan=2><div style="border-top: '+(d==""?"0":"1")+'px solid #C1BEBE; margin: 6px 0px;"></div></td></tr>';continue}let g=String(d).split(":"),c=this.getColumn(g[0]);c==null&&(c={field:g[0],caption:g[0]});let p=c?this.parseField(r,c.field):"";g.length>1&&(u.formatters[g[1]]?p=u.formatters[g[1]](p,g[2]||null,r):console.log('ERROR: w2utils.formatters["'+g[1]+'"] does not exists.')),typeof d=="function"&&(p=d(r,{self:this,index:e,colIndex:t,summary:!!i})),!(s.showEmpty!==!0&&(p==null||p==""))&&(s.maxLength!=null&&typeof p=="string"&&p.length>s.maxLength&&(p=p.substr(0,s.maxLength)+"..."),l+="<tr><td>"+h+"</td><td>"+((p===0?"0":p)||"")+"</td></tr>")}l+="</table>"}return O.show(u.extend({name:this.name+"-bubble",html:l,anchor:n.get(0),position:"top|bottom",class:"w2ui-info-bubble",style:"",hideOn:["doc-click"]},s.options??{})).hide(()=>[this.last.bubbleEl=null])}getCellEditable(e,t){let i=this.columns[t],s=this.records[e];if(!s||!i)return null;let l=s.w2ui?s.w2ui.editable:null;if(l===!1)return null;if((l==null||l===!0)&&(l=Object.keys(i.editable??{}).length>0?i.editable:null,typeof l=="function")){let r=this.getCellValue(e,t,!1);l=l.call(this,s,{self:this,value:r,index:e,colIndex:t})}return l}getCellValue(e,t,i,s){let l=this.columns[t],r=i!==!0?this.records[e]:this.summary[e],n=this.parseField(r,l.field),a="",h="",d="",g="";if(r?.w2ui?.changes?.[l.field]!=null&&(n=r.w2ui.changes[l.field]),l.render!=null&&e!==-1){if(typeof l.render=="function"&&r!=null){let c;try{c=l.render.call(this,r,{self:this,value:n,index:e,colIndex:t,summary:!!i})}catch(p){throw new Error(`Render function for column "${l.field}" in grid "${this.name}": -- `+p.message)}c!=null&&typeof c=="object"&&typeof c!="function"?(c.id!=null&&c.text!=null?n=c.text:typeof c.html=="string"?n=(c.html||"").trim():(n="",console.log("ERROR: render function should return a primitive or an object of the following structure.",{html:"",attr:"",style:"",class:"",divAttr:""})),d=c.attr??"",h=c.style??"",a=c.class??"",g=c.divAttr??""):n=String(c||"").trim()}if(typeof l.render=="object"){let c=l.render[n];c!=null&&c!==""&&(n=c)}if(typeof l.render=="string"){let c=l.render.toLowerCase().indexOf(":"),p=[];c==-1?(p[0]=l.render.toLowerCase(),p[1]=""):(p[0]=l.render.toLowerCase().substr(0,c),p[1]=l.render.toLowerCase().substr(c+1));let f=u.formatters[p[0]];l.options&&l.options.autoFormat===!1&&(f=null),n=typeof f=="function"?f(n,p[1],r):""}}return n==null&&(n=""),s?{value:n,attr:d,style:h,className:a,divAttr:g}:n}getFooterHTML(){return'<div>    <div class="w2ui-footer-left"></div>    <div class="w2ui-footer-right"></div>    <div class="w2ui-footer-center"></div></div>'}status(e){if(e!=null)o(this.box).find(`#grid_${this.name}_footer`).find(".w2ui-footer-left").html(e);else{let t="",i=this.getSelection();if(i.length>0&&(this.show.statusSelection&&i.length>1&&(t=String(i.length).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1"+u.settings.groupSymbol)+" "+u.lang("selected")),this.show.statusRecordID&&i.length==1)){let s=i[0];typeof s=="object"&&(s=s.recid+", "+u.lang("Column")+": "+s.column),t=u.lang("Record ID")+": "+s+" "}o(this.box).find("#grid_"+this.name+"_footer .w2ui-footer-left").html(t)}}lock(e,t){let i=Array.from(arguments);i.unshift(this.box),setTimeout(()=>{o(this.box).find("#grid_"+this.name+"_empty_msg").remove(),u.lock(...i)},10)}unlock(e){setTimeout(()=>{o(this.box).find(".w2ui-message").hasClass("w2ui-closing")||u.unlock(this.box,e)},25)}stateSave(e){let t={columns:[],show:u.clone(this.show),last:{search:this.last.search,multi:this.last.multi,logic:this.last.logic,label:this.last.label,field:this.last.field,scrollTop:this.last.vscroll.scrollTop,scrollLeft:this.last.vscroll.scrollLeft},sortData:[],searchData:[]},i;for(let l=0;l<this.columns.length;l++){let r=this.columns[l],n={};Object.keys(this.stateColProps).forEach((a,h)=>{this.stateColProps[a]&&(r[a]!==void 0?i=r[a]:i=this.colTemplate[a]||null,n[a]=i)}),t.columns.push(n)}for(let l=0;l<this.sortData.length;l++)t.sortData.push(u.clone(this.sortData[l]));for(let l=0;l<this.searchData.length;l++)t.searchData.push(u.clone(this.searchData[l]));let s=this.trigger("stateSave",{target:this.name,state:t});if(s.isCancelled!==!0)return e!==!0&&this.cacheSave("state",t),s.finish(),t}stateRestore(e){let t=typeof this.url!="object"?this.url:this.url.get;e||(e=this.cache("state"));let i=this.trigger("stateRestore",{target:this.name,state:e});if(i.isCancelled!==!0){if(u.isPlainObject(e)){u.extend(this.show,e.show??{}),u.extend(this.last,e.last??{});let s=this.last.vscroll.scrollTop,l=this.last.vscroll.scrollLeft;for(let r=0;r<e.columns?.length;r++){let n=e.columns[r],a=this.getColumn(n.field,!0);a!==null&&(u.extend(this.columns[a],n),r!==a&&this.columns.splice(r,0,this.columns.splice(a,1)[0]))}this.sortData.splice(0,this.sortData.length);for(let r=0;r<e.sortData?.length;r++)this.sortData.push(e.sortData[r]);this.searchData.splice(0,this.searchData.length);for(let r=0;r<e.searchData?.length;r++)this.searchData.push(e.searchData[r]);setTimeout(()=>{t||(this.sortData.length>0&&this.localSort(),this.searchData.length>0&&this.localSearch()),this.last.vscroll.scrollTop=s,this.last.vscroll.scrollLeft=l,this.refresh()},1),console.log(`INFO (w2ui): state restored for "${this.name}"`)}return i.finish(),!0}}stateReset(){this.stateRestore(this.last.state),this.cacheSave("state",null)}parseField(e,t){if(this.nestedFields){let i="";try{i=e;let s=String(t).split(".");for(let l=0;l<s.length;l++)i=i[s[l]]}catch{i=""}return i}else return e?e[t]:""}prepareData(){let e=this;for(let i=0;i<this.records.length;i++){let s=this.records[i];t(s)}function t(i){for(let s=0;s<e.columns.length;s++){let l=e.columns[s];if(!(i[l.field]==null||typeof l.render!="string")){if(["number","int","float","money","currency","percent"].indexOf(l.render.split(":")[0])!=-1&&typeof i[l.field]!="number"&&(i[l.field]=parseFloat(i[l.field])),["date","age"].indexOf(l.render.split(":")[0])!=-1&&!i[l.field+"_"]){let r=i[l.field];u.isInt(r)&&(r=parseInt(r)),i[l.field+"_"]=new Date(r)}if(["time"].indexOf(l.render)!=-1)if(u.isTime(i[l.field])){let r=u.isTime(i[l.field],!0),n=new Date;n.setHours(r.hours,r.minutes,r.seconds?r.seconds:0,0),i[l.field+"_"]||(i[l.field+"_"]=n)}else{let r=i[l.field];u.isInt(r)&&(r=parseInt(r)),r=r!=null?new Date(r):new Date;let n=new Date;n.setHours(r.getHours(),r.getMinutes(),r.getSeconds(),0),i[l.field+"_"]||(i[l.field+"_"]=n)}}}if(i.w2ui?.children&&i.w2ui?.expanded!==!0)for(let s=0;s<i.w2ui.children.length;s++){let l=i.w2ui.children[s];t(l)}}}nextCell(e,t,i){let s=t+1;if(s>=this.columns.length)return e=this.nextRow(e),e==null?e:this.nextCell(e,-1,i);let l=this.records[e].w2ui,r=this.columns[s],n=l&&l.colspan&&!isNaN(l.colspan[r.field])?parseInt(l.colspan[r.field]):1;if(r==null)return null;if(r&&r.hidden||n===0)return this.nextCell(e,s,i);if(i){let a=this.getCellEditable(e,s);if(a==null||["checkbox","check"].indexOf(a.type)!=-1)return this.nextCell(e,s,i)}return{index:e,colIndex:s}}prevCell(e,t,i){let s=t-1;if(s<0)return e=this.prevRow(e),e==null?e:this.prevCell(e,this.columns.length,i);if(s<0)return null;let l=this.records[e].w2ui,r=this.columns[s],n=l&&l.colspan&&!isNaN(l.colspan[r.field])?parseInt(l.colspan[r.field]):1;if(r==null)return null;if(r&&r.hidden||n===0)return this.prevCell(e,s,i);if(i){let a=this.getCellEditable(e,s);if(a==null||["checkbox","check"].indexOf(a.type)!=-1)return this.prevCell(e,s,i)}return{index:e,colIndex:s}}nextRow(e,t,i){let s=this.last.searchIds,l=null;if(i==null&&(i=1),i==-1)return this.records.length-1;if(e+i<this.records.length&&s.length===0||s.length>0&&e<s[s.length-i]){if(e+=i,s.length>0)for(;!(s.includes(e)||e>this.records.length);)e+=i;let r=this.records[e].w2ui,n=this.columns[t];(r&&r.colspan&&n!=null&&!isNaN(r.colspan[n.field])?parseInt(r.colspan[n.field]):1)===0?l=this.nextRow(e,t,i):l=e}return l}prevRow(e,t,i){let s=this.last.searchIds,l=null;if(i==null&&(i=1),i==-1)return 0;if(e-i>=0&&s.length===0||s.length>0&&e>s[0]){if(e-=i,s.length>0)for(;!(s.includes(e)||e<0);)e-=i;let r=this.records[e].w2ui,n=this.columns[t];(r&&r.colspan&&n!=null&&!isNaN(r.colspan[n.field])?parseInt(r.colspan[n.field]):1)===0?l=this.prevRow(e,t,i):l=e}return l}selectionSave(){return this.last.saved_sel=this.getSelection(),this.last.saved_sel}selectionRestore(e){let t=Date.now();this.last.selection={indexes:[],columns:{}};let i=this.last.selection,s=this.last.saved_sel;if(s)for(let l=0;l<s.length;l++)if(u.isPlainObject(s[l])){let r=this.get(s[l].recid,!0);r!=null&&(i.indexes.indexOf(r)==-1&&i.indexes.push(r),i.columns[r]||(i.columns[r]=[]),i.columns[r].push(s[l].column))}else{let r=this.get(s[l],!0);r!=null&&i.indexes.push(r)}return delete this.last.saved_sel,e!==!0&&this.refresh(),Date.now()-t}message(e){return u.message({owner:this,box:this.box,after:".w2ui-grid-header"},e)}confirm(e){return u.confirm({owner:this,box:this.box,after:".w2ui-grid-header"},e)}},W=class extends Y{constructor(e){super(e.name),this.name=null,this.header="",this.box=null,this.url="",this.method=null,this.routeData={},this.formURL="",this.formHTML="",this.page=0,this.pageStyle="",this.recid=null,this.fields=[],this.actions={},this.record={},this.original=null,this.dataType=null,this.postData={},this.httpHeaders={},this.toolbar={},this.tabs={},this.style="",this.focus=0,this.autosize=!0,this.nestedFields=!0,this.tabindexBase=0,this.isGenerated=!1,this.last={fetchCtrl:null,fetchOptions:null,errors:[]},this.onRequest=null,this.onLoad=null,this.onValidate=null,this.onSubmit=null,this.onProgress=null,this.onSave=null,this.onChange=null,this.onInput=null,this.onRender=null,this.onRefresh=null,this.onResize=null,this.onDestroy=null,this.onAction=null,this.onToolbar=null,this.onError=null,this.msgRefresh="Loading...",this.msgSaving="Saving...",this.msgServerError="Server error",this.ALL_TYPES=["text","textarea","email","pass","password","int","float","money","currency","percent","hex","alphanumeric","color","date","time","datetime","toggle","checkbox","radio","check","checks","list","combo","enum","file","select","switch","map","array","div","custom","html","empty"],this.LIST_TYPES=["select","radio","check","checks","list","combo","enum","switch"],this.W2FIELD_TYPES=["int","float","money","currency","percent","hex","alphanumeric","color","date","time","datetime","list","combo","enum","file"],u.extend(this,e);let t=e.record,i=e.original,s=e.fields,l=e.toolbar,r=e.tabs;if(Object.assign(this,{record:{},original:null,fields:[],tabs:{},toolbar:{},handlers:[]}),s){let a=n(s);this.fields=a.fields,!r&&a.tabs.length>0&&(r=a.tabs)}if(Array.isArray(r)){u.extend(this.tabs,{tabs:[]});for(let a=0;a<r.length;a++){let h=r[a];typeof h=="object"?(this.tabs.tabs.push(h),h.active===!0&&(this.tabs.active=h.id)):this.tabs.tabs.push({id:h,text:h})}}else u.extend(this.tabs,r);u.extend(this.toolbar,l);for(let a in t)u.isPlainObject(t[a])?this.record[a]=u.clone(t[a]):this.record[a]=t[a];for(let a in i)u.isPlainObject(i[a])?this.original[a]=u.clone(i[a]):this.original[a]=i[a];this.formURL!==""?fetch(this.formURL).then(a=>a.text()).then(a=>{this.formHTML=a,this.isGenerated=!0,this.box&&this.render(this.box)}):!this.formURL&&!this.formHTML?(this.formHTML=this.generateHTML(),this.isGenerated=!0):this.formHTML&&(this.isGenerated=!0),typeof this.box=="string"&&(this.box=o(this.box).get(0)),this.box&&this.render(this.box);function n(a){let h=[],d=[];if(u.isPlainObject(a)){let c=function(f){let m=["html"];return f.html==null&&(f.html={}),Object.keys(f).forEach(w=>{m.indexOf(w)==-1&&["label","attr","style","text","span","page","column","anchor","group","groupStyle","groupTitleStyle","groupCollapsible"].indexOf(w)!=-1&&(f.html[w]=f[w],delete f[w])}),f},p=function(f,m){let w=["style","html"];Object.keys(f).forEach(b=>{w.indexOf(b)==-1&&["span","column","attr","text","label"].indexOf(b)!=-1&&f[b]&&!m.html[b]&&(m.html[b]=f[b])})},g=a;a=[],Object.keys(g).forEach(f=>{let m=g[f];if(m.type=="group"){if(m.text=f,u.isPlainObject(m.fields)){let w=m.fields;m.fields=[],Object.keys(w).forEach(b=>{let y=w[b];y.field=b,m.fields.push(c(y))})}a.push(m)}else if(m.type=="tab"){let w={id:f,text:f};m.style&&(w.style=m.style),d.push(w);let b=n(m.fields).fields;b.forEach(y=>{y.html=y.html||{},y.html.page=d.length-1,p(m,y)}),a.push(...b)}else m.field=f,a.push(c(m))})}return a.forEach(g=>{if(g.type=="group"){let c={group:g.text||"",groupStyle:g.style||"",groupTitleStyle:g.titleStyle||"",groupCollapsible:g.collapsible===!0};Array.isArray(g.fields)&&g.fields.forEach(p=>{let f=u.clone(p);f.html==null&&(f.html={}),u.extend(f.html,c),Array("span","column","attr","label","page").forEach(m=>{f.html[m]==null&&g[m]!=null&&(f.html[m]=g[m])}),f.field==null&&f.name!=null&&(console.log("NOTICE: form field.name property is deprecated, please use field.field. Field ->",g),f.field=f.name),h.push(f)})}else{let c=u.clone(g);c.field==null&&c.name!=null&&(console.log("NOTICE: form field.name property is deprecated, please use field.field. Field ->",g),c.field=c.name),h.push(c)}}),{fields:h,tabs:d}}}get(e,t){if(arguments.length===0){let i=[];for(let s=0;s<this.fields.length;s++)this.fields[s].field!=null&&i.push(this.fields[s].field);return i}else{for(let i=0;i<this.fields.length;i++)if(this.fields[i].field==e)return t===!0?i:this.fields[i];return null}}set(e,t){for(let i=0;i<this.fields.length;i++)if(this.fields[i].field==e)return u.extend(this.fields[i],t),delete this.fields[i].w2field,this.refresh(e),!0;return!1}getValue(e,t){if(this.nestedFields){let i;try{let s=t===!0?this.original:this.record;i=String(e).split(".").reduce((l,r)=>l[r],s)}catch{}return i}else return this.record[e]}setValue(e,t,i){if((t===""||t==null||Array.isArray(t)&&t.length===0||u.isPlainObject(t)&&Object.keys(t).length==0)&&(t=null),this.nestedFields)try{let s=this.record;return String(e).split(".").map((l,r,n)=>{n.length-1!==r?(s[l]||(s[l]={}),s=s[l]):s[l]=t}),i||this.setFieldValue(e,t),!0}catch{return!1}else return this.record[e]=t,i||this.setFieldValue(e,t),!0}getFieldValue(e){let t=this.get(e);if(t==null)return;let i=t.el,s=this.getValue(e),l=this.getValue(e,!0),r=i.value;if(["int","float","percent","money","currency"].includes(t.type)&&(t.type=="int"||r[r.length-1]!=".")&&(r=t.w2field.clean(r)),["radio"].includes(t.type)){let a=o(i).closest("div").find("input:checked").get(0);a?r=t.options.items[o(a).data("index")].id:r=null}if(["toggle","checkbox"].includes(t.type)&&(r=i.checked),["check","checks"].indexOf(t.type)!==-1){r=[];let a=o(i).closest("div").find("input:checked");a.length>0&&a.each(h=>{let d=t.options.items[o(h).data("index")];r.push(d.id)}),Array.isArray(s)||(s=[])}let n=i._w2field?.selected;if(["list","enum","file"].includes(t.type)&&n){let a=n,h=s;if(Array.isArray(a)){r=[];for(let d=0;d<a.length;d++)r[d]=u.clone(a[d])}if(Array.isArray(h)){s=[];for(let d=0;d<h.length;d++)s[d]=u.clone(h[d])}u.isPlainObject(a)&&(r=u.clone(a)),u.isPlainObject(h)&&(s=u.clone(h))}return["map","array"].includes(t.type)&&(r=t.type=="map"?{}:[],t.$el.parent().find(".w2ui-map-field").each(a=>{let h=o(a).find(".w2ui-map.key").val(),d=o(a).find(".w2ui-map.value").val();t.type=="map"?r[h]=d:r.push(d)})),{current:r,previous:s,original:l}}setFieldValue(e,t){let i=this.get(e);if(i==null)return;let s=i.el;switch(i.type){case"toggle":case"checkbox":{s.checked=!!t;break}case"radio":{t=t?.id??t;let r=o(s).closest("div").find("input");i.options.items.forEach((a,h)=>{a.id===t&&r.filter(`[data-index="${h}"]`).prop("checked",!0)});break}case"check":case"checks":{Array.isArray(t)||(t!=null?t=[t]:t=[]),t=t.map(a=>a?.id??a);let r=o(s).closest("div").find("input");i.options.items.forEach((a,h)=>{r.filter(`[data-index="${h}"]`).prop("checked",!!t.includes(a.id))});break}case"list":case"combo":let l=t;l?.id==null&&Array.isArray(i.options?.items)&&i.options.items.forEach(r=>{r.id===t&&(l=r)}),l!=t&&this.setValue(i.name,l,!0),i.type=="list"?(i.w2field.selected=l,i.w2field.refresh()):i.el.value=l?.text??t;break;case"switch":{s.value=t,i.toolbar.uncheck(...i.toolbar.get()),i.toolbar.check(t);break}case"enum":case"file":{Array.isArray(t)||(t=t!=null?[t]:[]);let r=[...t],n=!1;r.forEach((a,h)=>{a?.id==null&&Array.isArray(i.options.items)&&i.options.items.forEach(d=>{d.id==a&&(r[h]=d,n=!0)})}),n&&this.setValue(i.name,r,!0),i.w2field.selected=r,i.w2field.refresh();break}case"map":case"array":{i.type=="map"&&(t==null||!u.isPlainObject(t))&&(this.setValue(i.field,{},!0),t=this.getValue(i.field)),i.type=="array"&&(t==null||!Array.isArray(t))&&(this.setValue(i.field,[],!0),t=this.getValue(i.field));let r=o(i.el).parent().find(".w2ui-map-container");i.el.mapRefresh(t,r);break}case"div":case"custom":{o(s).html(t);break}case"color":{s.value=t??"",i.w2field.refresh();break}case"html":case"empty":break;default:s.value=t??"";break}}show(){let e=[];for(let t=0;t<arguments.length;t++){let i=this.get(arguments[t]);i&&i.hidden&&(i.hidden=!1,e.push(i.field))}return e.length>0&&this.refresh.apply(this,e),this.updateEmptyGroups(),e}hide(){let e=[];for(let t=0;t<arguments.length;t++){let i=this.get(arguments[t]);i&&!i.hidden&&(i.hidden=!0,e.push(i.field))}return e.length>0&&this.refresh.apply(this,e),this.updateEmptyGroups(),e}enable(){let e=[];for(let t=0;t<arguments.length;t++){let i=this.get(arguments[t]);i&&i.disabled&&(i.disabled=!1,e.push(i.field))}return e.length>0&&this.refresh.apply(this,e),e}disable(){let e=[];for(let t=0;t<arguments.length;t++){let i=this.get(arguments[t]);i&&!i.disabled&&(i.disabled=!0,e.push(i.field))}return e.length>0&&this.refresh.apply(this,e),e}updateEmptyGroups(){o(this.box).find(".w2ui-group").each(t=>{e(o(t).find(".w2ui-field"))?o(t).hide():o(t).show()});function e(t){let i=!0;return t.each(s=>{s.style.display!="none"&&(i=!1)}),i}}change(){Array.from(arguments).forEach(e=>{let t=this.get(e);t.$el&&t.$el.change()})}reload(e){return(typeof this.url!="object"?this.url:this.url.get)&&this.recid!=null?this.request(e):(typeof e=="function"&&e(),new Promise(i=>{i()}))}clear(){arguments.length!=0?Array.from(arguments).forEach(e=>{let t=this.record;String(e).split(".").map((i,s,l)=>{l.length-1!==s?t=t[i]:delete t[i]}),this.refresh(e)}):(this.recid=null,this.record={},this.original=null,this.refresh(),this.hideErrors())}error(e){let t=this.trigger("error",{target:this.name,message:e,fetchCtrl:this.last.fetchCtrl,fetchOptions:this.last.fetchOptions});t.isCancelled!==!0&&(setTimeout(()=>{this.message(e)},1),t.finish())}message(e){return u.message({owner:this,box:this.box,after:".w2ui-form-header"},e)}confirm(e){return u.confirm({owner:this,box:this.box,after:".w2ui-form-header"},e)}validate(e){e==null&&(e=!0);let t=[];for(let s=0;s<this.fields.length;s++){let l=this.fields[s];if(this.getValue(l.field)==null&&this.setValue(l.field,""),["int","float","currency","money"].indexOf(l.type)!=-1){let n=this.getValue(l.field),a=l.options.min,h=l.options.max;a!=null&&n!=null&&n<a&&t.push({field:l,error:u.lang("Should be more than ${min}",{min:a})}),h!=null&&n!=null&&n>h&&t.push({field:l,error:u.lang("Should be less than ${max}",{max:h})})}switch(l.type){case"alphanumeric":this.getValue(l.field)&&!u.isAlphaNumeric(this.getValue(l.field))&&t.push({field:l,error:u.lang("Not alpha-numeric")});break;case"int":this.getValue(l.field)&&!u.isInt(this.getValue(l.field))&&t.push({field:l,error:u.lang("Not an integer")});break;case"percent":case"float":this.getValue(l.field)&&!u.isFloat(this.getValue(l.field))&&t.push({field:l,error:u.lang("Not a float")});break;case"currency":case"money":this.getValue(l.field)&&!u.isMoney(this.getValue(l.field))&&t.push({field:l,error:u.lang("Not in money format")});break;case"color":case"hex":this.getValue(l.field)&&!u.isHex(this.getValue(l.field))&&t.push({field:l,error:u.lang("Not a hex number")});break;case"email":this.getValue(l.field)&&!u.isEmail(this.getValue(l.field))&&t.push({field:l,error:u.lang("Not a valid email")});break;case"checkbox":this.getValue(l.field)==!0?this.setValue(l.field,!0):this.setValue(l.field,!1);break;case"date":l.options.format||(l.options.format=u.settings.dateFormat),this.getValue(l.field)&&!u.isDate(this.getValue(l.field),l.options.format)&&t.push({field:l,error:u.lang("Not a valid date")+": "+l.options.format});break;case"list":case"combo":case"switch":break;case"enum":break}let r=this.getValue(l.field);l.hidden!==!0&&l.required&&!["div","custom","html","empty"].includes(l.type)&&(r==null||r===""||Array.isArray(r)&&r.length===0||u.isPlainObject(r)&&Object.keys(r).length==0)&&t.push({field:l,error:u.lang("Required field")}),l.hidden!==!0&&l.options?.minLength>0&&!["enum","list","combo"].includes(l.type)&&(r==null||r.length<l.options.minLength)&&t.push({field:l,error:u.lang("Field should be at least ${count} characters.",{count:l.options.minLength})})}let i=this.trigger("validate",{target:this.name,errors:t});if(i.isCancelled!==!0)return this.last.errors=t,e&&this.showErrors(),i.finish(),t}showErrors(){let e=this.last.errors;e.length<=0||(this.goto(e[0].field.page),o(e[0].field.$el).parents(".w2ui-field")[0].scrollIntoView({block:"nearest",inline:"nearest"}),e.forEach(t=>{let i=u.extend({anchorClass:"w2ui-error",class:"w2ui-light",position:"right|left",hideOn:["input"]},t.options);if(t.field==null)return;let s=t.field.el;t.field.type==="radio"?s=o(t.field.el).closest("div").get(0):["enum","file"].includes(t.field.type),O.show(u.extend({anchor:s,name:`${this.name}-${t.field.field}-error`,html:t.error},i))}),o(e[0].field.$el).parents(".w2ui-page").off(".hideErrors").on("scroll.hideErrors",t=>{this.hideErrors()}))}hideErrors(){this.fields.forEach(e=>{O.hide(`${this.name}-${e.field}-error`)})}getChanges(){let e={};return this.original!=null&&typeof this.original=="object"&&Object.keys(this.record).length!==0&&(e=t(this.record,this.original,{})),e;function t(i,s,l){if(Array.isArray(i)&&Array.isArray(s))for(;i.length<s.length;)i.push(null);for(let r in i)i[r]!=null&&typeof i[r]=="object"?(l[r]=t(i[r],s[r]||{},{}),(!l[r]||Object.keys(l[r]).length==0&&Object.keys(s[r].length==0))&&delete l[r]):(i[r]!=s[r]||i[r]==null&&s[r]!=null)&&(l[r]=i[r]);return Object.keys(l).length!=0?l:null}}getCleanRecord(e){let t=u.clone(this.record);return this.fields.forEach(i=>{if(["list","combo","enum"].indexOf(i.type)!=-1){let s={nestedFields:!0,record:t},l=this.getValue.call(s,i.field);u.isPlainObject(l)&&l.id!=null&&this.setValue.call(s,i.field,l.id),Array.isArray(l)&&l.forEach((r,n)=>{u.isPlainObject(r)&&r.id&&(l[n]=r.id)})}if(i.type=="map"){let s={nestedFields:!0,record:t},l=this.getValue.call(s,i.field);l._order&&delete l._order}if(i.type=="file"){let s={nestedFields:!0,record:t},l=this.getValue.call(s,i.field)??[];l.forEach(r=>{delete r.file,delete r.modified}),this.setValue.call(s,i.field,l)}}),e===!0&&Object.keys(t).forEach(i=>{this.get(i)||delete t[i]}),t}request(e,t){let i=this,s,l,r=new Promise((c,p)=>{s=c,l=p});if(typeof e=="function"&&(t=e,e=null),e==null&&(e={}),!this.url||typeof this.url=="object"&&!this.url.get)return;let n={};n.action="get",n.recid=this.recid,n.name=this.name,u.extend(n,this.postData),u.extend(n,e);let a=this.trigger("request",{target:this.name,url:this.url,httpMethod:"GET",postData:n,httpHeaders:this.httpHeaders});if(a.isCancelled===!0)return;this.record={},this.original=null,this.lock(u.lang(this.msgRefresh));let h=a.detail.url;if(typeof h=="object"&&h.get&&(h=h.get),this.last.fetchCtrl)try{this.last.fetchCtrl.abort()}catch{}if(Object.keys(this.routeData).length!=0){let c=u.parseRoute(h);if(c.keys.length>0)for(let p=0;p<c.keys.length;p++)this.routeData[c.keys[p].name]!=null&&(h=h.replace(new RegExp(":"+c.keys[p].name,"g"),this.routeData[c.keys[p].name]))}h=new URL(h,location);let d=u.prepareParams(h,{method:a.detail.httpMethod,headers:a.detail.httpHeaders,body:a.detail.postData},this.dataType);return this.last.fetchCtrl=new AbortController,d.signal=this.last.fetchCtrl.signal,this.last.fetchOptions=d,fetch(h,d).catch(g).then(c=>{if(c?.status!=200){c&&g(c);return}c.json().catch(g).then(p=>{let f=i.trigger("load",{target:i.name,fetchCtrl:this.last.fetchCtrl,fetchOptions:this.last.fetchOptions,data:p});f.isCancelled!==!0&&(p.error==null&&p.status==="error"&&(p.error=!0),p.record||Object.assign(p,{record:u.clone(p)}),p.error===!0?i.error(u.lang(p.message??this.msgServerError)):i.record=u.clone(p.record),i.unlock(),f.finish(),i.refresh(),i.setFocus(),typeof t=="function"&&t(p),s(p))})}),a.finish(),r;function g(c){if(c.name==="AbortError")return;i.unlock();let p=i.trigger("error",{response:c,fetchCtrl:i.last.fetchCtrl,fetchOptions:i.last.fetchOptions});p.isCancelled!==!0&&(c.status&&c.status!=200?i.error(c.status+": "+c.statusText):(console.log("ERROR: Server request failed.",c,". ","Expected Response:",{error:!1,record:{field1:1,field2:"item"}},"OR:",{error:!0,message:"Error description"}),i.error(String(c))),p.finish(),l(c))}}submit(e,t){return this.save(e,t)}save(e,t){let i=this,s,l,r=new Promise((p,f)=>{s=p,l=f});if(typeof e=="function"&&(t=e,e=null),i.validate(!0).length!==0)return;if(e==null&&(e={}),!i.url||typeof i.url=="object"&&!i.url.save){console.log("ERROR: Form cannot be saved because no url is defined.");return}i.lock(u.lang(i.msgSaving)+' <span id="'+i.name+'_progress"></span>');let a={};a.action="save",a.recid=i.recid,a.name=i.name,u.extend(a,i.postData),u.extend(a,e),a.record=u.clone(i.record);let h=i.trigger("submit",{target:i.name,url:i.url,httpMethod:this.method??"POST",postData:a,httpHeaders:i.httpHeaders});if(h.isCancelled===!0)return;let d=h.detail.url;if(typeof d=="object"&&d.save&&(d=d.save),i.last.fetchCtrl&&i.last.fetchCtrl.abort(),Object.keys(i.routeData).length>0){let p=u.parseRoute(d);if(p.keys.length>0)for(let f=0;f<p.keys.length;f++)i.routeData[p.keys[f].name]!=null&&(d=d.replace(new RegExp(":"+p.keys[f].name,"g"),i.routeData[p.keys[f].name]))}d=new URL(d,location);let g=u.prepareParams(d,{method:h.detail.httpMethod,headers:h.detail.httpHeaders,body:h.detail.postData},this.dataType);return this.last.fetchCtrl=new AbortController,g.signal=this.last.fetchCtrl.signal,this.last.fetchOptions=g,fetch(d,g).catch(c).then(p=>{if(i.unlock(),p?.status!=200){c(p??{});return}p.json().catch(c).then(f=>{let m=i.trigger("save",{target:i.name,fetchCtrl:this.last.fetchCtrl,fetchOptions:this.last.fetchOptions,data:f});m.isCancelled!==!0&&(f.error===!0?i.error(u.lang(f.message??this.msgServerError)):i.original=null,m.finish(),i.refresh(),typeof t=="function"&&t(f),s(f))})}),h.finish(),r;function c(p){if(p?.name==="AbortError")return;i.unlock();let f=i.trigger("error",{response:p,fetchCtrl:i.last.fetchCtrl,fetchOptions:i.last.fetchOptions});f.isCancelled!==!0&&(p.status&&p.status!=200?i.error(p.status+": "+p.statusText):(console.log("ERROR: Server request failed.",p,". ","Expected Response:",{error:!1,record:{field1:1,field2:"item"}},"OR:",{error:!0,message:"Error description"}),i.error(String(p))),f.finish(),l())}}lock(e,t){let i=Array.from(arguments);i.unshift(this.box),u.lock(...i)}unlock(e){let t=this.box;u.unlock(t,e)}lockPage(e,t,i){let s=o(this.box).find(".page-"+e);return s.length?(u.lock(s,t,i),!0):!1}unlockPage(e,t){let i=o(this.box).find(".page-"+e);return i.length?(u.unlock(i,t),!0):!1}goto(e){this.page!==e&&(e!=null&&(this.page=e),o(this.box).data("autoSize")===!0&&(o(this.box).get(0).clientHeight=0),this.refresh())}generateHTML(){let e=[],t="",i,s,l,r,n;for(let h=0;h<this.fields.length;h++){l="",r=this.tabindexBase+h+1,n=' tabindex="'+r+'"';let d=this.fields[h];d.html==null&&(d.html={}),d.options==null&&(d.options={}),d.html.caption!=null&&d.html.label==null&&(console.log("NOTICE: form field.html.caption property is deprecated, please use field.html.label. Field ->",d),d.html.label=d.html.caption),d.html.label==null&&(d.html.label=d.field),d.html=u.extend({label:"",span:6,attr:"",text:"",style:"",page:0,column:0},d.html),i==null&&(i=d.html.page),s==null&&(s=d.html.column);let g=`<input id="${d.field}" name="${d.field}" class="w2ui-input ${d.html.class??""}" type="text" ${d.html.attr+n}>`;switch(d.type){case"pass":case"password":g=g.replace('type="text"','type="password"');break;case"checkbox":{g=`
                        <label class="w2ui-box-label">
                            <input id="${d.field}" name="${d.field}" class="w2ui-input ${d.html.class??""}" type="checkbox" ${d.html.attr+n}>
                            <span>${d.html.label}</span>
                        </label>`;break}case"check":case"checks":{d.options.items==null&&d.html.items!=null&&(d.options.items=d.html.items);let c=d.options.items;g="",Array.isArray(c)||(c=[]),c.length>0&&(c=u.normMenu.call(this,c,d));for(let p=0;p<c.length;p++)g+=`
                            <label class="w2ui-box-label">
                                <input id="${d.field+p}" name="${d.field}" class="w2ui-input ${d.html.class??""}" type="checkbox"
                                    ${d.html.attr+n} data-value="${c[p].id}" data-index="${p}">
                                <span>&#160;${c[p].text}</span>
                            </label>
                            <br>`;break}case"radio":{g="",d.options.items==null&&d.html.items!=null&&(d.options.items=d.html.items);let c=d.options.items;Array.isArray(c)||(c=[]),c.length>0&&(c=u.normMenu.call(this,c,d));for(let p=0;p<c.length;p++)g+=`
                            <label class="w2ui-box-label">
                                <input id="${d.field+p}" name="${d.field}" class="w2ui-input ${d.html.class??""}" type="radio"
                                    ${d.html.attr+(p===0?n:"")}
                                    data-value="${c[p].id}" data-index="${p}">
                                <span>&#160;${c[p].text}</span>
                            </label>
                            <br>`;break}case"select":{g=`<select id="${d.field}" name="${d.field}" class="w2ui-input ${d.html.class??""}" ${d.html.attr+n}>`,d.options.items==null&&d.html.items!=null&&(d.options.items=d.html.items);let c=d.options.items;Array.isArray(c)||(c=[]),c.length>0&&(c=u.normMenu.call(this,c,d));for(let p=0;p<c.length;p++)g+=`<option value="${c[p].id}">${c[p].text}</option>`;g+="</select>";break}case"switch":{g=`<div id="${d.field}-tb" class="w2ui-form-switch ${d.html.class??""}" ${d.html.attr}
                        style="outline1: 1px solid red !important; height: 34px; margin-top: -5px; padding: 0px; background-color: transparent; position: relative;"></div>
                        <input id="${d.field}" name="${d.field}" ${n} class="w2ui-input"
                            style="position: absolute; right: 0; margin-top: -30px; width: 1px; padding: 0; opacity: 0">`;break}case"textarea":g=`<textarea id="${d.field}" name="${d.field}" class="w2ui-input ${d.html.class??""}" ${d.html.attr+n}></textarea>`;break;case"toggle":g=`<input id="${d.field}" name="${d.field}" class="w2ui-input w2ui-toggle  ${d.html.class??""}"
                                type="checkbox" ${d.html.attr+n}>
                            <div><div></div></div>`;break;case"map":case"array":d.html.key=d.html.key||{},d.html.value=d.html.value||{},d.html.tabindex_str=n,g='<span style="float: right">'+(d.html.text||"")+'</span><input id="'+d.field+'" name="'+d.field+'" type="hidden" '+d.html.attr+n+'><div class="w2ui-map-container"></div>';break;case"div":case"custom":g=`<div id="${d.field}" name="${d.field}" ${d.html.attr+n} class="w2ui-input ${d.html.class??""}">`+(d&&d.html&&d.html.html?d.html.html:"")+"</div>";break;case"html":case"empty":g=`<div id="${d.field}" name="${d.field}" ${d.html.attr+n} class="w2ui-input ${d.html.class??""}">`+(d&&d.html?(d.html.html||"")+(d.html.text||""):"")+"</div>";break}if(t!==""&&(i!=d.html.page||s!=d.html.column||d.html.group&&t!=d.html.group)&&(e[i][s]+=`
   </div>
  </div>`,t=""),d.html.group&&t!=d.html.group){let c="";d.html.groupCollapsible&&(c='<span class="w2ui-icon-collapse" style="width: 15px; display: inline-block; position: relative; top: -2px;"></span>'),l+=`
 <div class="w2ui-group">
   <div class="w2ui-group-title w2ui-eaction" style="`+(d.html.groupTitleStyle||"")+"; "+(c!=""?"cursor: pointer; user-select: none":"")+'"'+(c!=""?'data-group="'+u.base64encode(d.html.group)+'"':"")+(c!=""?'data-click="toggleGroup|'+d.html.group+'"':"")+">"+c+u.lang(d.html.group)+`</div>
   <div class="w2ui-group-fields" style="`+(d.html.groupStyle||"")+'">',t=d.html.group}if(d.html.anchor==null){let c=d.html.span!=null?"w2ui-span"+d.html.span:"";d.html.span==-1&&(c="w2ui-span-none");let p="<label"+(c=="none"?' style="display: none"':"")+">"+u.lang(d.type!="checkbox"?d.html.label:d.html.text)+"</label>";d.html.label||(p=""),l+=`
      <div class="w2ui-field `+c+'" style="'+(d.hidden?"display: none;":"")+d.html.style+`">
         `+p+(d.type==="empty"?g:`
         <div>`+g+(d.type!="array"&&d.type!="map"?u.lang(d.type!="checkbox"?d.html.text:""):"")+"</div>")+`
      </div>`}else e[d.html.page].anchors=e[d.html.page].anchors||{},e[d.html.page].anchors[d.html.anchor]='<div class="w2ui-field w2ui-field-inline" style="'+(d.hidden?"display: none;":"")+d.html.style+'">'+(d.type==="empty"?g:"<div>"+u.lang(d.type!="checkbox"?d.html.label:d.html.text,!0)+g+u.lang(d.type!="checkbox"?d.html.text:"")+"</div>")+"</div>";e[d.html.page]==null&&(e[d.html.page]={}),e[d.html.page][d.html.column]==null&&(e[d.html.page][d.html.column]=""),e[d.html.page][d.html.column]+=l,i=d.html.page,s=d.html.column}if(t!==""&&(e[i][s]+=`
   </div>
  </div>`),this.tabs.tabs)for(let h=0;h<this.tabs.tabs.length;h++)e[h]==null&&(e[h]=[]);let a="";if(Object.keys(this.actions).length>0){a+=`
<div class="w2ui-buttons">`,r=this.tabindexBase+this.fields.length+1;for(let h in this.actions){let d=this.actions[h],g={text:"",style:"",class:""};u.isPlainObject(d)?(d.text==null&&d.caption!=null&&(console.log("NOTICE: form action.caption property is deprecated, please use action.text. Action ->",d),d.text=d.caption),d.text&&(g.text=d.text),d.style&&(g.style=d.style),d.class&&(g.class=d.class)):(g.text=h,["save","update","create"].indexOf(h.toLowerCase())!==-1?g.class="w2ui-btn-blue":g.class=""),a+=`
    <button name="`+h+'" class="w2ui-btn '+g.class+'" style="'+g.style+'" tabindex="'+r+'">'+u.lang(g.text)+"</button>",r++}a+=`
</div>`}l="";for(let h=0;h<e.length;h++){if(l+='<div class="w2ui-page page-'+h+'" style="'+(h!==0?"display: none;":"")+this.pageStyle+'">',!e[h])return console.log(`ERROR: Page ${h} does not exist`),!1;e[h].before&&(l+=e[h].before),l+='<div class="w2ui-column-container">',Object.keys(e[h]).sort().forEach((d,g)=>{d==parseInt(d)&&(l+='<div class="w2ui-column col-'+d+'">'+(e[h][d]||"")+`
</div>`)}),l+=`
</div>`,e[h].after&&(l+=e[h].after),l+=`
</div>`,e[h].anchors&&Object.keys(e[h].anchors).forEach((d,g)=>{l=l.replace(d,e[h].anchors[d])})}return l+=a,l}toggleGroup(e,t){let i=o(this.box).find('.w2ui-group-title[data-group="'+u.base64encode(e)+'"]');if(i.length===0)return;let s=o(i.prop("nextElementSibling"));typeof t>"u"&&(t=s.css("display")=="none"),t?(s.show(),i.find("span").addClass("w2ui-icon-collapse").removeClass("w2ui-icon-expand")):(s.hide(),i.find("span").addClass("w2ui-icon-expand").removeClass("w2ui-icon-collapse"))}action(e,t){let i=this.actions[e],s=i;u.isPlainObject(i)&&i.onClick&&(s=i.onClick);let l=this.trigger("action",{target:e,action:i,originalEvent:t});l.isCancelled!==!0&&(typeof s=="function"&&s.call(this,t),l.finish())}resize(){let e=this,t=this.trigger("resize",{target:this.name});if(t.isCancelled!==!0){if(this.box!=null){let c=function(){let p=e.header!==""?u.getSize(i,"height"):0,f=Array.isArray(e.toolbar?.items)&&e.toolbar?.items?.length>0?u.getSize(s,"height"):0,m=Array.isArray(e.tabs?.tabs)&&e.tabs?.tabs?.length>0?u.getSize(l,"height"):0;return s.css({top:p+"px"}),l.css({top:p+f+"px"}),r.css({top:p+f+m+"px",bottom:(a.length>0?u.getSize(a,"height"):0)+"px"}),{headerHeight:p,tbHeight:f,tabsHeight:m}},i=o(this.box).find(":scope > div .w2ui-form-header"),s=o(this.box).find(":scope > div .w2ui-form-toolbar"),l=o(this.box).find(":scope > div .w2ui-form-tabs"),r=o(this.box).find(":scope > div .w2ui-page"),n=o(this.box).find(":scope > div .w2ui-page.page-"+this.page+" > div"),a=o(this.box).find(":scope > div .w2ui-buttons"),{headerHeight:h,tbHeight:d,tabsHeight:g}=c();this.autosize&&((o(this.box).get(0).clientHeight===0||o(this.box).data("autosize")=="yes")&&(o(this.box).css({height:h+d+g+15+(r.length>0?u.getSize(n,"height"):0)+(a.length>0?u.getSize(a,"height"):0)+"px"}),o(this.box).data("autosize","yes")),c())}t.finish()}}refresh(){let e=Date.now(),t=this;if(!this.box||!this.isGenerated||!o(this.box).html())return;let i=this.trigger("refresh",{target:this.name,page:this.page,field:arguments[0],fields:arguments});if(i.isCancelled===!0)return;let s=Array.from(this.fields.keys());arguments.length>0?s=Array.from(arguments).map((l,r)=>(typeof l!="string"&&console.log("ERROR: Arguments in refresh functions should be field names"),this.get(l,!0))).filter((l,r)=>l!=null):(o(this.box).find("input, textarea, select").each(l=>{let r=o(l).attr("name")!=null?o(l).attr("name"):o(l).attr("id"),n=this.get(r);if(n){let a=o(l).closest(".w2ui-page");if(a.length>0){for(let h=0;h<100;h++)if(a.hasClass("page-"+h)){n.page=h;break}}}}),o(this.box).find(".w2ui-page").hide(),o(this.box).find(".w2ui-page.page-"+this.page).show(),o(this.box).find(".w2ui-form-header").html(u.lang(this.header)),typeof this.tabs=="object"&&Array.isArray(this.tabs.tabs)&&this.tabs.tabs.length>0?(o(this.box).find("#form_"+this.name+"_tabs").show(),this.tabs.active=this.tabs.tabs[this.page].id,this.tabs.refresh()):o(this.box).find("#form_"+this.name+"_tabs").hide(),typeof this.toolbar=="object"&&Array.isArray(this.toolbar.items)&&this.toolbar.items.length>0?(o(this.box).find("#form_"+this.name+"_toolbar").show(),this.toolbar.refresh()):o(this.box).find("#form_"+this.name+"_toolbar").hide());for(let l=0;l<s.length;l++){let r=this.fields[s[l]];r.name==null&&r.field!=null&&(r.name=r.field),r.field==null&&r.name!=null&&(r.field=r.name),r.$el=o(this.box).find(`[name='${String(r.name).replace(/\\/g,"\\\\")}']`),r.el=r.$el.get(0),r.el&&(r.el.id=r.name),r.w2field&&r.w2field.reset(),r.$el.off(".w2form").on("change.w2form",function(a){let h=t.getFieldValue(r.field);if(["enum","file"].includes(r.type)){let g=r.el._w2field?.helpers?.multi;o(g).removeClass("w2ui-error")}this._previous!=null&&(h.previous=this._previous,delete this._previous);let d=t.trigger("change",{target:this.name,field:this.name,value:h,originalEvent:a});d.isCancelled!==!0&&(t.setValue(this.name,h.current),d.finish())}).on("input.w2form",function(a){t.original==null&&(Object.keys(t.record).length>0?t.original=u.clone(t.record):t.original={});let h=t.getFieldValue(r.field);this._previous==null&&(this._previous=h.previous);let d=t.trigger("input",{target:t.name,field:r,value:h,originalEvent:a});d.isCancelled!==!0&&(t.setValue(this.name,h.current),d.finish())}),r.required?r.$el.closest(".w2ui-field").addClass("w2ui-required"):r.$el.closest(".w2ui-field").removeClass("w2ui-required"),r.disabled!=null&&(r.disabled?(r.$el.data("tabIndex")==null&&r.$el.data("tabIndex",r.$el.prop("tabIndex")),r.$el.prop("readOnly",!0).prop("disabled",!0).prop("tabIndex",-1).closest(".w2ui-field").addClass("w2ui-disabled")):r.$el.prop("readOnly",!1).prop("disabled",!1).prop("tabIndex",r.$el.data("tabIndex")??r.$el.prop("tabIndex")??0).closest(".w2ui-field").removeClass("w2ui-disabled"));let n=r.el;n||(n=o(this.box).find("#"+r.field)),r.hidden?o(n).closest(".w2ui-field").hide():o(n).closest(".w2ui-field").show()}o(this.box).find("button, input[type=button]").each(l=>{o(l).off("click").on("click",function(r){let n=this.value;this.id&&(n=this.id),this.name&&(n=this.name),t.action(n,r)})});for(let l=0;l<s.length;l++){let r=this.fields[s[l]];if(r.el){if(r.$el.hasClass("w2ui-input")||r.$el.addClass("w2ui-input"),r.type=String(r.type).toLowerCase(),r.options||(r.options={}),this.LIST_TYPES.includes(r.type)){let n=r.options.items;n==null&&(r.options.items=[]),r.type=="switch"?n.forEach((a,h)=>n[h]=typeof a!="object"?{id:a,text:a}:a):r.options.items=u.normMenu.call(this,n??[],r)}if(r.type=="switch"){r.toolbar&&N[this.name+"_"+r.name+"_tb"].destroy();let n=r.options.items;n.forEach(a=>a.type="radio"),r.toolbar=new Z({box:r.$el.prev().get(0),name:this.name+"_"+r.name+"_tb",items:n,onClick(a){let h=a.detail.item.id,d=t.trigger("change",{target:r.name,field:r.name,value:h,originalEvent:a});d.isCancelled!==!0&&(t.record[r.name]=a.detail.item.id,t.setFieldValue(r.name,a.detail.item.id),d.finish())}}),r.$el.off(".form-input").on("focus.form-input",a=>{let h=r.toolbar.get(r.$el.val(),!0);o(a.target).prop("_index",h)}).on("blur.form-input",a=>{o(a.target).removeProp("_index"),o(`#${r.name}-tb .w2ui-tb-button`).removeClass("over")}).on("keydown.form-input",a=>{let h=o(a.target).prop("_index");switch(a.key){case"ArrowLeft":{h>0&&h--,o(`#${r.name}-tb .w2ui-tb-button`).removeClass("over").eq(h).addClass("over"),o(a.target).prop("_index",h);break}case"ArrowRight":{h<r.toolbar.items.length-1&&h++,o(`#${r.name}-tb .w2ui-tb-button`).removeClass("over").eq(h).addClass("over"),o(a.target).prop("_index",h);break}}if(a.keyCode==32||a.keyCode==13){let d=r.toolbar.items[h];t.setFieldValue(r.name,d.id),o(`#${r.name}-tb .w2ui-tb-button`).removeClass("over")}!a.metaKey&&!a.ctrlKey&&a.keyCode!=9&&a.preventDefault()})}if(r.type=="select"){let n=r.options.items,a="";n.forEach(h=>{a+=`<option value="${h.id}">${h.text}</option>`}),r.$el.html(a)}this.W2FIELD_TYPES.includes(r.type)&&(r.w2field=r.w2field??new ie(u.extend({},r.options,{type:r.type})),r.w2field.render(r.el)),["map","array"].includes(r.type)&&function(n,a){let h;a.el.mapAdd=function(d,g,c){let p=(d.disabled?" readOnly ":"")+(d.html.tabindex_str||""),f=`
                            <div class="w2ui-map-field" style="margin-bottom: 5px" data-index="${c}">
                            ${d.type=="map"?`<input type="text" ${(d.html.key.attr??"")+p} class="w2ui-input ${d.html.class??""} w2ui-map key">
                                    ${d.html.key.text||""}
                                `:""}
                            <input type="text" ${(d.html.value.attr??"")+p} class="w2ui-input ${d.html.class??""} w2ui-map value">
                                ${d.html.value.text||""}
                            </div>`;g.append(f)},a.el.mapRefresh=function(d,g){let c,p,f;a.type=="map"&&(u.isPlainObject(d)||(d={}),d._order==null&&(d._order=Object.keys(d)),c=d._order),a.type=="array"&&(Array.isArray(d)||(d=[]),c=d.map((x,C)=>C));let m=g.find(".w2ui-map-field");for(let x=m.length-1;x>=c.length;x--)g.find(`div[data-index='${x}']`).remove();for(let x=0;x<c.length;x++){let C=c[x],_=g.find(`div[data-index='${x}']`);_.length==0&&(a.el.mapAdd(a,g,x),_=g.find(`div[data-index='${x}']`)),_.attr("data-key",C),p=_.find(".w2ui-map.key"),f=_.find(".w2ui-map.value");let v=d[C];if(a.type=="array"){let k=d.filter(D=>D.key==C);k.length>0&&(v=k[0].value)}p.val(C),f.val(v),(a.disabled===!0||a.disabled===!1)&&(p.prop("readOnly",!!a.disabled),f.prop("readOnly",!!a.disabled))}let w=c.length,b=g.find(`div[data-index='${w}']`);b.length===0&&(!p||p.val()!=""||f.val()!="")&&!(p&&(p.prop("readOnly")===!0||p.prop("disabled")===!0))&&a.el.mapAdd(a,g,w),(a.disabled===!0||a.disabled===!1)&&(b.find(".key").prop("readOnly",!!a.disabled),b.find(".value").prop("readOnly",!!a.disabled));let y=o(a.el).get(0)?.nextSibling;o(y).find("input.w2ui-map").off(".mapChange").on("keyup.mapChange",function(x){let C=o(x.target).closest(".w2ui-map-field"),_=C.get(0).nextElementSibling,v=C.get(0).previousElementSibling;if(x.keyCode==13){let D=h??_;if(D instanceof HTMLElement){let S=o(D).find("input");S.length>0&&S.get(0).focus()}h=void 0}let k=o(x.target).hasClass("key")?"key":"value";x.keyCode==38&&v&&(o(v).find(`input.${k}`).get(0).select(),x.preventDefault()),x.keyCode==40&&_&&(o(_).find(`input.${k}`).get(0).select(),x.preventDefault())}).on("keydown.mapChange",function(x){(x.keyCode==38||x.keyCode==40)&&x.preventDefault()}).on("input.mapChange",function(x){let C=o(x.target).closest("div"),_=C.data("index"),v=C.get(0).nextElementSibling;if(C.find("input").val()!=""&&!v)a.el.mapAdd(a,g,parseInt(_)+1);else if(C.find("input").val()==""&&v){let k=!0;o(v).find("input").each(D=>{D.value!=""&&(k=!1)}),k&&o(v).remove()}}).on("change.mapChange",function(x){t.original==null&&(Object.keys(t.record).length>0?t.original=u.clone(t.record):t.original={});let{current:C,previous:_,original:v}=t.getFieldValue(a.field),k=o(x.target).closest(".w2ui-map-container");a.type=="map"&&(C._order=[]),k.find(".w2ui-map.key").each(S=>{C._order.push(S.value)});let D=t.trigger("change",{target:a.field,field:a.field,originalEvent:x,value:{current:C,previous:_,original:v}});D.isCancelled!==!0&&(a.type=="map"&&(C._order=C._order.filter(S=>S!==""),delete C[""]),a.type=="array"&&(C=C.filter(S=>S!=="")),o(x.target).parent().find("input").val()==""&&(h=x.target),t.setValue(a.field,C),a.el.mapRefresh(C,g),D.finish())})}}(this,r),this.setFieldValue(r.field,this.getValue(r.name))}}return i.finish(),this.resize(),Date.now()-e}render(e){let t=Date.now(),i=this;typeof e=="string"&&(e=o(e).get(0));let s=this.trigger("render",{target:this.name,box:e??this.box});if(s.isCancelled===!0||(e!=null&&(this.unmount(),this.box=e),!this.isGenerated&&!this.formHTML)||!this.box)return;let l='<div class="w2ui-form-box">'+(this.header!==""?'<div class="w2ui-form-header">'+u.lang(this.header)+"</div>":"")+'    <div id="form_'+this.name+'_toolbar" class="w2ui-form-toolbar" style="display: none"></div>    <div id="form_'+this.name+'_tabs" class="w2ui-form-tabs" style="display: none"></div>'+this.formHTML+"</div>";if(o(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-form").html(l),o(this.box).length>0&&(o(this.box)[0].style.cssText+=this.style),u.bindEvents(o(this.box).find(".w2ui-eaction"),this),typeof this.toolbar.render!="function"&&(this.toolbar=new Z(u.extend({},this.toolbar,{name:this.name+"_toolbar",owner:this})),this.toolbar.on("click",function(n){let a=i.trigger("toolbar",{target:n.target,originalEvent:n});a.isCancelled!==!0&&a.finish()})),typeof this.toolbar=="object"&&typeof this.toolbar.render=="function"&&this.toolbar.render(o(this.box).find("#form_"+this.name+"_toolbar")[0]),typeof this.tabs.render!="function"&&(this.tabs=new ce(u.extend({},this.tabs,{name:this.name+"_tabs",owner:this,active:this.tabs.active})),this.tabs.on("click",function(n){i.goto(this.get(n.target,!0))})),typeof this.tabs=="object"&&typeof this.tabs.render=="function"&&(this.tabs.render(o(this.box).find("#form_"+this.name+"_tabs")[0]),this.tabs.active&&this.tabs.click(this.tabs.active)),s.finish(),this.resize(),(typeof this.url!="object"?this.url:this.url.get)&&this.recid!=null?this.request().catch(n=>this.refresh()):this.refresh(),this.last.observeResize=new ResizeObserver(()=>{this.resize()}),this.last.observeResize.observe(this.box),this.focus!=-1){let n=0,a=()=>{o(i.box).find("input, select, textarea").length>0?i.setFocus():(n++,n<20&&setTimeout(a,50))};a()}return Date.now()-t}unmount(){super.unmount(),this.tabs?.unmount?.(),this.toolbar?.unmount?.(),this.last.observeResize?.disconnect()}destroy(){let e=this.trigger("destroy",{target:this.name});e.isCancelled!==!0&&(this.tabs?.destroy?.(),this.toolbar?.destroy?.(),o(this.box).find("#form_"+this.name+"_tabs").length>0&&this.unmount(),this.last.observeResize?.disconnect(),delete N[this.name],e.finish())}setFocus(e){typeof e>"u"&&(e=this.focus);let t;if(u.isInt(e)){if(e<0)return;let i=o(this.box).find("div:not(.w2ui-field-helper) > input, select, textarea, div > label:nth-child(1) > [type=radio]").filter(":not(.file-input)");for(;i[e].offsetParent==null&&i.length>=e;)e++;i[e]&&(t=o(i[e]))}else typeof e=="string"&&(t=o(this.box).find(`[name='${e}']`));return t.length>0&&t.get(0).focus(),t}},ie=class extends Y{constructor(e,t){super(),typeof e=="string"&&t==null&&(t={type:e}),typeof e=="object"&&t==null&&(t=u.clone(e)),typeof e=="string"&&typeof t=="object"&&(t.type=e),t.type=String(t.type).toLowerCase(),this.el=t.el??null,this.selected=null,this.helpers={},this.type=t.type??"text",this.options=u.clone(t),this.onClick=t.onClick??null,this.onAdd=t.onAdd??null,this.onNew=t.onNew??null,this.onRemove=t.onRemove??null,this.onMouseEnter=t.onMouseEnter??null,this.onMouseLeave=t.onMouseLeave??null,this.onScroll=t.onScroll??null,this.tmp={},delete this.options.type,delete this.options.onClick,delete this.options.onMouseEnter,delete this.options.onMouseLeave,delete this.options.onScroll,this.el&&this.render(this.el)}render(e){if(!(e instanceof HTMLElement)){console.log("ERROR: Cannot init w2field on empty subject");return}e._w2field?e._w2field.reset():e._w2field=this,this.el=e,this.init()}init(){let e=this.options,t;if(!["INPUT","TEXTAREA"].includes(this.el.tagName.toUpperCase())){console.log("ERROR: w2field could only be applied to INPUT or TEXTAREA.",this.el);return}switch(this.type){case"text":case"int":case"float":case"money":case"currency":case"percent":case"alphanumeric":case"bin":case"hex":{t={min:null,max:null,step:1,autoFormat:!0,autoCorrect:!0,currencyPrefix:u.settings.currencyPrefix,currencySuffix:u.settings.currencySuffix,currencyPrecision:u.settings.currencyPrecision,decimalSymbol:u.settings.decimalSymbol,groupSymbol:u.settings.groupSymbol,arrow:!1,keyboard:!0,precision:null,prefix:"",suffix:""},this.options=u.extend({},t,e),e=this.options,e.numberRE=new RegExp("["+e.groupSymbol+"]","g"),e.moneyRE=new RegExp("["+e.currencyPrefix+e.currencySuffix+e.groupSymbol+"]","g"),e.percentRE=new RegExp("["+e.groupSymbol+"%]","g"),["text","alphanumeric","hex","bin"].includes(this.type)&&(e.arrow=!1,e.keyboard=!1);break}case"color":{let i=parseInt(getComputedStyle(this.el)["font-size"])||12;t={prefix:"#",suffix:`<div style="width: ${i}px; height: ${i}px; margin-top: -2px;
                                    position: relative; top: 50%; transform: translateY(-50%);">&#160;</div>`,arrow:!1,advanced:null,transparent:!0},this.options=u.extend({},t,e),e=this.options;break}case"date":{t={format:u.settings.dateFormat,keyboard:!0,autoCorrect:!0,start:null,end:null,blockDates:[],blockWeekdays:[],colored:{},btnNow:!0},this.options=u.extend({type:"date"},t,e),e=this.options,o(this.el).attr("placeholder")==null&&o(this.el).attr("placeholder",e.format);break}case"time":{t={format:u.settings.timeFormat,keyboard:!0,autoCorrect:!0,start:null,end:null,btnNow:!0,noMinutes:!1},this.options=u.extend({type:"time"},t,e),e=this.options,o(this.el).attr("placeholder")==null&&o(this.el).attr("placeholder",e.format);break}case"datetime":{t={format:u.settings.dateFormat+"|"+u.settings.timeFormat,keyboard:!0,autoCorrect:!0,start:null,end:null,startTime:null,endTime:null,blockDates:[],blockWeekdays:[],colored:{},btnNow:!0,noMinutes:!1},this.options=u.extend({type:"datetime"},t,e),e=this.options,o(this.el).attr("placeholder")==null&&o(this.el).attr("placeholder",e.placeholder||e.format);break}case"list":case"combo":{t={items:[],selected:{},prefix:"",suffix:"",openOnFocus:!1,icon:null,iconStyle:"",url:null,recId:null,recText:null,method:null,debounce:250,postData:{},minLength:1,cacheMax:250,maxDropHeight:350,maxDropWidth:null,minDropWidth:null,match:"begins",align:"both",altRows:!0,renderDrop:null,compare:null,filter:!0,hideSelected:!1,markSearch:!1,msgNoItems:"No matches",msgSearch:"Type to search...",onSearch:null,onRequest:null,onLoad:null,onError:null},typeof e.items=="function"&&(e._items_fun=e.items),e.items=u.normMenu.call(this,e.items),this.type==="list"&&(o(this.el).addClass("w2ui-select"),!u.isPlainObject(e.selected)&&Array.isArray(e.items)&&e.items.forEach(s=>{s&&s.id===e.selected&&(e.selected=u.clone(s))})),e=u.extend({},t,e);let i=["is","begins","contains","ends"];i.includes(e.match)||console.log(`ERROR: invalid value "${e.match}" for option.match. It should be one of following: ${i.join(", ")}.`),this.options=e,u.isPlainObject(e.selected)||(e.selected={}),this.selected=e.selected,o(this.el).attr("autocapitalize","off").attr("autocomplete","off").attr("autocorrect","off").attr("spellcheck","false"),e.selected.text!=null&&o(this.el).val(e.selected.text);break}case"enum":{t={items:[],selected:[],max:0,maxItemWidth:250,style:"",openOnFocus:!1,renderItem:null,onMouseEnter:null,onMouseLeave:null,onScroll:null,onClick:null,onAdd:null,onNew:null,onRemove:null,url:null,recId:null,recText:null,debounce:250,method:null,postData:{},minLength:1,cacheMax:250,match:"begins",align:"",altRows:!0,renderDrop:null,maxDropHeight:350,maxDropWidth:null,markSearch:!1,compare:null,filter:!0,hideSelected:!0,msgNoItems:"No matches",msgSearch:"Type to search...",onSearch:null,onRequest:null,onLoad:null,onError:null},e=u.extend({},t,e,{suffix:""}),typeof e.items=="function"&&(e._items_fun=e.items);let i=["is","begins","contains","ends"];i.includes(e.match)||console.log(`ERROR: invalid value "${e.match}" for option.match. It should be one of following: ${i.join(", ")}.`),e.items=u.normMenu.call(this,e.items),e.selected=u.normMenu.call(this,e.selected),this.options=e,Array.isArray(e.selected)||(e.selected=[]),this.selected=e.selected;break}case"file":{t={selected:[],max:0,maxSize:0,maxFileSize:0,maxItemWidth:250,maxDropHeight:350,maxDropWidth:null,readContent:!0,silent:!0,align:"both",altRows:!0,renderItem:null,style:"",onClick:null,onAdd:null,onRemove:null,onMouseEnter:null,onMouseLeave:null},e=u.extend({},t,e),this.options=e,Array.isArray(e.selected)||(e.selected=[]),this.selected=e.selected,o(this.el).attr("placeholder")==null&&o(this.el).attr("placeholder",u.lang("Attach files by dragging and dropping or Click to Select"));break}default:{console.log(`ERROR: field type "${this.type}" is not supported.`);break}}o(this.el).css("box-sizing","border-box").addClass("w2field w2ui-input").off(".w2field").on("change.w2field",i=>{this.change(i)}).on("click.w2field",i=>{this.click(i)}).on("focus.w2field",i=>{this.focus(i)}).on("blur.w2field",i=>{this.type!=="list"&&this.blur(i)}).on("keydown.w2field",i=>{this.keyDown(i)}).on("keyup.w2field",i=>{this.keyUp(i)}),this.addPrefix(),this.addSuffix(),this.addSearch(),this.addMultiSearch(),this.change(new Event("change"))}get(){let e;return["list","enum","file"].indexOf(this.type)!==-1?e=this.selected:e=o(this.el).val(),e}set(e,t){if(["list","enum","file"].indexOf(this.type)!==-1){if(this.type!=="list"&&t){Array.isArray(this.selected)||(this.selected=[]),this.selected.push(e);let i=j.get(this.el.id+"_menu");i&&(i.options.selected=this.selected),o(this.el).trigger("input").trigger("change")}else{e==null&&(e=[]);let i=this.type==="enum"&&!Array.isArray(e)?[e]:e;this.selected=i,o(this.el).trigger("input").trigger("change")}this.refresh()}else o(this.el).val(e)}setIndex(e,t){if(["list","enum"].indexOf(this.type)!==-1){let i=this.options.items;if(i&&i[e]){this.type=="list"&&(this.selected=i[e]),this.type=="enum"&&(t||(this.selected=[]),this.selected.push(i[e]));let s=j.get(this.el.id+"_menu");return s&&(s.options.selected=this.selected),o(this.el).trigger("input").trigger("change"),this.refresh(),!0}}return!1}refresh(){let e=this.options,t=Date.now(),i=getComputedStyle(this.el);if(this.type=="color"){let l=this.el.value;l.substr(0,1)!="#"&&l.substr(0,3)!="rgb"&&(l="#"+l),o(this.helpers.suffix).find(":scope > div").css("background-color",l)}if(this.type=="list"){if(this.helpers.prefix&&this.helpers.prefix.hide(),!this.helpers.search)return;this.selected==null&&e.icon?(e.prefix=`
                    <span class="w2ui-icon ${e.icon} "style="cursor: pointer; font-size: 14px;
                        display: inline-block; margin-top: -1px; color: #7F98AD; ${e.iconStyle}">
                    </span>`,this.addPrefix()):(e.prefix="",this.addPrefix());let l=o(this.helpers.search_focus),r=o(l[0].previousElementSibling);if(l.css({outline:"none"}),l.val()==="")if(l.css("opacity",0),r.css("opacity",0),this.selected?.id){let n=this.selected.text,a=this.findItemIndex(e.items,this.selected.id);n!=null&&o(this.el).val(u.lang(n)).data({selected:n,selectedIndex:a[0]})}else this.el.value="",o(this.el).removeData("selected selectedIndex");else l.css("opacity",1),r.css("opacity",1),o(this.el).val(""),setTimeout(()=>{this.helpers.prefix&&this.helpers.prefix.hide(),e.icon?(l.css("margin-left","17px"),o(this.helpers.search).find(".w2ui-icon-search").addClass("show-search")):(l.css("margin-left","0px"),o(this.helpers.search).find(".w2ui-icon-search").removeClass("show-search"))},1);o(this.el).prop("readOnly")||o(this.el).prop("disabled")?setTimeout(()=>{this.helpers.prefix&&o(this.helpers.prefix).css("opacity","0.6"),this.helpers.suffix&&o(this.helpers.suffix).css("opacity","0.6")},1):setTimeout(()=>{this.helpers.prefix&&o(this.helpers.prefix).css("opacity","1"),this.helpers.suffix&&o(this.helpers.suffix).css("opacity","1")},1)}let s=this.helpers.multi;if(["enum","file"].includes(this.type)&&s){let l="";Array.isArray(this.selected)&&this.selected.forEach((n,a)=>{n!=null&&(l+=`
                        <div class="li-item" index="${a}" style="max-width: ${parseInt(e.maxItemWidth)}px; ${n.style?n.style:""}">
                        ${typeof e.renderItem=="function"?e.renderItem(n,a,`<div class="w2ui-list-remove" index="${a}">&#160;&#160;</div>`):`
                               ${n.icon?`<span class="w2ui-icon ${n.icon}"></span>`:""}
                               <div class="w2ui-list-remove" index="${a}">&#160;&#160;</div>
                               ${(this.type==="enum"?n.text:n.name)??n.id??n}
                               ${n.size?`<span class="file-size"> - ${u.formatSize(n.size)}</span>`:""}
                            `}
                        </div>`)});let r=s.find(".w2ui-multi-items");if(e.style&&s.attr("style",s.attr("style")+";"+e.style),o(this.el).css("z-index","-1"),o(this.el).prop("readOnly")||o(this.el).prop("disabled")?setTimeout(()=>{s[0].scrollTop=0,s.addClass("w2ui-readonly").find(".li-item").css("opacity","0.9").parent().find(".li-search").hide().find("input").prop("readOnly",!0).closest(".w2ui-multi-items").find(".w2ui-list-remove").hide()},1):setTimeout(()=>{s.removeClass("w2ui-readonly").find(".li-item").css("opacity","1").parent().find(".li-search").show().find("input").prop("readOnly",!1).closest(".w2ui-multi-items").find(".w2ui-list-remove").show()},1),this.selected?.length>0&&o(this.el).attr("placeholder",""),s.find(".w2ui-enum-placeholder").remove(),r.find(".li-item").remove(),l!=="")r.prepend(l);else if(o(this.el).attr("placeholder")!=null&&s.find("input").val()===""){let n=u.stripSpaces(`
                    padding-top: ${i["padding-top"]};
                    padding-left: ${i["padding-left"]};
                    box-sizing: ${i["box-sizing"]};
                    line-height: ${i["line-height"]};
                    font-size: ${i["font-size"]};
                    font-family: ${i["font-family"]};
                `);s.prepend(`<div class="w2ui-enum-placeholder" style="${n}">${o(this.el).attr("placeholder")}</div>`)}s.off(".w2item").on("scroll.w2item",n=>{let a=this.trigger("scroll",{target:this.el,originalEvent:n});a.isCancelled!==!0&&(O.hide(this.el.id+"_preview"),a.finish())}).find(".li-item").on("click.w2item",n=>{let a=o(n.target).closest(".li-item"),h=a.attr("index"),d=this.selected[h];if(o(a).hasClass("li-search"))return;n.stopPropagation();let g;if(o(n.target).hasClass("w2ui-list-remove")){if(o(this.el).prop("readOnly")||o(this.el).prop("disabled")||(g=this.trigger("remove",{target:this.el,originalEvent:n,item:d}),g.isCancelled===!0))return;this.selected.splice(h,1),o(this.el).trigger("input").trigger("change"),o(n.target).remove()}else{if(g=this.trigger("click",{target:this.el,originalEvent:n.originalEvent,item:d}),g.isCancelled===!0)return;let c=d.tooltip;if(this.type==="file"&&(/image/i.test(d.type)&&(c=`
                                    <div class="w2ui-file-preview">
                                        <img src="${d.content?"data:"+d.type+";base64,"+d.content:""}"
                                            style="max-width: 300px">
                                    </div>`),c+=`
                                <div class="w2ui-file-info">
                                    <div class="file-caption">${u.lang("Name")}:</div>
                                    <div class="file-value">${d.name}</div>
                                    <div class="file-caption">${u.lang("Size")}:</div>
                                    <div class="file-value">${u.formatSize(d.size)}</div>
                                    <div class="file-caption">${u.lang("Type")}:</div>
                                    <div class="file-value file-type">${d.type}</div>
                                    <div class="file-caption">${u.lang("Modified")}:</div>
                                    <div class="file-value">${u.date(d.modified)}</div>
                                </div>`),c){let p=this.el.id+"_preview";O.show({name:p,anchor:a.get(0),html:c,hideOn:["doc-click"],class:""}).show(f=>{o(`#w2overlay-${p} img`).on("load",function(w){let b=this.clientWidth,y=this.clientHeight;b<300&y<300||(b>=y&&b>300&&o(this).css("width","300px"),b<y&&y>300&&o(this).css("height","300px"))}).on("error",function(w){this.style.display="none"})})}g.finish()}}).on("mouseenter.w2item",n=>{let a=o(n.target).closest(".li-item");if(o(a).hasClass("li-search"))return;let h=this.selected[o(n.target).attr("index")],d=this.trigger("mouseEnter",{target:this.el,originalEvent:n,item:h});d.isCancelled!==!0&&d.finish()}).on("mouseleave.w2item",n=>{let a=o(n.target).closest(".li-item");if(o(a).hasClass("li-search"))return;let h=this.selected[o(n.target).attr("index")],d=this.trigger("mouseLeave",{target:this.el,originalEvent:n,item:h});d.isCancelled!==!0&&d.finish()}),this.type==="enum"?this.helpers.multi.find("input").css({width:"15px"}):this.helpers.multi.find(".li-search").hide(),this.resize()}return Date.now()-t}resize(){let e=this.el.clientWidth,t=getComputedStyle(this.el),i=this.helpers.search,s=this.helpers.multi,l=this.helpers.suffix,r=this.helpers.prefix;i&&o(i).css("width",e),s&&o(s).css("width",e-parseInt(t["margin-left"],10)-parseInt(t["margin-right"],10)),l&&this.addSuffix(),r&&this.addPrefix();let n=this.helpers.multi;if(["enum","file"].includes(this.type)&&n){o(this.el).css("height","");let a=o(n).find(":scope div.w2ui-multi-items").get(0).clientHeight+5;a<20&&(a=20),a>this.tmp["max-height"]&&(a=this.tmp["max-height"]),a<this.tmp["min-height"]&&(a=this.tmp["min-height"]);let h=u.getSize(this.el,"height")-2;h>a&&(a=h),o(n).css({height:a+"px",overflow:a==this.tmp["max-height"]?"auto":"hidden"}),o(n).css("height",a+"px"),o(this.el).css({height:a+"px"})}this.tmp.current_width=e}reset(){this.tmp!=null&&(o(this.el).css("height",""),Array("padding-left","padding-right","background-color","border-color").forEach(e=>{this.tmp&&this.tmp["old-"+e]!=null&&(o(this.el).css(e,this.tmp["old-"+e]),delete this.tmp["old-"+e])}),clearInterval(this.tmp.sizeTimer)),o(this.el).val(this.clean(o(this.el).val())).removeClass("w2field w2ui-input").removeData("selected selectedIndex").off(".w2field"),Object.keys(this.helpers).forEach(e=>{o(this.helpers[e]).remove()}),this.helpers={}}clean(e){if(typeof e=="number")return e;let t=this.options;return e=String(e).trim(),["int","float","money","currency","percent"].includes(this.type)&&(typeof e=="string"&&(t.autoFormat&&(["money","currency"].includes(this.type)&&(e=String(e).replace(t.moneyRE,"")),this.type==="percent"&&(e=String(e).replace(t.percentRE,"")),["int","float"].includes(this.type)&&(e=String(e).replace(t.numberRE,""))),e=e.replace(/\s+/g,"").replace(new RegExp(t.groupSymbol,"g"),"").replace(t.decimalSymbol,".")),e!==""&&u.isFloat(e)?e=Number(e):e=""),e}format(e){let t=this.options;if(t.autoFormat&&e!==""){switch(this.type){case"money":case"currency":e=u.formatNumber(e,t.currencyPrecision,!0),e!==""&&(e=t.currencyPrefix+e+t.currencySuffix);break;case"percent":e=u.formatNumber(e,t.precision,!0),e!==""&&(e+="%");break;case"float":e=u.formatNumber(e,t.precision,!0);break;case"int":e=u.formatNumber(e,0,!0);break}let i=parseInt(1e3).toLocaleString(u.settings.locale,{useGrouping:!0}).slice(1,2);i!==this.options.groupSymbol&&(e=e.replaceAll(i,this.options.groupSymbol))}return e}change(e){if(["int","float","money","currency","percent"].indexOf(this.type)!==-1){let t=o(this.el).val(),i=this.format(this.clean(o(this.el).val()));if(t!==""&&t!=i)return o(this.el).val(i),e.stopPropagation(),e.preventDefault(),!1}if(this.type==="color"){let t=o(this.el).val();if(t.substr(0,3).toLowerCase()!=="rgb"){t="#"+t;let s=o(this.el).val().length;s!==8&&s!==6&&s!==3&&(t="")}let i=o(this.el).get(0).nextElementSibling;o(i).find("div").css("background-color",t),o(this.el).hasClass("has-focus")&&this.updateOverlay()}if(["list","enum","file"].indexOf(this.type)!==-1&&this.refresh(),["date","time","datetime"].indexOf(this.type)!==-1){let t=parseInt(this.el.value);u.isInt(this.el.value)&&t>3e3&&(this.type==="time"&&(t=u.formatTime(new Date(t),this.options.format)),this.type==="date"&&(t=u.formatDate(new Date(t),this.options.format)),this.type==="datetime"&&(t=u.formatDateTime(new Date(t),this.options.format)),o(this.el).val(t).trigger("input").trigger("change"))}}click(e){if(["list","combo","enum"].includes(this.type)&&(o(this.el).hasClass("has-focus")||this.focus(e),this.type=="list"||this.type=="combo")){if(!this.tmp.openedOnFocus){let t=this.el.id+"_menu";j.get(t)?.displayed?j.hide(t):this.updateOverlay()}delete this.tmp.openedOnFocus,this.type=="list"&&e.stopPropagation()}["date","time","datetime","color"].includes(this.type)&&this.updateOverlay()}focus(e){if(this.type=="list"&&document.activeElement==this.el){this.helpers.search_focus.focus();return}if(["color","date","time","datetime"].indexOf(this.type)!==-1){if(o(this.el).prop("readOnly")||o(this.el).prop("disabled"))return;this.updateOverlay()}if(["list","combo","enum"].indexOf(this.type)!==-1){if(o(this.el).prop("readOnly")||o(this.el).prop("disabled")){o(this.el).addClass("has-focus");return}if(typeof this.options._items_fun=="function"&&(this.options.items=u.normMenu.call(this,this.options._items_fun)),this.helpers.search){let t=this.helpers.search_focus;t.value="",t.select()}if(this.type=="enum"){let t=o(this.el.previousElementSibling).find(".li-search input").get(0);document.activeElement!==t&&t.focus()}this.resize(),e.showMenu!==!1&&(this.options.openOnFocus!==!1||o(this.el).hasClass("has-focus"))&&!this.tmp.overlay?.overlay?.displayed&&setTimeout(()=>{this.tmp.openedOnFocus=!0,this.updateOverlay()},0)}if(this.type=="file"){let t=o(this.el).get(0).previousElementSibling;o(t).addClass("has-focus")}o(this.el).addClass("has-focus")}blur(e){let t=o(this.el).val().trim();if(o(this.el).removeClass("has-focus"),["int","float","money","currency","percent"].includes(this.type)&&t!==""){let i=t,s="";if(!this.isStrValid(t))i="";else{let l=this.clean(t);this.options.min!=null&&l<this.options.min&&(i=this.options.min,s=`Should be >= ${this.options.min}`),this.options.max!=null&&l>this.options.max&&(i=this.options.max,s=`Should be <= ${this.options.max}`)}this.options.autoCorrect&&(o(this.el).val(i).trigger("input").trigger("change"),s&&(O.show({name:this.el.id+"_error",anchor:this.el,html:s}),setTimeout(()=>{O.hide(this.el.id+"_error")},3e3)))}if(["date","time","datetime"].includes(this.type)&&this.options.autoCorrect&&t!==""){let i=this.type=="date"?u.isDate:this.type=="time"?u.isTime:u.isDateTime;(!re.inRange(this.el.value,this.options)||!i.bind(u)(this.el.value,this.options.format))&&o(this.el).val("").trigger("input").trigger("change")}if(this.type==="enum"&&o(this.helpers.multi).find("input").val("").css("width","15px"),this.type=="file"){let i=this.el.previousElementSibling;o(i).removeClass("has-focus")}this.type==="list"&&(this.el.value=this.selected?.text??"")}keyDown(e,t){let i=this.options,s=e.keyCode||t&&t.keyCode,l=!1,r,n,a,h,d,g;if(["int","float","money","currency","percent","hex","bin","color","alphanumeric"].includes(this.type)&&!e.metaKey&&!e.ctrlKey&&!e.altKey&&!this.isStrValid(e.key??"1",!0)&&![9,8,13,27,37,38,39,40,46].includes(e.keyCode))return e.preventDefault(),e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,!1;if(["int","float","money","currency","percent"].includes(this.type)){if(!i.keyboard||o(this.el).prop("readOnly")||o(this.el).prop("disabled"))return;switch(r=parseFloat(o(this.el).val().replace(i.moneyRE,""))||0,n=i.step,(e.ctrlKey||e.metaKey)&&(n=i.step*10),s){case 38:if(e.shiftKey)break;d=r+n<=i.max||i.max==null?Number((r+n).toFixed(12)):i.max,o(this.el).val(d).trigger("input").trigger("change"),l=!0;break;case 40:if(e.shiftKey)break;d=r-n>=i.min||i.min==null?Number((r-n).toFixed(12)):i.min,o(this.el).val(d).trigger("input").trigger("change"),l=!0;break}l&&(e.preventDefault(),this.moveCaret2end())}if(["date","datetime"].includes(this.type)){if(!i.keyboard||o(this.el).prop("readOnly")||o(this.el).prop("disabled"))return;let c=(this.type=="date"?u.isDate:u.isDateTime).bind(u),p=(this.type=="date"?u.formatDate:u.formatDateTime).bind(u);switch(a=24*60*60*1e3,n=1,(e.ctrlKey||e.metaKey)&&(n=10),h=c(o(this.el).val(),i.format,!0),h||(h=new Date,a=0),s){case 38:if(e.shiftKey)break;n==10?h.setMonth(h.getMonth()+1):h.setTime(h.getTime()+a),g=p(h.getTime(),i.format),o(this.el).val(g).trigger("input").trigger("change"),l=!0;break;case 40:if(e.shiftKey)break;n==10?h.setMonth(h.getMonth()-1):h.setTime(h.getTime()-a),g=p(h.getTime(),i.format),o(this.el).val(g).trigger("input").trigger("change"),l=!0;break}l&&(e.preventDefault(),this.moveCaret2end(),this.updateOverlay())}if(this.type==="time"){if(!i.keyboard||o(this.el).prop("readOnly")||o(this.el).prop("disabled"))return;n=e.ctrlKey||e.metaKey?60:1,r=o(this.el).val();let c=re.str2min(r)||re.str2min(new Date().getHours()+":"+(new Date().getMinutes()-1));switch(s){case 38:if(e.shiftKey)break;c+=n,l=!0;break;case 40:if(e.shiftKey)break;c-=n,l=!0;break}l&&(e.preventDefault(),o(this.el).val(re.min2str(c)).trigger("input").trigger("change"),this.moveCaret2end())}if(["list","enum"].includes(this.type))switch(s){case 8:case 46:if(this.type=="list")o(this.helpers.search_focus).val()==""&&(this.selected=null,j.hide(this.el.id+"_menu"),o(this.el).val("").trigger("input").trigger("change"));else if(o(this.helpers.multi).find("input").val()==""){j.hide(this.el.id+"_menu"),this.selected.pop();let p=j.get(this.el.id+"_menu");p&&(p.options.selected=this.selected),this.refresh()}break;case 9:case 16:break;case 27:j.hide(this.el.id+"_menu"),this.refresh();break;default:}}keyUp(e){if(this.type=="list"){let t=o(this.helpers.search_focus);t.val()!==""?o(this.el).attr("placeholder",""):o(this.el).attr("placeholder",this.tmp.pholder),e.keyCode==13&&setTimeout(()=>{t.val(""),j.hide(this.el.id+"_menu"),this.refresh()},1),[38,40].includes(e.keyCode)&&!this.tmp.overlay?.overlay?.displayed&&this.updateOverlay(),this.refresh()}if(this.type=="combo"&&(![9,16,27].includes(e.keyCode)&&this.options.openOnFocus!==!0&&this.updateOverlay(),[38,40].includes(e.keyCode)&&!this.tmp.overlay?.overlay?.displayed&&this.updateOverlay()),this.type=="enum"){let t=this.helpers.multi.find("input"),i=getComputedStyle(t.get(0)),s=u.getStrWidth(t.val(),`font-family: ${i["font-family"]}; font-size: ${i["font-size"]};`);t.css({width:s+15+"px"}),this.resize(),[38,40].includes(e.keyCode)&&!this.tmp.overlay?.overlay?.displayed&&this.updateOverlay()}}findItemIndex(e,t,i){let s=[];if(i||(i=[]),["list","combo","enum"].includes(this.type)&&this.options.url){let l=j.get(this.el.id+"_menu");l&&(e=l.options.items,this.options.items=e)}return e.forEach((l,r)=>{l.id===t&&(s=i.concat([r]),this.options.index=[r]),s.length==0&&l.items&&l.items.length>0&&(i.push(r),s=this.findItemIndex(l.items,t,i),i.pop())}),s}updateOverlay(e){let t=this.options,i;if(this.type==="color"){if(o(this.el).prop("readOnly")||o(this.el).prop("disabled"))return;Ne.show(u.extend({name:this.el.id+"_color",anchor:this.el,transparent:t.transparent,advanced:t.advanced,color:this.el.value,liveUpdate:!0},this.options)).select(s=>{let l=s.detail.color;o(this.el).val(l).trigger("input").trigger("change")}).liveUpdate(s=>{let l=s.detail.color;o(this.helpers.suffix).find(":scope > div").css("background-color","#"+l)})}if(["list","combo","enum"].includes(this.type)){let s=this.el,l=this.el;if(this.type==="enum"&&(s=this.helpers.multi.get(0),l=o(s).find("input").get(0)),this.type==="list"){let r=this.selected;if(u.isPlainObject(r)&&Object.keys(r).length>0){let n=this.findItemIndex(t.items,r.id);n.length>0&&(t.index=n)}l=this.helpers.search_focus}o(this.el).hasClass("has-focus")&&!this.el.readOnly&&!this.el.disabled&&(i=u.extend({},t,{name:this.el.id+"_menu",anchor:l,selected:this.selected,search:!1,render:t.renderDrop,anchorClass:"",offsetY:5,maxHeight:t.maxDropHeight,maxWidth:t.maxDropWidth,minWidth:t.minDropWidth}),this.tmp.overlay=j.show(i).select(r=>{if(["list","combo"].includes(this.type))this.selected=r.detail.item,o(l).val(""),o(this.el).val(this.selected.text).trigger("input").trigger("change"),this.focus({showMenu:!1});else{let n=this.selected,a=r.detail?.item;if(a){let h=this.trigger("add",{target:this.el,item:a,originalEvent:r});if(h.isCancelled===!0)return;n.length>=t.max&&t.max>0&&n.pop(),delete a.hidden,n.push(a),o(this.el).trigger("input").trigger("change"),o(this.helpers.multi).find("input").val("");let d=j.get(this.el.id+"_menu");d&&(d.options.selected=this.selected),h.finish()}}}))}if(["date","time","datetime"].includes(this.type)){if(o(this.el).prop("readOnly")||o(this.el).prop("disabled"))return;re.show(u.extend({name:this.el.id+"_date",anchor:this.el,value:this.el.value},this.options)).select(s=>{let l=s.detail.date;l!=null&&o(this.el).val(l).trigger("input").trigger("change")})}}isStrValid(e,t){let i=!0;switch(this.type){case"int":t&&["-",this.options.groupSymbol].includes(e)?i=!0:i=u.isInt(e.replace(this.options.numberRE,""));break;case"percent":e=e.replace(/%/g,"");case"float":t&&["-","",this.options.decimalSymbol,this.options.groupSymbol].includes(e)?i=!0:i=u.isFloat(e.replace(this.options.numberRE,""));break;case"money":case"currency":t&&["-",this.options.decimalSymbol,this.options.groupSymbol,this.options.currencyPrefix,this.options.currencySuffix].includes(e)?i=!0:i=u.isFloat(e.replace(this.options.moneyRE,""));break;case"bin":i=u.isBin(e);break;case"color":case"hex":i=u.isHex(e);break;case"alphanumeric":i=u.isAlphaNumeric(e);break}return i}addPrefix(){if(!this.options.prefix)return;let e,t=getComputedStyle(this.el);this.tmp["old-padding-left"]==null&&(this.tmp["old-padding-left"]=t["padding-left"]),this.helpers.prefix&&o(this.helpers.prefix).remove(),o(this.el).before(`<div class="w2ui-field-helper">${this.options.prefix}</div>`),e=o(this.el).get(0).previousElementSibling,o(e).css({color:t.color,"font-family":t["font-family"],"font-size":t["font-size"],height:this.el.clientHeight+"px","padding-top":parseInt(t["padding-top"],10)+1+"px","padding-bottom":parseInt(t["padding-bottom"],10)-1+"px","padding-left":this.tmp["old-padding-left"],"padding-right":0,"margin-top":parseInt(t["margin-top"],10)+"px","margin-bottom":parseInt(t["margin-bottom"],10)+"px","margin-left":t["margin-left"],"margin-right":0,"z-index":1,display:"flex","align-items":"center"}),o(this.el).css("padding-left",e.clientWidth+"px !important"),this.helpers.prefix=e}addSuffix(){if(!this.options.suffix&&!this.options.arrow)return;let e,t=this,i=getComputedStyle(this.el);this.tmp["old-padding-right"]==null&&(this.tmp["old-padding-right"]=i["padding-right"]);let s=parseInt(i["padding-right"]||0);this.options.arrow&&(this.helpers.arrow&&o(this.helpers.arrow).remove(),o(this.el).after('<div class="w2ui-field-helper" style="border: 1px solid transparent">&#160;    <div class="w2ui-field-up" type="up">        <div class="arrow-up" type="up"></div>    </div>    <div class="w2ui-field-down" type="down">        <div class="arrow-down" type="down"></div>    </div></div>'),e=o(this.el).get(0).nextElementSibling,o(e).css({color:i.color,"font-family":i["font-family"],"font-size":i["font-size"],height:this.el.clientHeight+"px",padding:0,"margin-top":parseInt(i["margin-top"],10)+1+"px","margin-bottom":0,"border-left":"1px solid silver",width:"16px",transform:"translateX(-100%)"}).on("mousedown",function(l){o(l.target).hasClass("arrow-up")&&t.keyDown(l,{keyCode:38}),o(l.target).hasClass("arrow-down")&&t.keyDown(l,{keyCode:40})}),s+=e.clientWidth,o(this.el).css("padding-right",s+"px !important"),this.helpers.arrow=e),this.options.suffix!==""&&(this.helpers.suffix&&o(this.helpers.suffix).remove(),o(this.el).after(`<div class="w2ui-field-helper">${this.options.suffix}</div>`),e=o(this.el).get(0).nextElementSibling,o(e).css({color:i.color,"font-family":i["font-family"],"font-size":i["font-size"],height:this.el.clientHeight+"px","padding-top":i["padding-top"],"padding-bottom":i["padding-bottom"],"padding-left":0,"padding-right":i["padding-right"],"margin-top":parseInt(i["margin-top"],10)+2+"px","margin-bottom":parseInt(i["margin-bottom"],10)+1+"px",transform:"translateX(-100%)"}),o(this.el).css("padding-right",e.clientWidth+"px !important"),this.helpers.suffix=e)}addSearch(){if(this.type!=="list")return;this.helpers.search&&o(this.helpers.search).remove();let e=parseInt(o(this.el).attr("tabIndex"));!isNaN(e)&&e!==-1&&(this.tmp["old-tabIndex"]=e),this.tmp["old-tabIndex"]&&(e=this.tmp["old-tabIndex"]),(e==null||isNaN(e))&&(e=0);let t="";o(this.el).attr("id")!=null&&(t='id="'+o(this.el).attr("id")+'_search"');let i=`
            <div class="w2ui-field-helper">
                <span class="w2ui-icon w2ui-icon-search"></span>
                <input ${t} type="text" tabIndex="${e}" autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"/>
            </div>`;o(this.el).attr("tabindex",-1).before(i);let s=o(this.el).get(0).previousElementSibling;this.helpers.search=s,this.helpers.search_focus=o(s).find("input").get(0);let l=getComputedStyle(this.el);o(s).css({width:this.el.clientWidth+"px","margin-top":l["margin-top"],"margin-left":l["margin-left"],"margin-bottom":l["margin-bottom"],"margin-right":l["margin-right"]}).find("input").css({cursor:"default",width:"100%",opacity:1,padding:l.padding,margin:l.margin,border:"1px solid transparent","background-color":"transparent"}),o(s).find("input").off(".helper").on("focus.helper",r=>{o(r.target).val(""),this.tmp.pholder=o(this.el).attr("placeholder")??"",this.focus(r),r.stopPropagation()}).on("blur.helper",r=>{o(r.target).val(""),this.tmp.pholder!=null&&o(this.el).attr("placeholder",this.tmp.pholder),this.blur(r),r.stopPropagation()}).on("keydown.helper",r=>{this.keyDown(r)}).on("keyup.helper",r=>{this.keyUp(r)}),o(s).on("click",r=>{o(r.target).find("input").focus()})}addMultiSearch(){if(!["enum","file"].includes(this.type))return;o(this.helpers.multi).remove();let e="",t=getComputedStyle(this.el),i=u.stripSpaces(`
            margin-top: 0px;
            margin-bottom: 0px;
            margin-left: ${t["margin-left"]};
            margin-right: ${t["margin-right"]};
            width: ${u.getSize(this.el,"width")-parseInt(t["margin-left"],10)-parseInt(t["margin-right"],10)}px;
        `);if(this.tmp["min-height"]==null){let n=this.tmp["min-height"]=parseInt((t["min-height"]!="none"?t["min-height"]:0)||0),a=parseInt(t.height);this.tmp["min-height"]=Math.max(n,a)}this.tmp["max-height"]==null&&t["max-height"]!="none"&&(this.tmp["max-height"]=parseInt(t["max-height"]));let s="";o(this.el).attr("id")!=null&&(s=`id="${o(this.el).attr("id")}_search"`);let l=parseInt(o(this.el).attr("tabIndex"));!isNaN(l)&&l!==-1&&(this.tmp["old-tabIndex"]=l),this.tmp["old-tabIndex"]&&(l=this.tmp["old-tabIndex"]),(l==null||isNaN(l))&&(l=0),this.type==="enum"&&(e=`
            <div class="w2ui-field-helper w2ui-list" style="${i}">
                <div class="w2ui-multi-items">
                    <div class="li-search">
                        <input ${s} type="text" autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"
                            tabindex="${l}"
                            ${o(this.el).prop("readOnly")?"readonly":""}
                            ${o(this.el).prop("disabled")?"disabled":""}>
                    </div>
                </div>
            </div>`),this.type==="file"&&(e=`
            <div class="w2ui-field-helper w2ui-list" style="${i}">
                <div class="w2ui-multi-file">
                    <input name="attachment" class="file-input" type="file" tabindex="-1"'
                        style="width: 100%; height: 100%; opacity: 0" title=""
                        ${this.options.max!==1?"multiple":""}
                        ${o(this.el).prop("readOnly")||o(this.el).prop("disabled")?"disabled":""}
                        ${o(this.el).attr("accept")?' accept="'+o(this.el).attr("accept")+'"':""}>
                </div>
                <div class="w2ui-multi-items">
                    <div class="li-search" style="display: none">
                        <input ${s} type="text" autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"
                            tabindex="${l}"
                            ${o(this.el).prop("readOnly")?"readonly":""}
                            ${o(this.el).prop("disabled")?"disabled":""}>
                    </div>
                </div>
            </div>`),this.tmp["old-background-color"]=t["background-color"],this.tmp["old-border-color"]=t["border-color"],o(this.el).before(e).css({"border-color":"transparent","background-color":"transparent"});let r=o(this.el.previousElementSibling);this.helpers.multi=r,o(this.el).attr("tabindex",-1),r.on("click",n=>{this.focus(n)}),r.find("input:not(.file-input)").on("click",n=>{this.click(n)}).on("focus",n=>{this.focus(n)}).on("blur",n=>{this.blur(n)}).on("keydown",n=>{this.keyDown(n)}).on("keyup",n=>{this.keyUp(n)}),this.type==="file"&&r.find("input.file-input").off(".drag").on("click.drag",n=>{n.stopPropagation(),!(o(this.el).prop("readOnly")||o(this.el).prop("disabled"))&&this.focus(n)}).on("dragenter.drag",n=>{o(this.el).prop("readOnly")||o(this.el).prop("disabled")||r.addClass("w2ui-file-dragover")}).on("dragleave.drag",n=>{o(this.el).prop("readOnly")||o(this.el).prop("disabled")||r.removeClass("w2ui-file-dragover")}).on("drop.drag",n=>{if(o(this.el).prop("readOnly")||o(this.el).prop("disabled"))return;r.removeClass("w2ui-file-dragover"),Array.from(n.dataTransfer.files).forEach(h=>{this.addFile(h)}),this.focus(n),n.preventDefault(),n.stopPropagation()}).on("dragover.drag",n=>{n.preventDefault(),n.stopPropagation()}).on("change.drag",n=>{typeof n.target.files<"u"&&Array.from(n.target.files).forEach(a=>{this.addFile(a)}),this.focus(n)}),this.refresh()}addFile(e){let t=this.options,i=this.selected,s={name:e.name,type:e.type,modified:e.lastModifiedDate,size:e.size,content:null,file:e},l=0,r=0,n=[];Array.isArray(i)&&i.forEach(h=>{h.name==e.name&&h.size==e.size&&n.push(u.lang('The file "${name}" (${size}) is already added.',{name:e.name,size:u.formatSize(e.size)})),l+=h.size,r++}),t.maxFileSize!==0&&s.size>t.maxFileSize&&n.push(u.lang("Maximum file size is ${size}",{size:u.formatSize(t.maxFileSize)})),t.maxSize!==0&&l+s.size>t.maxSize&&n.push(u.lang("Maximum total size is ${size}",{size:u.formatSize(t.maxSize)})),t.max!==0&&r>=t.max&&n.push(u.lang("Maximum number of files is ${count}",{count:t.max}));let a=this.trigger("add",{target:this.el,file:s,total:r,totalSize:l,errors:n});if(a.isCancelled!==!0){if(t.silent!==!0&&n.length>0){O.show({anchor:this.el,html:"Errors: "+n.join("<br>")}),console.log("ERRORS (while adding files): ",n);return}if(i.push(s),typeof FileReader<"u"&&t.readContent===!0){let h=new FileReader,d=this;h.onload=function(){return function(p){let f=p.target.result,m=f.indexOf(",");s.content=f.substr(m+1),d.refresh(),o(d.el).trigger("input").trigger("change"),a.finish()}}(),h.readAsDataURL(e)}else this.refresh(),o(this.el).trigger("input").trigger("change"),a.finish()}}moveCaret2end(){setTimeout(()=>{this.el.setSelectionRange(this.el.value.length,this.el.value.length)},0)}};var ke=class extends Y{constructor(e){super(),this.modules=e||{},this.routes={},this.routeRE={},this.verbose=!0,this.onAdd=null,this.onRemvoe=null,this.onRoute=null,window.addEventListener?window.addEventListener("hashchange",this.process.bind(this),!1):window.attachEvent("onhashchange",this.process.bind(this))}init(e){this.get()===""?this.go(e):this.process()}add(e,t){let i=this,s;return typeof e=="object"?(Object.keys(e).forEach(l=>{let r=("/"+l).replace(/\/{2,}/g,"/");this.routes[r]=e[l]}),i):(e=("/"+e).replace(/\/{2,}/g,"/"),typeof i.trigger=="function"&&(s=i.trigger("add",{target:"self",route:e,handler:t}),s.isCancelled===!0)?!1:(this.routes[e]=t,typeof i.trigger=="function"&&s.finish(),i))}remove(e){let t=this,i;return e=("/"+e).replace(/\/{2,}/g,"/"),typeof t.trigger=="function"&&(i=t.trigger("remove",{target:"self",route:e}),i.isCancelled===!0)?!1:(delete this.routes[e],delete this.routeRE[e],typeof t.trigger=="function"&&i.finish(),t)}go(e){let t=this;return e=("/"+e).replace(/\/{2,}/g,"/"),window.history.replaceState({},document.title,"#"+e),this.process(),t}set(e){let t=this;return e=("/"+e).replace(/\/{2,}/g,"/"),window.history.replaceState({},document.title,"#"+e),t}get(){return window.location.hash.substr(1).replace(/\/{2,}/g,"/")}info(){let e=[],t=window.location.hash.substr(1).replace(/\/{2,}/g,"/");return t===""&&(t="/"),Object.keys(this.routeRE).forEach(i=>{let s={},l=this.routeRE[i].path.exec(t);if(l!=null){let r=1;for(let n in this.routeRE[i].keys)s[this.routeRE[i].keys[n].name]=l[r],r++;e.push({name:i,path:t,params:s})}}),e}list(){this.prepare();let e={};return Object.keys(this.routes).forEach(t=>{let i=this.routeRE[t].keys,s=[];Object.keys(i).forEach(l=>{s.push(i[l].name)}),e[t]=s}),e}process(){this.prepare();let e=this,t=window.location.hash.substr(1).replace(/\/{2,}/g,"/");t===""&&(t="/");let i=!1,s=!1,l=!1;if(Object.keys(this.routeRE).forEach(r=>{let n={},a=this.routeRE[r].path.exec(t),h;if(a!=null){i=!0,!s&&r.indexOf("*")===-1&&r.indexOf("/:")===-1&&(s=!0);let d=1;for(let c in this.routeRE[r].keys)n[this.routeRE[r].keys[c].name]=a[d],d++;if(typeof e.trigger=="function"&&(h=e.trigger("route",{target:"self",route:r,params:n}),h.isCancelled===!0))return!1;this.routes&&typeof this.routes[r]=="function"&&this.routes[r]({name:r,path:t,params:n},n),typeof e.trigger=="function"&&h.finish();let g=window.location.hash.substr(1).replace(/\/{2,}/g,"/");if(t!==g)return}}),s||Object.keys(this.modules).forEach(r=>{let n={route:r,path:e.modules[r]},a=n.route;a!=null&&(typeof a=="string"&&(a=[a]),Array.isArray(a)&&a.forEach(d=>{h(d)}));function h(d){if(e.routeRE=e.routeRE||{},e.routeRE[d]==null&&(e.routeRE[d]=e.prepare(d)),!n.ready&&d&&e.routeRE[d].path.exec(t)){let g=!1;if(document.querySelectorAll("script").forEach(c=>{c.type==="module"&&c.path===n.path&&(g=!0)}),!g){l=!0;let c="?"+new Date().getTime(),p=document.createElement("script");p.type="module",p.src=n.path+c,p.path=n.path+c;let f=document.createAttribute("crossorigin");f.value="use-credentials",p.setAttributeNode(f),p.onload=m=>{e.go(e.get())},p.onerror=m=>{let w=e.trigger("error",{target:"self",hash:t,originalEvent:m,404:!0});if(w.isCancelled===!0)return!1;w.finish()},e.verbose&&console.log(`ROUTER: Auto Load Module "${n.path}" for path "${n.route}"`),document.head.appendChild(p)}}}}),!l&&!i){let r=e.trigger("error",{target:"self",hash:t});if(r.isCancelled===!0)return!1;r.finish()}!l&&e.verbose&&(s||console.log(`ROUTER: Exact route for "${t}" not found`),i||console.log(`ROUTER: Wild card route for "${t}" not found`))}prepare(e){if(e!=null)return t(e);for(let i in this.routes)this.routeRE[i]||(this.routeRE[i]=t(i));function t(i){let s=[],l=i.replace(/\/\(/g,"(?:/").replace(/\+/g,"__plus__").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,(r,n,a,h,d,g)=>(s.push({name:h,optional:!!g}),n=n||"",""+(g?"":n)+"(?:"+(g?n:"")+(a||"")+(d||a&&"([^/.]+?)"||"([^/]+?)")+")"+(g||""))).replace(/([/.])/g,"\\$1").replace(/__plus__/g,"(.+)").replace(/\*/g,"(.*)");return{path:new RegExp("^"+l+"$","i"),keys:s}}}},je=ke;var $e=class{constructor(e){this.clear(),e&&this.set(e)}clear(){this.userInfo=null}set(e){this.userInfo=e}get(){return this.userInfo}isLoggedIn(e){return this.getUserID()===e}getUserID(){return this.userInfo?parseInt(this.userInfo.userid):0}getUserName(){return this.userInfo?this.userInfo.name:""}hasRole(e){if(e=parseInt(e),e===0)return!0;if(this.getUserID()===0||!this.userInfo.roles)return!1;for(let t=0;t<this.userInfo.roles.length;++t)if(parseInt(this.userInfo.roles[t].roleid)===e)return!0;return!1}isSessionActive(){return this.getUserID()===0?!1:this.userInfo?.session?.status==="active"&&this.userInfo.session.remained_time>300}},He=$e;var Pe=async(I,e)=>new Promise((t,i)=>{fetch(I).catch(s).then(l=>{if(l?.status!==200){l&&s(l);return}l.json().catch(s).then(r=>{console.log(r),typeof e=="function"&&e(r),t(r)})});function s(l){l.name!=="AbortError"&&(l.status&&l.status!==200?console.log(l.status+": "+l.statusText):console.log("ERROR: Server request failed.",l,". "),i(l))}}),Je=async(I,e,t)=>{typeof e>"u"&&(e={});let i=new Request(I,{method:"GET",cache:"no-cache"});return Pe(i).then(s=>typeof s.error>"u"?(typeof t=="function"&&t(s),s):[])},Qe=async(I,e,t)=>{let i=new Request(I,{method:"GET",cache:"no-cache"});return fetch(i).then(s=>s.text()).then(s=>{if(s.indexOf("data:")!==-1){let l=typeof e=="string"?o(e).get(0):e;if(e){let r=new Image;r.width=l.width,r.height=l.height,r.class=l.class,r.style=l.style,r.id=l.id,r.src=s,l.replaceWith(r),typeof t=="function"&&t()}}})},K={doAjax:Pe,getItems:Je,loadImg:Qe};var Se=class{constructor(e){this.context=e,this.userInfo=new He}getUserInfo(){return this.userInfo}logout(e){this.userInfo.clear(),K.doAjax(this.context+"logout").then(t=>{typeof e=="function"&&e(t?.error===!1)}).catch(console.log)}getSession(e,t){this.userInfo.clear(),K.doAjax(this.context+"session").then(i=>{i?.user&&(i.user.pref=i.pref,i.user.type=i.type,i.user.roles=i.roles,i.user.session=i.session,this.userInfo.set(i.user)),typeof t=="function"&&t(this.userInfo)}).catch(i=>{typeof t=="function"&&e&&t(i.message)})}},Ue=Se;var Te=class{constructor(e){this.name=e,this.data={}}init(e){try{this.data=localStorage.getItem(app.name+"-prefs"),this.data=JSON.parse(this.data)}catch{this.data=null}this.data===null&&(this.data=e||{},localStorage.setItem(this.name+"-prefs",JSON.stringify(this.data)))}set(e,t){e!==null&&(this.data[e]=t,localStorage.setItem(this.name+"-prefs",JSON.stringify(this.data)))}get(e){return e===null?null:this.data[e]}},Ve=Te;var Ye=[{version:"1.0.0",date:"2024-02-20",notes:"Initial Application"}];var fe={version:"1.0.0",builddate:"2024-02-20"};var se={app_layout:{name:"app_layout",style:"",panels:[{type:"top",size:"20px",overflow:"hidden",hidden:!0},{type:"left",size:"180px",minSize:100,resizable:!0,style:"border-right: 1px solid #ddd"},{type:"main",overflow:"hidden",style:"background-color: white;"},{type:"right",size:"400px",resizable:!0,hidden:!0,style:"border-left: 1px solid #ddd"},{type:"preview",size:"200px",overflow:"hidden",hidden:!0,resizable:!0},{type:"bottom",size:"40px",hidden:!0}]},app_toolbar:{name:"app_toolbar",items:[{id:"spacer1",type:"spacer"},{id:"swversion",type:"html",html:"---"},{id:"break1",type:"break"},{id:"help",text:"Help",type:"menu",icon:"icon-question",items:[{id:"version",text:"Version",icon:"icon-wand"},{id:"release_notes",text:"Release notes",icon:"icon-list"}]},{id:"user",text:"User Name",type:"menu",items:[{id:"logout",text:"Logout",icon:"icon-off"}]}]},version_form:{fields:[{field:"version",type:"text",html:{label:"Version",attr:'style="width: 300px"'}},{field:"builddate",type:"text",html:{label:"Build date",attr:'style="width: 300px"'}},{field:"apiversion",type:"text",html:{label:"API version",attr:'style="width: 300px"'}},{field:"apibuilddate",type:"text",html:{label:"API builddate",attr:'style="width: 300px"'}}]},version_popup:{title:"Version info",width:500,height:300},release_notes_grid:{columns:[{field:"version",text:"Version",size:"100px"},{field:"date",text:"Date",size:"120px"},{field:"notes",text:"Notes",size:"100%"}]},release_notes_popup:{title:"Release Notes",width:800,height:600}};var pe={loginHTML:`
        <div class="login-box">
            <div class="login-msg">&nbsp;</div>
            <div id="login-form">&nbsp;</div>
            <div class="login-footer">
                Copyright 2024
            </div>
        </div>`,login_form:{fields:[{field:"login",type:"email",required:!0,html:{label:"Login",attr:'maxlength="128" style="width: 300px"'}},{field:"pass",type:"password",required:!0,html:{label:"Password",attr:'maxlength="40" style="width: 300px"'}}]},forgot_form:{fields:[{field:"email",type:"email",required:!0,html:{label:"Email",attr:'maxlength="128" style="width: 300px"',text:`<br><br><br><h3>Instructions will be sent to this email address.</h3>
                        <p>Please, follow the instructions!</p>`}}]},pwreset_form:{fields:[{field:"pwemail",type:"email",required:!0,html:{label:"Login",attr:'maxlength="128" style="width: 300px"'}},{field:"pw",type:"password",required:!0,html:{label:"Password",attr:'maxlength="40" style="width: 300px"'}},{field:"pw2",type:"password",required:!0,html:{label:"Password again",attr:'maxlength="40" style="width: 300px"'}}]}},Ee=class{constructor(e){this.ResetCode=this.getResetCode(),this.login_form=new W(u.extend({name:"login_form",url:app.getContextUrl("login"),owner:this,actions:{Login:function(){t(),this.save({},s=>{s?.error===!0?i(this,s):typeof e=="function"&&(this.owner.pwreset_form.destroy(),this.owner.forgot_form.destroy(),this.owner.login_form.destroy(),e())})},custom:{text:"Forgot Password?",class:"custom-class",onClick(){this.owner.forgot_form.render(o("#login-form")[0])}}}},pe.login_form)),this.forgot_form=new W(u.extend({name:"forgot_form",url:app.getContextUrl("forgot"),owner:this,actions:{Reset:function(){t(),this.save({},s=>{s?.error===!0?i(this,s):t("Please follow the instructions in the sent mail!")})},custom:{text:"Try to login again?",class:"custom-class",onClick(){this.owner.login_form.render(o("#login-form")[0])}}}},pe.forgot_form)),this.pwreset_form=new W(u.extend({name:"pwreset_form",url:app.getContextUrl("pwreset"),owner:this,actions:{Reset:function(){t(),this.save({},s=>{s?.error===!0?i(this,s):(t("Password has been changed. Please login!"),this.owner.login_form.render(o("#login-form")[0]))})},custom:{text:"Try to login again?",class:"custom-class",onClick(){this.owner.login_form.render(o("#login-form")[0])}}},onValidate:function(s){this.getValue("pw")!==this.getValue("pw2")&&s.detail.errors.push({error:"Passwords do not match.",field:this.get("pw")})},onSubmit:s=>{delete s.detail.postData.record.pw2,u.extend(s.detail.postData.record,{reset_code:this.ResetCode})}},pe.pwreset_form));function t(s){typeof s>"u"&&(s="&nbsp;"),o(".login-box .login-msg").html(s)}function i(s,l){t(l.message),l?.details?.forEach(r=>{s.last.errors.push({field:s.get(r.field),error:r.message})}),s.showErrors()}}getResetCode(){let e=document.location.search;if(e.length&&e[0]==="?"&&(e=e.substring(1),e.indexOf("reset_code")!==-1)){let t=e.split("reset_code=");if(t.length===2)return t[1]}return null}start(e){e.main.getLayout().html("main",pe.loginHTML),this.ResetCode?(this.pwreset_form.render(o("#login-form")[0]),window.history.pushState({},document.title,window.location.origin+window.location.pathname)):this.login_form.render(o("#login-form")[0])}};function Ie(I,e){new Ee(e).start(I)}var ze=class extends de{constructor(e,t){super(Object.assign(e,{flatButton:!0,onFlat(i){t&&t.main.goFlat(i.detail.goFlat)},onRender(i){i.done(function(){if(t){let s=t.main.isFlatSmall();s&&this.flat!==!0&&this.goFlat(!0),!s&&this.flat===!0&&this.goFlat(!1)}})},onClick(i){i.object.route?t.router.go(i.object.route):action.call(this,i)}}))}getLevel(e){let t=this.get(e);return t?t.level||0:!1}getSelectedRoute(e){let t=this.find({selected:!0,disabled:!1,hidden:!1});return t=t.length&&t[0].route||e,t}showRoles(){e(this.nodes);function e(t){for(let i=0;i<t.length;i++){let s=t[i].id;this.hasRole(s)?(this.show(s),t[i].nodes.length>0&&this.showRoles(t[i].nodes)):(this.hide(s),this.unselect(s))}}}hasRole(e){let t=this.getLevel(e);return t===!1?!0:window.app.main.session.hasRole(t)}onAction(e){}},Be=ze;function Ze(I,e){for(let t=0;t<I.columns.length;t++)I.columns[t].text=u.lang(e.columns[t].text);for(let t=0;t<I.searches.length;t++)I.searches[t].text=u.lang(e.searches[t].text)}function et(I,e,t){let i=0;if(typeof e.insertedid<"u")i=e.insertedid;else{let s=w2ui[I].getSelection();s.length===1&&(i=s[0])}w2ui[I].reload(function(){i&&w2ui[I].select(i),typeof t=="function"&&t()})}function tt(){return[{id:"0",text:"No"},{id:"1",text:"Yes"}]}function it(I){return I===null?"":(typeof I!="boolean"&&(I=parseInt(I)),I=I===!1?0:1,["No","Yes"][I])}var le={setLang:Ze,reload:et,get_yes_no_items:tt,get_yes_no_text:it};var Re=class I{static ROLE_QUEST=0;static ROLE_ADMIN=1;static ROLE_SALES=2;static isAdmin(){return window.app.main.session.getUserInfo().hasRole(I.ROLE_ADMIN)}static isSales(){return window.app.main.session.getUserInfo().hasRole(I.ROLE_SALES)}},ee=Re;var te={usertype_grid:{style:"border: 0px",sortData:[{field:"utypename",direction:"asc"}],searches:[{field:"utypeid",type:"int",label:"ID"},{field:"utypename",type:"text",label:"Name"},{field:"roles",type:"enum",label:"Has Role",options:{items:[]}}],columns:[{field:"utypeid",text:"ID",size:"60px",sortable:!0,hidden:!0},{field:"utypename",text:"Name",size:"150px",sortable:!0},{field:"roles",text:"Roles",size:"100%",sortable:!0,render:function(I){let e="";if(I&&I.role)for(let t in I.role)t>0&&(e+=", "),e+=I.role[t].rolename;return e}}]},usertype_form:{fields:[{field:"utypename",type:"text",required:!0,html:{label:"Name",attr:'maxlength="64" style="width: 300px"'}},{field:"roles",type:"html",html:{label:"Roles",html:'<div id="usertype_role_grid"></div>'}}]},usertype_popup:{title:"User Type",width:500,height:400},usertype_role_grid:{show:{columnHeaders:!1,selectColumn:!0},style:"border: 0px; width:250px;height:224px",sortData:[{field:"rolename",direction:"asc"}],columns:[{field:"roleid",label:"ID",size:"60px",sortable:!0,hidden:!0},{field:"rolename",label:"Name",size:"100%",sortable:!0}]},view_css:`
.preview-usertype .usertype-title{height:40px;border-bottom:1px solid silver;padding:6px 2px}
.preview-usertype .usertype-title #usertype-name{margin-right:90px;padding:5px;font-size:24px}
.preview-usertype .usertype-details{height:152px;overflow:hidden;border-top:1px solid #888;border-bottom:1px solid silver;padding-top:10px}
.preview-usertype .usertype-details .usertype-value{padding:10px 5px 5px 0}
.preview-usertype .usertype-details #usertype-details{height:40px;overflow:hidden;text-overflow:ellipsis;margin-right:10px}`,view_html:`
<div class="preview-usertype w2ui-group-title">
    <div class="usertype-title">
        <div id="usertype-name"></div>
    </div>
    <div class="usertype-details" id="usertype-details">
    </div>
</div>`};var Ae=class{constructor(){this.usertype_grid=new Q(u.extend({name:"usertype_grid",url:app.getContextUrl("usertypes"),recid:"utypeid",show:{toolbar:!0,toolbarAdd:ee.isAdmin(),toolbarEdit:ee.isAdmin()},onAdd:function(i){t()},onEdit:function(i){t(i.detail.recid)},onDblClick:function(i){ee.isAdmin()&&t(i.detail.recid)},onRender:function(i){i.onComplete=function(s){e()}},roles_rendering:!1},te.usertype_grid));function e(){w2ui.usertype_grid.roles_rendering||(w2ui.usertype_grid.roles_rendering=!0,K.getItems(app.getContextUrl("roleitems"),{},function(i){let s=app.main.getLayout();s.html("right","<style>"+te.view_css+"</style>"+te.view_html);let l=o(s.el("right"));l.find("#usertype-name").html("Available Roles"),l.find("#usertype-details").html(n("Roles",r(i))),w2ui.usertype_grid.roles_rendering=!1;function r(a){var h="";for(var d in a)h+=a[d].text+"<br>";return h}function n(a,h){(h===null||h==="")&&(h="&nbsp;");var d='<div class="w2ui-field w2ui-span7">     <label>'+a+'</label>    <div class="usertype-value">'+h+"</div></div>";return d}}))}function t(i){typeof w2ui.usertype_role_grid<"u"&&w2ui.usertype_role_grid.destroy();let s=new Q(u.extend({name:"usertype_role_grid",recid:"roleid"},te.usertype_role_grid));s.load(app.getContextUrl("roles"),function(){let l=new W(u.extend({name:"usertype_form",url:app.getContextUrl("usertype",i),recid:i,actions:{Save:function(){l.save({},function(r){r?.error===!0?(r?.details.forEach(n=>{l.last.errors.push({field:l.get(n.field),error:n.message})}),l.showErrors()):le.reload("usertype_grid",r,function(){U.close()})})},Cancel:function(){U.close()}},onLoad:function(r){r.onComplete=function(){setTimeout(function(){w2ui.usertype_role_grid.selectNone();for(let n in w2ui.usertype_role_grid.records){let a=w2ui.usertype_role_grid.records[n].roleid;1<<a-1&w2ui.usertype_form.record.roles&&w2ui.usertype_role_grid.select(a)}},200)}},onSubmit:function(r){r.detail.postData.record.roles=0;let n=w2ui.usertype_role_grid.getSelection();for(let a in n)r.detail.postData.record.roles+=1<<n[a]-1}},te.usertype_form));U.open(u.extend({title:te.usertype_popup.title+": "+(i?"Edit":"Add New"),body:'<div id="form" style="width: 100%; height: 100%;"></div>'},te.usertype_popup)).then(r=>{l.render(o("#w2ui-popup #form").get(0)),s.render(o("#w2ui-popup #form #usertype_role_grid").get(0))}).close(r=>{l.destroy(),s.destroy()})})}}start(){var e=window.app.main.getLayout();e.set("right",{size:400}),e.html("main",w2ui.usertype_grid),e.show("right",!0)}},We=Ae;var X={user_grid:{style:"border: 0px",sortData:[{field:"userid",direction:"asc"}],searches:[{field:"userid",type:"int",label:"ID"},{field:"name",type:"text",label:"Name"},{field:"title",type:"text",label:"Title"},{field:"phone",type:"text",label:"Phone"},{field:"email",type:"text",label:"Email"},{field:"fk_utypeid",type:"list",label:"Usertype",options:{items:[]}},{field:"inactive",type:"select",label:"Inactive",options:{items:[]},style:"width: 100px;"},{field:"roles",type:"enum",label:"Has Role",options:{items:[]}}],columns:[{field:"userid",text:"ID",size:"60px",sortable:!0},{field:"name",text:"Name",size:"100%",sortable:!0,min:"120px"},{field:"title",text:"Title",size:"200px",sortable:!0},{field:"phone",text:"Phone",size:"120px",sortable:!0},{field:"email",text:"Email",size:"200px",sortable:!0},{field:"utypename",text:"Usertype",size:"120px",sortable:!0},{field:"inactive",text:"Inactive",size:"64px",sortable:!0,render:function(I){return I&&parseInt(I.inactive)===1?"Yes":""}}]},user_form:{fields:[{field:"name",type:"text",required:!0,html:{label:"Name",attr:'maxlength="64" style="width: 300px"'}},{field:"title",type:"text",html:{label:"Title",attr:'maxlength="32" style="width: 300px"'}},{field:"phone",type:"text",html:{label:"Phone",attr:'maxlength="32" style="width: 300px"'}},{field:"email",type:"email",required:!0,html:{label:"Email",attr:'maxlength="128" style="width: 300px"'}},{field:"fk_utypeid",type:"list",required:!0,html:{label:"UserType",attr:'style="width: 300px"'}},{field:"inactive",type:"list",required:!0,html:{label:"Inactive"}}]},user_popup:{title:"User",width:680,height:420},user_view_css:`
.user-main{margin-top:30px;padding:10px;}
.user-col1{float:left;width:160px;padding:5px;text-align:center}
.user-col1 .user-photo{width:120px;height:135px;margin:0 auto;border-radius:3px;background-color:#888;overflow:hidden;border:1px solid #888}
.user-col1 .user-photo img{width:120px;height:135px;border:0}
.user-col2{position:relative;margin-left:160px;padding:5px}
.user-col2 .user-name{display:block;font-size:20px;padding:5px 0}
.user-col2 .user-email{display:block;padding:3px}
.user-col2 .user-teamname{display:block;padding:3px}
.user-col3{margin-top:20px}
.user-col3 .user-details{padding-top:10px!important;line-height:150%}
.w2ui-field>label{clear:right}`,user_view_html:`
<div class="user-main">
    <div class="user-col1">
        <div class="user-photo">
            <img id="user-photo">
        </div>
    </div>
    <div class="user-col2">
        <span id="name" class="user-name w2ui-group-title"></span>
        <span id="email" class="user-email">&nbsp;</span>
        <div style="height: 20px;"></div>
    </div>
    <div style="clear:both;"></div>
    <hr>
    <h2>Details</h2>
    <div id="details" class="user-col3">
    </div>
    <hr>
    <h2>Activity</h2>
    <div id="activity" class="user-col3">
    </div>
    <hr>
</div>`,close_box_html:'<div><div id="user_close" style="float:right;padding:10px;"><span class="w2ui-icon icon-cross"></span></div></div>',msg_noselected:"Select an item to view!",msg_manyselected:"Select only one item!",preview_msg_html:'<div class="preview-msg">$message</div>'};var De=class{constructor(){var e=!1,t=!1;new Q(u.extend({name:"user_grid",url:app.getContextUrl("users"),recid:"userid",show:{toolbar:!0,toolbarAdd:ee.isAdmin(),toolbarEdit:ee.isAdmin()},toolbar:{items:[{type:"spacer"},{type:"button",id:"details",text:"Show Details",tooltip:"Preview details",img:"icon-eye"}]},onToolbar:function(n){n.target==="details"&&(t?s():i())},onAdd:function(n){r()},onEdit:function(n){r(n.detail.recid)},onDblClick:function(n){ee.isAdmin()&&r(n.detail.recid)},onSelect:function(n){n.onComplete=function(){l()}},onUnselect:function(n){n.onComplete=function(){l()}},onRefresh:function(n){n.onComplete=function(){l()}}},X.user_grid)),setTimeout(async()=>{let n=w2ui.user_grid.getSearch("fk_utypeid");n.options.items=await K.getItems(app.getContextUrl("usertypeitems"));let a=w2ui.user_grid.getSearch("inactive");a.options.items=le.get_yes_no_items();let h=w2ui.user_grid.getSearch("roles");h.options.items=await K.getItems(app.getContextUrl("roleitems"))},1);function i(){t=!0;var n=app.main.getLayout();n.show("right",!0),w2ui.user_grid.toolbar.hide("details"),l()}function s(){t=!1;var n=app.main.getLayout();n.hide("right",!0),w2ui.user_grid.toolbar.show("details")}function l(){if(!t||e)return;let n=app.main.getLayout(),a=w2ui.user_grid,h=a.getSelection();if(h.length!==1){let m=h.length<1?X.msg_noselected:X.msg_manyselected;n.html("right",X.close_box_html+X.preview_msg_html.replace("$message",m))}else{e=!0,n.html("right","<style>"+X.user_view_css+"</style>"+X.close_box_html+X.user_view_html);let m=a.get(h[0]);var d=o(n.el("right"));d.find("#name").html(m.name),d.find("#email").html('<a href="mailto:'+m.email+'">'+m.email+"</a>"),c("ID",m.userid),m.phone&&c("Phone",m.phone),parseInt(m.inactive)===1&&c("Inactive","Yes"),m.utypename&&c("Usertype",m.utypename),m.ses_lastlogin&&p("Last login",m.ses_lastlogin),m.ses_lastactive&&p("Last active",m.ses_lastactive),K.loadImg(app.getContextUrl("user/"+m.userid+"/photo"),"#user-photo"),f(m.userid),e=!1}o("#user_close").on("click",s);function g(m,w){return(w===null||w==="")&&(w="&nbsp;"),'<div class="w2ui-field w2ui-span7">     <label>'+m+'</label>    <div class="user-details">'+w+"</div></div>"}function c(m,w){d.find("#details").append(g(m,w))}function p(m,w){d.find("#activity").append(g(m,w))}function f(m){K.getItems(app.getContextUrl("user/"+m+"/roleitems"),{},function(w){let b="";for(let y in w)b+=w[y].text+"<br>";c("Roles",b)})}}function r(n){let a=new W(u.extend({name:"user_form",url:app.getContextUrl("user",n),recid:n,actions:{Save:function(){this.action_save(this)},Cancel:function(){U.close()}},action_save:async h=>{h.save({},function(d){d?.error===!0?(d?.details.forEach(g=>{h.last.errors.push({field:h.get(g.field),error:g.message})}),h.showErrors()):le.reload("user_grid",d,function(){U.close()})})},onSubmit:h=>{u.isPlainObject(h.detail.postData.record.fk_utypeid)&&(h.detail.postData.record.fk_utypeid=h.detail.postData.record.fk_utypeid.id),u.isPlainObject(h.detail.postData.record.inactive)&&(h.detail.postData.record.inactive=h.detail.postData.record.inactive.id)}},X.user_form));setTimeout(async()=>{let h=await K.getItems(app.getContextUrl("usertypeitems")),d=a.get("fk_utypeid");d.options.items=h;let g=a.get("inactive");g.options.items=le.get_yes_no_items()}),U.open(u.extend({title:X.user_popup.title+": "+(n?"Edit":"Add New"),body:'<div id="form" style="width: 100%; height: 100%;"></div>'},X.user_popup)).then(h=>{a.render(o("#w2ui-popup #form")[0])}).close(h=>{a.destroy()})}}start(){var e=app.main.getLayout();e.html("main",w2ui.user_grid),e.set("right",{size:450})}},Xe=De;var Oe={home_menuitem:{id:"home",text:"Home",type:"radio",group:"main",icon:"icon-home",route:"/home"},home_sb:{name:"home_sb",nodes:[{id:"home-users",text:"Users",img:"icon-folder",expanded:!0,group:!0,nodes:[{id:"users",text:"Users",icon:"icon-user",route:"/home/users"},{id:"usertypes",text:"Usertypes",icon:"icon-users",route:"/home/usertypes",level:1}]}]}};var Me=class{constructor(e){e.main.getToolbar().insert("spacer1",Oe.home_menuitem);let t=new Be(Oe.home_sb,e),i=null,s=null;e.router.add({"/home*"(l){e.main.selectToolbar("home"),t.unselect(["usertypes","users"]);let r=e.main.getClearLayout();r.show("left",!0),r.html("left",t)},"/"(l){e.router.go(t.getSelectedRoute("/home"))},"/home"(l){e.router.go(t.getSelectedRoute("/home/users"))},"/home/usertypes"(l){t.select("usertypes"),i||(i=new We),i.start()},"/home/users"(l,r){t.select("users"),s||(s=new Xe),s.start()}})}},qe=Me;function Ke(I){I.hasModule("home")||I.addModule("home",new qe(I))}var Fe=class{constructor(e){this.loc="/",this.prefs=new Ve(e.getName()),this.prefs.init({"ui-sidebar-size":"large"}),this.session=new Ue(e.getContextUrl("")),this.app_layout=new ue(se.app_layout),this.app_toolbar=new Z(se.app_toolbar);let t=this;this.app_toolbar.onClick=i=>{switch(i.target){case"user:logout":t.userLogout();break;case"help:version":t.showVersion();break;case"help:release_notes":t.showReleaseNotes();break;default:if(i.target.split(":").length>1){let l=null;typeof i.detail<"u"?l=i.detail:typeof i.item<"u"&&(l=i),l&&typeof l.item<"u"&&l.item.type==="menu"&&typeof l.subItem<"u"&&typeof l.subItem.onSelect=="function"&&(console.log("TRACE: "+i.target+".onSelect."),l.subItem.onSelect(i))}}},u.settings.weekStarts="M",u.settings.dateFormat="yyyy-mm-dd",u.settings.timeFormat="hh24:mm",u.settings.datetimeFormat="yyyy-mm-dd|hh24:mm",u.settings.dataType="JSON"}start(e){let t=(r,n)=>{let a=this.session.getUserInfo();a?.getUserID()!==0&&r!==!0?typeof n=="function"&&n(a):this.session.getSession(r,n)},i=r=>!(r?.getUserID()===0||!r?.isSessionActive()),s=()=>{setTimeout(()=>{t(!0,r=>{i(r)?s():this.userLogin()})},3e5)},l=()=>{this.app_toolbar.set("swversion",{html:"Version: "+fe.version+"<br>"+fe.builddate}),this.setUserName(this.session.getUserInfo()),this.app_toolbar.render("#app-toolbar"),this.app_layout.render("#app-main"),o("#app-container").show()};t(!0,r=>{if(typeof r=="string"){e.error(r);return}if(!i(r)){this.userLogin();return}Ke(e),l(),e.router.init(this.loc),s()})}userLogin(){this.loc=app.router.get(),console.log(this.loc),this.getClearLayout(),this.app_layout.render("#app-main"),o("#app-toolbar").html(""),o("#app-container").show(),o("#w2ui-popup").length>0&&U.close(),Ie(app,()=>{this.start(app)})}userLogout(){this.loc=app.router.set("/"),this.loc=app.router.get(),console.log(this.loc),this.session.logout(()=>{this.userLogin()})}getToolbar(e){return typeof e>"u"?this.app_toolbar:this.app_toolbar.get(e)}selectToolbar(e){this.app_toolbar.uncheck(...this.app_toolbar.get()),this.app_toolbar.check(e)}addMenuItem(e,t){let i=this.getToolbar(e);i&&i.type==="menu"&&i.items.push(t)}getLayout(){return this.app_layout}getClearLayout(){return this.app_layout.hide("left",!0),this.app_layout.hide("right",!0),this.app_layout.hide("preview",!0),this.app_layout}setUserName(e){this.app_toolbar.set("user",{text:e.getUserID()?e.getUserName():"No login"})}isFlatSmall(){return this.prefs.get("ui-sidebar-size")==="small"}goFlat(e){e===!0?(this.app_layout.set("left",{size:35,minSize:35,resizable:!1}),this.prefs.set("ui-sidebar-size","small")):(this.app_layout.set("left",{size:180,minSize:100,resizable:!0}),this.prefs.set("ui-sidebar-size","large"))}getPref(e){return this.prefs.get(e)}setPref(e,t){this.prefs.set(e,t)}openInNewTab(e){window.open(e,"_blank").focus()}showVersion(){let e=new W(u.extend({name:"VersionForm",url:app.getContextUrl("version"),recid:"api",onLoad:t=>{t.onComplete=function(){u.extend(this.record,fe)}},onRender:t=>{t.onComplete=function(){this.disable("version","builddate","apiversion","apibuilddate")}}},se.VersionForm));U.open(u.extend({body:'<div id="form" style="width: 100%; height: 100%;"></div>'},se.version_popup)).then(t=>{e.render(o("#w2ui-popup #form")[0])}).close(t=>{e.destroy()})}showReleaseNotes(){let e=new Q(u.extend({name:"ReleaseNotesGrid",show:{toolbar:!1},records:Ye||[]},se.release_notes_grid));U.open(u.extend({body:'<div id="form" style="width: 100%; height: 100%;"></div>'},se.release_notes_popup)).then(t=>{e.render(o("#w2ui-popup #form")[0])}).close(t=>{e.destroy()})}},Ge=Fe;var Le=class{constructor(){this.name="WebApp",this.context="api/",this.router=new je,this.modules=[],this.router.on("error",e=>{Ce(`Route "${e.detail.hash}" is not defined.`),this.router.go("/")})}getName(){return this.name}getContextUrl(e,t){return this.context+e+(t?"/"+t:"")}hasModule(e){return e in ae.modules}addModule(e,t){ae.modules[e]=t}lock(e){e||(e="Loading..."),u.lock("body",e,!0)}unlock(){u.unlock("body")}error(e,t,i){console.log("ERROR: "+e),t!==!0&&(i===!0||o("#w2ui-popup").length===0)&&Ce(e,"Error")}isSaveError(e,t,i){return typeof e>"u"?(this.error("Error!"),!0):typeof e.status<"u"&&e.status==="success"||typeof e.error>"u"||e.error===!1?!1:(typeof e.error.message<"u"?this.error("Error: "+e.error.message,t,i):typeof e.message<"u"?this.error("Error: "+e.message,t,i):this.error("Error without message!",t,i),!0)}run(){this.main=new Ge(this),this.main.start(this)}};u.extend(u,{prepareParams:function(I,e,t){let i=t??u.settings.dataType,s=e.body;return e.method=="GET"?typeof s.recid<"u"?delete e.body:(s={request:s},l()):e.method=="POST"?(s?.recid>0&&(e.method="PUT"),e.body=e.body.record,e.headers["Content-Type"]="application/json"):(e.method=="PUT"&&(e.body=e.body.changes),e.headers["Content-Type"]="application/json"),e.body=typeof e.body=="string"?e.body:JSON.stringify(e.body),e;function l(){Object.keys(s).forEach(r=>{let n=s[r];typeof n=="object"&&(n=JSON.stringify(n)),I.searchParams.append(r,n)}),delete e.body}}});var ae=new Le;window.w2ui=N;window.app=ae;ae.run();var di=ae;})();
